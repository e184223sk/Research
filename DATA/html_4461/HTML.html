<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Unity 3Dでアニメーションを考慮したジャンプ その2（アニメーションを分割して溜め大ジャンプ） - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/mkgask/items/fa307811da6d9d76bc97" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="8A+NI6duwt1WiF/7QHhLzYnrIk3scthgQpnW4bPo3Kfyl68LM4PwP97fTvyifArwc/CXAXhq7Q0vPP7BL0FzRg==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@mkgask" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="Unity 3Dでアニメーションを考慮したジャンプ その2（アニメーションを分割して溜め大ジャンプ） - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WVzVwZEhrZ00wVGpnYWZqZ3FMamc0dmpnNkhqZzd6amdyZmpnNmZqZzdQamdwTG9nSVBtaGE3amdaZmpnWl9qZ3Jqamc2UGpnN1BqZzVjZzQ0R2Q0NEd1TXUtOGlPT0NvdU9EaS1PRG9lT0R2T09DdC1PRHAtT0RzLU9Da3VXSWh1V0pzdU9CbC1PQnB1YTZuT09DZ2VXa3AtT0N1T09Eby1PRHMtT0RsLS04aVEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9OTA5MzA2MzU5NDlmMTAzOGYxMGI5NGQwNTYyYmNiZjY&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzFyWjJGemF3JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGY4YjNmNTEzZmQzNWJjZmM5NGQwNWZlOGY3ZTE1NDY&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=d30920c97aa3d2d7487311053dbb5151"><meta property="og:description" content="

はじめに

Unity 3DでUpdateとFixedUpdate間のタイミングを考慮したジャンプ（基礎）
Unity 3Dでアニメーションを考慮したジャンプ その1（単アニメーション）
の続きです。

上記記事で設定したジャンプ..."><meta content="https://qiita.com/mkgask/items/fa307811da6d9d76bc97" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Unity" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-0074d0f0-e3cf-4239-85b3-0d4c9941dd29"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fmkgask%2Fitems%2Ffa307811da6d9d76bc97">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fmkgask%2Fitems%2Ffa307811da6d9d76bc97">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-0074d0f0-e3cf-4239-85b3-0d4c9941dd29">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-10-29T01:11:08.000+09:00","dateModified":"2019-06-22T00:18:40.000+09:00","headline":"Unity 3Dでアニメーションを考慮したジャンプ その2（アニメーションを分割して溜め大ジャンプ）","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WVzVwZEhrZ00wVGpnYWZqZ3FMamc0dmpnNkhqZzd6amdyZmpnNmZqZzdQamdwTG9nSVBtaGE3amdaZmpnWl9qZ3Jqamc2UGpnN1BqZzVjZzQ0R2Q0NEd1TXUtOGlPT0NvdU9EaS1PRG9lT0R2T09DdC1PRHAtT0RzLU9Da3VXSWh1V0pzdU9CbC1PQnB1YTZuT09DZ2VXa3AtT0N1T09Eby1PRHMtT0RsLS04aVEmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9OTA5MzA2MzU5NDlmMTAzOGYxMGI5NGQwNTYyYmNiZjY\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzFyWjJGemF3JnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OGY4YjNmNTEzZmQzNWJjZmM5NGQwNWZlOGY3ZTE1NDY\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=d30920c97aa3d2d7487311053dbb5151","mainEntityOfPage":"https://qiita.com/mkgask/items/fa307811da6d9d76bc97","author":{"@type":"Person","address":"だがね","email":null,"identifier":"mkgask","name":"mkgask","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F72594%2Fprofile-images%2F1473699207?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=13e12b10c92fd48268dbffad96bda4d6","url":"https://qiita.com/mkgask","description":"業務ではPHP触りつつ趣味ではUnity C#とPythonで遊んでいます。\r\n何か色々やってるのでフォローにはご注意くださいヾ( ╹◡╹)ﾉﾞ ","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mkgask","type":"items","id":"fa307811da6d9d76bc97"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mkgask","type":"items","id":"fa307811da6d9d76bc97"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"mkgask","type":"items","id":"fa307811da6d9d76bc97"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/mkgask/items/fa307811da6d9d76bc97","location":"/mkgask/items/fa307811da6d9d76bc97","scheme":"https","host":"qiita.com","port":null,"pathname":"/mkgask/items/fa307811da6d9d76bc97","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"XKQX+NMtWhGCO6uMKNF/2607uWl7qAWKMFKfVA63EMVePDXQR8Bo8wpsuovK1T7mVyAMJe+wMOdd97d0kh6/JA==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-c3a8dbf1-1001-432b-8c33-4ae025f9fdb0"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mkgask/items/fa307811da6d9d76bc97/likers" class="css-1iupg5d">9</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">8</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/fa307811da6d9d76bc97/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mkgask/items/fa307811da6d9d76bc97/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mkgask/items/fa307811da6d9d76bc97/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mkgask/items/fa307811da6d9d76bc97/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mkgask/items/fa307811da6d9d76bc97.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/mkgask"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/72594/profile-images/1473699207" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/mkgask" class="css-10ougpm">@<!-- -->mkgask</a><div class="css-1ay9vb9"><span><meta content="2018-10-28T16:11:08Z"/><time dateTime="2019-06-21T15:18:40Z" class="css-m19uds">updated at 2019-06-21</time></span></div></div></div></div></div><h1 class="css-cgzq40">Unity 3Dでアニメーションを考慮したジャンプ その2（アニメーションを分割して溜め大ジャンプ）</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/unity" class="css-4czcte">Unity</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p><a href="https://qiita.com/mkgask/items/6d04d0be13cc0b14d4fb" id="reference-dcb87ac3b1f0cbfa4c97">Unity 3DでUpdateとFixedUpdate間のタイミングを考慮したジャンプ（基礎）</a><br>
<a href="https://qiita.com/mkgask/items/e660fc802b2ec994fb5f" id="reference-79f332d8e30555f0bd7c">Unity 3Dでアニメーションを考慮したジャンプ その1（単アニメーション）</a><br>
の続きです。</p>

<p>上記記事で設定したジャンプアニメーションをベースに改良していきます。</p>

<h1>
<span id="想定環境" class="fragment"></span><a href="#%E6%83%B3%E5%AE%9A%E7%92%B0%E5%A2%83"><i class="fa fa-link"></i></a>想定環境</h1>

<ul>
<li>Windows 10</li>
<li>Unity 2018.2.14f1</li>
<li>プレイヤーキャラクターに <a href="http://unity-chan.com/" rel="nofollow noopener" target="_blank">Unity Technologies Japanオリジナルキャラクター Unityちゃん</a> を利用</li>
<li>素のUnityで実行できるコードになっています</li>
</ul>

<h1>
<span id="アニメーション分割" class="fragment"></span><a href="#%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%86%E5%89%B2"><i class="fa fa-link"></i></a>アニメーション分割</h1>

<p><a href="https://qiita.com/mkgask/items/e660fc802b2ec994fb5f">前回記事</a> にて確認した通り、単アニメーションでのジャンプはジャンプの挙動が様々に変化するゲームには向いていません。</p>

<p>なので、ジャンプの内容が変わってもきちんと対応出来るように変更します。</p>

<p>アニメーションを分割し、アニメーション間の遷移をAnimatorとコードを使って行うことで、遷移のタイミングをずらしたり、遷移先のアニメーションを動的に変更できるようになります。</p>

<h2>
<span id="どこからするの" class="fragment"></span><a href="#%E3%81%A9%E3%81%93%E3%81%8B%E3%82%89%E3%81%99%E3%82%8B%E3%81%AE"><i class="fa fa-link"></i></a>どこからするの</h2>

<p>アニメーションを持っているfbxファイルを選択するとInspectorに表示される、<code>Animation</code> から分割することが出来ます。<br>
<a href="https://camo.qiitausercontent.com/cc91ee4076e750f5bade0e0cdb8605ac22917b8f/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373936372d61386132633738302d646231302d313165382d383430342d6661303333633839306364632e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617967-a8a2c780-db10-11e8-8404-fa033c890cdc.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5579c493afbcf6254578145f76eadebb" alt="01" data-canonical-src="https://user-images.githubusercontent.com/8291395/47617967-a8a2c780-db10-11e8-8404-fa033c890cdc.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617967-a8a2c780-db10-11e8-8404-fa033c890cdc.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=0ba1eb7a5b7dc9daf5e7c5e1a687e06a 1x" loading="lazy"></a></p>

<p>Clipsの欄の右下にある＋ボタンを押すことで、アニメーションを追加することが出来ます。<br>
<a href="https://camo.qiitausercontent.com/b1fd656d5d6e07ddecdd81415062a8ad58ad5d6f/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373937342d62326334633630302d646231302d313165382d383665622d6162656234323235666537342e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617974-b2c4c600-db10-11e8-86eb-abeb4225fe74.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ccc3977be2fa0ea2d4cab820fc280b80" alt="02" data-canonical-src="https://user-images.githubusercontent.com/8291395/47617974-b2c4c600-db10-11e8-86eb-abeb4225fe74.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617974-b2c4c600-db10-11e8-86eb-abeb4225fe74.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a198bfad0f417aa17f83d1f361db5085 1x" loading="lazy"></a></p>

<p><a href="https://camo.qiitausercontent.com/90bcb01de289ea0e7c8835386f233f16c438bc67/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373937392d62626235393738302d646231302d313165382d383838632d3964313636626265346435302e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617979-bbb59780-db10-11e8-888c-9d166bbe4d50.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1d8cb51647a77f476a6198d31d713317" alt="03" data-canonical-src="https://user-images.githubusercontent.com/8291395/47617979-bbb59780-db10-11e8-888c-9d166bbe4d50.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617979-bbb59780-db10-11e8-888c-9d166bbe4d50.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=eef0fa92210e0e38e9dda7946804d922 1x" loading="lazy"></a></p>

<h2>
<span id="どうやってするの" class="fragment"></span><a href="#%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E3%81%99%E3%82%8B%E3%81%AE"><i class="fa fa-link"></i></a>どうやってするの</h2>

<p>増やしたアニメーションは、そのままではJUMP00の丸コピーなので、まだ分割されていません。</p>

<p>これを、以下4つのモーションに分割します。</p>

<ul>
<li>ジャンプ前</li>
<li>上昇中</li>
<li>下降中</li>
<li>着地</li>
</ul>

<p>Inspectorの下にアニメーションを再生できる表示がありますので、これを使ってアニメーションを再生しながら、それぞれの区切りとなる時間で各モーションを分割していきます。<br>
<a href="https://camo.qiitausercontent.com/6935a5a43dc8c3d4e06d57cc95bad955df62d385/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383236382d37356661636530302d646231342d313165382d386636332d3038366266376561353435632e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618268-75face00-db14-11e8-8f63-086bf7ea545c.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0eb3f48be3c1bd536a7b58f92a5fcdbe" alt="04" data-canonical-src="https://user-images.githubusercontent.com/8291395/47618268-75face00-db14-11e8-8f63-086bf7ea545c.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618268-75face00-db14-11e8-8f63-086bf7ea545c.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1e6fe731b6cb891f462e25939f7bd7ee 1x" loading="lazy"></a><br>
ジャンプ前のモーションの時間を指定したところです。</p>

<p>どんなモーションなのか自分の分かりやすい名前に変更し、Lengthのところで分割するモーションの時間を指定します。</p>

<p>また、Root Transform Position (Y) を feet （足元）に設定しています。<br>
ここはアニメーション毎に最適な原点位置が違うので、モーションとして最も自然な形になるように、またコライダーの位置ともズレが起きないように調整が必要です。</p>

<p>これをあと3回繰り返します。<br>
<a href="https://camo.qiitausercontent.com/fefc23ad179557255049233672c4996d57f94542/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383237362d38383735303738302d646231342d313165382d383131352d6632383638323831323831372e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618276-88750780-db14-11e8-8115-f28682812817.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f60f2421a4dd92a5a53ac81c50f7a788" alt="05" data-canonical-src="https://user-images.githubusercontent.com/8291395/47618276-88750780-db14-11e8-8115-f28682812817.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618276-88750780-db14-11e8-8115-f28682812817.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=37b8d2cc8f89105c38336687ee6d487b 1x" loading="lazy"></a><br>
上昇中からジャンプ頂点を越えて下降中に移行するモーションは、下降中モーションに含めたほうが自然な再生が出来ると思います。<br>
なので、上昇中モーションはジャンプ頂点に入る少し前のところまでで切ります。<br>
<a href="https://camo.qiitausercontent.com/4f709732830ab2bb881fb066faa2afa91da4d323/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383237392d38653661653838302d646231342d313165382d393261392d3236623734623964653138612e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618279-8e6ae880-db14-11e8-92a9-26b74b9de18a.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=af0b02580288bddf4364aa3dbc0a8427" alt="06" data-canonical-src="https://user-images.githubusercontent.com/8291395/47618279-8e6ae880-db14-11e8-92a9-26b74b9de18a.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618279-8e6ae880-db14-11e8-92a9-26b74b9de18a.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8fa0f44754add174a453d4b6935ed7b7 1x" loading="lazy"></a><br>
同様の理由で、下降中モーションも着地に入る手前のところで切ります。<br>
<a href="https://camo.qiitausercontent.com/a2eec20fb4bf2e2a9554e074689b1c8d1155cbbf/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383238352d39363261386430302d646231342d313165382d386261332d3037343764326666616236612e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618285-962a8d00-db14-11e8-8ba3-0747d2ffab6a.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=86d43db0b5ba0a51f6f31c7a03b208cf" alt="07" data-canonical-src="https://user-images.githubusercontent.com/8291395/47618285-962a8d00-db14-11e8-8ba3-0747d2ffab6a.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618285-962a8d00-db14-11e8-8ba3-0747d2ffab6a.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1a0d210d566b6ad8463fa6df4a7f02df 1x" loading="lazy"></a><br>
これでアニメーションが分割出来ました。</p>

<p>Inspectorをスクロールして一番右下のApplyボタンを押すと、分割したアニメーションがfbxに反映されます。<br>
<a href="https://camo.qiitausercontent.com/c8e6c943b4fa863b11d83552d5faa270c5021564/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373939352d65643265363330302d646231302d313165382d393038652d6637373036633637623830622e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617995-ed2e6300-db10-11e8-908e-f7706c67b80b.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d03726e81f000a7da95218f80e817b48" alt="08" data-canonical-src="https://user-images.githubusercontent.com/8291395/47617995-ed2e6300-db10-11e8-908e-f7706c67b80b.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617995-ed2e6300-db10-11e8-908e-f7706c67b80b.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=8ae93bd02419afeefbb92078700d1792 1x" loading="lazy"></a></p>

<h1>
<span id="animator-を更新" class="fragment"></span><a href="#animator-%E3%82%92%E6%9B%B4%E6%96%B0"><i class="fa fa-link"></i></a>Animator を更新</h1>

<p>分割したアニメーションの制御のために、AnimatorにもStateを追加します。<br>
<a href="https://camo.qiitausercontent.com/cb10e7eb1c1c4ca496dafa88ce288caa19767ee7/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373939372d66336263646138302d646231302d313165382d383066332d6561646238316539326533392e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617997-f3bcda80-db10-11e8-80f3-eadb81e92e39.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=20e18e27d89b021c7c60197e476a5d6d" alt="09" data-canonical-src="https://user-images.githubusercontent.com/8291395/47617997-f3bcda80-db10-11e8-80f3-eadb81e92e39.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617997-f3bcda80-db10-11e8-80f3-eadb81e92e39.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=366a5d3e2cc2b208d75c7d556c543c80 1x" loading="lazy"></a><br>
パラメータはすべてBoolで追加し、Transitionでは同名のパラメータがONになったら遷移するように設定します。<br>
<a href="https://camo.qiitausercontent.com/395615a27846d0e10e8dcccd717a3251fa6eff9e/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383030302d66393161323530302d646231302d313165382d393265622d6231626662386238363639352e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618000-f91a2500-db10-11e8-92eb-b1bfb8b86695.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7f092a5793e2ca4c7d1ae74c87d72dcd" alt="10" data-canonical-src="https://user-images.githubusercontent.com/8291395/47618000-f91a2500-db10-11e8-92eb-b1bfb8b86695.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618000-f91a2500-db10-11e8-92eb-b1bfb8b86695.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6fd673edf83b29e9ff09de37a46b7fe2 1x" loading="lazy"></a></p>

<h1>
<span id="溜めて大ジャンプ" class="fragment"></span><a href="#%E6%BA%9C%E3%82%81%E3%81%A6%E5%A4%A7%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97"><i class="fa fa-link"></i></a>溜めて大ジャンプ</h1>

<p>今回、一連のジャンプ記事で筆者がやりたかった内容がこれです。</p>

<p>ジャンプボタンを押している間ジャンプ力を溜めて、離したときに溜まっているジャンプ力でジャンプの強さを変更します。</p>

<p>溜めたジャンプ力によって上昇中と下降中の状態の長さが変わるので、アニメーションの遷移をコードで制御します。</p>

<h2>
<span id="仕様の再検討" class="fragment"></span><a href="#%E4%BB%95%E6%A7%98%E3%81%AE%E5%86%8D%E6%A4%9C%E8%A8%8E"><i class="fa fa-link"></i></a>仕様の再検討</h2>

<p>コードでアニメーションの遷移をするので、遷移条件の判定と遷移処理を追加します。</p>

<ul>
<li>ジャンプキー入力開始（key down）ではジャンプ溜め開始</li>
<li>ジャンプキーが離されたら（key up）ジャンプ開始</li>
<li>ジャンプキー入力開始（key down）でジャンプ前モーション</li>
<li>ジャンプキーが離されたら（key up）上昇中モーション</li>
<li>ジャンプの頂点を過ぎて下降を開始したら下降中モーション</li>
<li>着地したら着地モーション</li>
</ul>

<p>を実装します。</p>

<p>一番ポイントになるところは、ジャンプの頂点を越えて下降中になるところの判定でしょうか。</p>

<p>raycastで地面との距離をとれるようにしてあるので、前フレームとの差をとって、＋（上昇中）か、－（下降中）かで判断を行います。</p>

<p>ただ、ジャンプ頂点の判定にraycastの距離を使っていて、測定できる距離に上限をとっているので、上限以上にジャンプしてしまうとモーションの遷移が行なえません。<br>
raycastの測定距離上限は、ジャンプで想定される最大高さに多少のマージンを足した値にしておく必要があります。</p>

<p>また、ジャンプキーの入力について、上記の仕様ではkey down、key upと書きましたが、使うメソッドとしては <code>UnityEngine.Input.GetButton</code> で変わりありません。</p>

<p>最初は <code>GetButtonDown</code> と <code>GetButtonUp</code> で実装したのですが、ジャンプキーを押してから溜めモーションに移行するまでに本当に少しですが時間がかかるので、その間にジャンプキーを離すと、ジャンプキーが離されてから溜めモーションに移行して次の <code>GetButtonUp</code> が来るのを待ってしまうため、もう一度ジャンプキーを押さないとジャンプ出来ません。</p>

<p>なので、押されている間trueになり、離されたらfalseになる <code>GetButton</code> のほうがここでは都合が良かったです。</p>

<h2>
<span id="状態管理" class="fragment"></span><a href="#%E7%8A%B6%E6%85%8B%E7%AE%A1%E7%90%86"><i class="fa fa-link"></i></a>状態管理</h2>

<p>こういった特定の状態から条件によって行うべき内容が変化して次へ次へと移行していく形式のものは、バグが紛れ込みやすくなるのでその扱いには気をつけないといけません。</p>

<p>一番単純な構造としては</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">JumpState.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">enum</span> <span class="n">JumpState</span> <span class="p">{</span>
    <span class="n">IDLE</span><span class="p">,</span>    <span class="c1">// 入力待ち状態</span>
    <span class="n">WAITING</span><span class="p">,</span>    <span class="c1">// ジャンプ溜め状態</span>
    <span class="n">RISING</span><span class="p">,</span>    <span class="c1">// 上昇中状態</span>
    <span class="n">FALLING</span><span class="p">,</span>    <span class="c1">// 下降中状態</span>
    <span class="n">LANDING</span><span class="p">,</span>    <span class="c1">// 着地状態</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>と状態を定義し、遷移条件判定や各状態の内容処理の場合にそれぞれでswitchをかける</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">ng_code.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">switch</span><span class="p">(</span><span class="n">jump_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">IDLE</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">WAITING</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">RISING</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">FALLING</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">LANDING</span><span class="p">:</span> <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>というものがありますが、同じswitch文が各所に出現したり、どこで何の処理をしているのか分かりづらくなるなど問題が多く、この形の処理は出来る限り避けた方が懸命です。</p>

<p>ではどうするのかと言うと、前回までに書いてきた既存のコードは捨てて、一から定義し直すことになります。<br>
ここまで来て書き直しとかめんどいやりたくない・・・と思うかもしれませんが、時間がかかっても最も正攻法なやり方をとるのが実は一番近道だと知っているのがプログラマですので、ここは我慢してゼロベースで考え直します。（と自分に言い聞かせている）</p>

<p>とはいえ、外側の管理構造は変えますが、詳細な処理部分については流用が効く部分も多いので、本当に完全にゼロからというわけではありません。<br>
ここまで作ってきた内容が無駄になるわけではありません。（と自分に言い聞かせている）</p>

<p>さて、<code>switch</code> するのは良くないので、じゃあどうするかと言うと、各状態をクラスとして実装し <code>Dictionary</code> に置いておき、状態が変わるごとに必要なクラスを取り出して使う、という方法があります。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">maybe_better_code.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">JumpState</span><span class="p">,</span> <span class="n">IJumpState</span><span class="p">&gt;</span> <span class="n">_jump_state_list</span><span class="p">;</span>

<span class="n">JumpState</span> <span class="n">_state_old</span><span class="p">;</span>

<span class="n">IJumpState</span> <span class="n">_state_instance</span><span class="p">;</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="n">_state_instance</span><span class="p">.</span><span class="nf">stayUpdate</span><span class="p">();</span>    <span class="c1">// 状態を更新</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="p">==</span> <span class="n">_state_old</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>    <span class="c1">// 変更があるまで現在の状態を維持</span>

    <span class="n">_state_instance</span><span class="p">.</span><span class="nf">exit</span><span class="p">();</span>    <span class="c1">// 状態終了時の処理（今回は使わないかも）</span>
    <span class="n">_state_instance</span> <span class="p">=</span> <span class="n">_jump_state_list</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>    <span class="c1">// 遷移後の状態に切り替え</span>
    <span class="n">_state_instance</span><span class="p">.</span><span class="nf">enter</span><span class="p">();</span>    <span class="c1">// 状態開始時の処理</span>
    <span class="n">_state_old</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>    <span class="c1">// 切り替え判定用に前フレームの状態を保持</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>使わないのはswitchの分岐処理だけなので、JumpStateはさっきのEnumがそのまま使えます。<br>
<code>Start()</code> や <code>FixedUpdate()</code> でも処理が必要ですが、基本構造はこれで回せるはずです。</p>

<p>これを実現するために、</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">IJumpState.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">interface</span> <span class="nc">IJumpState</span> <span class="p">{</span>
    <span class="n">JumpState</span> <span class="nf">stay_update</span><span class="p">();</span>    <span class="c1">// 状態に留まっている間Updateで実行される</span>
    <span class="k">void</span> <span class="nf">stay_fixed_update</span><span class="p">();</span>    <span class="c1">// 状態に留まっている間FixedUpdateで実行される</span>
    <span class="k">void</span> <span class="nf">enter</span><span class="p">();</span>    <span class="c1">// 状態に遷移してきた時に一度だけ実行される</span>
    <span class="k">void</span> <span class="nf">exit</span><span class="p">();</span>    <span class="c1">// 状態から遷移していく時に一度だけ実行される</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>というインターフェイスを用意します。</p>

<p>これは各状態を実装する際の基盤とするもので、インターフェイスを継承したクラスはインターフェイスにあるメソッドを全て実装しなければなりません。<br>
管理クラスから見ると、このインターフェイスを継承しているクラスにはこれらのメソッドが実装されていることが保証される事になります。</p>

<p>各状態の処理をそれぞれのクラスに記述し、上位の管理クラスでは各クラスの保持とどのクラスの処理を実行するのかだけを管理するようにします。</p>

<h3>
<span id="jumpstateidle" class="fragment"></span><a href="#jumpstateidle"><i class="fa fa-link"></i></a>JumpStateIdle</h3>

<p>入力待ちのアイドル状態を管理します。<br>
ジャンプキー入力開始（key down）でジャンプ溜め状態に移行します。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">JumpStateIdle.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">JumpState</span> <span class="p">=</span> <span class="n">animJump</span><span class="p">.</span><span class="n">JumpState</span><span class="p">;</span>    <span class="c1">// UniRxのJumpStateと命名が被ってしまっているので、UniRxが入っている場合に必要です。</span>

<span class="k">namespace</span> <span class="nn">animJump</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">JumpStateIdle</span> <span class="p">:</span> <span class="n">IJumpState</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">Animator</span> <span class="n">_animator</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="n">_anim_name</span> <span class="p">=</span> <span class="s">"Idle"</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">JumpStateIdle</span><span class="p">(</span><span class="n">Animator</span> <span class="n">animator</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_animator</span> <span class="p">=</span> <span class="n">animator</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">JumpState</span> <span class="nf">stayUpdate</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_animator</span><span class="p">.</span><span class="nf">isName</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">Input</span><span class="p">.</span><span class="nf">GetButton</span><span class="p">(</span><span class="s">"Jump"</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">WAITING</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">IDLE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">enter</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">_animator</span><span class="p">.</span><span class="nf">animationStart</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">stayFixedUpdate</span><span class="p">()</span> <span class="p">{}</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">exit</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>本来の <code>Animator</code> には <code>animationStart</code> というメソッドはありませんが、C#の拡張メソッド機能を使って追加してあります。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">AnimatorExtensions.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">AnimatorExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">radioBool</span><span class="p">(</span><span class="k">this</span> <span class="n">Animator</span> <span class="n">anim</span><span class="p">,</span> <span class="kt">string</span> <span class="k">on</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">param</span> <span class="k">in</span> <span class="n">anim</span><span class="p">.</span><span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">type</span> <span class="p">!=</span> <span class="n">AnimatorControllerParameterType</span><span class="p">.</span><span class="n">Bool</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
            <span class="n">anim</span><span class="p">.</span><span class="nf">SetBool</span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">name</span> <span class="p">==</span> <span class="k">on</span><span class="p">)</span> <span class="p">?</span> <span class="k">true</span> <span class="p">:</span> <span class="k">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">animationStart</span><span class="p">(</span><span class="k">this</span> <span class="n">Animator</span> <span class="n">anim</span><span class="p">,</span> <span class="kt">string</span> <span class="n">anim_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">layer_no</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">anim</span><span class="p">.</span><span class="nf">radioBool</span><span class="p">(</span><span class="n">anim_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">isName</span><span class="p">(</span><span class="k">this</span> <span class="n">Animator</span> <span class="n">anim</span><span class="p">,</span> <span class="kt">string</span> <span class="n">anim_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">layer_no</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">state_info</span> <span class="p">=</span> <span class="n">anim</span><span class="p">.</span><span class="nf">GetCurrentAnimatorStateInfo</span><span class="p">(</span><span class="n">layer_no</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">state_info</span><span class="p">.</span><span class="nf">IsName</span><span class="p">(</span><span class="n">anim_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">animationEnd</span><span class="p">(</span><span class="k">this</span> <span class="n">Animator</span> <span class="n">anim</span><span class="p">,</span> <span class="kt">string</span> <span class="n">anim_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">layer_no</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">state_info</span> <span class="p">=</span> <span class="n">anim</span><span class="p">.</span><span class="nf">GetCurrentAnimatorStateInfo</span><span class="p">(</span><span class="n">layer_no</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">state_info</span><span class="p">.</span><span class="nf">IsName</span><span class="p">(</span><span class="n">anim_name</span><span class="p">))</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state_info</span><span class="p">.</span><span class="n">normalizedTime</span> <span class="p">&lt;</span> <span class="m">1f</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</div>

<p><code>animationStart</code> 自体は一緒に追加した <code>radioBool</code> の呼び出しのみで、<code>radioBool</code> メソッドは引数で指定したBoolパラメータのみをtrueとし、他のBoolパラメータはすべてfalseに落とすメソッドです。</p>

<p>同時に追加している <code>isName</code> は、現在進行中のアニメーションが指定したアニメーションかどうかを判定し、<code>animationEnd</code> は、アニメーションが終了したかどうかを判定するメソッドです。<br>
後で使います。</p>

<h3>
<span id="jumpstatewaiting" class="fragment"></span><a href="#jumpstatewaiting"><i class="fa fa-link"></i></a>JumpStateWaiting</h3>

<p>ジャンプ溜め中の状態を管理します。<br>
ジャンプキーが離されたら（key up）上昇中状態に移行します。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">JumpStateWaiting.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">JumpState</span> <span class="p">=</span> <span class="n">animJump</span><span class="p">.</span><span class="n">JumpState</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">animJump</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">JumpStateWaiting</span> <span class="p">:</span> <span class="n">IJumpState</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">Animator</span> <span class="n">_animator</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">JumpData</span> <span class="n">_jump_data</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="n">_anim_name</span> <span class="p">=</span> <span class="s">"Waiting"</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">JumpStateWaiting</span><span class="p">(</span><span class="n">Animator</span> <span class="n">animator</span><span class="p">,</span> <span class="n">JumpData</span> <span class="n">jump_data</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_animator</span> <span class="p">=</span> <span class="n">animator</span><span class="p">;</span>
            <span class="n">_jump_data</span> <span class="p">=</span> <span class="n">jump_data</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">JumpState</span> <span class="nf">stayUpdate</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">_jump_data</span><span class="p">.</span><span class="nf">power_up</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">_animator</span><span class="p">.</span><span class="nf">isName</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">Input</span><span class="p">.</span><span class="nf">GetButton</span><span class="p">(</span><span class="s">"Jump"</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">RISING</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">WAITING</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">enter</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">_animator</span><span class="p">.</span><span class="nf">animationStart</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">stayFixedUpdate</span><span class="p">()</span> <span class="p">{}</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">exit</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>ジャンプキーを押している長さの分だけジャンプパワーを溜めますが、溜めるのはWaitingで使うのがRisingで、別クラスでの操作になるため、横串でデータのやり取りをするためのクラス <code>JumpData</code> を追加しました。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">JumpData.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">animJump</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">JumpData</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="kt">float</span> <span class="n">_power</span><span class="p">;</span>

        <span class="k">public</span> <span class="kt">float</span> <span class="n">power</span> <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_power</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">float</span> <span class="n">_power_default</span> <span class="p">=</span> <span class="m">5f</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">float</span> <span class="n">_power_up</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">float</span> <span class="n">_power_max</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">JumpData</span><span class="p">(</span><span class="kt">float</span> <span class="n">up</span><span class="p">,</span> <span class="kt">float</span> <span class="n">max</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_power_up</span> <span class="p">=</span> <span class="n">up</span><span class="p">;</span>
            <span class="n">_power_max</span> <span class="p">=</span> <span class="n">max</span><span class="p">;</span>
            <span class="nf">power_reset</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">power_up</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_power_max</span> <span class="p">&lt;=</span> <span class="n">_power</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="n">_power</span> <span class="p">+=</span> <span class="n">_power_up</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">power_reset</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_power</span> <span class="p">=</span> <span class="n">_power_default</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>毎フレーム毎に溜めるパワーの値と、溜められるパワーの上限を外部から与えられるようにしてあります。<br>
管理クラスを通してInspectorで設定できるようにするとUnity的な使い方が出来ます。</p>

<h3>
<span id="jumpstaterising" class="fragment"></span><a href="#jumpstaterising"><i class="fa fa-link"></i></a>JumpStateRising</h3>

<p>上昇中の状態を管理します。<br>
初回のFixedUpdate()で、Rigidbody.AddForceを使って上方へのジャンプを行います。<br>
また、ジャンプの頂点を過ぎて下降を開始したら下降中の状態へ移行します。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">JumpStateRising.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">JumpState</span> <span class="p">=</span> <span class="n">animJump</span><span class="p">.</span><span class="n">JumpState</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">animJump</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">JumpStateRising</span> <span class="p">:</span> <span class="n">IJumpState</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">Animator</span> <span class="n">_animator</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">JumpData</span> <span class="n">_jump_data</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">JumpDistance</span> <span class="n">_jump_distance</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">Rigidbody</span> <span class="n">_rigid_body</span><span class="p">;</span>

        <span class="k">private</span> <span class="kt">bool</span> <span class="n">_allow_add_force</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="n">_anim_name</span> <span class="p">=</span> <span class="s">"Rising"</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">JumpStateRising</span><span class="p">(</span><span class="n">Animator</span> <span class="n">animator</span><span class="p">,</span> <span class="n">JumpData</span> <span class="n">jump_data</span><span class="p">,</span>
                <span class="n">JumpDistance</span> <span class="n">jump_distance</span><span class="p">,</span> <span class="n">Rigidbody</span> <span class="n">rigid_body</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_animator</span> <span class="p">=</span> <span class="n">animator</span><span class="p">;</span>
            <span class="n">_jump_data</span> <span class="p">=</span> <span class="n">jump_data</span><span class="p">;</span>
            <span class="n">_jump_distance</span> <span class="p">=</span> <span class="n">jump_distance</span><span class="p">;</span>
            <span class="n">_rigid_body</span> <span class="p">=</span> <span class="n">rigid_body</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">JumpState</span> <span class="nf">stayUpdate</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_animator</span><span class="p">.</span><span class="nf">isName</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">_jump_distance</span><span class="p">.</span><span class="nf">isFalling</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">_allow_add_force</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="n">_jump_data</span><span class="p">.</span><span class="nf">power_reset</span><span class="p">();</span>
                <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">FALLING</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">RISING</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">enter</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">_animator</span><span class="p">.</span><span class="nf">animationStart</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">stayFixedUpdate</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_allow_add_force</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="n">_allow_add_force</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

            <span class="n">_rigid_body</span><span class="p">.</span><span class="nf">AddForce</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">up</span> <span class="p">*</span> <span class="n">_jump_data</span><span class="p">.</span><span class="n">power</span><span class="p">,</span> <span class="n">ForceMode</span><span class="p">.</span><span class="n">Impulse</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">exit</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>ジャンプが下降に移る際の判定のために、新しく <code>JumpDistance</code> クラスを追加しました。<br>
各状態がキャラと地面との細かい距離を知って判定する必要は無いので、判定処理を丸ごと任せて結果だけを貰います。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">JumpDistance.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">animJump</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">JumpDistance</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="kt">float</span> <span class="n">_distance</span><span class="p">;</span>

        <span class="k">public</span> <span class="kt">float</span> <span class="n">distance</span> <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_distance</span><span class="p">;</span> <span class="p">}</span>

            <span class="k">set</span> <span class="p">{</span>
                <span class="n">_distance</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>

                <span class="kt">float</span> <span class="n">old_distance</span> <span class="p">=</span>  <span class="p">(</span><span class="m">0</span> <span class="p">&lt;</span> <span class="n">_old_distance_list</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span> <span class="p">?</span>
                    <span class="n">_old_distance_list</span><span class="p">.</span><span class="nf">Last</span><span class="p">()</span> <span class="p">:</span>
                    <span class="k">value</span><span class="p">;</span>

                <span class="n">_old_distance_diff_list</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="k">value</span> <span class="p">-</span> <span class="n">old_distance</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">_distance_list_limit</span> <span class="p">&lt;</span> <span class="n">_old_distance_diff_list</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">_old_distance_diff_list</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="n">_old_distance_list</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">_distance_list_limit</span> <span class="p">&lt;</span> <span class="n">_old_distance_list</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">_old_distance_list</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">&gt;</span> <span class="n">_old_distance_diff_list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">&gt;();</span>
        <span class="k">private</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">&gt;</span> <span class="n">_old_distance_list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="kt">float</span><span class="p">&gt;();</span>

        <span class="k">private</span> <span class="kt">int</span> <span class="n">_distance_list_limit</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">float</span> <span class="n">_ground_distance_limit</span> <span class="p">=</span> <span class="m">0.01f</span><span class="p">;</span>

        <span class="k">private</span> <span class="n">Vector3</span> <span class="n">_raycastOffset</span>  <span class="p">=</span> <span class="k">new</span> <span class="nf">Vector3</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">0.005f</span><span class="p">,</span> <span class="m">0f</span><span class="p">);</span>
        <span class="k">private</span> <span class="kt">float</span> <span class="n">_raycastSearchDistance</span> <span class="p">=</span> <span class="m">100f</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">Transform</span> <span class="n">_transform</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">JumpDistance</span><span class="p">(</span><span class="n">Transform</span> <span class="n">transform</span><span class="p">,</span>
                <span class="kt">int</span> <span class="n">distance_list_limit</span><span class="p">,</span>
                <span class="kt">float</span> <span class="n">ground_distance_limit</span><span class="p">,</span>
                <span class="kt">float</span> <span class="n">raycastSearchDistance</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_transform</span> <span class="p">=</span> <span class="n">transform</span><span class="p">;</span>
            <span class="n">_distance_list_limit</span> <span class="p">=</span> <span class="n">distance_list_limit</span><span class="p">;</span>
            <span class="n">_ground_distance_limit</span> <span class="p">=</span> <span class="n">ground_distance_limit</span><span class="p">;</span>
            <span class="n">_raycastSearchDistance</span> <span class="p">=</span> <span class="n">raycastSearchDistance</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">isFalling</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">check</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_old_distance_diff_list</span><span class="p">.</span><span class="nf">Average</span><span class="p">()</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">isLanding</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">check</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_old_distance_list</span><span class="p">.</span><span class="nf">Average</span><span class="p">()</span> <span class="p">&lt;</span> <span class="n">_ground_distance_limit</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">check</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">RaycastHit</span> <span class="n">hit</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">layerMask</span> <span class="p">=</span> <span class="n">LayerMask</span><span class="p">.</span><span class="nf">GetMask</span><span class="p">(</span><span class="s">"Ground"</span><span class="p">);</span>

            <span class="c1">// プレイヤーの位置から下向きにRaycast</span>
            <span class="c1">// レイヤーマスクでGroundを設定しているので、</span>
            <span class="c1">// 地面のGameObjectにGroundのレイヤーを設定しておけば、</span>
            <span class="c1">// Groundのレイヤーを持つGameObjectで一番近いものが一つだけヒットする</span>
            <span class="kt">var</span> <span class="n">isGroundHit</span> <span class="p">=</span> <span class="n">Physics</span><span class="p">.</span><span class="nf">Raycast</span><span class="p">(</span>
                    <span class="n">_transform</span><span class="p">.</span><span class="n">position</span> <span class="p">+</span> <span class="n">_raycastOffset</span><span class="p">,</span>
                    <span class="n">_transform</span><span class="p">.</span><span class="nf">TransformDirection</span><span class="p">(</span><span class="n">Vector3</span><span class="p">.</span><span class="n">down</span><span class="p">),</span>
                    <span class="k">out</span> <span class="n">hit</span><span class="p">,</span>
                    <span class="n">_raycastSearchDistance</span><span class="p">,</span>
                    <span class="n">layerMask</span>
                <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">isGroundHit</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">distance</span> <span class="p">=</span> <span class="n">hit</span><span class="p">.</span><span class="n">distance</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// ヒットしなかった場合はキャラの下方に地面が存在しないものとして扱う</span>
                <span class="n">distance</span> <span class="p">=</span> <span class="kt">float</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><code>isFalling</code> は上昇中に、<code>isLanding</code> は下降中に毎フレーム呼ばれるので、<code>check</code> メソッドをここで呼ぶようにし、接地中はraycastの判定をしないようにしています。</p>

<p>より負荷を軽減するなら、2フレームか3フレームに1回だけ <code>check</code> するような形にしても、動作上はそこまで影響はないかと思います。<br>
1点気をつけるとすれば、実は今回の処理では <code>isLanding</code> の設定判定に使っている <code>_ground_distance_limit</code> の値を、ちょっと遠目にしています。<br>
接地前からアニメーションを開始しておくことで、アニメーション上の着地と実際の着地が近いタイミングになるようにしているので、フレームを飛ばすならそこは再調整が必要になりそうです。</p>

<p>また、今回は完全にジャンプ処理だけに注目しているコードなので <code>isFalling</code> 、<code>isLanding</code> の中で <code>check</code> するようにしましたが、実際に3Dゲームで使う際に、ジャンプではなく段差を降りるなどで下降モーションを起こしたい場合、ジャンプ中しか距離計測していないのではアクションが起こせないので、そういう場合も再検討が必要だと考えられます。</p>

<h3>
<span id="jumpstatefalling" class="fragment"></span><a href="#jumpstatefalling"><i class="fa fa-link"></i></a>JumpStateFalling</h3>

<p>下降中の状態を管理します。<br>
着地したら着地状態へ移行します。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">JumpStateFalling.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">JumpState</span> <span class="p">=</span> <span class="n">animJump</span><span class="p">.</span><span class="n">JumpState</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">animJump</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">JumpStateFalling</span> <span class="p">:</span> <span class="n">IJumpState</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">Animator</span> <span class="n">_animator</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">JumpDistance</span> <span class="n">_jump_distance</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="n">_anim_name</span> <span class="p">=</span> <span class="s">"Falling"</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">JumpStateFalling</span><span class="p">(</span><span class="n">Animator</span> <span class="n">animator</span><span class="p">,</span> <span class="n">JumpDistance</span> <span class="n">jump_distance</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_animator</span> <span class="p">=</span> <span class="n">animator</span><span class="p">;</span>
            <span class="n">_jump_distance</span> <span class="p">=</span> <span class="n">jump_distance</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">JumpState</span> <span class="nf">stayUpdate</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_animator</span><span class="p">.</span><span class="nf">isName</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">_jump_distance</span><span class="p">.</span><span class="nf">isLanding</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">LANDING</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">FALLING</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">enter</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">_animator</span><span class="p">.</span><span class="nf">animationStart</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">stayFixedUpdate</span><span class="p">()</span> <span class="p">{}</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">exit</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h3>
<span id="jumpstatelanding" class="fragment"></span><a href="#jumpstatelanding"><i class="fa fa-link"></i></a>JumpStateLanding</h3>

<p>着地の状態を管理します。<br>
着地モーションが完了したらアイドル状態へ移行します。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">JumpStateLanding.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UniRx</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">JumpState</span> <span class="p">=</span> <span class="n">animJump</span><span class="p">.</span><span class="n">JumpState</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">animJump</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">JumpStateLanding</span> <span class="p">:</span> <span class="n">IJumpState</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">Animator</span> <span class="n">_animator</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">string</span> <span class="n">_anim_name</span> <span class="p">=</span> <span class="s">"Landing"</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">JumpStateLanding</span><span class="p">(</span><span class="n">Animator</span> <span class="n">animator</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_animator</span> <span class="p">=</span> <span class="n">animator</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">JumpState</span> <span class="nf">stayUpdate</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_animator</span><span class="p">.</span><span class="nf">animationEnd</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">IDLE</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">LANDING</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">enter</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">_animator</span><span class="p">.</span><span class="nf">animationStart</span><span class="p">(</span><span class="n">_anim_name</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">stayFixedUpdate</span><span class="p">()</span> <span class="p">{}</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">exit</span><span class="p">()</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><code>animationEnd</code> は、<code>animationStart</code> と一緒に追加した拡張メソッドで、再生中のアニメーションが終了したかどうかをbool値で返してくれます。<br>
また <code>isName</code> と同等の処理を <code>animationEnd</code> の中で行っているため、ここでは不要です。</p>

<h3>
<span id="管理クラス" class="fragment"></span><a href="#%E7%AE%A1%E7%90%86%E3%82%AF%E3%83%A9%E3%82%B9"><i class="fa fa-link"></i></a>管理クラス</h3>

<p>各状態を管理するクラスを作ってきたので、最後は状態の変遷を管理するクラスを作成します。</p>

<div class="code-frame" data-lang="cs">
<div class="code-lang"><span class="bold">PlayerStateController.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">animJump</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">JumpState</span> <span class="p">=</span> <span class="n">animJump</span><span class="p">.</span><span class="n">JumpState</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PlayerStateController</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    ジャンプ処理に使用するRigidbody</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="k">private</span> <span class="n">Rigidbody</span> <span class="n">_rigidBody</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    ジャンプアニメーションを担当するAnimator</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="k">private</span> <span class="n">Animator</span> <span class="n">_animator</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    ジャンプの各状態を保持しておく辞書リスト</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">JumpState</span><span class="p">,</span> <span class="n">IJumpState</span><span class="p">&gt;</span> <span class="n">_jump_state_list</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    ジャンプの以前の状態を記憶しておく</span>
    <span class="c1">///    これと比較することで状態の変更を識別する</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="k">private</span> <span class="n">JumpState</span> <span class="n">_state_old</span> <span class="p">=</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">IDLE</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    現在のジャンプの状態を保持</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="k">private</span> <span class="n">IJumpState</span> <span class="n">_state_instance</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    ジャンプ力に関する情報を保持</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="k">private</span> <span class="n">JumpData</span> <span class="n">_jump_data</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    プレイヤーキャラクターと地面間の距離に関する情報を保持</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="k">private</span> <span class="n">JumpDistance</span> <span class="n">_jump_distance</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    キーを押している間に溜めるジャンプ力の1フレーム分</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">_jump_power_up</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    ジャンプ力の上限</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">_jump_power_max</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    上昇中から下降中に切り替わる変化の検知精度</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="kt">int</span> <span class="n">distance_list_limit</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    下降中から接地したと判定する距離</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span> <span class="kt">float</span> <span class="n">ground_distance_limit</span><span class="p">;</span>

    <span class="c1">///&lt;summary&gt;</span>
    <span class="c1">///    プレイヤーキャラクターと地面間の計測距離上限</span>
    <span class="c1">///    最高高度より高い値でないと、ジャンプ頂点での下降モーションへの切り替わりが出来ません</span>
    <span class="c1">///&lt;/summary&gt;</span>
    <span class="p">[</span><span class="n">SerializeField</span><span class="p">]</span><span class="kt">float</span> <span class="n">raycastSearchDistance</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_rigidBody</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Rigidbody</span><span class="p">&gt;();</span>
        <span class="n">_animator</span> <span class="p">=</span> <span class="n">GetComponent</span><span class="p">&lt;</span><span class="n">Animator</span><span class="p">&gt;();</span>
        <span class="n">_jump_data</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">JumpData</span><span class="p">(</span><span class="n">_jump_power_up</span><span class="p">,</span> <span class="n">_jump_power_max</span><span class="p">);</span>

        <span class="n">_jump_distance</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">JumpDistance</span><span class="p">(</span>
            <span class="n">transform</span><span class="p">,</span>
            <span class="n">distance_list_limit</span><span class="p">,</span>
            <span class="n">ground_distance_limit</span><span class="p">,</span>
            <span class="n">raycastSearchDistance</span>
        <span class="p">);</span>

        <span class="n">_jump_state_list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">JumpState</span><span class="p">,</span> <span class="n">IJumpState</span><span class="p">&gt;</span> <span class="p">{</span>
            <span class="p">{</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">IDLE</span><span class="p">,</span> <span class="k">new</span> <span class="nf">JumpStateIdle</span><span class="p">(</span><span class="n">_animator</span><span class="p">)</span> <span class="p">},</span>
            <span class="p">{</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">WAITING</span><span class="p">,</span> <span class="k">new</span> <span class="nf">JumpStateWaiting</span><span class="p">(</span><span class="n">_animator</span><span class="p">,</span> <span class="n">_jump_data</span><span class="p">)</span> <span class="p">},</span>
            <span class="p">{</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">RISING</span><span class="p">,</span> <span class="k">new</span> <span class="nf">JumpStateRising</span><span class="p">(</span><span class="n">_animator</span><span class="p">,</span> <span class="n">_jump_data</span><span class="p">,</span> <span class="n">_jump_distance</span><span class="p">,</span> <span class="n">_rigidBody</span><span class="p">)</span> <span class="p">},</span>
            <span class="p">{</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">FALLING</span><span class="p">,</span> <span class="k">new</span> <span class="nf">JumpStateFalling</span><span class="p">(</span><span class="n">_animator</span><span class="p">,</span> <span class="n">_jump_distance</span><span class="p">)</span> <span class="p">},</span>
            <span class="p">{</span> <span class="n">JumpState</span><span class="p">.</span><span class="n">LANDING</span><span class="p">,</span> <span class="k">new</span> <span class="nf">JumpStateLanding</span><span class="p">(</span><span class="n">_animator</span><span class="p">)</span> <span class="p">},</span>
        <span class="p">};</span>

        <span class="n">_state_instance</span> <span class="p">=</span> <span class="n">_jump_state_list</span><span class="p">[</span><span class="n">JumpState</span><span class="p">.</span><span class="n">IDLE</span><span class="p">];</span>
        <span class="n">_state_instance</span><span class="p">.</span><span class="nf">enter</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="n">_state_instance</span><span class="p">.</span><span class="nf">stayUpdate</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="p">==</span> <span class="n">_state_old</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="n">_state_instance</span><span class="p">.</span><span class="nf">exit</span><span class="p">();</span>
        <span class="n">_state_instance</span> <span class="p">=</span> <span class="n">_jump_state_list</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
        <span class="n">_state_instance</span><span class="p">.</span><span class="nf">enter</span><span class="p">();</span>
        <span class="n">_state_old</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">FixedUpdate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_state_instance</span><span class="p">.</span><span class="nf">stayFixedUpdate</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>基本構造は記事の最初の方で出てきた状態管理のものそのままです。</p>

<p>初期化処理では、 <code>JumpData</code> と <code>JumpDistance</code> を生成し、情報が必要な状態にだけ渡しています。<br>
それから状態とクラスのリストを作成し、最初の状態 <code>JumpState.IDLE</code> を設定、開始しています。</p>

<p><code>FixedUpdate</code> では、各状態の <code>stayFixedUpdate</code> を呼び出していますが、今回処理が行われているのは <code>JumpStateRising</code> だけです。<br>
空メソッドの呼び出しだけならそこまで高コストにはならないので恐らく許容範囲と思いますが、必要であれば特定の状態のときだけ <code>stayFixedUpdate</code> を呼び出すような形にすることも考えられます。</p>

<p>UnityちゃんにAttachするのは、このPlayerStateControllerだけです。<br>
<a href="https://camo.qiitausercontent.com/78fcd202efdafa96c2d3073ee6ff21f2aefdef4c/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383036332d66326438373838302d646231312d313165382d383765662d3130333739353637653538612e6a7067" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618063-f2d87880-db11-11e8-87ef-10379567e58a.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5751b5d436f2ff49bceb8ebd5075ad53" alt="11" data-canonical-src="https://user-images.githubusercontent.com/8291395/47618063-f2d87880-db11-11e8-87ef-10379567e58a.jpg" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618063-f2d87880-db11-11e8-87ef-10379567e58a.jpg?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=fd2e2cc7054387981f051b073662dd8e 1x" loading="lazy"></a></p>

<h1>
<span id="動かす" class="fragment"></span><a href="#%E5%8B%95%E3%81%8B%E3%81%99"><i class="fa fa-link"></i></a>動かす</h1>

<p><a href="https://camo.qiitausercontent.com/fd07f4149d52f58c2ce25f4d495ec2302aa7d17f/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383032352d37353134366430302d646231312d313165382d383466622d6433336361616231333335382e676966" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618025-75146d00-db11-11e8-84fb-d33caab13358.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7319d2baf3f16f9e0e5105814f467b56" alt="capture_20181028_234041" data-canonical-src="https://user-images.githubusercontent.com/8291395/47618025-75146d00-db11-11e8-84fb-d33caab13358.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618025-75146d00-db11-11e8-84fb-d33caab13358.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=170955486de0e39814dd7a364c831c7b 1x" loading="lazy"></a></p>

<p>スペースキーを押すとジャンプ待機、離すとジャンプし、待機時間でジャンプの強さが変わります。</p>

<h1>
<span id="あとがき" class="fragment"></span><a href="#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D"><i class="fa fa-link"></i></a>あとがき</h1>

<p>アニメーションを分割してコードから操作するようにしたら、タイミング調整とか、今回はやってませんが途中でアニメーションを入れ替えたりとかも出来るのでめっちゃ便利になりますよね！っていう記事を3回に分けて書いてきたのですが、最終的に辿り着いたのは「状態管理って難しいしめんどくさいよね」でした。</p>

<p>内容的には初心者はクリアした初級者向けあたりになるのかな？と疑問に思いつつ、意図的にUniRxの記述を避けてきたのですが、外部の誰かがジャンプの状態を知りたい状況でなければ使うメリットがそれほど無いのではと思っています。</p>

<p>あるいは現在の状態をReactivePropertyにして、状態が切り替わったらアニメーションを切り替える形なら、現在の「状態がアニメーションを管理する」のではなく、「状態の変更条件のチェック」と「アニメーションの管理」を切り離すことは出来るかもしれません。</p>

<p>もしくは、ジャンプキー入力やraycastで取っている地面との距離をReactivePropertyにすれば、必要なタイミングを教えてくれるように出来て、メソッドに起こさなくてもラムダでその時その時の処理を書けば良いだけに出来るかもしれませんね。<br>
もっとコンパクトでスマートなコードになるのなら検討する価値は大いにありそうです。（手のひらクルーが速い）</p>

<p>Rxもオブジェクト指向もDDDも、すべては関心の分離のために行われている気がしてきているので、そっちの方向でプログラミング出来るならより良いコードになりそうです。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fmkgask%2Fitems%2Ffa307811da6d9d76bc97&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fmkgask%2Fitems%2Ffa307811da6d9d76bc97&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/mkgask/items/fa307811da6d9d76bc97/likers" class="css-1iupg5d">9</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">8</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/fa307811da6d9d76bc97/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/mkgask/items/fa307811da6d9d76bc97/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/mkgask/items/fa307811da6d9d76bc97/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/mkgask/items/fa307811da6d9d76bc97/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/mkgask/items/fa307811da6d9d76bc97.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-c3a8dbf1-1001-432b-8c33-4ae025f9fdb0">{"authorAnalyticsTrackingId":"UA-80285705-1","organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-9ed6ce67-ff0a-4211-95c0-70c2666eae21"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-9ed6ce67-ff0a-4211-95c0-70c2666eae21">{}</script>
      
<div id="LoginModal-react-component-4f7c9061-bed9-4cbe-b26c-5aef84ff935a"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-4f7c9061-bed9-4cbe-b26c-5aef84ff935a">{}</script>
      
<div id="StockModal-react-component-1f5d4daa-79ad-4364-ae70-d56a015e650a"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-1f5d4daa-79ad-4364-ae70-d56a015e650a">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;JOxV59IDmncDt1Gj+OEaKxzW8+ev+FCjCjm1+A9IL1smdHfPRu6olYvgQKQa5VsW5s1GqzvgZc5nnJ3Yk+GAug==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/mkgask/items/6d04d0be13cc0b14d4fb\" id=\"reference-dcb87ac3b1f0cbfa4c97\"\u003eUnity 3DでUpdateとFixedUpdate間のタイミングを考慮したジャンプ（基礎）\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/mkgask/items/e660fc802b2ec994fb5f\" id=\"reference-79f332d8e30555f0bd7c\"\u003eUnity 3Dでアニメーションを考慮したジャンプ その1（単アニメーション）\u003c/a\u003e\u003cbr\u003e\nの続きです。\u003c/p\u003e\n\n\u003cp\u003e上記記事で設定したジャンプアニメーションをベースに改良していきます。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"想定環境\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%83%B3%E5%AE%9A%E7%92%B0%E5%A2%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e想定環境\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eWindows 10\u003c/li\u003e\n\u003cli\u003eUnity 2018.2.14f1\u003c/li\u003e\n\u003cli\u003eプレイヤーキャラクターに \u003ca href=\"http://unity-chan.com/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eUnity Technologies Japanオリジナルキャラクター Unityちゃん\u003c/a\u003e を利用\u003c/li\u003e\n\u003cli\u003e素のUnityで実行できるコードになっています\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"アニメーション分割\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%86%E5%89%B2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eアニメーション分割\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/mkgask/items/e660fc802b2ec994fb5f\"\u003e前回記事\u003c/a\u003e にて確認した通り、単アニメーションでのジャンプはジャンプの挙動が様々に変化するゲームには向いていません。\u003c/p\u003e\n\n\u003cp\u003eなので、ジャンプの内容が変わってもきちんと対応出来るように変更します。\u003c/p\u003e\n\n\u003cp\u003eアニメーションを分割し、アニメーション間の遷移をAnimatorとコードを使って行うことで、遷移のタイミングをずらしたり、遷移先のアニメーションを動的に変更できるようになります。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"どこからするの\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%A9%E3%81%93%E3%81%8B%E3%82%89%E3%81%99%E3%82%8B%E3%81%AE\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eどこからするの\u003c/h2\u003e\n\n\u003cp\u003eアニメーションを持っているfbxファイルを選択するとInspectorに表示される、\u003ccode\u003eAnimation\u003c/code\u003e から分割することが出来ます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/cc91ee4076e750f5bade0e0cdb8605ac22917b8f/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373936372d61386132633738302d646231302d313165382d383430342d6661303333633839306364632e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617967-a8a2c780-db10-11e8-8404-fa033c890cdc.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5579c493afbcf6254578145f76eadebb\" alt=\"01\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47617967-a8a2c780-db10-11e8-8404-fa033c890cdc.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617967-a8a2c780-db10-11e8-8404-fa033c890cdc.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=0ba1eb7a5b7dc9daf5e7c5e1a687e06a 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eClipsの欄の右下にある＋ボタンを押すことで、アニメーションを追加することが出来ます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/b1fd656d5d6e07ddecdd81415062a8ad58ad5d6f/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373937342d62326334633630302d646231302d313165382d383665622d6162656234323235666537342e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617974-b2c4c600-db10-11e8-86eb-abeb4225fe74.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=ccc3977be2fa0ea2d4cab820fc280b80\" alt=\"02\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47617974-b2c4c600-db10-11e8-86eb-abeb4225fe74.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617974-b2c4c600-db10-11e8-86eb-abeb4225fe74.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=a198bfad0f417aa17f83d1f361db5085 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/90bcb01de289ea0e7c8835386f233f16c438bc67/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373937392d62626235393738302d646231302d313165382d383838632d3964313636626265346435302e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617979-bbb59780-db10-11e8-888c-9d166bbe4d50.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=1d8cb51647a77f476a6198d31d713317\" alt=\"03\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47617979-bbb59780-db10-11e8-888c-9d166bbe4d50.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617979-bbb59780-db10-11e8-888c-9d166bbe4d50.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=eef0fa92210e0e38e9dda7946804d922 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"どうやってするの\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E3%81%99%E3%82%8B%E3%81%AE\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eどうやってするの\u003c/h2\u003e\n\n\u003cp\u003e増やしたアニメーションは、そのままではJUMP00の丸コピーなので、まだ分割されていません。\u003c/p\u003e\n\n\u003cp\u003eこれを、以下4つのモーションに分割します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eジャンプ前\u003c/li\u003e\n\u003cli\u003e上昇中\u003c/li\u003e\n\u003cli\u003e下降中\u003c/li\u003e\n\u003cli\u003e着地\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eInspectorの下にアニメーションを再生できる表示がありますので、これを使ってアニメーションを再生しながら、それぞれの区切りとなる時間で各モーションを分割していきます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/6935a5a43dc8c3d4e06d57cc95bad955df62d385/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383236382d37356661636530302d646231342d313165382d386636332d3038366266376561353435632e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618268-75face00-db14-11e8-8f63-086bf7ea545c.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=0eb3f48be3c1bd536a7b58f92a5fcdbe\" alt=\"04\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47618268-75face00-db14-11e8-8f63-086bf7ea545c.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618268-75face00-db14-11e8-8f63-086bf7ea545c.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1e6fe731b6cb891f462e25939f7bd7ee 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nジャンプ前のモーションの時間を指定したところです。\u003c/p\u003e\n\n\u003cp\u003eどんなモーションなのか自分の分かりやすい名前に変更し、Lengthのところで分割するモーションの時間を指定します。\u003c/p\u003e\n\n\u003cp\u003eまた、Root Transform Position (Y) を feet （足元）に設定しています。\u003cbr\u003e\nここはアニメーション毎に最適な原点位置が違うので、モーションとして最も自然な形になるように、またコライダーの位置ともズレが起きないように調整が必要です。\u003c/p\u003e\n\n\u003cp\u003eこれをあと3回繰り返します。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/fefc23ad179557255049233672c4996d57f94542/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383237362d38383735303738302d646231342d313165382d383131352d6632383638323831323831372e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618276-88750780-db14-11e8-8115-f28682812817.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=f60f2421a4dd92a5a53ac81c50f7a788\" alt=\"05\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47618276-88750780-db14-11e8-8115-f28682812817.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618276-88750780-db14-11e8-8115-f28682812817.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=37b8d2cc8f89105c38336687ee6d487b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n上昇中からジャンプ頂点を越えて下降中に移行するモーションは、下降中モーションに含めたほうが自然な再生が出来ると思います。\u003cbr\u003e\nなので、上昇中モーションはジャンプ頂点に入る少し前のところまでで切ります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/4f709732830ab2bb881fb066faa2afa91da4d323/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383237392d38653661653838302d646231342d313165382d393261392d3236623734623964653138612e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618279-8e6ae880-db14-11e8-92a9-26b74b9de18a.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=af0b02580288bddf4364aa3dbc0a8427\" alt=\"06\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47618279-8e6ae880-db14-11e8-92a9-26b74b9de18a.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618279-8e6ae880-db14-11e8-92a9-26b74b9de18a.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8fa0f44754add174a453d4b6935ed7b7 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\n同様の理由で、下降中モーションも着地に入る手前のところで切ります。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/a2eec20fb4bf2e2a9554e074689b1c8d1155cbbf/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383238352d39363261386430302d646231342d313165382d386261332d3037343764326666616236612e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618285-962a8d00-db14-11e8-8ba3-0747d2ffab6a.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=86d43db0b5ba0a51f6f31c7a03b208cf\" alt=\"07\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47618285-962a8d00-db14-11e8-8ba3-0747d2ffab6a.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618285-962a8d00-db14-11e8-8ba3-0747d2ffab6a.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=1a0d210d566b6ad8463fa6df4a7f02df 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nこれでアニメーションが分割出来ました。\u003c/p\u003e\n\n\u003cp\u003eInspectorをスクロールして一番右下のApplyボタンを押すと、分割したアニメーションがfbxに反映されます。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/c8e6c943b4fa863b11d83552d5faa270c5021564/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373939352d65643265363330302d646231302d313165382d393038652d6637373036633637623830622e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617995-ed2e6300-db10-11e8-908e-f7706c67b80b.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=d03726e81f000a7da95218f80e817b48\" alt=\"08\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47617995-ed2e6300-db10-11e8-908e-f7706c67b80b.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617995-ed2e6300-db10-11e8-908e-f7706c67b80b.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=8ae93bd02419afeefbb92078700d1792 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"animator-を更新\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#animator-%E3%82%92%E6%9B%B4%E6%96%B0\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eAnimator を更新\u003c/h1\u003e\n\n\u003cp\u003e分割したアニメーションの制御のために、AnimatorにもStateを追加します。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/cb10e7eb1c1c4ca496dafa88ce288caa19767ee7/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631373939372d66336263646138302d646231302d313165382d383066332d6561646238316539326533392e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617997-f3bcda80-db10-11e8-80f3-eadb81e92e39.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=20e18e27d89b021c7c60197e476a5d6d\" alt=\"09\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47617997-f3bcda80-db10-11e8-80f3-eadb81e92e39.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47617997-f3bcda80-db10-11e8-80f3-eadb81e92e39.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=366a5d3e2cc2b208d75c7d556c543c80 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003cbr\u003e\nパラメータはすべてBoolで追加し、Transitionでは同名のパラメータがONになったら遷移するように設定します。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/395615a27846d0e10e8dcccd717a3251fa6eff9e/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383030302d66393161323530302d646231302d313165382d393265622d6231626662386238363639352e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618000-f91a2500-db10-11e8-92eb-b1bfb8b86695.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7f092a5793e2ca4c7d1ae74c87d72dcd\" alt=\"10\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47618000-f91a2500-db10-11e8-92eb-b1bfb8b86695.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618000-f91a2500-db10-11e8-92eb-b1bfb8b86695.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=6fd673edf83b29e9ff09de37a46b7fe2 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"溜めて大ジャンプ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%BA%9C%E3%82%81%E3%81%A6%E5%A4%A7%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e溜めて大ジャンプ\u003c/h1\u003e\n\n\u003cp\u003e今回、一連のジャンプ記事で筆者がやりたかった内容がこれです。\u003c/p\u003e\n\n\u003cp\u003eジャンプボタンを押している間ジャンプ力を溜めて、離したときに溜まっているジャンプ力でジャンプの強さを変更します。\u003c/p\u003e\n\n\u003cp\u003e溜めたジャンプ力によって上昇中と下降中の状態の長さが変わるので、アニメーションの遷移をコードで制御します。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"仕様の再検討\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BB%95%E6%A7%98%E3%81%AE%E5%86%8D%E6%A4%9C%E8%A8%8E\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e仕様の再検討\u003c/h2\u003e\n\n\u003cp\u003eコードでアニメーションの遷移をするので、遷移条件の判定と遷移処理を追加します。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eジャンプキー入力開始（key down）ではジャンプ溜め開始\u003c/li\u003e\n\u003cli\u003eジャンプキーが離されたら（key up）ジャンプ開始\u003c/li\u003e\n\u003cli\u003eジャンプキー入力開始（key down）でジャンプ前モーション\u003c/li\u003e\n\u003cli\u003eジャンプキーが離されたら（key up）上昇中モーション\u003c/li\u003e\n\u003cli\u003eジャンプの頂点を過ぎて下降を開始したら下降中モーション\u003c/li\u003e\n\u003cli\u003e着地したら着地モーション\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eを実装します。\u003c/p\u003e\n\n\u003cp\u003e一番ポイントになるところは、ジャンプの頂点を越えて下降中になるところの判定でしょうか。\u003c/p\u003e\n\n\u003cp\u003eraycastで地面との距離をとれるようにしてあるので、前フレームとの差をとって、＋（上昇中）か、－（下降中）かで判断を行います。\u003c/p\u003e\n\n\u003cp\u003eただ、ジャンプ頂点の判定にraycastの距離を使っていて、測定できる距離に上限をとっているので、上限以上にジャンプしてしまうとモーションの遷移が行なえません。\u003cbr\u003e\nraycastの測定距離上限は、ジャンプで想定される最大高さに多少のマージンを足した値にしておく必要があります。\u003c/p\u003e\n\n\u003cp\u003eまた、ジャンプキーの入力について、上記の仕様ではkey down、key upと書きましたが、使うメソッドとしては \u003ccode\u003eUnityEngine.Input.GetButton\u003c/code\u003e で変わりありません。\u003c/p\u003e\n\n\u003cp\u003e最初は \u003ccode\u003eGetButtonDown\u003c/code\u003e と \u003ccode\u003eGetButtonUp\u003c/code\u003e で実装したのですが、ジャンプキーを押してから溜めモーションに移行するまでに本当に少しですが時間がかかるので、その間にジャンプキーを離すと、ジャンプキーが離されてから溜めモーションに移行して次の \u003ccode\u003eGetButtonUp\u003c/code\u003e が来るのを待ってしまうため、もう一度ジャンプキーを押さないとジャンプ出来ません。\u003c/p\u003e\n\n\u003cp\u003eなので、押されている間trueになり、離されたらfalseになる \u003ccode\u003eGetButton\u003c/code\u003e のほうがここでは都合が良かったです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"状態管理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%8A%B6%E6%85%8B%E7%AE%A1%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e状態管理\u003c/h2\u003e\n\n\u003cp\u003eこういった特定の状態から条件によって行うべき内容が変化して次へ次へと移行していく形式のものは、バグが紛れ込みやすくなるのでその扱いには気をつけないといけません。\u003c/p\u003e\n\n\u003cp\u003e一番単純な構造としては\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eJumpState.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIDLE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 入力待ち状態\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eWAITING\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// ジャンプ溜め状態\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eRISING\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 上昇中状態\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eFALLING\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 下降中状態\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eLANDING\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 着地状態\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eと状態を定義し、遷移条件判定や各状態の内容処理の場合にそれぞれでswitchをかける\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eng_code.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eswitch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ejump_state\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eIDLE\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eWAITING\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eRISING\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eFALLING\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eLANDING\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eというものがありますが、同じswitch文が各所に出現したり、どこで何の処理をしているのか分かりづらくなるなど問題が多く、この形の処理は出来る限り避けた方が懸命です。\u003c/p\u003e\n\n\u003cp\u003eではどうするのかと言うと、前回までに書いてきた既存のコードは捨てて、一から定義し直すことになります。\u003cbr\u003e\nここまで来て書き直しとかめんどいやりたくない・・・と思うかもしれませんが、時間がかかっても最も正攻法なやり方をとるのが実は一番近道だと知っているのがプログラマですので、ここは我慢してゼロベースで考え直します。（と自分に言い聞かせている）\u003c/p\u003e\n\n\u003cp\u003eとはいえ、外側の管理構造は変えますが、詳細な処理部分については流用が効く部分も多いので、本当に完全にゼロからというわけではありません。\u003cbr\u003e\nここまで作ってきた内容が無駄になるわけではありません。（と自分に言い聞かせている）\u003c/p\u003e\n\n\u003cp\u003eさて、\u003ccode\u003eswitch\u003c/code\u003e するのは良くないので、じゃあどうするかと言うと、各状態をクラスとして実装し \u003ccode\u003eDictionary\u003c/code\u003e に置いておき、状態が変わるごとに必要なクラスを取り出して使う、という方法があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003emaybe_better_code.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_state_list\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"n\"\u003e_state_old\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estayUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 状態を更新\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003e_state_old\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 変更があるまで現在の状態を維持\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 状態終了時の処理（今回は使わないかも）\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_state_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 遷移後の状態に切り替え\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eenter\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 状態開始時の処理\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e_state_old\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 切り替え判定用に前フレームの状態を保持\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e使わないのはswitchの分岐処理だけなので、JumpStateはさっきのEnumがそのまま使えます。\u003cbr\u003e\n\u003ccode\u003eStart()\u003c/code\u003e や \u003ccode\u003eFixedUpdate()\u003c/code\u003e でも処理が必要ですが、基本構造はこれで回せるはずです。\u003c/p\u003e\n\n\u003cp\u003eこれを実現するために、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eIJumpState.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003einterface\u003c/span\u003e \u003cspan class=\"nc\"\u003eIJumpState\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"nf\"\u003estay_update\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 状態に留まっている間Updateで実行される\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003estay_fixed_update\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 状態に留まっている間FixedUpdateで実行される\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eenter\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 状態に遷移してきた時に一度だけ実行される\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 状態から遷移していく時に一度だけ実行される\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eというインターフェイスを用意します。\u003c/p\u003e\n\n\u003cp\u003eこれは各状態を実装する際の基盤とするもので、インターフェイスを継承したクラスはインターフェイスにあるメソッドを全て実装しなければなりません。\u003cbr\u003e\n管理クラスから見ると、このインターフェイスを継承しているクラスにはこれらのメソッドが実装されていることが保証される事になります。\u003c/p\u003e\n\n\u003cp\u003e各状態の処理をそれぞれのクラスに記述し、上位の管理クラスでは各クラスの保持とどのクラスの処理を実行するのかだけを管理するようにします。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"jumpstateidle\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#jumpstateidle\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eJumpStateIdle\u003c/h3\u003e\n\n\u003cp\u003e入力待ちのアイドル状態を管理します。\u003cbr\u003e\nジャンプキー入力開始（key down）でジャンプ溜め状態に移行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eJumpStateIdle.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimJump\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// UniRxのJumpStateと命名が被ってしまっているので、UniRxが入っている場合に必要です。\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eanimJump\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eJumpStateIdle\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Idle\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateIdle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"nf\"\u003estayUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eisName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetButton\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Jump\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWAITING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIDLE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eenter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eanimationStart\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003estayFixedUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e本来の \u003ccode\u003eAnimator\u003c/code\u003e には \u003ccode\u003eanimationStart\u003c/code\u003e というメソッドはありませんが、C#の拡張メソッド機能を使って追加してあります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eAnimatorExtensions.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eAnimatorExtensions\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eradioBool\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003eanim\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"k\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eparam\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003eanim\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eparameters\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimatorControllerParameterType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBool\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eanim\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSetBool\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparam\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003eon\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eanimationStart\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003eanim\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eanim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elayer_no\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eanim\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eradioBool\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eanim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eisName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003eanim\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eanim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elayer_no\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estate_info\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanim\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCurrentAnimatorStateInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elayer_no\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003estate_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eanim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eanimationEnd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003eanim\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003eanim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elayer_no\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estate_info\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanim\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetCurrentAnimatorStateInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elayer_no\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003estate_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eanim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate_info\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enormalizedTime\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e1f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eanimationStart\u003c/code\u003e 自体は一緒に追加した \u003ccode\u003eradioBool\u003c/code\u003e の呼び出しのみで、\u003ccode\u003eradioBool\u003c/code\u003e メソッドは引数で指定したBoolパラメータのみをtrueとし、他のBoolパラメータはすべてfalseに落とすメソッドです。\u003c/p\u003e\n\n\u003cp\u003e同時に追加している \u003ccode\u003eisName\u003c/code\u003e は、現在進行中のアニメーションが指定したアニメーションかどうかを判定し、\u003ccode\u003eanimationEnd\u003c/code\u003e は、アニメーションが終了したかどうかを判定するメソッドです。\u003cbr\u003e\n後で使います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"jumpstatewaiting\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#jumpstatewaiting\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eJumpStateWaiting\u003c/h3\u003e\n\n\u003cp\u003eジャンプ溜め中の状態を管理します。\u003cbr\u003e\nジャンプキーが離されたら（key up）上昇中状態に移行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eJumpStateWaiting.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimJump\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eanimJump\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eJumpStateWaiting\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpData\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Waiting\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateWaiting\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpData\u003c/span\u003e \u003cspan class=\"n\"\u003ejump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ejump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"nf\"\u003estayUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epower_up\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eisName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eInput\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetButton\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Jump\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRISING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWAITING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eenter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eanimationStart\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003estayFixedUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eジャンプキーを押している長さの分だけジャンプパワーを溜めますが、溜めるのはWaitingで使うのがRisingで、別クラスでの操作になるため、横串でデータのやり取りをするためのクラス \u003ccode\u003eJumpData\u003c/code\u003e を追加しました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eJumpData.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eanimJump\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eJumpData\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003e_power\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003epower\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_power\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003e_power_default\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003e_power_up\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003e_power_max\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eup\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_power_up\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eup\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_power_max\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003epower_reset\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003epower_up\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_power_max\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003e_power\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_power\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003e_power_up\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003epower_reset\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_power\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_power_default\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e毎フレーム毎に溜めるパワーの値と、溜められるパワーの上限を外部から与えられるようにしてあります。\u003cbr\u003e\n管理クラスを通してInspectorで設定できるようにするとUnity的な使い方が出来ます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"jumpstaterising\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#jumpstaterising\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eJumpStateRising\u003c/h3\u003e\n\n\u003cp\u003e上昇中の状態を管理します。\u003cbr\u003e\n初回のFixedUpdate()で、Rigidbody.AddForceを使って上方へのジャンプを行います。\u003cbr\u003e\nまた、ジャンプの頂点を過ぎて下降を開始したら下降中の状態へ移行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eJumpStateRising.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimJump\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eanimJump\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eJumpStateRising\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpData\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpDistance\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eRigidbody\u003c/span\u003e \u003cspan class=\"n\"\u003e_rigid_body\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003e_allow_add_force\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Rising\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateRising\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpData\u003c/span\u003e \u003cspan class=\"n\"\u003ejump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eJumpDistance\u003c/span\u003e \u003cspan class=\"n\"\u003ejump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRigidbody\u003c/span\u003e \u003cspan class=\"n\"\u003erigid_body\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ejump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ejump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_rigid_body\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erigid_body\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"nf\"\u003estayUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eisName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eisFalling\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_allow_add_force\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003epower_reset\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFALLING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRISING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eenter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eanimationStart\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003estayFixedUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003e_allow_add_force\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_allow_add_force\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003e_rigid_body\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAddForce\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eup\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epower\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eForceMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eImpulse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eジャンプが下降に移る際の判定のために、新しく \u003ccode\u003eJumpDistance\u003c/code\u003e クラスを追加しました。\u003cbr\u003e\n各状態がキャラと地面との細かい距離を知って判定する必要は無いので、判定処理を丸ごと任せて結果だけを貰います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eJumpDistance.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Linq\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eanimJump\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eJumpDistance\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003e_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003edistance\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eset\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_distance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eold_distance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_old_distance_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e?\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_old_distance_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003e_old_distance_diff_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eold_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_distance_list_limit\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_old_distance_diff_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_old_distance_diff_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDequeue\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003e_old_distance_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_distance_list_limit\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_old_distance_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_old_distance_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDequeue\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eQueue\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_old_distance_diff_list\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eQueue\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eQueue\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_old_distance_list\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eQueue\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_distance_list_limit\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003e_ground_distance_limit\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0.01f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eVector3\u003c/span\u003e \u003cspan class=\"n\"\u003e_raycastOffset\u003c/span\u003e  \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0.005f\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0f\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003e_raycastSearchDistance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e100f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eTransform\u003c/span\u003e \u003cspan class=\"n\"\u003e_transform\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpDistance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTransform\u003c/span\u003e \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edistance_list_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eground_distance_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eraycastSearchDistance\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_transform\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_distance_list_limit\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edistance_list_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_ground_distance_limit\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eground_distance_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_raycastSearchDistance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eraycastSearchDistance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eisFalling\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003echeck\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_old_distance_diff_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAverage\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"nf\"\u003eisLanding\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003echeck\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_old_distance_list\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAverage\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_ground_distance_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003echeck\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eRaycastHit\u003c/span\u003e \u003cspan class=\"n\"\u003ehit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elayerMask\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eLayerMask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetMask\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Ground\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// プレイヤーの位置から下向きにRaycast\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// レイヤーマスクでGroundを設定しているので、\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 地面のGameObjectにGroundのレイヤーを設定しておけば、\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// Groundのレイヤーを持つGameObjectで一番近いものが一つだけヒットする\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eisGroundHit\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePhysics\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRaycast\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_transform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003e_raycastOffset\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_transform\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTransformDirection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVector3\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edown\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003ehit\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_raycastSearchDistance\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003elayerMask\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eisGroundHit\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003edistance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehit\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edistance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// ヒットしなかった場合はキャラの下方に地面が存在しないものとして扱う\u003c/span\u003e\n                \u003cspan class=\"n\"\u003edistance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMaxValue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eisFalling\u003c/code\u003e は上昇中に、\u003ccode\u003eisLanding\u003c/code\u003e は下降中に毎フレーム呼ばれるので、\u003ccode\u003echeck\u003c/code\u003e メソッドをここで呼ぶようにし、接地中はraycastの判定をしないようにしています。\u003c/p\u003e\n\n\u003cp\u003eより負荷を軽減するなら、2フレームか3フレームに1回だけ \u003ccode\u003echeck\u003c/code\u003e するような形にしても、動作上はそこまで影響はないかと思います。\u003cbr\u003e\n1点気をつけるとすれば、実は今回の処理では \u003ccode\u003eisLanding\u003c/code\u003e の設定判定に使っている \u003ccode\u003e_ground_distance_limit\u003c/code\u003e の値を、ちょっと遠目にしています。\u003cbr\u003e\n接地前からアニメーションを開始しておくことで、アニメーション上の着地と実際の着地が近いタイミングになるようにしているので、フレームを飛ばすならそこは再調整が必要になりそうです。\u003c/p\u003e\n\n\u003cp\u003eまた、今回は完全にジャンプ処理だけに注目しているコードなので \u003ccode\u003eisFalling\u003c/code\u003e 、\u003ccode\u003eisLanding\u003c/code\u003e の中で \u003ccode\u003echeck\u003c/code\u003e するようにしましたが、実際に3Dゲームで使う際に、ジャンプではなく段差を降りるなどで下降モーションを起こしたい場合、ジャンプ中しか距離計測していないのではアクションが起こせないので、そういう場合も再検討が必要だと考えられます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"jumpstatefalling\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#jumpstatefalling\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eJumpStateFalling\u003c/h3\u003e\n\n\u003cp\u003e下降中の状態を管理します。\u003cbr\u003e\n着地したら着地状態へ移行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eJumpStateFalling.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimJump\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eanimJump\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eJumpStateFalling\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpDistance\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Falling\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateFalling\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpDistance\u003c/span\u003e \u003cspan class=\"n\"\u003ejump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ejump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"nf\"\u003estayUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eisName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eisLanding\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLANDING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFALLING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eenter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eanimationStart\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003estayFixedUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"jumpstatelanding\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#jumpstatelanding\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eJumpStateLanding\u003c/h3\u003e\n\n\u003cp\u003e着地の状態を管理します。\u003cbr\u003e\n着地モーションが完了したらアイドル状態へ移行します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eJumpStateLanding.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUniRx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimJump\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003eanimJump\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eJumpStateLanding\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"Landing\"\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateLanding\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"nf\"\u003estayUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eanimationEnd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIDLE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLANDING\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eenter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eanimationStart\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_anim_name\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003estayFixedUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eanimationEnd\u003c/code\u003e は、\u003ccode\u003eanimationStart\u003c/code\u003e と一緒に追加した拡張メソッドで、再生中のアニメーションが終了したかどうかをbool値で返してくれます。\u003cbr\u003e\nまた \u003ccode\u003eisName\u003c/code\u003e と同等の処理を \u003ccode\u003eanimationEnd\u003c/code\u003e の中で行っているため、ここでは不要です。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"管理クラス\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%AE%A1%E7%90%86%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e管理クラス\u003c/h3\u003e\n\n\u003cp\u003e各状態を管理するクラスを作ってきたので、最後は状態の変遷を管理するクラスを作成します。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"cs\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003ePlayerStateController.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Collections.Generic\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eUnityEngine\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eanimJump\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eanimJump\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003ePlayerStateController\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eMonoBehaviour\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    ジャンプ処理に使用するRigidbody\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eRigidbody\u003c/span\u003e \u003cspan class=\"n\"\u003e_rigidBody\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    ジャンプアニメーションを担当するAnimator\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    ジャンプの各状態を保持しておく辞書リスト\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_state_list\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    ジャンプの以前の状態を記憶しておく\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    これと比較することで状態の変更を識別する\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e \u003cspan class=\"n\"\u003e_state_old\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIDLE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    現在のジャンプの状態を保持\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    ジャンプ力に関する情報を保持\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpData\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    プレイヤーキャラクターと地面間の距離に関する情報を保持\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpDistance\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    キーを押している間に溜めるジャンプ力の1フレーム分\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_power_up\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    ジャンプ力の上限\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_power_max\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    上昇中から下降中に切り替わる変化の検知精度\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edistance_list_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    下降中から接地したと判定する距離\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eground_distance_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e///\u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    プレイヤーキャラクターと地面間の計測距離上限\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///    最高高度より高い値でないと、ジャンプ頂点での下降モーションへの切り替わりが出来ません\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e///\u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eSerializeField\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003eraycastSearchDistance\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_rigidBody\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGetComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eRigidbody\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_animator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eGetComponent\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAnimator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_jump_power_up\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_power_max\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpDistance\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etransform\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edistance_list_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eground_distance_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eraycastSearchDistance\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_jump_state_list\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eIJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIDLE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateIdle\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWAITING\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateWaiting\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRISING\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateRising\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_data\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_rigidBody\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFALLING\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateFalling\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_distance\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLANDING\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eJumpStateLanding\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_animator\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_state_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eJumpState\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIDLE\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eenter\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estayUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003e_state_old\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_jump_state_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eenter\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_state_old\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eFixedUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e_state_instance\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003estayFixedUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e基本構造は記事の最初の方で出てきた状態管理のものそのままです。\u003c/p\u003e\n\n\u003cp\u003e初期化処理では、 \u003ccode\u003eJumpData\u003c/code\u003e と \u003ccode\u003eJumpDistance\u003c/code\u003e を生成し、情報が必要な状態にだけ渡しています。\u003cbr\u003e\nそれから状態とクラスのリストを作成し、最初の状態 \u003ccode\u003eJumpState.IDLE\u003c/code\u003e を設定、開始しています。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eFixedUpdate\u003c/code\u003e では、各状態の \u003ccode\u003estayFixedUpdate\u003c/code\u003e を呼び出していますが、今回処理が行われているのは \u003ccode\u003eJumpStateRising\u003c/code\u003e だけです。\u003cbr\u003e\n空メソッドの呼び出しだけならそこまで高コストにはならないので恐らく許容範囲と思いますが、必要であれば特定の状態のときだけ \u003ccode\u003estayFixedUpdate\u003c/code\u003e を呼び出すような形にすることも考えられます。\u003c/p\u003e\n\n\u003cp\u003eUnityちゃんにAttachするのは、このPlayerStateControllerだけです。\u003cbr\u003e\n\u003ca href=\"https://camo.qiitausercontent.com/78fcd202efdafa96c2d3073ee6ff21f2aefdef4c/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383036332d66326438373838302d646231312d313165382d383765662d3130333739353637653538612e6a7067\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618063-f2d87880-db11-11e8-87ef-10379567e58a.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=5751b5d436f2ff49bceb8ebd5075ad53\" alt=\"11\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47618063-f2d87880-db11-11e8-87ef-10379567e58a.jpg\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618063-f2d87880-db11-11e8-87ef-10379567e58a.jpg?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=fd2e2cc7054387981f051b073662dd8e 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"動かす\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8B%95%E3%81%8B%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e動かす\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://camo.qiitausercontent.com/fd07f4149d52f58c2ce25f4d495ec2302aa7d17f/68747470733a2f2f757365722d696d616765732e67697468756275736572636f6e74656e742e636f6d2f383239313339352f34373631383032352d37353134366430302d646231312d313165382d383466622d6433336361616231333335382e676966\" target=\"_blank\" rel=\"nofollow noopener\"\u003e\u003cimg src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618025-75146d00-db11-11e8-84fb-d33caab13358.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;s=7319d2baf3f16f9e0e5105814f467b56\" alt=\"capture_20181028_234041\" data-canonical-src=\"https://user-images.githubusercontent.com/8291395/47618025-75146d00-db11-11e8-84fb-d33caab13358.gif\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fuser-images.githubusercontent.com%2F8291395%2F47618025-75146d00-db11-11e8-84fb-d33caab13358.gif?ixlib=rb-4.0.0\u0026amp;auto=format\u0026amp;gif-q=60\u0026amp;q=75\u0026amp;w=1400\u0026amp;fit=max\u0026amp;s=170955486de0e39814dd7a364c831c7b 1x\" loading=\"lazy\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eスペースキーを押すとジャンプ待機、離すとジャンプし、待機時間でジャンプの強さが変わります。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"あとがき\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eあとがき\u003c/h1\u003e\n\n\u003cp\u003eアニメーションを分割してコードから操作するようにしたら、タイミング調整とか、今回はやってませんが途中でアニメーションを入れ替えたりとかも出来るのでめっちゃ便利になりますよね！っていう記事を3回に分けて書いてきたのですが、最終的に辿り着いたのは「状態管理って難しいしめんどくさいよね」でした。\u003c/p\u003e\n\n\u003cp\u003e内容的には初心者はクリアした初級者向けあたりになるのかな？と疑問に思いつつ、意図的にUniRxの記述を避けてきたのですが、外部の誰かがジャンプの状態を知りたい状況でなければ使うメリットがそれほど無いのではと思っています。\u003c/p\u003e\n\n\u003cp\u003eあるいは現在の状態をReactivePropertyにして、状態が切り替わったらアニメーションを切り替える形なら、現在の「状態がアニメーションを管理する」のではなく、「状態の変更条件のチェック」と「アニメーションの管理」を切り離すことは出来るかもしれません。\u003c/p\u003e\n\n\u003cp\u003eもしくは、ジャンプキー入力やraycastで取っている地面との距離をReactivePropertyにすれば、必要なタイミングを教えてくれるように出来て、メソッドに起こさなくてもラムダでその時その時の処理を書けば良いだけに出来るかもしれませんね。\u003cbr\u003e\nもっとコンパクトでスマートなコードになるのなら検討する価値は大いにありそうです。（手のひらクルーが速い）\u003c/p\u003e\n\n\u003cp\u003eRxもオブジェクト指向もDDDも、すべては関心の分離のために行われている気がしてきているので、そっちの方向でプログラミング出来るならより良いコードになりそうです。\u003c/p\u003e\n","createdAt":"2018-10-28T16:11:08Z","elapsedYearsFromLastModifiedAt":2,"encryptedId":"hNwjZImua/muRE6pf6zm8/M71YLWJ9X9--vsSdzrmdRwDyeyEm--EVEwdVG0wa0us08SMecD5Q==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-06-21T15:18:40Z","likesCount":9,"linkUrl":"https://qiita.com/mkgask/items/fa307811da6d9d76bc97","organization":null,"originalId":714562,"stockedCount":8,"title":"Unity 3Dでアニメーションを考慮したジャンプ その2（アニメーションを分割して溜め大ジャンプ）","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%83%B3%E5%AE%9A%E7%92%B0%E5%A2%83\"\u003e想定環境\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A2%E3%83%8B%E3%83%A1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E5%88%86%E5%89%B2\"\u003eアニメーション分割\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%A9%E3%81%93%E3%81%8B%E3%82%89%E3%81%99%E3%82%8B%E3%81%AE\"\u003eどこからするの\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E3%81%99%E3%82%8B%E3%81%AE\"\u003eどうやってするの\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#animator-%E3%82%92%E6%9B%B4%E6%96%B0\"\u003eAnimator を更新\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%BA%9C%E3%82%81%E3%81%A6%E5%A4%A7%E3%82%B8%E3%83%A3%E3%83%B3%E3%83%97\"\u003e溜めて大ジャンプ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BB%95%E6%A7%98%E3%81%AE%E5%86%8D%E6%A4%9C%E8%A8%8E\"\u003e仕様の再検討\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%8A%B6%E6%85%8B%E7%AE%A1%E7%90%86\"\u003e状態管理\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#jumpstateidle\"\u003eJumpStateIdle\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#jumpstatewaiting\"\u003eJumpStateWaiting\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#jumpstaterising\"\u003eJumpStateRising\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#jumpstatefalling\"\u003eJumpStateFalling\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#jumpstatelanding\"\u003eJumpStateLanding\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%AE%A1%E7%90%86%E3%82%AF%E3%83%A9%E3%82%B9\"\u003e管理クラス\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8B%95%E3%81%8B%E3%81%99\"\u003e動かす\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%82%E3%81%A8%E3%81%8C%E3%81%8D\"\u003eあとがき\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":3588,"uuid":"fa307811da6d9d76bc97","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"emMcSEMnPx9ndbR8iEtlbmMFR9I=--43Eo2D+5lx1ezc3a--TnAtQpNVhw7sXFj0Ko5+XQ==","originalId":72594,"description":"業務ではPHP触りつつ趣味ではUnity C#とPythonで遊んでいます。\r\n何か色々やってるのでフォローにはご注意くださいヾ( ╹◡╹)ﾉﾞ ","facebookUrl":null,"githubUrl":"https://github.com/mkgask","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/72594/profile-images/1473699207","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F72594%2Fprofile-images%2F1473699207?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=b910d5ec1b2769448a88f943d3cd0763","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F72594%2Fprofile-images%2F1473699207?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=13e12b10c92fd48268dbffad96bda4d6","urlName":"mkgask","websiteUrl":"http://zsw.jp","twitterUrl":"https://twitter.com/mkgask","twitterUrlName":"mkgask","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Unity","urlName":"unity"}],"followingLikers":{"edges":[]},"comments":{"totalCount":0}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
