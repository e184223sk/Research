More than 3 years have passed since last update.この記事は、SkyrimというゲームソフトのModファイルのバリナリ解析とそれを利用してModを生成するC#のコードについて記載していくシリーズ物です。
ファイルフォーマットについての詳しい情報は以下のサイトがあります。(以降UESP)
Tes5Mod:Mod File Format - The Unofficial Elder Scrolls Pages (UESP)前回はModファイルのクラスについて扱いました。今回はその際に登場したセル情報とワールド情報を扱うクラスについてです。セル情報は他と構造が異なります。基本的には次のようになっています。SSEEditで見ると次のようになっています。
通常は、グループの中にはレコードがあるだけですが、セルの場合はグループが入れ子になっています。
まずは、セル全体のグループを扱うクラスです。これまでは、グループの後はレコードが続くため、レコードの読み取りを行っていましたが、セルではレコードが続くわけではないため、レコードの読み取りを行わないように、TesGroupクラスのコンストラクタを変更しています。続いて、ブロックのグループ続いてブロックの中のサブブロックブロックとサブブロックはSSEEditで見た感じではBlock 0～Block 9までの範囲で各ブロック内はそれぞれSub-Block 0～Sub-Block 9までの範囲となっていると思われます。Creation Kitでセルを新規作成するといずれかのブロックのいずれかのサブブロックに割り当てられるようで、どのように設定されるのかの詳細は不明です。
また、この後に続くセルそのものについての情報を扱うレコードについても解析できていませんので、プログラムで新規生成するのは難しく、現状では一旦Creation Kitでセルを作成し、そこにデータを追加する形となります。なお、ここまでは基本的にグループ範囲を読み取っていましたが、セルについては別途読み取り範囲の方法が異なるので、読み取りようのメソッドを追加しました。セル内に「セル情報詳細（グループ）」が無く、セルそのもののレコードしかないケースもあるため、読み取り範囲のチェックを行っています。続いて、1つのセルを扱うクラスですが、グループのようなものではあるのですが、Modファイル内での形式としてはレコードなので、レコードクラスを継承し、レコードデータと共にグループを内包するクラスとなります。TesGroupと同様に、TesRecordでも、コンストラクタを変更します。また、この後の説明でする「セルデータ（レコード）」にあるナビメッシュなどは、通常のレコードとは異なる他、解析できていませんので、そのままバイトデータを読み取るようにしています。では続いて、セル情報詳細を扱うクラスです。続いて、セル配置を扱うクラスです。SSEEditでの、PersistentとTemporaryにあたる部分です。
ここにセル内に配置するあらゆるオブジェクトがレコードして登録されます。
なお、どっちか片方か、両方の2つしかないため、リストにしなくても良いのかもしれませんが、とりあえずリストにしています。これで、セル情報を扱えるようになりました。ワールド情報はほぼセル情報と同じような形式ですが、まずワールド情報があり、各ワールド内に直接セル情報が続く場合と、セルと同じくブロック、サブブロック、セルとなる場合があります。ではまず、ワールド情報全体を扱うクラスです。各ワールドについては、「ワールド情報（レコード）」と「ワールド情報詳細（グループ）」が対になっています。
これは、「セル（レコード）」の時と同じ方法で読み取れます。続いて、ワールド情報を扱うクラスです。「ワールド情報（レコード）」と「ワールド情報詳細（グループ）」を対で扱うためにTesBaseを基底として、それぞれのクラスを持つようにしました。最後に、ワールド情報詳細を扱うクラスです。ワールド情報詳細では1つのセルがある場合と、複数のブロックがある場合がありますので、直前のSignatureをチェックして読み取るようにしています。
なお、セルの時とは異なり、ブロックとサブブロックはX軸とY軸での座標形式となっているようです。
SSEEditで見ると次のようになっています。
以上、これでセル情報とワールド情報が扱えるようになりました。
この2つが特に特別な構造となっていますので、これでほぼ大体のデータの読み取りと変更が行えるようになったと思います。以上


