<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Stardard MIDI Fileを解析して音ゲーの譜面を作る話 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/owts/items/8d641e8a8a423566db71" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="OT9dcYa2orBaLf/Xh/XOoG1W1ylxytlYoPzdAM0tXAx/CMFNJA2mhMfnyX8Id1DZKoNYaN/QdkNqsebBi26AnQ==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="Stardard MIDI Fileを解析して音ゲーの譜面を作る話 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1VM1JoY21SaGNtUWdUVWxFU1NCR2FXeGw0NEtTNktlajVwNlE0NEdYNDRHbTZaLXo0NEt5NDRPODQ0R3U2SzJjNloyaTQ0S1M1TDJjNDRLTDZLbXgmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZjQ2NTNiYzgxMTI3MDdkNmJkNWMyN2Y4NWRiY2M0ZTA&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzkzZEhNJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OTU3MDBhMDZhYTRiZDczYTc0Njk4MzRmMTFlOTEwNTc&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=c553e2d87ac3928d0fdd679ff68a91da"><meta property="og:description" content="この記事は、KLab Engineer Advent Calendar 2018 19日目の記事です。


Standard MIDI File とは

一言で表すなら、「どの音符をどのタイミングで鳴らすか」等の演奏に関する全ての情報..."><meta content="https://qiita.com/owts/items/8d641e8a8a423566db71" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,MIDI" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-b32f1452-6cc1-459b-a83d-f5a28a64bdec"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fowts%2Fitems%2F8d641e8a8a423566db71">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fowts%2Fitems%2F8d641e8a8a423566db71">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-b32f1452-6cc1-459b-a83d-f5a28a64bdec">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-12-18T00:44:34.000+09:00","dateModified":"2021-08-22T17:26:12.000+09:00","headline":"Stardard MIDI Fileを解析して音ゲーの譜面を作る話","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1VM1JoY21SaGNtUWdUVWxFU1NCR2FXeGw0NEtTNktlajVwNlE0NEdYNDRHbTZaLXo0NEt5NDRPODQ0R3U2SzJjNloyaTQ0S1M1TDJjNDRLTDZLbXgmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9ZjQ2NTNiYzgxMTI3MDdkNmJkNWMyN2Y4NWRiY2M0ZTA\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RRzkzZEhNJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NDUmdHh0LWFsaWduPXJpZ2h0JTJDYm90dG9tJnM9OTU3MDBhMDZhYTRiZDczYTc0Njk4MzRmMTFlOTEwNTc\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=c553e2d87ac3928d0fdd679ff68a91da","mainEntityOfPage":"https://qiita.com/owts/items/8d641e8a8a423566db71","author":{"@type":"Person","address":"","email":null,"identifier":"owts","name":"owts","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars0.githubusercontent.com%2Fu%2F13196855%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=5d761e90b0c88fda8d7adb6e093210ec","url":"https://qiita.com/owts","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"owts","type":"items","id":"8d641e8a8a423566db71"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"owts","type":"items","id":"8d641e8a8a423566db71"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_1","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"owts","type":"items","id":"8d641e8a8a423566db71"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":1,"pos_id":"header_text_message_2","message":"Qiita創業者海野氏登壇！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/owts/items/8d641e8a8a423566db71","location":"/owts/items/8d641e8a8a423566db71","scheme":"https","host":"qiita.com","port":null,"pathname":"/owts/items/8d641e8a8a423566db71","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"VEx9LOnu1gqxt5m2/ev0+hPQ26r2eev7qWV6rvWVKekSe+EQS1XSPix9rx5yaWqDVAVU61hjROBjKEFvs9b1eA==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-82271995-d02c-4424-8a8f-9f2f963322fe"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/owts/items/8d641e8a8a423566db71/likers" class="css-1iupg5d">24</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">13</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/8d641e8a8a423566db71/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/owts/items/8d641e8a8a423566db71/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/owts/items/8d641e8a8a423566db71/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/owts/items/8d641e8a8a423566db71/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/owts/items/8d641e8a8a423566db71.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2018/klab" class="it-AdcalRibbon_title">KLab Engineer<!-- --> Advent Calendar<!-- --> <!-- -->2018</a>Day 19</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/owts"><img class="css-100alwu eyfquo10" src="https://avatars0.githubusercontent.com/u/13196855?v=4" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/owts" class="css-10ougpm">@<!-- -->owts</a><div class="css-1ay9vb9"><span><meta content="2018-12-17T15:44:34Z"/><time dateTime="2021-08-22T08:26:12Z" class="css-m19uds">updated at 2021-08-22</time></span></div></div></div></div></div><h1 class="css-cgzq40">Stardard MIDI Fileを解析して音ゲーの譜面を作る話</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/midi" class="css-4czcte">MIDI</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>この記事は、<a href="https://qiita.com/advent-calendar/2018/klab">KLab Engineer Advent Calendar 2018</a> 19日目の記事です。</p>

<h2>
<span id="standard-midi-file-とは" class="fragment"></span><a href="#standard-midi-file-%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>Standard MIDI File とは</h2>

<p>一言で表すなら、「どの音符をどのタイミングで鳴らすか」等の演奏に関する全ての情報が入っているファイルです。<br>
これだけ聞くと音ゲーの譜面みたいですね！その通りです！</p>

<p>この記事ではMIDIファイルから音ゲーに使えそうな譜面データに変換するプログラムを書きつつ解説します。<br>
レーンに沿って流れてくるタイプの音ゲーの譜面を作るのにとても有効な手法です。</p>

<h2>
<span id="譜面用構造体の定義" class="fragment"></span><a href="#%E8%AD%9C%E9%9D%A2%E7%94%A8%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AE%E5%AE%9A%E7%BE%A9"><i class="fa fa-link"></i></a>譜面用構造体の定義</h2>

<p>MIDI解析の前準備としてノーツイベントとBPMイベントの構造体を定義します。<br>
実際の譜面データになるものです。</p>

<div class="code-frame" data-lang="c#"><div class="highlight"><pre><code><span class="k">public</span> <span class="k">enum</span> <span class="n">NoteType</span>
<span class="p">{</span>
  <span class="n">Normal</span><span class="p">,</span>      <span class="c1">// 通常ノーツ</span>
  <span class="n">LongStart</span><span class="p">,</span>   <span class="c1">// ロング開始</span>
  <span class="n">LongEnd</span><span class="p">,</span>     <span class="c1">// ロング終端</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">struct</span> <span class="nc">NoteData</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">eventTime</span><span class="p">;</span>  <span class="c1">// ノーツタイミング(ms)</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">laneIndex</span><span class="p">;</span>  <span class="c1">// レーン番号</span>
  <span class="k">public</span> <span class="n">NoteType</span> <span class="n">type</span>   <span class="c1">// ノーツの種類</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">struct</span> <span class="nc">TempoData</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="kt">int</span> <span class="n">eventTime</span><span class="p">;</span>  <span class="c1">// BPM変化のタイミング(ms)</span>
  <span class="k">public</span> <span class="kt">float</span> <span class="n">bpm</span><span class="p">;</span>      <span class="c1">// BPM値</span>
  <span class="k">public</span> <span class="kt">float</span> <span class="n">tick</span>      <span class="c1">// tick値</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>
<span id="midiファイル構成" class="fragment"></span><a href="#midi%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>MIDIファイル構成</h2>

<p>データ構造ですが、大きく分けて<br>
・ヘッダチャンク<br>
・トラックチャンク<br>
の2部で構成されています。</p>

<h3>
<span id="ヘッダチャンク" class="fragment"></span><a href="#%E3%83%98%E3%83%83%E3%83%80%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF"><i class="fa fa-link"></i></a>ヘッダチャンク</h3>

<table>
<thead>
<tr>
<th>ヘッダチャンク</th>
<th>バイト数</th>
<th>補足</th>
</tr>
</thead>
<tbody>
<tr>
<td>チャンクID</td>
<td>4byte</td>
<td>チャンクID　"MThd" で固定</td>
</tr>
<tr>
<td>データ長</td>
<td>4byte</td>
<td>続くチャンクのデータ長　"6" で固定</td>
</tr>
<tr>
<td>フォーマット</td>
<td>2byte</td>
<td>フォーマット</td>
</tr>
<tr>
<td>トラック数</td>
<td>2byte</td>
<td><strong>後のトラックチャンクの個数</strong></td>
</tr>
<tr>
<td>分能値</td>
<td>2byte</td>
<td>タイムベース　大体480</td>
</tr>
</tbody>
</table>

<h3>
<span id="トラックチャンク" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF"><i class="fa fa-link"></i></a>トラックチャンク</h3>

<table>
<thead>
<tr>
<th>トラックチャンク</th>
<th>バイト数</th>
<th>補足</th>
</tr>
</thead>
<tbody>
<tr>
<td>チャンクID</td>
<td>4byte</td>
<td>チャンクID　 "MTrk" で固定</td>
</tr>
<tr>
<td>データ長</td>
<td>4byte</td>
<td>データ部のサイズ</td>
</tr>
<tr>
<td>データ部</td>
<td>可変</td>
<td>メインのデータ部分<br> <strong>ここにノートイベント等の情報が格納</strong>
</td>
</tr>
</tbody>
</table>

<p>こちらを構造体にします</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">チャンクデータ用構造体</span></div>
<div class="highlight"><pre><code><span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// ヘッダーチャンク情報を格納する構造体</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">HeaderChunkData</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">chunkID</span><span class="p">;</span>      <span class="c1">// チャンクのIDを示す(4byte)</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">dataLength</span><span class="p">;</span>      <span class="c1">// チャンクのデータ長(4byte)</span>
    <span class="k">public</span> <span class="kt">short</span> <span class="n">format</span><span class="p">;</span>        <span class="c1">// MIDIファイルフォーマット(2byte)</span>
    <span class="k">public</span> <span class="kt">short</span> <span class="n">tracks</span><span class="p">;</span>        <span class="c1">// トラック数(2byte)</span>
    <span class="k">public</span> <span class="kt">short</span> <span class="n">division</span><span class="p">;</span>      <span class="c1">// タイムベース MIDI独自の時間の最小単位をtickと呼び、4分音符あたりのtick数がタイムベース 大体480(2byte)</span>
<span class="p">};</span>

<span class="c1">/// &lt;summary&gt;</span>
<span class="c1">/// トラックチャンク情報を格納する構造体</span>
<span class="c1">/// &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">TrackChunkData</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">chunkID</span><span class="p">;</span>      <span class="c1">// チャンクのIDを示す(4byte)</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">dataLength</span><span class="p">;</span>      <span class="c1">// チャンクのデータ長(4byte)</span>
    <span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">;</span>         <span class="c1">// 演奏情報が入っているデータ</span>
<span class="p">};</span>
</code></pre></div>
</div>

<h2>
<span id="チャンク解析" class="fragment"></span><a href="#%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF%E8%A7%A3%E6%9E%90"><i class="fa fa-link"></i></a>チャンク解析</h2>

<p>ここからは、実際の解析コードを交えて解説していきます。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">MIDILoader.cs</span></div>
<div class="highlight"><pre><code>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">NoteData</span><span class="p">&gt;</span> <span class="n">noteList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">NoteData</span><span class="p">&gt;();</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">TempoData</span><span class="p">&gt;</span> <span class="n">tempoList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">TempoData</span><span class="p">&gt;();</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">LoadMIDI</span><span class="p">(</span><span class="kt">string</span> <span class="n">fileName</span><span class="p">)</span>
    <span class="p">{</span>
            <span class="c1">// リスト初期化</span>
            <span class="n">noteList</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
            <span class="n">tempoList</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>

            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryReader</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
            <span class="p">{</span>

</code></pre></div>
</div>

<p>MIDIファイルはバイナリデータのため、バイナリで読み込んでいきます。</p>

<h3>
<span id="ヘッダチャンク解析" class="fragment"></span><a href="#%E3%83%98%E3%83%83%E3%83%80%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF%E8%A7%A3%E6%9E%90"><i class="fa fa-link"></i></a>ヘッダチャンク解析</h3>

<p>まずはヘッダチャンクの解析から。</p>

<div class="code-frame" data-lang="c#"><div class="highlight"><pre><code>                <span class="cm">/* ヘッダチャンク侵入 */</span>
                <span class="kt">var</span> <span class="n">headerChunk</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HeaderChunkData</span><span class="p">();</span>

                <span class="c1">// チャンクID</span>
                <span class="n">headerChunk</span><span class="p">.</span><span class="n">chunkID</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">4</span><span class="p">);</span>

                <span class="c1">// 自分のPCがリトルエンディアンならバイト順を逆に</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="n">IsLittleEndian</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// ヘッダ部のデータ長(値は6固定)</span>
                    <span class="kt">var</span> <span class="n">byteArray</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">4</span><span class="p">);</span>
                    <span class="n">Array</span><span class="p">.</span><span class="nf">Reverse</span><span class="p">(</span><span class="n">byteArray</span><span class="p">);</span>
                    <span class="n">headerChunk</span><span class="p">.</span><span class="n">dataLength</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">byteArray</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                    <span class="c1">// フォーマット(2byte)</span>
                    <span class="n">byteArray</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
                    <span class="n">Array</span><span class="p">.</span><span class="nf">Reverse</span><span class="p">(</span><span class="n">byteArray</span><span class="p">);</span>
                    <span class="n">headerChunk</span><span class="p">.</span><span class="n">format</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">byteArray</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                    <span class="c1">// トラック数(2byte)</span>
                    <span class="n">byteArray</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
                    <span class="n">Array</span><span class="p">.</span><span class="nf">Reverse</span><span class="p">(</span><span class="n">byteArray</span><span class="p">);</span>
                    <span class="n">headerChunk</span><span class="p">.</span><span class="n">tracks</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">byteArray</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                    <span class="c1">// タイムベース(2byte)</span>
                    <span class="n">byteArray</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
                    <span class="n">Array</span><span class="p">.</span><span class="nf">Reverse</span><span class="p">(</span><span class="n">byteArray</span><span class="p">);</span>
                    <span class="n">headerChunk</span><span class="p">.</span><span class="n">division</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">byteArray</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">// ヘッダ部のデータ長(値は6固定)</span>
                    <span class="n">headerChunk</span><span class="p">.</span><span class="n">dataLength</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">4</span><span class="p">),</span> <span class="m">0</span><span class="p">);</span>
                    <span class="c1">// フォーマット(2byte)</span>
                    <span class="n">headerChunk</span><span class="p">.</span><span class="n">format</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">2</span><span class="p">),</span> <span class="m">0</span><span class="p">);</span>
                    <span class="c1">// トラック数(2byte)</span>
                    <span class="n">headerChunk</span><span class="p">.</span><span class="n">tracks</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">2</span><span class="p">),</span> <span class="m">0</span><span class="p">);</span>
                    <span class="c1">// タイムベース(2byte)</span>
                    <span class="n">headerChunk</span><span class="p">.</span><span class="n">division</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt16</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">2</span><span class="p">),</span> <span class="m">0</span><span class="p">);</span>
                <span class="p">}</span>
</code></pre></div></div>

<p>MIDIファイルはビッグエンディアン方式でデータが格納されているため、CPUに応じてバイトオーダー変換を行う必要があります<br>
C#では <code>BitConverter.IsLittleEndian</code> を用いてエンディアンの判定を行います。</p>

<h3>
<span id="トラックチャンク解析" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF%E8%A7%A3%E6%9E%90"><i class="fa fa-link"></i></a>トラックチャンク解析</h3>

<p>次はトラックチャンクの解析です</p>

<div class="code-frame" data-lang="c#"><div class="highlight"><pre><code>                <span class="cm">/* トラックチャンク侵入 */</span>
                <span class="kt">var</span> <span class="n">trackChunks</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TrackChunkData</span><span class="p">[</span><span class="n">headerChunk</span><span class="p">.</span><span class="n">tracks</span><span class="p">];</span>

                <span class="c1">// トラック数ぶん</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">headerChunk</span><span class="p">.</span><span class="n">tracks</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">trackChunks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TrackChunkData</span><span class="p">();</span>

                    <span class="c1">// チャンクID</span>
                    <span class="n">trackChunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chunkID</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">4</span><span class="p">);</span>

                    <span class="c1">// 自分のPCがリトルエンディアンなら変換する</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">BitConverter</span><span class="p">.</span><span class="n">IsLittleEndian</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// トラックのデータ長読み込み(値は6固定)</span>
                        <span class="kt">var</span> <span class="n">byteArray</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">4</span><span class="p">);</span>
                        <span class="n">Array</span><span class="p">.</span><span class="nf">Reverse</span><span class="p">(</span><span class="n">byteArray</span><span class="p">);</span>
                        <span class="n">trackChunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dataLength</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">byteArray</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="n">trackChunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dataLength</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="m">4</span><span class="p">),</span> <span class="m">0</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="c1">// データ部読み込み</span>
                    <span class="n">trackChunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="n">trackChunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dataLength</span><span class="p">);</span>

                    <span class="c1">// データ部解析</span>
                    <span class="nf">TrackDataAnalysis</span><span class="p">(</span><span class="n">trackChunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="n">headerChunk</span><span class="p">);</span>
                <span class="p">}</span>
</code></pre></div></div>

<p>補足<br>
チャンクIDやデータ部をエンディアン変換しないのは1バイトずつで表現されているため。</p>

<h2>
<span id="トラックデータ部解析" class="fragment"></span><a href="#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%87%E3%83%BC%E3%82%BF%E9%83%A8%E8%A7%A3%E6%9E%90"><i class="fa fa-link"></i></a>トラックデータ部解析</h2>

<p>MIDI解析のメインです。ここからノーツや速度変化のイベントを抽出します。</p>

<p>データ部の構成は<br>
前回のイベントからの経過時間(ms) <strong>デルタタイム</strong> <br>
次に <strong>イベントデータ</strong><br>
この２つが繰り返し格納されています。</p>

<p>こちらもコードを交えながら解説していきたいと思います。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">前準備</span></div>
<div class="highlight"><pre><code>    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// トラックデータ解析</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">TrackDataAnalysis</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">,</span> <span class="n">HeaderChunkData</span> <span class="n">headerChunk</span><span class="p">)</span>
    <span class="p">{</span>
            <span class="kt">uint</span> <span class="n">currentTime</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>                    <span class="c1">// デルタタイムを足していく、つまり現在の時間(ms)（ノーツやソフランのイベントタイムはこれを使う）</span>
            <span class="kt">byte</span> <span class="n">statusByte</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>                     <span class="c1">// ステータスバイト</span>
            <span class="kt">bool</span><span class="p">[]</span> <span class="n">longFlags</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">bool</span><span class="p">[</span><span class="m">128</span><span class="p">];</span>    <span class="c1">// ロングノーツ用フラグ</span>

            <span class="c1">// データ分</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">;)</span>
            <span class="p">{</span>
</code></pre></div>
</div>

<h3>
<span id="デルタタイム部解析" class="fragment"></span><a href="#%E3%83%87%E3%83%AB%E3%82%BF%E3%82%BF%E3%82%A4%E3%83%A0%E9%83%A8%E8%A7%A3%E6%9E%90"><i class="fa fa-link"></i></a>デルタタイム部解析</h3>

<p>デルタタイムは <strong>可変長数値表現</strong> を用いてデータ格納されています。</p>

<ul>
<li>１バイトをビット単位に分解し、上位１ビットと下位７ビットに分ける</li>
<li>下位７ビットを数値として表現</li>
<li>上位１ビットが

<ul>
<li>１の場合、次の１バイトも可変長数値として連結し、同じように処理する</li>
<li>０の場合、終了</li>
</ul>
</li>
</ul>

<p>ここはコードを見たほうが分かりやすいかもしれません。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">可変長数値表現をint型に変換する</span></div>
<div class="highlight"><pre><code>                <span class="c1">// デルタタイム格納用</span>
                <span class="kt">uint</span> <span class="n">deltaTime</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">tmp</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>

                    <span class="c1">// 下位7bitを格納</span>
                    <span class="n">deltaTime</span> <span class="p">|=</span> <span class="n">tmp</span> <span class="p">&amp;</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="m">0x7f</span><span class="p">;</span>

                    <span class="c1">// 最上位1bitが0ならデータ終了</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="p">&amp;</span> <span class="m">0x80</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

                    <span class="c1">// 次の下位7bit用にビット移動</span>
                    <span class="n">deltaTime</span> <span class="p">=</span> <span class="n">deltaTime</span> <span class="p">&lt;&lt;</span> <span class="m">7</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// 現在の時間にデルタタイムを足す</span>
                <span class="n">currentTime</span> <span class="p">+=</span> <span class="n">deltaTime</span><span class="p">;</span>
</code></pre></div>
</div>

<h3>
<span id="イベント部解析" class="fragment"></span><a href="#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E9%83%A8%E8%A7%A3%E6%9E%90"><i class="fa fa-link"></i></a>イベント部解析</h3>

<p>構造は単純なのですが、イベントの種類が無駄に多い。</p>

<p>何のイベントかを表す <strong>ステータスバイト</strong> <br>
次に <strong>イベントに沿ったデータ</strong><br>
の２点構成。</p>

<p>まずはステータスバイトから</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">ステータスバイトを保存</span></div>
<div class="highlight"><pre><code>                <span class="cm">/* ランニングステータスチェック */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">&lt;</span> <span class="m">0x80</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// ランニングステータス適応(前回のステータスバイトを使いまわす)</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="c1">// ステータスバイト保存</span>
                    <span class="n">statusByte</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>
                <span class="p">}</span>
</code></pre></div>
</div>

<p>ここで急にでてきた <strong>ランニングステータス</strong> ですが、<br>
名前の割に難しいことはなく、「前回のイベントと同じだから使いまわしてね！」という意味です。<br>
変数を外に出したのはこの使いまわしの為です。</p>

<p>そして、ステータスバイトの値から何のイベントかを特定しデータを解析します。<br>
ステータスバイトのイベント採番や、データの情報は<a href="https://www.csie.ntu.edu.tw/%7Er92092/ref/midi/#midi_event" rel="nofollow noopener" target="_blank">こちらのサイト</a>で詳細に解説されているのでガッツリ参考にさせていただきました。<br>
2020/4/9追記 サイトが見れなくなっているっぽいので<a href="http://faydoc.tripod.com/formats/mid.htm#Track_Chunks" rel="nofollow noopener" target="_blank">代替リンク</a>を追加しました。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">ステータスバイトからイベントを特定し、譜面に使えそうなイベントならデータ解析</span></div>
<div class="highlight"><pre><code>
                <span class="c1">// ステータスバイト後のデータ保存用</span>
                <span class="kt">byte</span> <span class="n">dataByte0</span><span class="p">,</span> <span class="n">dataByte1</span><span class="p">,</span> <span class="n">dataLength</span><span class="p">;</span>

                <span class="cm">/* MIDIイベント(ステータスバイト0x80-0xEF) */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">statusByte</span> <span class="p">&gt;=</span> <span class="m">0x80</span> <span class="p">&amp;&amp;</span> <span class="n">statusByte</span> <span class="p">&lt;=</span> <span class="m">0xef</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">switch</span> <span class="p">(</span><span class="n">statusByte</span> <span class="p">&amp;</span> <span class="m">0xf0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="cm">/* チャンネルメッセージ */</span>

                        <span class="k">case</span> <span class="m">0x80</span><span class="p">:</span>  <span class="c1">// ノートオフ</span>
                            <span class="c1">// どのキーが離されたか</span>
                            <span class="n">dataByte0</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>
                            <span class="c1">// ベロシティ値</span>
                            <span class="n">dataByte1</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>

                            <span class="c1">// 前のレーンがロングノーツなら</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">longFlags</span><span class="p">[</span><span class="n">dataByte0</span><span class="p">])</span>
                            <span class="p">{</span>
                                <span class="c1">// ロング終点ノート情報生成</span>
                                <span class="kt">var</span> <span class="n">note</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NoteData</span><span class="p">();</span>
                                <span class="n">note</span><span class="p">.</span><span class="n">eventTime</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">currentTime</span><span class="p">;</span>
                                <span class="n">note</span><span class="p">.</span><span class="n">laneIndex</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dataByte0</span><span class="p">;</span>
                                <span class="n">note</span><span class="p">.</span><span class="n">type</span> <span class="p">=</span> <span class="n">NoteType</span><span class="p">.</span><span class="n">LongEnd</span><span class="p">;</span>

                                <span class="c1">// リストにつっこむ</span>
                                <span class="n">noteList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">note</span><span class="p">);</span>

                                <span class="c1">// ロングノーツフラグ解除</span>
                                <span class="n">longFlags</span><span class="p">[</span><span class="n">note</span><span class="p">.</span><span class="n">laneIndex</span><span class="p">]</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x90</span><span class="p">:</span>  <span class="c1">// ノートオン(ノートオフが呼ばれるまでは押しっぱなし扱い)</span>
                            <span class="c1">// どのキーが押されたか</span>
                            <span class="n">dataByte0</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>
                            <span class="c1">// ベロシティ値という名の音の強さ。ノートオフメッセージの代わりにここで0を送ってくるタイプもある</span>
                            <span class="n">dataByte1</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>

                            <span class="p">{</span>
                                <span class="c1">// ノート情報生成</span>
                                <span class="kt">var</span> <span class="n">note</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NoteData</span><span class="p">();</span>
                                <span class="n">note</span><span class="p">.</span><span class="n">eventTime</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">currentTime</span><span class="p">;</span>
                                <span class="n">note</span><span class="p">.</span><span class="n">laneIndex</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dataByte0</span><span class="p">;</span>
                                <span class="n">note</span><span class="p">.</span><span class="n">type</span> <span class="p">=</span> <span class="n">NoteType</span><span class="p">.</span><span class="n">Normal</span><span class="p">;</span>
                                <span class="c1">// 独自でやっている。ベロシティ値が最大のときのみロングの始点とする</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">dataByte1</span> <span class="p">==</span> <span class="m">127</span><span class="p">)</span>
                                <span class="p">{</span>
                                   <span class="n">note</span><span class="p">.</span><span class="n">type</span> <span class="p">=</span> <span class="n">NoteType</span><span class="p">.</span><span class="n">LongStart</span><span class="p">;</span>
                                   <span class="c1">// ロングノーツフラグセット</span>
                                   <span class="n">longFlags</span><span class="p">[</span><span class="n">note</span><span class="p">.</span><span class="n">laneIndex</span><span class="p">]</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="c1">// ノートオフイベントではなく、ベロシティ値0をノートオフとして保存する形式もあるので対応</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">dataByte1</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
                                <span class="p">{</span>
                                    <span class="c1">// 同じレーンで前回がロングノーツ始点なら</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">longFlags</span><span class="p">[</span><span class="n">note</span><span class="p">.</span><span class="n">laneIndex</span><span class="p">])</span>
                                    <span class="p">{</span>
                                        <span class="n">note</span><span class="p">.</span><span class="n">type</span> <span class="p">=</span> <span class="n">NoteType</span><span class="p">.</span><span class="n">LongEnd</span><span class="p">;</span>
                                        <span class="c1">// ロングノーツフラグ解除</span>
                                        <span class="n">longFlags</span><span class="p">[</span><span class="n">note</span><span class="p">.</span><span class="n">laneIndex</span><span class="p">]</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>

                                <span class="c1">// リストにつっこむ</span>
                                <span class="n">noteList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">note</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0xa0</span><span class="p">:</span>  <span class="c1">// ポリフォニック キープレッシャー(鍵盤楽器で、キーを押した状態でさらに押し込んだ際に、その圧力に応じて送信される)</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="m">2</span><span class="p">;</span> <span class="c1">// 使わないのでスルー</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0xb0</span><span class="p">:</span>  <span class="c1">// コントロールチェンジ(音量、音質など様々な要素を制御するための命令)</span>
                            <span class="c1">// コントロールする番号</span>
                            <span class="n">dataByte0</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>
                            <span class="c1">// 設定する値</span>
                            <span class="n">dataByte1</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>

                            <span class="c1">// ※0x00-0x77までがコントロールチェンジで、それ以上はチャンネルモードメッセージとして処理する</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">dataByte0</span> <span class="p">&lt;</span> <span class="m">0x78</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="c1">// コントロールチェンジ</span>
                            <span class="p">}</span>
                            <span class="k">else</span>
                            <span class="p">{</span>
                                <span class="c1">// チャンネルモードメッセージは一律データバイトを2つ使用している</span>
                                <span class="c1">// チャンネルモードメッセージ</span>
                                <span class="k">switch</span> <span class="p">(</span><span class="n">dataByte0</span><span class="p">)</span>
                                <span class="p">{</span>
                                    <span class="k">case</span> <span class="m">0x78</span><span class="p">:</span>  <span class="c1">// オールサウンドオフ</span>
                                        <span class="c1">// 該当するチャンネルの発音中の音を直ちに消音する。後述のオールノートオフより強制力が強い。</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="k">case</span> <span class="m">0x79</span><span class="p">:</span>  <span class="c1">// リセットオールコントローラ</span>
                                        <span class="c1">// 該当するチャンネルの全種類のコントロール値を初期化する。</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="k">case</span> <span class="m">0x7a</span><span class="p">:</span>  <span class="c1">// ローカルコントロール</span>
                                        <span class="c1">// オフ:鍵盤を弾くとMIDIメッセージは送信されるがピアノ自体から音は出ない</span>
                                        <span class="c1">// オン:鍵盤を弾くと音源から音が出る(基本こっち)</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="k">case</span> <span class="m">0x7b</span><span class="p">:</span>  <span class="c1">// オールノートオフ</span>
                                        <span class="c1">// 該当するチャンネルの発音中の音すべてに対してノートオフ命令を出す</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="cm">/* MIDIモード設定 */</span>
                                    <span class="c1">// オムニのオン・オフとモノ・ポリモードを組み合わせて4種類のモードがある</span>
                                    <span class="k">case</span> <span class="m">0x7c</span><span class="p">:</span>  <span class="c1">// オムニモードオフ</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="k">case</span> <span class="m">0x7d</span><span class="p">:</span>  <span class="c1">// オムニモードオン</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="k">case</span> <span class="m">0x7e</span><span class="p">:</span>  <span class="c1">// モノモードオン</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="k">case</span> <span class="m">0x7f</span><span class="p">:</span>  <span class="c1">// モノモードオン</span>
                                        <span class="k">break</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                            <span class="k">break</span><span class="p">;</span>

                        <span class="k">case</span> <span class="m">0xc0</span><span class="p">:</span>  <span class="c1">// プログラムチェンジ(音色を変える命令)</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="m">1</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>

                        <span class="k">case</span> <span class="m">0xd0</span><span class="p">:</span>  <span class="c1">// チャンネルプレッシャー(概ねポリフォニック キープレッシャーと同じだが、違いはそのチャンネルの全ノートナンバーに対して有効となる)</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="m">1</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>

                        <span class="k">case</span> <span class="m">0xe0</span><span class="p">:</span>  <span class="c1">// ピッチベンド(ウォェーンウェューンの表現で使う)</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="m">2</span><span class="p">;</span>
                            <span class="c1">// ボルテのつまみみたいなのを実装する場合、ここの値が役立つかも</span>
                            <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="cm">/* システムエクスクルーシブ (SysEx) イベント*/</span>
                <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">statusByte</span> <span class="p">==</span> <span class="m">0x70</span> <span class="p">||</span> <span class="n">statusByte</span> <span class="p">==</span> <span class="m">0x7f</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">dataLength</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>
                    <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="cm">/* メタイベント*/</span>
                <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">statusByte</span> <span class="p">==</span> <span class="m">0xff</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// メタイベントの番号</span>
                    <span class="kt">byte</span> <span class="n">metaEventID</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>
                    <span class="c1">// データ長</span>
                    <span class="n">dataLength</span> <span class="p">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>

                    <span class="k">switch</span> <span class="p">(</span><span class="n">metaEventID</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">case</span> <span class="m">0x00</span><span class="p">:</span>  <span class="c1">// シーケンスメッセージ</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x01</span><span class="p">:</span>  <span class="c1">// テキストイベント</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x02</span><span class="p">:</span>  <span class="c1">// 著作権表示</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x03</span><span class="p">:</span>  <span class="c1">// シーケンス/トラック名</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x04</span><span class="p">:</span>  <span class="c1">// 楽器名</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x05</span><span class="p">:</span>  <span class="c1">// 歌詞</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x06</span><span class="p">:</span>  <span class="c1">// マーカー</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x07</span><span class="p">:</span>  <span class="c1">// キューポイント</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x20</span><span class="p">:</span>  <span class="c1">// MIDIチャンネルプリフィクス</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x21</span><span class="p">:</span>  <span class="c1">// MIDIポートプリフィックス</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x2f</span><span class="p">:</span>  <span class="c1">// トラック終了</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="c1">// ここでループを抜けても良い</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x51</span><span class="p">:</span>  <span class="c1">// テンポ変更</span>
                            <span class="p">{</span>
                                <span class="c1">// テンポ変更情報リストに格納する</span>
                                <span class="kt">var</span> <span class="n">tempoData</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TempoData</span><span class="p">();</span>
                                <span class="n">tempoData</span><span class="p">.</span><span class="n">eventTime</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">currentTime</span><span class="p">;</span>

                                <span class="c1">// ４分音符の長さをマイクロ秒単位で格納されている</span>
                                <span class="kt">uint</span> <span class="n">tempo</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                                <span class="n">tempo</span> <span class="p">|=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>
                                <span class="n">tempo</span> <span class="p">&lt;&lt;=</span> <span class="m">8</span><span class="p">;</span>
                                <span class="n">tempo</span> <span class="p">|=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>
                                <span class="n">tempo</span> <span class="p">&lt;&lt;=</span> <span class="m">8</span><span class="p">;</span>
                                <span class="n">tempo</span> <span class="p">|=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">++];</span>

                                <span class="c1">// BPM割り出し</span>
                                <span class="n">tempoData</span><span class="p">.</span><span class="n">bpm</span> <span class="p">=</span> <span class="m">60000000</span> <span class="p">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">tempo</span><span class="p">;</span>

                                <span class="c1">// 小数点第1で切り捨て処理(10にすると第一位、100にすると第2位まで切り捨てられる)</span>
                                <span class="n">tempoData</span><span class="p">.</span><span class="n">bpm</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">Floor</span><span class="p">(</span><span class="n">tempoData</span><span class="p">.</span><span class="n">bpm</span> <span class="p">*</span> <span class="m">10</span><span class="p">)</span> <span class="p">/</span> <span class="m">10</span><span class="p">;</span>

                                <span class="c1">// tick値割り出し</span>
                                <span class="n">tempoData</span><span class="p">.</span><span class="n">tick</span> <span class="p">=</span> <span class="p">(</span><span class="m">60</span> <span class="p">/</span> <span class="n">tempoData</span><span class="p">.</span><span class="n">bpm</span> <span class="p">/</span> <span class="n">headerChunk</span><span class="p">.</span><span class="n">division</span> <span class="p">*</span> <span class="m">1000</span><span class="p">);</span>

                                <span class="c1">// リストにつっこむ</span>
                                <span class="n">tempoList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">tempoData</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x54</span><span class="p">:</span>  <span class="c1">// SMTPEオフセット</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x58</span><span class="p">:</span>  <span class="c1">// 拍子</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="c1">// 小節線を表示させるなら使えるかも</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x59</span><span class="p">:</span>  <span class="c1">// 調号</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="m">0x7f</span><span class="p">:</span>  <span class="c1">// シーケンサ固有メタイベント</span>
                            <span class="n">i</span> <span class="p">+=</span> <span class="n">dataLength</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
</code></pre></div>
</div>

<p>これでノーツイベントとBPM変更イベントを格納し、音ゲーの基本的な譜面データが揃いました。<br>
あともう一歩です。</p>

<h3>
<span id="イベントタイム再計算" class="fragment"></span><a href="#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%BF%E3%82%A4%E3%83%A0%E5%86%8D%E8%A8%88%E7%AE%97"><i class="fa fa-link"></i></a>イベントタイム再計算</h3>

<p>MIDIファイルのイベントデルタタイムは全て最初に設定されたテンポから計算されているため、<br>
各イベント時間をその時に設定されている状態のテンポで計算しなおす必要があります。</p>

<div class="code-frame" data-lang="c#">
<div class="code-lang"><span class="bold">MIDILoader.cs</span></div>
<div class="highlight"><pre><code>    <span class="k">void</span> <span class="nf">ModificationEventTimes</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// 一時格納用（計算前の時間を保持したいため）</span>
        <span class="kt">var</span> <span class="n">tempTempoList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">TempoData</span><span class="p">&gt;(</span><span class="n">tempoList</span><span class="p">);</span>

        <span class="c1">// テンポイベント時間修正</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">tempoList</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">TempoData</span> <span class="n">tempo</span> <span class="p">=</span> <span class="n">tempoList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

            <span class="kt">int</span> <span class="n">timeDifference</span> <span class="p">=</span> <span class="n">tempTempoList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eventTime</span> <span class="p">-</span> <span class="n">tempTempoList</span><span class="p">[</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span><span class="p">].</span><span class="n">eventTime</span><span class="p">;</span>
            <span class="n">tempo</span><span class="p">.</span><span class="n">eventTime</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">timeDifference</span> <span class="p">*</span> <span class="n">tempoList</span><span class="p">[</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span><span class="p">].</span><span class="n">tick</span><span class="p">)</span> <span class="p">+</span> <span class="n">tempoList</span><span class="p">[</span><span class="n">i</span> <span class="p">-</span> <span class="m">1</span><span class="p">].</span><span class="n">eventTime</span><span class="p">;</span>

            <span class="n">tempoList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">tempo</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ノーツイベント時間修正</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">noteList</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="n">tempoList</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">j</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span><span class="p">--)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">noteList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eventTime</span> <span class="p">&gt;=</span> <span class="n">tempTempoList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">eventTime</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">NoteData</span> <span class="n">note</span> <span class="p">=</span> <span class="n">noteList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

                    <span class="kt">int</span> <span class="n">timeDifference</span> <span class="p">=</span> <span class="n">noteList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eventTime</span> <span class="p">-</span> <span class="n">tempTempoList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">eventTime</span><span class="p">;</span>
                    <span class="n">note</span><span class="p">.</span><span class="n">eventTime</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">timeDifference</span> <span class="p">*</span> <span class="n">tempTempoList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">tick</span><span class="p">)</span> <span class="p">+</span> <span class="n">tempoList</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">eventTime</span><span class="p">;</span>   <span class="c1">// 計算後のテンポ変更イベント時間+そこからの自分の時間</span>
                    <span class="n">noteList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="n">note</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
</div>

<p>以上でMIDIファイルから譜面データ( <code>noteList</code> , <code>tempoList</code> )を作るコードは終了となります。</p>

<p>本当は譜面データを元にUnity上で動かすまで書きたかったのですが、あまりに長くなってしまう（あと間に合わなかった…）ので今回はここで閉めさせていただきます…ゴメンナサイ</p>

<h2>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h2>

<p>めちゃ長くなってしまいましたが、最後までお読みいただきありがとうございました。<br>
この記事が音ゲーを作ってみたいと思う人への手助けになれば私は幸せです。</p>

<h2>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h2>

<p><a href="https://ja.wikipedia.org/wiki/%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%80%E3%83%BC%E3%83%89MIDI%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB" rel="nofollow noopener" target="_blank">スタンダードMIDIファイル</a><br>
<a href="https://www.csie.ntu.edu.tw/%7Er92092/ref/midi/#midi_event" rel="nofollow noopener" target="_blank">The MIDI File Format</a><br>
<a href="https://cyber-rainforce.net/2018/01/10/midtimeconv-src/" rel="nofollow noopener" target="_blank">MIDIファイル解析ソースコードの紹介</a><br>
<a href="http://torasukenote.blog120.fc2.com/blog-entry-104.html" rel="nofollow noopener" target="_blank">C言語でMIDI(SMF)データを読んでみる！</a><br>
<a href="https://qiita.com/PianoScoreJP/items/0c5ad3c6becec3c79746" id="reference-b90b11742f3788edefdf">JavaScriptで可変長数値表現を使う</a></p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fowts%2Fitems%2F8d641e8a8a423566db71&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fowts%2Fitems%2F8d641e8a8a423566db71&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/owts/items/8d641e8a8a423566db71/likers" class="css-1iupg5d">24</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">13</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/8d641e8a8a423566db71/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/owts/items/8d641e8a8a423566db71/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/owts/items/8d641e8a8a423566db71/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/owts/items/8d641e8a8a423566db71/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/owts/items/8d641e8a8a423566db71.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-82271995-d02c-4424-8a8f-9f2f963322fe">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-283bfb77-d380-4a9a-9d2c-7afa9f413f77"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-283bfb77-d380-4a9a-9d2c-7afa9f413f77">{}</script>
      
<div id="LoginModal-react-component-3fb78b04-b536-468b-ad7f-04298afb40ee"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-3fb78b04-b536-468b-ad7f-04298afb40ee">{}</script>
      
<div id="StockModal-react-component-482895dd-c412-4431-b0d9-c113fab32138"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-482895dd-c412-4431-b0d9-c113fab32138">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;3Xuk99NwE9nbnWefyKSsOywqJzPu1/LxGQnTGif23gybTDjLccsX7UZXUTdHJjJCa/+ockDNXerTROjbYbUCnQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003eこの記事は、\u003ca href=\"https://qiita.com/advent-calendar/2018/klab\"\u003eKLab Engineer Advent Calendar 2018\u003c/a\u003e 19日目の記事です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"standard-midi-file-とは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#standard-midi-file-%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eStandard MIDI File とは\u003c/h2\u003e\n\n\u003cp\u003e一言で表すなら、「どの音符をどのタイミングで鳴らすか」等の演奏に関する全ての情報が入っているファイルです。\u003cbr\u003e\nこれだけ聞くと音ゲーの譜面みたいですね！その通りです！\u003c/p\u003e\n\n\u003cp\u003eこの記事ではMIDIファイルから音ゲーに使えそうな譜面データに変換するプログラムを書きつつ解説します。\u003cbr\u003e\nレーンに沿って流れてくるタイプの音ゲーの譜面を作るのにとても有効な手法です。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"譜面用構造体の定義\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AD%9C%E9%9D%A2%E7%94%A8%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AE%E5%AE%9A%E7%BE%A9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e譜面用構造体の定義\u003c/h2\u003e\n\n\u003cp\u003eMIDI解析の前準備としてノーツイベントとBPMイベントの構造体を定義します。\u003cbr\u003e\n実際の譜面データになるものです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003eNoteType\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eNormal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// 通常ノーツ\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eLongStart\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e   \u003cspan class=\"c1\"\u003e// ロング開始\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eLongEnd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e     \u003cspan class=\"c1\"\u003e// ロング終端\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eNoteData\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ノーツタイミング(ms)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elaneIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// レーン番号\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eNoteType\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e   \u003cspan class=\"c1\"\u003e// ノーツの種類\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eTempoData\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// BPM変化のタイミング(ms)\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ebpm\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// BPM値\u003c/span\u003e\n  \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003etick\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// tick値\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"midiファイル構成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#midi%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E6%A7%8B%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eMIDIファイル構成\u003c/h2\u003e\n\n\u003cp\u003eデータ構造ですが、大きく分けて\u003cbr\u003e\n・ヘッダチャンク\u003cbr\u003e\n・トラックチャンク\u003cbr\u003e\nの2部で構成されています。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ヘッダチャンク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%98%E3%83%83%E3%83%80%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eヘッダチャンク\u003c/h3\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eヘッダチャンク\u003c/th\u003e\n\u003cth\u003eバイト数\u003c/th\u003e\n\u003cth\u003e補足\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eチャンクID\u003c/td\u003e\n\u003ctd\u003e4byte\u003c/td\u003e\n\u003ctd\u003eチャンクID　\"MThd\" で固定\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eデータ長\u003c/td\u003e\n\u003ctd\u003e4byte\u003c/td\u003e\n\u003ctd\u003e続くチャンクのデータ長　\"6\" で固定\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eフォーマット\u003c/td\u003e\n\u003ctd\u003e2byte\u003c/td\u003e\n\u003ctd\u003eフォーマット\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eトラック数\u003c/td\u003e\n\u003ctd\u003e2byte\u003c/td\u003e\n\u003ctd\u003e\u003cstrong\u003e後のトラックチャンクの個数\u003c/strong\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e分能値\u003c/td\u003e\n\u003ctd\u003e2byte\u003c/td\u003e\n\u003ctd\u003eタイムベース　大体480\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"トラックチャンク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eトラックチャンク\u003c/h3\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eトラックチャンク\u003c/th\u003e\n\u003cth\u003eバイト数\u003c/th\u003e\n\u003cth\u003e補足\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eチャンクID\u003c/td\u003e\n\u003ctd\u003e4byte\u003c/td\u003e\n\u003ctd\u003eチャンクID　 \"MTrk\" で固定\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eデータ長\u003c/td\u003e\n\u003ctd\u003e4byte\u003c/td\u003e\n\u003ctd\u003eデータ部のサイズ\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eデータ部\u003c/td\u003e\n\u003ctd\u003e可変\u003c/td\u003e\n\u003ctd\u003eメインのデータ部分\u003cbr\u003e \u003cstrong\u003eここにノートイベント等の情報が格納\u003c/strong\u003e\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003eこちらを構造体にします\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eチャンクデータ用構造体\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// ヘッダーチャンク情報を格納する構造体\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eHeaderChunkData\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003echunkID\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// チャンクのIDを示す(4byte)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// チャンクのデータ長(4byte)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eformat\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// MIDIファイルフォーマット(2byte)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003etracks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// トラック数(2byte)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003edivision\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// タイムベース MIDI独自の時間の最小単位をtickと呼び、4分音符あたりのtick数がタイムベース 大体480(2byte)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// トラックチャンク情報を格納する構造体\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eTrackChunkData\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003echunkID\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// チャンクのIDを示す(4byte)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// チャンクのデータ長(4byte)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e         \u003cspan class=\"c1\"\u003e// 演奏情報が入っているデータ\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"チャンク解析\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF%E8%A7%A3%E6%9E%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eチャンク解析\u003c/h2\u003e\n\n\u003cp\u003eここからは、実際の解析コードを交えて解説していきます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMIDILoader.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNoteData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003enoteList\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eNoteData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eLoadMIDI\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003efileName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// リスト初期化\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enoteList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eClear\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003estream\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFileStream\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efileName\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileMode\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFileAccess\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRead\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eBinaryReader\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estream\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eMIDIファイルはバイナリデータのため、バイナリで読み込んでいきます。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"ヘッダチャンク解析\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%98%E3%83%83%E3%83%80%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF%E8%A7%A3%E6%9E%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eヘッダチャンク解析\u003c/h3\u003e\n\n\u003cp\u003eまずはヘッダチャンクの解析から。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e                \u003cspan class=\"cm\"\u003e/* ヘッダチャンク侵入 */\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eHeaderChunkData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e// チャンクID\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003echunkID\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e// 自分のPCがリトルエンディアンならバイト順を逆に\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsLittleEndian\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// ヘッダ部のデータ長(値は6固定)\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReverse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edataLength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// フォーマット(2byte)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReverse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eformat\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt16\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// トラック数(2byte)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReverse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etracks\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt16\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// タイムベース(2byte)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReverse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edivision\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt16\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// ヘッダ部のデータ長(値は6固定)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edataLength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// フォーマット(2byte)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eformat\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt16\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// トラック数(2byte)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etracks\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt16\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// タイムベース(2byte)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edivision\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt16\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eMIDIファイルはビッグエンディアン方式でデータが格納されているため、CPUに応じてバイトオーダー変換を行う必要があります\u003cbr\u003e\nC#では \u003ccode\u003eBitConverter.IsLittleEndian\u003c/code\u003e を用いてエンディアンの判定を行います。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"トラックチャンク解析\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF%E8%A7%A3%E6%9E%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eトラックチャンク解析\u003c/h3\u003e\n\n\u003cp\u003e次はトラックチャンクの解析です\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e                \u003cspan class=\"cm\"\u003e/* トラックチャンク侵入 */\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etrackChunks\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eTrackChunkData\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etracks\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n                \u003cspan class=\"c1\"\u003e// トラック数ぶん\u003c/span\u003e\n                \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etracks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003etrackChunks\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eTrackChunkData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e// チャンクID\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003etrackChunks\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003echunkID\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e// 自分のPCがリトルエンディアンなら変換する\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsLittleEndian\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"c1\"\u003e// トラックのデータ長読み込み(値は6固定)\u003c/span\u003e\n                        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eArray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReverse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003etrackChunks\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003edataLength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebyteArray\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003etrackChunks\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003edataLength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBitConverter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eToInt32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e// データ部読み込み\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003etrackChunks\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etrackChunks\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e// データ部解析\u003c/span\u003e\n                    \u003cspan class=\"nf\"\u003eTrackDataAnalysis\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etrackChunks\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e補足\u003cbr\u003e\nチャンクIDやデータ部をエンディアン変換しないのは1バイトずつで表現されているため。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"トラックデータ部解析\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%87%E3%83%BC%E3%82%BF%E9%83%A8%E8%A7%A3%E6%9E%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eトラックデータ部解析\u003c/h2\u003e\n\n\u003cp\u003eMIDI解析のメインです。ここからノーツや速度変化のイベントを抽出します。\u003c/p\u003e\n\n\u003cp\u003eデータ部の構成は\u003cbr\u003e\n前回のイベントからの経過時間(ms) \u003cstrong\u003eデルタタイム\u003c/strong\u003e \u003cbr\u003e\n次に \u003cstrong\u003eイベントデータ\u003c/strong\u003e\u003cbr\u003e\nこの２つが繰り返し格納されています。\u003c/p\u003e\n\n\u003cp\u003eこちらもコードを交えながら解説していきたいと思います。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e前準備\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e    \u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// トラックデータ解析\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e/// \u0026lt;/summary\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eTrackDataAnalysis\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eHeaderChunkData\u003c/span\u003e \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                    \u003cspan class=\"c1\"\u003e// デルタタイムを足していく、つまり現在の時間(ms)（ノーツやソフランのイベントタイムはこれを使う）\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003estatusByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                     \u003cspan class=\"c1\"\u003e// ステータスバイト\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003elongFlags\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e128\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// ロングノーツ用フラグ\u003c/span\u003e\n\n            \u003cspan class=\"c1\"\u003e// データ分\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"デルタタイム部解析\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%87%E3%83%AB%E3%82%BF%E3%82%BF%E3%82%A4%E3%83%A0%E9%83%A8%E8%A7%A3%E6%9E%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eデルタタイム部解析\u003c/h3\u003e\n\n\u003cp\u003eデルタタイムは \u003cstrong\u003e可変長数値表現\u003c/strong\u003e を用いてデータ格納されています。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e１バイトをビット単位に分解し、上位１ビットと下位７ビットに分ける\u003c/li\u003e\n\u003cli\u003e下位７ビットを数値として表現\u003c/li\u003e\n\u003cli\u003e上位１ビットが\n\n\u003cul\u003e\n\u003cli\u003e１の場合、次の１バイトも可変長数値として連結し、同じように処理する\u003c/li\u003e\n\u003cli\u003e０の場合、終了\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eここはコードを見たほうが分かりやすいかもしれません。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003e可変長数値表現をint型に変換する\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e                \u003cspan class=\"c1\"\u003e// デルタタイム格納用\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003edeltaTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e// 下位7bitを格納\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003edeltaTime\u003c/span\u003e \u003cspan class=\"p\"\u003e|=\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"m\"\u003e0x7f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e// 最上位1bitが0ならデータ終了\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x80\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                    \u003cspan class=\"c1\"\u003e// 次の下位7bit用にビット移動\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003edeltaTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edeltaTime\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e7\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"c1\"\u003e// 現在の時間にデルタタイムを足す\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecurrentTime\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edeltaTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"イベント部解析\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E9%83%A8%E8%A7%A3%E6%9E%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eイベント部解析\u003c/h3\u003e\n\n\u003cp\u003e構造は単純なのですが、イベントの種類が無駄に多い。\u003c/p\u003e\n\n\u003cp\u003e何のイベントかを表す \u003cstrong\u003eステータスバイト\u003c/strong\u003e \u003cbr\u003e\n次に \u003cstrong\u003eイベントに沿ったデータ\u003c/strong\u003e\u003cbr\u003e\nの２点構成。\u003c/p\u003e\n\n\u003cp\u003eまずはステータスバイトから\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eステータスバイトを保存\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e                \u003cspan class=\"cm\"\u003e/* ランニングステータスチェック */\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x80\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// ランニングステータス適応(前回のステータスバイトを使いまわす)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// ステータスバイト保存\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003estatusByte\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eここで急にでてきた \u003cstrong\u003eランニングステータス\u003c/strong\u003e ですが、\u003cbr\u003e\n名前の割に難しいことはなく、「前回のイベントと同じだから使いまわしてね！」という意味です。\u003cbr\u003e\n変数を外に出したのはこの使いまわしの為です。\u003c/p\u003e\n\n\u003cp\u003eそして、ステータスバイトの値から何のイベントかを特定しデータを解析します。\u003cbr\u003e\nステータスバイトのイベント採番や、データの情報は\u003ca href=\"https://www.csie.ntu.edu.tw/%7Er92092/ref/midi/#midi_event\" rel=\"nofollow noopener\" target=\"_blank\"\u003eこちらのサイト\u003c/a\u003eで詳細に解説されているのでガッツリ参考にさせていただきました。\u003cbr\u003e\n2020/4/9追記 サイトが見れなくなっているっぽいので\u003ca href=\"http://faydoc.tripod.com/formats/mid.htm#Track_Chunks\" rel=\"nofollow noopener\" target=\"_blank\"\u003e代替リンク\u003c/a\u003eを追加しました。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eステータスバイトからイベントを特定し、譜面に使えそうなイベントならデータ解析\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e\n                \u003cspan class=\"c1\"\u003e// ステータスバイト後のデータ保存用\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003edataByte0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edataByte1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                \u003cspan class=\"cm\"\u003e/* MIDIイベント(ステータスバイト0x80-0xEF) */\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estatusByte\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0x80\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003estatusByte\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0xef\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estatusByte\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"m\"\u003e0xf0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"cm\"\u003e/* チャンネルメッセージ */\u003c/span\u003e\n\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x80\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ノートオフ\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// どのキーが離されたか\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003edataByte0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// ベロシティ値\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003edataByte1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n\n                            \u003cspan class=\"c1\"\u003e// 前のレーンがロングノーツなら\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elongFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003edataByte0\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"c1\"\u003e// ロング終点ノート情報生成\u003c/span\u003e\n                                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enote\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNoteData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elaneIndex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003edataByte0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNoteType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLongEnd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                                \u003cspan class=\"c1\"\u003e// リストにつっこむ\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003enoteList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                                \u003cspan class=\"c1\"\u003e// ロングノーツフラグ解除\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003elongFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elaneIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x90\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ノートオン(ノートオフが呼ばれるまでは押しっぱなし扱い)\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// どのキーが押されたか\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003edataByte0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// ベロシティ値という名の音の強さ。ノートオフメッセージの代わりにここで0を送ってくるタイプもある\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003edataByte1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"c1\"\u003e// ノート情報生成\u003c/span\u003e\n                                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003enote\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNoteData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elaneIndex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003edataByte0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNoteType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNormal\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"c1\"\u003e// 独自でやっている。ベロシティ値が最大のときのみロングの始点とする\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edataByte1\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e127\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                   \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNoteType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLongStart\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                   \u003cspan class=\"c1\"\u003e// ロングノーツフラグセット\u003c/span\u003e\n                                   \u003cspan class=\"n\"\u003elongFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elaneIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                                \u003cspan class=\"c1\"\u003e// ノートオフイベントではなく、ベロシティ値0をノートオフとして保存する形式もあるので対応\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edataByte1\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                    \u003cspan class=\"c1\"\u003e// 同じレーンで前回がロングノーツ始点なら\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elongFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elaneIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n                                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                        \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNoteType\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLongEnd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                        \u003cspan class=\"c1\"\u003e// ロングノーツフラグ解除\u003c/span\u003e\n                                        \u003cspan class=\"n\"\u003elongFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elaneIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                                \u003cspan class=\"c1\"\u003e// リストにつっこむ\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003enoteList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0xa0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ポリフォニック キープレッシャー(鍵盤楽器で、キーを押した状態でさらに押し込んだ際に、その圧力に応じて送信される)\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 使わないのでスルー\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0xb0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// コントロールチェンジ(音量、音質など様々な要素を制御するための命令)\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// コントロールする番号\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003edataByte0\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// 設定する値\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003edataByte1\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n\n                            \u003cspan class=\"c1\"\u003e// ※0x00-0x77までがコントロールチェンジで、それ以上はチャンネルモードメッセージとして処理する\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edataByte0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0x78\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"c1\"\u003e// コントロールチェンジ\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"c1\"\u003e// チャンネルモードメッセージは一律データバイトを2つ使用している\u003c/span\u003e\n                                \u003cspan class=\"c1\"\u003e// チャンネルモードメッセージ\u003c/span\u003e\n                                \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edataByte0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x78\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// オールサウンドオフ\u003c/span\u003e\n                                        \u003cspan class=\"c1\"\u003e// 該当するチャンネルの発音中の音を直ちに消音する。後述のオールノートオフより強制力が強い。\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x79\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// リセットオールコントローラ\u003c/span\u003e\n                                        \u003cspan class=\"c1\"\u003e// 該当するチャンネルの全種類のコントロール値を初期化する。\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x7a\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ローカルコントロール\u003c/span\u003e\n                                        \u003cspan class=\"c1\"\u003e// オフ:鍵盤を弾くとMIDIメッセージは送信されるがピアノ自体から音は出ない\u003c/span\u003e\n                                        \u003cspan class=\"c1\"\u003e// オン:鍵盤を弾くと音源から音が出る(基本こっち)\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x7b\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// オールノートオフ\u003c/span\u003e\n                                        \u003cspan class=\"c1\"\u003e// 該当するチャンネルの発音中の音すべてに対してノートオフ命令を出す\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                    \u003cspan class=\"cm\"\u003e/* MIDIモード設定 */\u003c/span\u003e\n                                    \u003cspan class=\"c1\"\u003e// オムニのオン・オフとモノ・ポリモードを組み合わせて4種類のモードがある\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x7c\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// オムニモードオフ\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x7d\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// オムニモードオン\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x7e\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// モノモードオン\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x7f\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// モノモードオン\u003c/span\u003e\n                                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0xc0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// プログラムチェンジ(音色を変える命令)\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0xd0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// チャンネルプレッシャー(概ねポリフォニック キープレッシャーと同じだが、違いはそのチャンネルの全ノートナンバーに対して有効となる)\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0xe0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// ピッチベンド(ウォェーンウェューンの表現で使う)\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// ボルテのつまみみたいなのを実装する場合、ここの値が役立つかも\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"cm\"\u003e/* システムエクスクルーシブ (SysEx) イベント*/\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estatusByte\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0x70\u003c/span\u003e \u003cspan class=\"p\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003estatusByte\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0x7f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"cm\"\u003e/* メタイベント*/\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estatusByte\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0xff\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// メタイベントの番号\u003c/span\u003e\n                    \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"n\"\u003emetaEventID\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n                    \u003cspan class=\"c1\"\u003e// データ長\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n\n                    \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emetaEventID\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x00\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// シーケンスメッセージ\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x01\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// テキストイベント\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x02\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 著作権表示\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x03\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// シーケンス/トラック名\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x04\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 楽器名\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x05\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 歌詞\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x06\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// マーカー\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x07\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// キューポイント\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x20\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// MIDIチャンネルプリフィクス\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x21\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// MIDIポートプリフィックス\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x2f\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// トラック終了\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// ここでループを抜けても良い\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x51\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// テンポ変更\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                                \u003cspan class=\"c1\"\u003e// テンポ変更情報リストに格納する\u003c/span\u003e\n                                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etempoData\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eTempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                                \u003cspan class=\"c1\"\u003e// ４分音符の長さをマイクロ秒単位で格納されている\u003c/span\u003e\n                                \u003cspan class=\"kt\"\u003euint\u003c/span\u003e \u003cspan class=\"n\"\u003etempo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempo\u003c/span\u003e \u003cspan class=\"p\"\u003e|=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempo\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempo\u003c/span\u003e \u003cspan class=\"p\"\u003e|=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempo\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempo\u003c/span\u003e \u003cspan class=\"p\"\u003e|=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++];\u003c/span\u003e\n\n                                \u003cspan class=\"c1\"\u003e// BPM割り出し\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebpm\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e60000000\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003etempo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                                \u003cspan class=\"c1\"\u003e// 小数点第1で切り捨て処理(10にすると第一位、100にすると第2位まで切り捨てられる)\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebpm\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMathf\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eFloor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebpm\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n                                \u003cspan class=\"c1\"\u003e// tick値割り出し\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etick\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e60\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003etempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebpm\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eheaderChunk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edivision\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n                                \u003cspan class=\"c1\"\u003e// リストにつっこむ\u003c/span\u003e\n                                \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x54\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// SMTPEオフセット\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x58\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 拍子\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"c1\"\u003e// 小節線を表示させるなら使えるかも\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x59\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 調号\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0x7f\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// シーケンサ固有メタイベント\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003edataLength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこれでノーツイベントとBPM変更イベントを格納し、音ゲーの基本的な譜面データが揃いました。\u003cbr\u003e\nあともう一歩です。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"イベントタイム再計算\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%BF%E3%82%A4%E3%83%A0%E5%86%8D%E8%A8%88%E7%AE%97\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eイベントタイム再計算\u003c/h3\u003e\n\n\u003cp\u003eMIDIファイルのイベントデルタタイムは全て最初に設定されたテンポから計算されているため、\u003cbr\u003e\n各イベント時間をその時に設定されている状態のテンポで計算しなおす必要があります。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"c#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eMIDILoader.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eModificationEventTimes\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 一時格納用（計算前の時間を保持したいため）\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etempTempoList\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTempoData\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// テンポイベント時間修正\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eTempoData\u003c/span\u003e \u003cspan class=\"n\"\u003etempo\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimeDifference\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etempTempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003etempTempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etempo\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003etimeDifference\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003etick\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etempo\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// ノーツイベント時間修正\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003enoteList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e--)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enoteList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003etempTempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eNoteData\u003c/span\u003e \u003cspan class=\"n\"\u003enote\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enoteList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n                    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003etimeDifference\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enoteList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003etempTempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003etimeDifference\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003etempTempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003etick\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003etempoList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eeventTime\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e   \u003cspan class=\"c1\"\u003e// 計算後のテンポ変更イベント時間+そこからの自分の時間\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003enoteList\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enote\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e以上でMIDIファイルから譜面データ( \u003ccode\u003enoteList\u003c/code\u003e , \u003ccode\u003etempoList\u003c/code\u003e )を作るコードは終了となります。\u003c/p\u003e\n\n\u003cp\u003e本当は譜面データを元にUnity上で動かすまで書きたかったのですが、あまりに長くなってしまう（あと間に合わなかった…）ので今回はここで閉めさせていただきます…ゴメンナサイ\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"終わりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e終わりに\u003c/h2\u003e\n\n\u003cp\u003eめちゃ長くなってしまいましたが、最後までお読みいただきありがとうございました。\u003cbr\u003e\nこの記事が音ゲーを作ってみたいと思う人への手助けになれば私は幸せです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"参考\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://ja.wikipedia.org/wiki/%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%80%E3%83%BC%E3%83%89MIDI%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\" rel=\"nofollow noopener\" target=\"_blank\"\u003eスタンダードMIDIファイル\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://www.csie.ntu.edu.tw/%7Er92092/ref/midi/#midi_event\" rel=\"nofollow noopener\" target=\"_blank\"\u003eThe MIDI File Format\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://cyber-rainforce.net/2018/01/10/midtimeconv-src/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMIDIファイル解析ソースコードの紹介\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"http://torasukenote.blog120.fc2.com/blog-entry-104.html\" rel=\"nofollow noopener\" target=\"_blank\"\u003eC言語でMIDI(SMF)データを読んでみる！\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://qiita.com/PianoScoreJP/items/0c5ad3c6becec3c79746\" id=\"reference-b90b11742f3788edefdf\"\u003eJavaScriptで可変長数値表現を使う\u003c/a\u003e\u003c/p\u003e\n","createdAt":"2018-12-17T15:44:34Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"CfeNJlo7I2Wz0wCM+MTwtzHAruTMley7--pYCWaeZnZxrJSzs9--AOY7/BU2YxM9AUdAqLTxPA==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2021-08-22T08:26:12Z","likesCount":24,"linkUrl":"https://qiita.com/owts/items/8d641e8a8a423566db71","organization":null,"originalId":743827,"stockedCount":13,"title":"Stardard MIDI Fileを解析して音ゲーの譜面を作る話","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#standard-midi-file-%E3%81%A8%E3%81%AF\"\u003eStandard MIDI File とは\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AD%9C%E9%9D%A2%E7%94%A8%E6%A7%8B%E9%80%A0%E4%BD%93%E3%81%AE%E5%AE%9A%E7%BE%A9\"\u003e譜面用構造体の定義\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#midi%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E6%A7%8B%E6%88%90\"\u003eMIDIファイル構成\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%98%E3%83%83%E3%83%80%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF\"\u003eヘッダチャンク\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF\"\u003eトラックチャンク\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF%E8%A7%A3%E6%9E%90\"\u003eチャンク解析\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%98%E3%83%83%E3%83%80%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF%E8%A7%A3%E6%9E%90\"\u003eヘッダチャンク解析\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%81%E3%83%A3%E3%83%B3%E3%82%AF%E8%A7%A3%E6%9E%90\"\u003eトラックチャンク解析\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%87%E3%83%BC%E3%82%BF%E9%83%A8%E8%A7%A3%E6%9E%90\"\u003eトラックデータ部解析\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%87%E3%83%AB%E3%82%BF%E3%82%BF%E3%82%A4%E3%83%A0%E9%83%A8%E8%A7%A3%E6%9E%90\"\u003eデルタタイム部解析\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E9%83%A8%E8%A7%A3%E6%9E%90\"\u003eイベント部解析\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%82%BF%E3%82%A4%E3%83%A0%E5%86%8D%E8%A8%88%E7%AE%97\"\u003eイベントタイム再計算\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e終わりに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83\"\u003e参考\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":7038,"uuid":"8d641e8a8a423566db71","banReason":null,"adventCalendarItem":{"day":19,"calendar":{"name":"KLab Engineer","urlName":"klab","year":2018,"organization":null}},"author":{"encryptedId":"+G++XZrrcoJsl0feSZsutGHqaBki--WDNKmxnjFI0HO2nd--7KkMJrILXAZYyPjkZc6lbg==","originalId":311580,"description":"","facebookUrl":null,"githubUrl":"https://github.com/Owataso","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":false,"linkedinUrl":null,"name":"","profileImageUrl":"https://avatars0.githubusercontent.com/u/13196855?v=4","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars0.githubusercontent.com%2Fu%2F13196855%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=949d64c7cc42482263c3c7c2f7606c06","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Favatars0.githubusercontent.com%2Fu%2F13196855%3Fv%3D4?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=5d761e90b0c88fda8d7adb6e093210ec","urlName":"owts","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"MIDI","urlName":"midi"}],"followingLikers":{"edges":[]},"comments":{"totalCount":2}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
