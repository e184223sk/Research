サーバーリプレース作業(Windows Server 2008R2 + Oracle 11g → Windows Server 2016 + PostgreSQL 9.6)を終えてから初めての大規模なサーバーメンテナンス作業を先日から行いました。
サーバーリプレース作業の中には汎用サーバーからNASサーバーに変更するところがありまして、NASサーバーに変更すると監視ソフトウェアから監視情報が取得できなくなります。そもそも監視ソフトウェアではどういう仕組みで監視情報（CPU使用率、メモリ使用率、ディスク使用率、プロセス監視、稼働日数など）を取得しているのかを調べたところ、「SNMP」というキーワードが見つかりました。今回のサーバーメンテナンス作業で、NASサーバーにSNMPサービスの追加作業をすることになりました。SNMP(Simple Network Management Protocol)とは、ネットワーク内に存在する装置の状態を監視することを目的につくられたプロトコルで業界標準の規格です。各ベンダ共通の規格なので、サーバーやルータの種類を問わず利用可能です。SNMPはマネージャ側(監視サーバなど、管理側)とエージェント側(監視対象のサーバ、ネットワーク機器など)に分かれて構成されます。ネットワーク監視の超基本「SNMP」とは？MIB(Management Information Base)とは、管理情報を蓄積したデータベースで、SNMPエージェントは監視対象機器の情報をMIBから参照します。
MIBには「標準MIB」とメーカーや機器固有のものなどが存在します。メーカーや機器固有のものはメーカーに確認する必要があります。MIBに格納されている情報の1つ1つは「オブジェクト（Object）」と呼ばれます。
オブジェクトは情報の要素によってツリー構造で管理され、それぞれに「オブジェクトID(OID)」という識別子が割り振られています。
OIDはピリオドで区切られた数字で表現されます。標準MIBのうち「MIB-2」はOID「1.3.6.1.2.1」になります。MIBに含まれているオブジェクトのOIDとその意味は「MIBファイル」というテキストファイルに記述されています。
監視対象機器からSNMPを使ってどのような情報を収集できるかは、その監視対象機器がサポートしているMIBファイルを確認する必要があります。http://oidref.com/ の次に OID 番号を入力すると何かを教えてくれます。WindowsではデフォルトでSNMP設定がされていないため、「SNMPサービス」を追加する必要があります。
SNMPを使用できるようにする図入りの設定は下記サイトを参照
WINDOWS SERVER : SNMP 設定方法SNMPサービスのプロパティにあるセキュリティタブにて、コミュニティ名"public"を追加して、「すべてのホストからSNMPパケットを受け取る」側にチェックを付ける。
なお、SNMPでアクセスできるサーバを限定する場合は、[これらのホストから、SNMPパケットを受け付ける]をチェックし、運用管理サーバのIPアドレスを追加してください。ファイアーウォールの受信の一覧から「SNMP トラップ サービス (UDP 受信)」のプロファイル「プライベート, パブリック」側を選択し、右クリックメニューから「規則の有効化」をクリックします。
右クリックメニューのプロパティのスコープタブにて、リモートIPアドレスの「任意のIPアドレス」を選択してOKボタンをクリックします。エージェントSNMPコミュニティ名には、SNMPサービスのプロパティのセキュリティータブで設定したコミュニティ名（例 public）を指定する。VBScriptで取得するには、COMにある「OlePrn.OleSNMP」モジュールを使用することが取得することが出来る。
ただし、OID番号で指定する必要があるのとsnmpwalkのような列挙ができない。nugetからLextm.SharpSnmpLibをダウンロードして使用する。MITライセンスとなっている。
Lextm.SharpSnmpLib の使用例Walk を使用することで一覧が一括で取得できる。現在は運用チームに属しているのでサーバー監視のような技術を知るようになります。
運用というのは、問題が発生する前に対処しておく必要があり平時が常な状態で問題が起きればお祭り状態です。
運用が平和な状態はいいことなんですが、経営層からすれば何も問題が発生していないとしてコスト削減で人数を減らしやすい対象となってしまいます。
問題がないように事前に対応しているということを経営層にアピールしていかないといけない。今の所はそんなことはなっていないんですけどね。


