<!DOCTYPE html><html><head><meta charset="utf-8" /><title>EventPipe(EventSource)から流れてくるデータを処理する - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/skitoy4321/items/12253681177e78d15aa3" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="9qeOCUX6DqavXYoAwBu0NPWnw1LXYBxegcon8rqnFvxUEzMlNeC2hBfactHv8DRW+Sq6+JccWWveZI8s0aPcpA==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@skitoy4321" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="EventPipe(EventSource)から流れてくるデータを処理する - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1SWFpsYm5SUWFYQmxLRVYyWlc1MFUyOTFjbU5sS2VPQmktT0NpZWExZ2VPQ2pPT0JwdU9Cai1PQ2ktT0RoLU9Edk9PQ3YtT0NrdVdIcHVlUWh1T0JtZU9DaXcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YmI2ODYwOTRjN2MyMTViYzMxOTA2MjFlNGM0ZDViZmU&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=3641e249878a0b96e198b18470d322c5"><meta property="og:description" content="

始めに

前回の記事で、DiagnosticSourceからEventSourceへ出力する記事 を書いたが、今回は、そのEventSourceのデータを処理するためのライブラリの使い方を書く。

これによって、コマンドラインで来..."><meta content="https://qiita.com/skitoy4321/items/12253681177e78d15aa3" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,EventSource,EventPipe" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-b36bc732-7c5f-43ca-b190-9262f4aff45e"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fskitoy4321%2Fitems%2F12253681177e78d15aa3">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fskitoy4321%2Fitems%2F12253681177e78d15aa3">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-b36bc732-7c5f-43ca-b190-9262f4aff45e">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2020-10-13T12:04:52.000+09:00","dateModified":"2020-10-15T17:21:37.000+09:00","headline":"EventPipe(EventSource)から流れてくるデータを処理する","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1SWFpsYm5SUWFYQmxLRVYyWlc1MFUyOTFjbU5sS2VPQmktT0NpZWExZ2VPQ2pPT0JwdU9Cai1PQ2ktT0RoLU9Edk9PQ3YtT0NrdVdIcHVlUWh1T0JtZU9DaXcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NCZ0eHQtY2xpcD1lbGxpcHNpcyZ0eHQtYWxpZ249Y2VudGVyJTJDbWlkZGxlJnM9YmI2ODYwOTRjN2MyMTViYzMxOTA2MjFlNGM0ZDViZmU\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=3641e249878a0b96e198b18470d322c5","mainEntityOfPage":"https://qiita.com/skitoy4321/items/12253681177e78d15aa3","author":{"@type":"Person","address":"","email":null,"identifier":"skitoy4321","name":"skitoy4321","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","url":"https://qiita.com/skitoy4321","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"12253681177e78d15aa3"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"12253681177e78d15aa3"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"12253681177e78d15aa3"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/skitoy4321/items/12253681177e78d15aa3","location":"/skitoy4321/items/12253681177e78d15aa3","scheme":"https","host":"qiita.com","port":null,"pathname":"/skitoy4321/items/12253681177e78d15aa3","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"bwGUR0hnVvw/AmmH0Kz6OzrWWC8B3kW3Y4jsMl/arinNtSlrOH3u3oeFkVb/R3pZNlshhUGiAII8JkTsNN5kcQ==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-ecd6da31-8cb4-4e48-a6b6-73bfff372d07"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/12253681177e78d15aa3/likers" class="css-1iupg5d">0</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">1</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/12253681177e78d15aa3/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/12253681177e78d15aa3/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/12253681177e78d15aa3/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/12253681177e78d15aa3/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/12253681177e78d15aa3.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/skitoy4321"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/skitoy4321" class="css-10ougpm">@<!-- -->skitoy4321</a><div class="css-1ay9vb9"><span><meta content="2020-10-13T03:04:52Z"/><time dateTime="2020-10-15T08:21:37Z" class="css-m19uds">updated at 2020-10-15</time></span></div></div></div></div></div><h1 class="css-cgzq40">EventPipe(EventSource)から流れてくるデータを処理する</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/eventsource" class="css-4czcte">EventSource</a><a href="/tags/eventpipe" class="css-4czcte">EventPipe</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="始めに" class="fragment"></span><a href="#%E5%A7%8B%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>始めに</h1>

<p><a href="https://qiita.com/skitoy4321/items/848889d76a0b6e697d6a" id="reference-8b90e944e552abc11138">前回の記事で、DiagnosticSourceからEventSourceへ出力する記事</a> を書いたが、今回は、そのEventSourceのデータを処理するためのライブラリの使い方を書く。</p>

<p>これによって、コマンドラインで来たデータを加工したり、あるいはWPFで流す等の処理も書けるようになる。</p>

<p><a href="https://gist.github.com/itn3000/69560c6b889677d6a42e24f289396f1c" rel="nofollow noopener" target="_blank">今回調査に使ったソースをgistに貼っておく。</a></p>

<h1>
<span id="前提条件" class="fragment"></span><a href="#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><i class="fa fa-link"></i></a>前提条件</h1>

<ul>
<li>dotnet sdk-3.0以降が必要</li>
<li>情報収集対象のアプリが、netcoreapp3.0以降</li>
</ul>

<h1>
<span id="準備イベント出力側の用意" class="fragment"></span><a href="#%E6%BA%96%E5%82%99%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E5%87%BA%E5%8A%9B%E5%81%B4%E3%81%AE%E7%94%A8%E6%84%8F"><i class="fa fa-link"></i></a>準備(イベント出力側の用意)</h1>

<p>前回の記事でも作成したソースを使用する。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">C1</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">DiagnosticSource</span> <span class="n">_D</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DiagnosticListener</span><span class="p">(</span><span class="s">"Diag1"</span><span class="p">);</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">A</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">_D</span><span class="p">.</span><span class="nf">IsEnabled</span><span class="p">(</span><span class="s">"ev1"</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">_D</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"ev1"</span><span class="p">,</span> <span class="k">new</span> <span class="p">{</span> <span class="n">X</span> <span class="p">=</span> <span class="s">"str"</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 1秒に一回"ev1"イベントが発生する</span>
            <span class="c1">// 停止機能はないので、Ctrl+C等を使用して止めること</span>
            <span class="k">new</span> <span class="nf">C1</span><span class="p">().</span><span class="nf">A</span><span class="p">();</span>
            <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">).</span><span class="nf">Wait</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1>
<span id="必要なライブラリ" class="fragment"></span><a href="#%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA"><i class="fa fa-link"></i></a>必要なライブラリ</h1>

<p><a href="https://www.nuget.org/packages/Microsoft.Diagnostics.NETCore.Client/" rel="nofollow noopener" target="_blank"><code>Microsoft.Diagnostics.NETCore.Client</code></a>と<a href="https://www.nuget.org/packages/Microsoft.Diagnostics.Tracing.TraceEvent/" rel="nofollow noopener" target="_blank"><code>Microsoft.Diagnostics.Tracing.TraceEvent</code></a>が必要。</p>

<h2>
<span id="microsoftdiagnosticsnetcoreclientについて" class="fragment"></span><a href="#microsoftdiagnosticsnetcoreclient%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a><code>Microsoft.Diagnostics.NETCore.Client</code>について</h2>

<p>EventPipeプロトコルでdotnetプロセスにアタッチするためのライブラリ。dotnetプロセスが用意するEventPipe読み込みの口へ、PIDをキーにしてアクセスして、データを受け取る。</p>

<p>主に使用するクラスは以下(名前空間は<code>Microsoft.Diagnostics.NETCore.Client</code>からの相対位置)</p>

<ul>
<li>EventPipeProvider

<ul>
<li>EventSourceの出力元の情報を保持するクラス</li>
<li>捕捉するイベントの種類、レベル、各種フラグ等を設定する</li>
</ul>
</li>
<li>DiagnosticClient

<ul>
<li>EventProviderとPIDを元に、EventPipe接続を行う</li>
<li><code>StartEventPipeSession</code></li>
<li>
<code>public static IEnumerable&lt;int&gt; DiagnosticClient.GetPublishedProcesses()</code>で、アタッチ可能なPIDの一覧が取得可能</li>
</ul>
</li>
<li>EventPipeSession

<ul>
<li>
<code>DiagnosticClient.StartEventPipeSession</code>から生成される、セッションオブジェクト</li>
<li>
<code>EventPipeSession.EventStream</code>で生のバイトデータが取得できる

<ul>
<li>フォーマットは <a href="https://github.com/microsoft/perfview/blob/master/src/TraceEvent/EventPipe/EventPipeFormat.md" rel="nofollow noopener" target="_blank">perfviewリポジトリのドキュメントに記載がある</a>
</li>
</ul>
</li>
<li><strong>使用後は、必ず<code>Stop()</code>メソッドで動作を停止すること</strong></li>
</ul>
</li>
</ul>

<p>さて、これだけではEventPipeの生データが取得できるだけで、中身はバイナリデータなので人に読めるものではない(いや、もしかしたら読める人もいるかもしれないが)。<br>
これを解析してくれるライブラリが、<code>Microsoft.Diagnostics.Tracing.TraceEvent</code>となる</p>

<h2>
<span id="microsoftdiagnosticstracingtraceeventについて" class="fragment"></span><a href="#microsoftdiagnosticstracingtraceevent%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a><code>Microsoft.Diagnostics.Tracing.TraceEvent</code>について</h2>

<p>前述のEventPipeSessionから得たデータを解釈して、プログラム的に解析するためのライブラリ。起点はStreamから読み込むので、先のEventPipeSession.EventStreamをの内容をそのまま出力したファイルを使っても良い</p>

<p>EventStreamの解析に使用する場合、主に使用するクラスは<code>Microsoft.Diagnostics.Tracing.EventPipeEventSource</code>である。</p>

<h3>
<span id="eventpipeeventsourceについて" class="fragment"></span><a href="#eventpipeeventsource%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a>EventPipeEventSourceについて</h3>

<p><code>System.IO.Stream</code>をコンストラクタにとる。Streamには、<code>EventPipeSession.EventStream</code>から得たデータが入っている想定。<br>
データ解析手順には非同期イベントパターン(EAP)を採用しているので、EventPipeEventSourceに付随するイベントを購読する。<br>
また、<code>IObservable&lt;T&gt;</code>を返すインターフェイスも提供している。</p>

<p>イベントは、共通のヘッダ部分以外はイベント固有のデータが流れてくるため、そのイベント用の解析クラスを用意する必要がある。<br>
このイベント解析用ベースクラスが<code>TraceEventParser</code>で、解析クラスはこれを継承して各イベントの解析処理を実装している。</p>

<p>例えば、CLRのイベント(GCの回収イベントとか)は、専用のパーサーが用意されており、EventPipeEventSource.Clrで専用のイベントが用意されている。</p>

<p>なお、汎用的な用途に使える<code>DynamicTraceEventParser</code>も存在しており、ライブラリ側で用意されていない場合はこちらを使用することになるだろう。</p>

<p>そして、一通りのイベント設定が終わったら、<code>EventPipeEventSource.Process</code>で解析を開始する。<br>
注意点として、<code>Process</code>を実行した時点でスレッドがロックされるため、途中キャンセル等をしたい場合は、<br>
別スレッドを展開して、別のスレッドから、<code>EventPipeEventSource.StopProcessing</code>と、元のストリームのクローズ(EventPipeSessionからStreamを取得している場合は、<code>EventPipeSession.Stop</code>を実行する<br>
具体的には以下</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="c1">// EventPipeSession session;</span>
<span class="c1">// 汎用的なイベントを購読</span>
<span class="n">evsrc</span><span class="p">.</span><span class="n">Dynamic</span><span class="p">.</span><span class="n">All</span> <span class="p">+=</span> <span class="p">(</span><span class="n">TraceEvent</span> <span class="n">evt</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="c1">// 解析処理</span>
<span class="p">};</span>
<span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span>
  <span class="c1">// 解析スレッド</span>
  <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">evsrc</span><span class="p">.</span><span class="nf">Process</span><span class="p">()),</span>
  <span class="c1">// 停止スレッド</span>
  <span class="c1">// エンターキーを押したら終了する</span>
  <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
    <span class="n">evsrc</span><span class="p">.</span><span class="nf">StopProcessing</span><span class="p">();</span>
    <span class="n">session</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">);</span>
</code></pre></div></div>

<p>なお、これを通さない<code>Action&lt;TraceEvent&gt; EventPipeEventSource.AllEvents</code>なるイベントもあるが、これを通すとPayloadNames(イベントデータプロパティの名前)など、主にPayload関連について、セットされないプロパティが出てくる。その場合は、<code>TraceEvent.EventData()</code>でバイトデータを取得して、自力でパースする必要がある。</p>

<h1>
<span id="eventpipeeventsourcedynamicallの中の解析処理について" class="fragment"></span><a href="#eventpipeeventsourcedynamicall%E3%81%AE%E4%B8%AD%E3%81%AE%E8%A7%A3%E6%9E%90%E5%87%A6%E7%90%86%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><i class="fa fa-link"></i></a><code>EventPipeEventSource.Dynamic.All</code>の中の解析処理について</h1>

<p><code>EventPipeEventSource.Dynamic.All</code>の中では、<code>TraceEvent.PayloadNames</code>と<code>TraceEvent.PayloadByName(string name)</code>の組み合わせでデータを取得する。具体的には以下のようになる。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="c1">// TracEvent traceevt;</span>
<span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">pname</span> <span class="k">in</span> <span class="n">traceevt</span><span class="p">.</span><span class="n">PayloadNames</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">object</span> <span class="n">pobj</span> <span class="p">=</span> <span class="n">traceevt</span><span class="p">.</span><span class="nf">PayloadByName</span><span class="p">(</span><span class="n">pname</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">pname</span><span class="p">}</span><span class="s"> = </span><span class="p">{</span><span class="n">pobj</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>pobjが何になるか、というところは、プリミティブ型(数値、文字列)ならばそのままキャストすればOK。しかし、それ以外のオブジェクト等がイベント発生元で渡された場合は少々工夫が必要。</p>

<h2>
<span id="ペイロードデータにオブジェクトで来た場合" class="fragment"></span><a href="#%E3%83%9A%E3%82%A4%E3%83%AD%E3%83%BC%E3%83%89%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A7%E6%9D%A5%E3%81%9F%E5%A0%B4%E5%90%88"><i class="fa fa-link"></i></a>ペイロードデータにオブジェクトで来た場合</h2>

<p>この場合、実際の型はinternalで隠蔽されているが、取り出す時には<code>IDictionary&lt;string, object&gt;[]</code>で取り出すことができる(<code>[]</code>なことに注意)。<br>
<code>IDictionary&lt;string, object&gt;</code>には二つ要素が格納されており、それぞれのキーは<code>Key</code>と<code>Value</code>で、値の方にそれぞれプロパティ名と、実際の値が格納されている<br>
具体的には以下のように値を取り出す。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="c1">// object pobj = traceevt.PayloadByName(pname);</span>
<span class="k">if</span><span class="p">(</span><span class="n">pobj</span> <span class="k">is</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;[]</span> <span class="n">pdicar</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">pdic</span> <span class="k">in</span> <span class="n">pdicar</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">pdic</span><span class="p">[</span><span class="s">"Key"</span><span class="p">];</span>
        <span class="kt">object</span> <span class="k">value</span> <span class="p">=</span> <span class="n">pdic</span><span class="p">[</span><span class="s">"Value"</span><span class="p">];</span>
        <span class="c1">// 解析処理</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>より複雑な型の場合はネストして処理が必要になるだろうが、そもそもEventSourceでそこまで複雑なデータは作らない方が良いと思う。<br>
パーサー自体についての詳細なドキュメントは、 <a href="https://github.com/microsoft/perfview/blob/P2.0.61/documentation/TraceEvent/TraceEventProgrammersGuide.md" rel="nofollow noopener" target="_blank">githubのmicrosoft/perfviewのドキュメントにある</a></p>

<h2>
<span id="解析処理の注意点" class="fragment"></span><a href="#%E8%A7%A3%E6%9E%90%E5%87%A6%E7%90%86%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9"><i class="fa fa-link"></i></a>解析処理の注意点</h2>

<h3>
<span id="コールバック内の例外処理" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E5%86%85%E3%81%AE%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86"><i class="fa fa-link"></i></a>コールバック内の例外処理</h3>

<p>解析コールバックの中で例外をキャッチし損ねると、以後のイベントが流れなくなり、更に、StopProcessingも受け付けなくなった。<br>
なので、現時点ではコールバックの中ではtry-catchで囲った方が良い。</p>

<h3>
<span id="一つもイベントが来ない条件で指定したらフリーズする" class="fragment"></span><a href="#%E4%B8%80%E3%81%A4%E3%82%82%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%8C%E6%9D%A5%E3%81%AA%E3%81%84%E6%9D%A1%E4%BB%B6%E3%81%A7%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E3%82%89%E3%83%95%E3%83%AA%E3%83%BC%E3%82%BA%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>一つもイベントが来ない条件で指定したらフリーズする</h3>

<p>少なくともMicrosoft.Diagnostics.Tracing.TraceEvent-2.0.61時点では、一つも該当するイベントが無いようなEventPipeProviderを設定すると、EventPipeEventSourceのコンストラクタで処理が止まってしまうという不具合があるらしい。<br>
詳しい内容は下記issue</p>

<ul>
<li><a href="https://github.com/microsoft/perfview/issues/1172" rel="nofollow noopener" target="_blank">EventPipeEventSource constructor blocks until the first event is read</a></li>
</ul>

<h1>
<span id="終わりに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終わりに</h1>

<p>前回の記事の派生で、EventPipeについて調べてみたけど、取っ掛かりは思ったより簡単だなという感想だった。<br>
ここから、自分なりに使いやすいモニタリングツールを作ってみるのもいいかもしれない。</p>

<p>また、EventPipe自体はローカル限定なので、ここから外部ネットワークに流す口を作るというのも面白い発想かもしれない。</p>

<p>今回紹介したのはイベントの取得のみだが、その他にもメモリダンプを取ることもできる等、トラブルシューティングに役立つ機能があるので、うまく活用していきたい。</p>

<h2>
<span id="参考資料" class="fragment"></span><a href="#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99"><i class="fa fa-link"></i></a>参考資料</h2>

<ul>
<li>
<a href="https://github.com/dotnet/diagnostics" rel="nofollow noopener" target="_blank">dotnet/diagnostics</a>: EventPipe等の記述など

<ul>
<li>
<a href="https://github.com/dotnet/diagnostics/blob/3.1.141901/documentation/design-docs/diagnostics-client-library.md" rel="nofollow noopener" target="_blank">dotnet/diagnostics/documentation/design-docs/diagnostics-client-library.md</a>: クライアントライブラリの使い方</li>
</ul>
</li>
<li>
<a href="https://github.com/microsoft/perfview" rel="nofollow noopener" target="_blank">microsoft/perfview</a>: 解析ツールのperfviewや、そのライブラリの<code>Microsoft.Diagnostics.Tracing.TraceEvent</code>のソース等

<ul>
<li>
<a href="https://github.com/microsoft/perfview/tree/P2.0.61/documentation/TraceEvent" rel="nofollow noopener" target="_blank">microsoft/perfview/documentation/TraceEvent</a>: もう少し詳細なドキュメント</li>
</ul>
</li>
<li><a href="https://github.com/dotnet/diagnostics/blob/3.1.141901/documentation/diagnostics-client-library-instructions.md" rel="nofollow noopener" target="_blank">Microsoft.Diagnostics.NETCore.Clientに関するドキュメント</a></li>
</ul>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2F12253681177e78d15aa3&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2F12253681177e78d15aa3&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/12253681177e78d15aa3/likers" class="css-1iupg5d">0</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">1</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/12253681177e78d15aa3/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/12253681177e78d15aa3/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/12253681177e78d15aa3/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/12253681177e78d15aa3/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/12253681177e78d15aa3.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-ecd6da31-8cb4-4e48-a6b6-73bfff372d07">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-fef4d932-8fde-4bc4-a965-c8c89140a432"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-fef4d932-8fde-4bc4-a965-c8c89140a432">{}</script>
      
<div id="LoginModal-react-component-b38e4120-fc48-4392-ba38-9050bdae3388"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-b38e4120-fc48-4392-ba38-9050bdae3388">{}</script>
      
<div id="StockModal-react-component-14459a31-daea-4349-a9f3-f0168731299d"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-14459a31-daea-4349-a9f3-f0168731299d">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;GfUH5ELkOsMw28Bzfzh1xjdUQJ1FrHesPvxT1Ftp1jm7QbrIMv6C4YhcOKJQ0/WkO9k5NwXQMplhUvsKMG0cYQ==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"始めに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%A7%8B%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e始めに\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/skitoy4321/items/848889d76a0b6e697d6a\" id=\"reference-8b90e944e552abc11138\"\u003e前回の記事で、DiagnosticSourceからEventSourceへ出力する記事\u003c/a\u003e を書いたが、今回は、そのEventSourceのデータを処理するためのライブラリの使い方を書く。\u003c/p\u003e\n\n\u003cp\u003eこれによって、コマンドラインで来たデータを加工したり、あるいはWPFで流す等の処理も書けるようになる。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://gist.github.com/itn3000/69560c6b889677d6a42e24f289396f1c\" rel=\"nofollow noopener\" target=\"_blank\"\u003e今回調査に使ったソースをgistに貼っておく。\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"前提条件\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e前提条件\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003edotnet sdk-3.0以降が必要\u003c/li\u003e\n\u003cli\u003e情報収集対象のアプリが、netcoreapp3.0以降\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"準備イベント出力側の用意\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%BA%96%E5%82%99%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E5%87%BA%E5%8A%9B%E5%81%B4%E3%81%AE%E7%94%A8%E6%84%8F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e準備(イベント出力側の用意)\u003c/h1\u003e\n\n\u003cp\u003e前回の記事でも作成したソースを使用する。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Diagnostics\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading.Tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eC1\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eDiagnosticSource\u003c/span\u003e \u003cspan class=\"n\"\u003e_D\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eDiagnosticListener\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Diag1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_D\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIsEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ev1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_D\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"ev1\"\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003eX\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\"str\"\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eProgram\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 1秒に一回\"ev1\"イベントが発生する\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// 停止機能はないので、Ctrl+C等を使用して止めること\u003c/span\u003e\n            \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eC1\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"必要なライブラリ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e必要なライブラリ\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://www.nuget.org/packages/Microsoft.Diagnostics.NETCore.Client/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003ccode\u003eMicrosoft.Diagnostics.NETCore.Client\u003c/code\u003e\u003c/a\u003eと\u003ca href=\"https://www.nuget.org/packages/Microsoft.Diagnostics.Tracing.TraceEvent/\" rel=\"nofollow noopener\" target=\"_blank\"\u003e\u003ccode\u003eMicrosoft.Diagnostics.Tracing.TraceEvent\u003c/code\u003e\u003c/a\u003eが必要。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"microsoftdiagnosticsnetcoreclientについて\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#microsoftdiagnosticsnetcoreclient%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eMicrosoft.Diagnostics.NETCore.Client\u003c/code\u003eについて\u003c/h2\u003e\n\n\u003cp\u003eEventPipeプロトコルでdotnetプロセスにアタッチするためのライブラリ。dotnetプロセスが用意するEventPipe読み込みの口へ、PIDをキーにしてアクセスして、データを受け取る。\u003c/p\u003e\n\n\u003cp\u003e主に使用するクラスは以下(名前空間は\u003ccode\u003eMicrosoft.Diagnostics.NETCore.Client\u003c/code\u003eからの相対位置)\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eEventPipeProvider\n\n\u003cul\u003e\n\u003cli\u003eEventSourceの出力元の情報を保持するクラス\u003c/li\u003e\n\u003cli\u003e捕捉するイベントの種類、レベル、各種フラグ等を設定する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eDiagnosticClient\n\n\u003cul\u003e\n\u003cli\u003eEventProviderとPIDを元に、EventPipe接続を行う\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eStartEventPipeSession\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003epublic static IEnumerable\u0026lt;int\u0026gt; DiagnosticClient.GetPublishedProcesses()\u003c/code\u003eで、アタッチ可能なPIDの一覧が取得可能\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eEventPipeSession\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eDiagnosticClient.StartEventPipeSession\u003c/code\u003eから生成される、セッションオブジェクト\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eEventPipeSession.EventStream\u003c/code\u003eで生のバイトデータが取得できる\n\n\u003cul\u003e\n\u003cli\u003eフォーマットは \u003ca href=\"https://github.com/microsoft/perfview/blob/master/src/TraceEvent/EventPipe/EventPipeFormat.md\" rel=\"nofollow noopener\" target=\"_blank\"\u003eperfviewリポジトリのドキュメントに記載がある\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e使用後は、必ず\u003ccode\u003eStop()\u003c/code\u003eメソッドで動作を停止すること\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eさて、これだけではEventPipeの生データが取得できるだけで、中身はバイナリデータなので人に読めるものではない(いや、もしかしたら読める人もいるかもしれないが)。\u003cbr\u003e\nこれを解析してくれるライブラリが、\u003ccode\u003eMicrosoft.Diagnostics.Tracing.TraceEvent\u003c/code\u003eとなる\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"microsoftdiagnosticstracingtraceeventについて\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#microsoftdiagnosticstracingtraceevent%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eMicrosoft.Diagnostics.Tracing.TraceEvent\u003c/code\u003eについて\u003c/h2\u003e\n\n\u003cp\u003e前述のEventPipeSessionから得たデータを解釈して、プログラム的に解析するためのライブラリ。起点はStreamから読み込むので、先のEventPipeSession.EventStreamをの内容をそのまま出力したファイルを使っても良い\u003c/p\u003e\n\n\u003cp\u003eEventStreamの解析に使用する場合、主に使用するクラスは\u003ccode\u003eMicrosoft.Diagnostics.Tracing.EventPipeEventSource\u003c/code\u003eである。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"eventpipeeventsourceについて\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#eventpipeeventsource%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eEventPipeEventSourceについて\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003eSystem.IO.Stream\u003c/code\u003eをコンストラクタにとる。Streamには、\u003ccode\u003eEventPipeSession.EventStream\u003c/code\u003eから得たデータが入っている想定。\u003cbr\u003e\nデータ解析手順には非同期イベントパターン(EAP)を採用しているので、EventPipeEventSourceに付随するイベントを購読する。\u003cbr\u003e\nまた、\u003ccode\u003eIObservable\u0026lt;T\u0026gt;\u003c/code\u003eを返すインターフェイスも提供している。\u003c/p\u003e\n\n\u003cp\u003eイベントは、共通のヘッダ部分以外はイベント固有のデータが流れてくるため、そのイベント用の解析クラスを用意する必要がある。\u003cbr\u003e\nこのイベント解析用ベースクラスが\u003ccode\u003eTraceEventParser\u003c/code\u003eで、解析クラスはこれを継承して各イベントの解析処理を実装している。\u003c/p\u003e\n\n\u003cp\u003e例えば、CLRのイベント(GCの回収イベントとか)は、専用のパーサーが用意されており、EventPipeEventSource.Clrで専用のイベントが用意されている。\u003c/p\u003e\n\n\u003cp\u003eなお、汎用的な用途に使える\u003ccode\u003eDynamicTraceEventParser\u003c/code\u003eも存在しており、ライブラリ側で用意されていない場合はこちらを使用することになるだろう。\u003c/p\u003e\n\n\u003cp\u003eそして、一通りのイベント設定が終わったら、\u003ccode\u003eEventPipeEventSource.Process\u003c/code\u003eで解析を開始する。\u003cbr\u003e\n注意点として、\u003ccode\u003eProcess\u003c/code\u003eを実行した時点でスレッドがロックされるため、途中キャンセル等をしたい場合は、\u003cbr\u003e\n別スレッドを展開して、別のスレッドから、\u003ccode\u003eEventPipeEventSource.StopProcessing\u003c/code\u003eと、元のストリームのクローズ(EventPipeSessionからStreamを取得している場合は、\u003ccode\u003eEventPipeSession.Stop\u003c/code\u003eを実行する\u003cbr\u003e\n具体的には以下\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// EventPipeSession session;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// 汎用的なイベントを購読\u003c/span\u003e\n\u003cspan class=\"n\"\u003eevsrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDynamic\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAll\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTraceEvent\u003c/span\u003e \u003cspan class=\"n\"\u003eevt\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// 解析処理\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhenAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 解析スレッド\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eevsrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eProcess\u003c/span\u003e\u003cspan class=\"p\"\u003e()),\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// 停止スレッド\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e// エンターキーを押したら終了する\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadLine\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eevsrc\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStopProcessing\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esession\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eなお、これを通さない\u003ccode\u003eAction\u0026lt;TraceEvent\u0026gt; EventPipeEventSource.AllEvents\u003c/code\u003eなるイベントもあるが、これを通すとPayloadNames(イベントデータプロパティの名前)など、主にPayload関連について、セットされないプロパティが出てくる。その場合は、\u003ccode\u003eTraceEvent.EventData()\u003c/code\u003eでバイトデータを取得して、自力でパースする必要がある。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"eventpipeeventsourcedynamicallの中の解析処理について\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#eventpipeeventsourcedynamicall%E3%81%AE%E4%B8%AD%E3%81%AE%E8%A7%A3%E6%9E%90%E5%87%A6%E7%90%86%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eEventPipeEventSource.Dynamic.All\u003c/code\u003eの中の解析処理について\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode\u003eEventPipeEventSource.Dynamic.All\u003c/code\u003eの中では、\u003ccode\u003eTraceEvent.PayloadNames\u003c/code\u003eと\u003ccode\u003eTraceEvent.PayloadByName(string name)\u003c/code\u003eの組み合わせでデータを取得する。具体的には以下のようになる。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// TracEvent traceevt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epname\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003etraceevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePayloadNames\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003epobj\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etraceevt\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePayloadByName\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epname\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003epname\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e = \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003epobj\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003epobjが何になるか、というところは、プリミティブ型(数値、文字列)ならばそのままキャストすればOK。しかし、それ以外のオブジェクト等がイベント発生元で渡された場合は少々工夫が必要。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ペイロードデータにオブジェクトで来た場合\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%9A%E3%82%A4%E3%83%AD%E3%83%BC%E3%83%89%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A7%E6%9D%A5%E3%81%9F%E5%A0%B4%E5%90%88\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eペイロードデータにオブジェクトで来た場合\u003c/h2\u003e\n\n\u003cp\u003eこの場合、実際の型はinternalで隠蔽されているが、取り出す時には\u003ccode\u003eIDictionary\u0026lt;string, object\u0026gt;[]\u003c/code\u003eで取り出すことができる(\u003ccode\u003e[]\u003c/code\u003eなことに注意)。\u003cbr\u003e\n\u003ccode\u003eIDictionary\u0026lt;string, object\u0026gt;\u003c/code\u003eには二つ要素が格納されており、それぞれのキーは\u003ccode\u003eKey\u003c/code\u003eと\u003ccode\u003eValue\u003c/code\u003eで、値の方にそれぞれプロパティ名と、実際の値が格納されている\u003cbr\u003e\n具体的には以下のように値を取り出す。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// object pobj = traceevt.PayloadByName(pname);\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epobj\u003c/span\u003e \u003cspan class=\"k\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003eIDictionary\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;[]\u003c/span\u003e \u003cspan class=\"n\"\u003epdicar\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003epdic\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003epdicar\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003epdic\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Key\"\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epdic\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Value\"\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// 解析処理\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eより複雑な型の場合はネストして処理が必要になるだろうが、そもそもEventSourceでそこまで複雑なデータは作らない方が良いと思う。\u003cbr\u003e\nパーサー自体についての詳細なドキュメントは、 \u003ca href=\"https://github.com/microsoft/perfview/blob/P2.0.61/documentation/TraceEvent/TraceEventProgrammersGuide.md\" rel=\"nofollow noopener\" target=\"_blank\"\u003egithubのmicrosoft/perfviewのドキュメントにある\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"解析処理の注意点\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A7%A3%E6%9E%90%E5%87%A6%E7%90%86%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e解析処理の注意点\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"コールバック内の例外処理\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E5%86%85%E3%81%AE%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコールバック内の例外処理\u003c/h3\u003e\n\n\u003cp\u003e解析コールバックの中で例外をキャッチし損ねると、以後のイベントが流れなくなり、更に、StopProcessingも受け付けなくなった。\u003cbr\u003e\nなので、現時点ではコールバックの中ではtry-catchで囲った方が良い。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"一つもイベントが来ない条件で指定したらフリーズする\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%B8%80%E3%81%A4%E3%82%82%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%8C%E6%9D%A5%E3%81%AA%E3%81%84%E6%9D%A1%E4%BB%B6%E3%81%A7%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E3%82%89%E3%83%95%E3%83%AA%E3%83%BC%E3%82%BA%E3%81%99%E3%82%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e一つもイベントが来ない条件で指定したらフリーズする\u003c/h3\u003e\n\n\u003cp\u003e少なくともMicrosoft.Diagnostics.Tracing.TraceEvent-2.0.61時点では、一つも該当するイベントが無いようなEventPipeProviderを設定すると、EventPipeEventSourceのコンストラクタで処理が止まってしまうという不具合があるらしい。\u003cbr\u003e\n詳しい内容は下記issue\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/microsoft/perfview/issues/1172\" rel=\"nofollow noopener\" target=\"_blank\"\u003eEventPipeEventSource constructor blocks until the first event is read\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"終わりに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e終わりに\u003c/h1\u003e\n\n\u003cp\u003e前回の記事の派生で、EventPipeについて調べてみたけど、取っ掛かりは思ったより簡単だなという感想だった。\u003cbr\u003e\nここから、自分なりに使いやすいモニタリングツールを作ってみるのもいいかもしれない。\u003c/p\u003e\n\n\u003cp\u003eまた、EventPipe自体はローカル限定なので、ここから外部ネットワークに流す口を作るというのも面白い発想かもしれない。\u003c/p\u003e\n\n\u003cp\u003e今回紹介したのはイベントの取得のみだが、その他にもメモリダンプを取ることもできる等、トラブルシューティングに役立つ機能があるので、うまく活用していきたい。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"参考資料\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e参考資料\u003c/h2\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://github.com/dotnet/diagnostics\" rel=\"nofollow noopener\" target=\"_blank\"\u003edotnet/diagnostics\u003c/a\u003e: EventPipe等の記述など\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://github.com/dotnet/diagnostics/blob/3.1.141901/documentation/design-docs/diagnostics-client-library.md\" rel=\"nofollow noopener\" target=\"_blank\"\u003edotnet/diagnostics/documentation/design-docs/diagnostics-client-library.md\u003c/a\u003e: クライアントライブラリの使い方\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"https://github.com/microsoft/perfview\" rel=\"nofollow noopener\" target=\"_blank\"\u003emicrosoft/perfview\u003c/a\u003e: 解析ツールのperfviewや、そのライブラリの\u003ccode\u003eMicrosoft.Diagnostics.Tracing.TraceEvent\u003c/code\u003eのソース等\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"https://github.com/microsoft/perfview/tree/P2.0.61/documentation/TraceEvent\" rel=\"nofollow noopener\" target=\"_blank\"\u003emicrosoft/perfview/documentation/TraceEvent\u003c/a\u003e: もう少し詳細なドキュメント\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/dotnet/diagnostics/blob/3.1.141901/documentation/diagnostics-client-library-instructions.md\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMicrosoft.Diagnostics.NETCore.Clientに関するドキュメント\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n","createdAt":"2020-10-13T03:04:52Z","elapsedYearsFromLastModifiedAt":0,"encryptedId":"ALfh4p7kvUwEt/GQrBO2xDy04EVQ8CdSsw==--4WUAiSPrbTWZ0CnE--t0WjD2hSfpYUdsSsZ9bkCw==","isBanned":false,"isDeprecated":false,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2020-10-15T08:21:37Z","likesCount":0,"linkUrl":"https://qiita.com/skitoy4321/items/12253681177e78d15aa3","organization":null,"originalId":1318973,"stockedCount":1,"title":"EventPipe(EventSource)から流れてくるデータを処理する","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%A7%8B%E3%82%81%E3%81%AB\"\u003e始めに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6\"\u003e前提条件\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%BA%96%E5%82%99%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E5%87%BA%E5%8A%9B%E5%81%B4%E3%81%AE%E7%94%A8%E6%84%8F\"\u003e準備(イベント出力側の用意)\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA\"\u003e必要なライブラリ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#microsoftdiagnosticsnetcoreclient%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eMicrosoft.Diagnostics.NETCore.Clientについて\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#microsoftdiagnosticstracingtraceevent%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eMicrosoft.Diagnostics.Tracing.TraceEventについて\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#eventpipeeventsource%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eEventPipeEventSourceについて\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#eventpipeeventsourcedynamicall%E3%81%AE%E4%B8%AD%E3%81%AE%E8%A7%A3%E6%9E%90%E5%87%A6%E7%90%86%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"\u003eEventPipeEventSource.Dynamic.Allの中の解析処理について\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%9A%E3%82%A4%E3%83%AD%E3%83%BC%E3%83%89%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AB%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A7%E6%9D%A5%E3%81%9F%E5%A0%B4%E5%90%88\"\u003eペイロードデータにオブジェクトで来た場合\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%A7%A3%E6%9E%90%E5%87%A6%E7%90%86%E3%81%AE%E6%B3%A8%E6%84%8F%E7%82%B9\"\u003e解析処理の注意点\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E5%86%85%E3%81%AE%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86\"\u003eコールバック内の例外処理\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%B8%80%E3%81%A4%E3%82%82%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E3%81%8C%E6%9D%A5%E3%81%AA%E3%81%84%E6%9D%A1%E4%BB%B6%E3%81%A7%E6%8C%87%E5%AE%9A%E3%81%97%E3%81%9F%E3%82%89%E3%83%95%E3%83%AA%E3%83%BC%E3%82%BA%E3%81%99%E3%82%8B\"\u003e一つもイベントが来ない条件で指定したらフリーズする\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"\u003e終わりに\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99\"\u003e参考資料\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":733,"uuid":"12253681177e78d15aa3","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"lXTSoCifgxhxS/vNUY2MHjQl6REb--grQ9nWODrjO9AS1O--+Bw05qK+ZJd8lBirizx/0w==","originalId":103253,"description":"","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=a7dce827dc16582e1b8e9c7a52216638","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","urlName":"skitoy4321","websiteUrl":"","twitterUrl":"https://twitter.com/skitoy4321","twitterUrlName":"skitoy4321","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"EventSource","urlName":"eventsource"},{"name":"EventPipe","urlName":"eventpipe"}],"followingLikers":{"edges":[]},"comments":{"totalCount":1}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
