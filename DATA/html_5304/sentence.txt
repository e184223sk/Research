More than 3 years have passed since last update.ASP.NET CoreにおけるSOAPリクエスト処理ミドルウェアのSoapCoreが、0.9.7よりsoap1.2リクエストの処理が可能になった。
しかし、同一URLでsoap1.1と1.2を受ける場合、そのままでは両方解析ということはできないので、やり方を書いておく。SoapCore自体の解説は、以前書いた記事 "ASP.NET CoreでHTTP SOAPリクエストを処理する"を参照のこと。UseSoapEndPointの第二引数で、どのような通信方式を使用するか等を指定するので、以下のようにする。それぞれHttpTransportBindingが、通信プロトコルの決定、TextMessageEncodingBindingElementが、メッセージフォーマットの決定となる。そして、この二つを合わせて、CustomBindingを作る。これ自体はWCFの話になるので、詳しく知りたければWCF公式ドキュメントを参照のこと。ここで問題は、TextMessageEncodingBindingElementが一度に一種類しか設定できないことにある。
よって、素直にUseSoapEndpointを使用した場合は、soap1.1あるいはsoap1.2のどちらかしか受け取れないということになる。Startup内で以下のようにする。要はUseWhen(Func&lt;HttpContext, bool&gt;, Action&lt;IApplicationBuilder&gt;)を使って、分岐すれば良い、という事になる。
判定部分にどのような基準を置くかという事になるが、HTTPヘッダを用いた方法はいくつかある。
ボディはミドルウェア内部で使用するので触ることはできないことに注意。この辺りはクライアントの動作仕様によるところが大きいので、唯一解は無い。参考リンクは以下


