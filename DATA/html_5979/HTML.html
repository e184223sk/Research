<!DOCTYPE html><html><head><meta charset="utf-8" /><title>LINQでBufferをやってみる話 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/aka-nse/items/010e2865cbfd06c71bd6" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="5yU2AU2pPNo2kR2yPYHsJkCPFKlLRtFo5hRz+CmwS6q29g+QZxaCDMo5hLoIAY+qr+Kdi6O+trAnsAL0okCU5w==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta property="og:type" content="article"><meta property="og:title" content="LINQでBufferをやってみる話 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1URWxPVWVPQnAwSjFabVpsY3VPQ2t1T0NoT09Cby1PQnB1T0J2LU9DaS1pcHNRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTdlYjUwZjE5MzFmYmM5OTIzMGRiNWY4YmY1OTJlMDU3&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR0ZyWVMxdWMyVSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTc5OTc1NWY2MWQ3Y2RmZDE5MWE1NDA1M2JjNDBlNDY4&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=d2525fab45d728cd75cf3e0db91d50b3"><meta property="og:description" content="IEnumerable&amp;lt;T&amp;gt;を指定件数で分割するという記事が何件か投稿されてたので自分でもやってみよう！という話
RxのBuffer使えばいいじゃん？と言うのはナシ。中身は参照してるけども。
記事の内容に誤りがあればバシバ..."><meta content="https://qiita.com/aka-nse/items/010e2865cbfd06c71bd6" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,LINQ" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-02212030-d659-41c7-a8ec-967131dac38b"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Faka-nse%2Fitems%2F010e2865cbfd06c71bd6">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Faka-nse%2Fitems%2F010e2865cbfd06c71bd6">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-02212030-d659-41c7-a8ec-967131dac38b">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2017-10-17T02:09:20.000+09:00","dateModified":"2019-11-20T18:21:44.000+09:00","headline":"LINQでBufferをやってみる話","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1URWxPVWVPQnAwSjFabVpsY3VPQ2t1T0NoT09Cby1PQnB1T0J2LU9DaS1pcHNRJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTdlYjUwZjE5MzFmYmM5OTIzMGRiNWY4YmY1OTJlMDU3\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR0ZyWVMxdWMyVSZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTQ1JnR4dC1hbGlnbj1yaWdodCUyQ2JvdHRvbSZzPTc5OTc1NWY2MWQ3Y2RmZDE5MWE1NDA1M2JjNDBlNDY4\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=d2525fab45d728cd75cf3e0db91d50b3","mainEntityOfPage":"https://qiita.com/aka-nse/items/010e2865cbfd06c71bd6","author":{"@type":"Person","address":"","email":null,"identifier":"aka-nse","name":"aka-nse","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F130885%2Fprofile-images%2F1605373686?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=680f4cff724a4ebd7fde1e3143ff43b0","url":"https://qiita.com/aka-nse","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"aka-nse","type":"items","id":"010e2865cbfd06c71bd6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"aka-nse","type":"items","id":"010e2865cbfd06c71bd6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_1","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"aka-nse","type":"items","id":"010e2865cbfd06c71bd6"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":0,"pos_id":"header_text_message_2","message":"「AirPods Pro」を抽選でプレゼント！Qiita エンジニアフェスタ 2021 Online Meetupを9/9(木)に開催","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/aka-nse/items/010e2865cbfd06c71bd6","location":"/aka-nse/items/010e2865cbfd06c71bd6","scheme":"https","host":"qiita.com","port":null,"pathname":"/aka-nse/items/010e2865cbfd06c71bd6","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"d9EIauxPGTWUHanJpup3B7iIKoosu+09riG89+1UYK8mAjH7xvCn42i1MMGTahSLV+WjqMRDiuVvhc37ZqS/4g==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-c13c617e-3097-41f1-9ecd-b828826023ed"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/aka-nse/items/010e2865cbfd06c71bd6/likers" class="css-1iupg5d">7</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">6</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/010e2865cbfd06c71bd6/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/aka-nse/items/010e2865cbfd06c71bd6/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/aka-nse/items/010e2865cbfd06c71bd6/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/aka-nse/items/010e2865cbfd06c71bd6/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/aka-nse/items/010e2865cbfd06c71bd6.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 1 year has passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/aka-nse"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/130885/profile-images/1605373686" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/aka-nse" class="css-10ougpm">@<!-- -->aka-nse</a><div class="css-1ay9vb9"><span><meta content="2017-10-16T17:09:20Z"/><time dateTime="2019-11-20T09:21:44Z" class="css-m19uds">updated at 2019-11-20</time></span></div></div></div></div></div><h1 class="css-cgzq40">LINQでBufferをやってみる話</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/linq" class="css-4czcte">LINQ</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p><code>IEnumerable&lt;T&gt;</code>を指定件数で分割するという記事が何件か投稿されてたので自分でもやってみよう！という話<br>
RxのBuffer使えばいいじゃん？と言うのはナシ。中身は参照してるけども。<br>
記事の内容に誤りがあればバシバシ叩いてください。</p>

<p><strong>2017.10.17追記</strong><br>
幾つかの実装にガード節の誤りがあったので修正。<br>
普通のListバッファを使った実装を2通り追加。</p>

<ul>
<li><a href="https://qiita.com/wipiano/items/eb562603f7efb7fac1aa">[C#][LINQ] IEnumerable の分割 (多分実用的)</a></li>
<li><a href="https://qiita.com/AsladaGSX/items/4f39c21f02b2a073a364" id="reference-149b6baaf93df4a16f17">Divide Enumerable</a></li>
</ul>

<p>なお本記事では<code>Buffer</code>という、また別のメソッド名を利用してるが、これは前述の通りReactive Extensionsの同名メソッドに倣うということで採用した。</p>

<h1>
<span id="実装を始める前に" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E3%82%92%E5%A7%8B%E3%82%81%E3%82%8B%E5%89%8D%E3%81%AB"><i class="fa fa-link"></i></a>実装を始める前に</h1>

<p>そもそも<code>Buffer</code>にはどんな仕様が要求されるのか、関連インターフェースにはどんな制約があるのかを考えてみる。</p>

<h2>
<span id="ienumerablet" class="fragment"></span><a href="#ienumerablet"><i class="fa fa-link"></i></a><code>IEnumerable&lt;T&gt;</code>
</h2>

<p>そのインスタンスに対するイテレータを公開する。<br>
<code>List&lt;T&gt;</code>や<code>Dictionary&lt;TKey,TValue&gt;</code>のような、.Netのコレクションはすべて<code>IEnumerable&lt;T&gt;</code>を実装している。<br>
LINQのオペレータは<code>IEnumerable&lt;T&gt;</code>の拡張メソッドとして定義されている。</p>

<h2>
<span id="ienumeratort" class="fragment"></span><a href="#ienumeratort"><i class="fa fa-link"></i></a><code>IEnumerator&lt;T&gt;</code>
</h2>

<p><code>IEnumerable&lt;T&gt;.GetEnumerator()</code>メソッドにより取得できるイテレータの実体。<br>
主に現在の要素を返す<code>Current</code>プロパティと、次の要素を検索する<code>MoveNext()</code>メソッドからなる。</p>

<p><code>IEnumerator&lt;T&gt;</code>の重要な性質として、もとのコレクションの変更を認めないという点があげられる。</p>

<p><a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.collections.generic.ienumerator-1?view=netstandard-2.0#Remarks" rel="nofollow noopener" target="_blank">IEnumerator Interface (System.Collections.Generic) | Microsoft Docs</a></p>

<blockquote>
<p>An enumerator remains valid as long as the collection remains unchanged. If changes are made to the collection, such as adding, modifying, or deleting elements, the enumerator is irrecoverably invalidated and the next call to MoveNext or Reset throws an InvalidOperationException.</p>
</blockquote>

<p>つまり、<code>GetEnumerator()</code>で<code>IEnumerator&lt;T&gt;</code>インスタンスを生成したあと、もとのデータソースを変更してしまうと<code>IEnumerator&lt;T&gt;</code>インスタンスは壊れてしまうということ。<br>
後述するが、これはLINQの性質と密接に関係がある。</p>

<h2>
<span id="コルーチン" class="fragment"></span><a href="#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3"><i class="fa fa-link"></i></a>コルーチン</h2>

<p>C#では<code>IEnumerable&lt;T&gt;</code>の実装、あるいは<code>IEnumerable&lt;T&gt;</code>を返すメソッドの実装に<code>yield</code>キーワードによりコルーチンを利用できる。<br>
例えば、次のように記述することができる。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">YieldSample.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">FooClass</span>
<span class="p">{</span>
    <span class="c1">// {0*a, 1*a,2*a}を返す。</span>
    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">GetFooEnumerable</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="m">0</span> <span class="p">*</span> <span class="n">a</span><span class="p">;</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="m">1</span> <span class="p">*</span> <span class="n">a</span><span class="p">;</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="m">2</span> <span class="p">*</span> <span class="n">a</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p><code>yield</code>はかなり複雑な糖衣構文で、コンパイラがステートマシンを自動生成する。<br>
前述のコードから自動生成されたクラスを読みやすく書き直すと以下のようになる。<br>
本来の生成コードはC#では認められない文法(ILレベルでは正当)を含んでいるが、ここではちゃんとC# 7.0でコンパイルが通るところまでいじっている。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">YieldSample_GeneratedCode.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">class</span> <span class="nc">FooClass</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">FooEnumerable</span> <span class="p">:</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;,</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;</span>
    <span class="p">{</span>

        <span class="k">private</span> <span class="kt">int</span> <span class="n">_state</span><span class="p">;</span>

        <span class="k">private</span> <span class="kt">long</span> <span class="n">_current</span><span class="p">;</span>

        <span class="k">private</span> <span class="kt">int</span> <span class="n">_initialThreadId</span><span class="p">;</span>

        <span class="k">private</span> <span class="kt">int</span> <span class="n">_a</span><span class="p">;</span>

        <span class="k">public</span> <span class="kt">int</span> <span class="n">A</span>
        <span class="p">{</span>
            <span class="k">get</span> <span class="p">=&gt;</span> <span class="n">_a</span><span class="p">;</span>
            <span class="k">set</span> <span class="p">=&gt;</span> <span class="n">_a</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">FooClass</span> <span class="n">_this</span><span class="p">;</span>

        <span class="kt">long</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;.</span><span class="n">Current</span> <span class="p">=&gt;</span> <span class="n">_current</span><span class="p">;</span>

        <span class="kt">object</span> <span class="n">IEnumerator</span><span class="p">.</span><span class="n">Current</span> <span class="p">=&gt;</span> <span class="n">_current</span><span class="p">;</span>



        <span class="k">public</span> <span class="nf">FooEnumerable</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_state</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
            <span class="n">_initialThreadId</span> <span class="p">=</span> <span class="n">Environment</span><span class="p">.</span><span class="n">CurrentManagedThreadId</span><span class="p">;</span>
        <span class="p">}</span>



        <span class="k">void</span> <span class="n">IDisposable</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>



        <span class="kt">bool</span> <span class="n">IEnumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">_state</span><span class="p">)</span>
            <span class="p">{</span>
                    <span class="k">case</span> <span class="m">0</span><span class="p">:</span>
                        <span class="n">_state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
                        <span class="n">_current</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                        <span class="n">_state</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
                        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
                    <span class="k">case</span> <span class="m">1</span><span class="p">:</span>
                        <span class="n">_state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
                        <span class="n">_current</span> <span class="p">=</span> <span class="n">_a</span><span class="p">;</span>
                        <span class="n">_state</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
                    <span class="k">case</span> <span class="m">2</span><span class="p">:</span>
                        <span class="n">_state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
                        <span class="n">_current</span> <span class="p">=</span> <span class="m">2</span> <span class="p">*</span> <span class="n">_a</span><span class="p">;</span>
                        <span class="n">_state</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
                        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
                    <span class="k">case</span> <span class="m">3</span><span class="p">:</span>
                        <span class="n">_state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
                        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                    <span class="k">default</span><span class="p">:</span>
                        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>



        <span class="k">void</span> <span class="n">IEnumerator</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
            <span class="p">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotSupportedException</span><span class="p">();</span>



        <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;.</span><span class="nf">GetEnumerator</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">FooEnumerable</span> <span class="n">retval</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">_state</span> <span class="p">==</span> <span class="p">-</span><span class="m">2</span> <span class="p">&amp;&amp;</span>  <span class="n">_initialThreadId</span> <span class="p">==</span> <span class="n">Environment</span><span class="p">.</span><span class="n">CurrentManagedThreadId</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_state</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                <span class="n">retval</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">retval</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FooEnumerable</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">_this</span> <span class="p">=</span> <span class="n">_this</span> <span class="p">};</span>
            <span class="p">}</span>

            <span class="n">retval</span><span class="p">.</span><span class="n">_a</span> <span class="p">=</span>  <span class="n">A</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
        <span class="p">}</span>



        <span class="n">IEnumerator</span> <span class="n">IEnumerable</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">()</span>
            <span class="p">=&gt;</span> <span class="p">(</span><span class="k">this</span> <span class="k">as</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;).</span><span class="nf">GetEnumerator</span><span class="p">();</span>

    <span class="p">}</span>



    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;</span> <span class="nf">GetFooEnumerable</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">retval</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FooEnumerable</span><span class="p">(-</span><span class="m">2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_this</span> <span class="p">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="n">A</span> <span class="p">=</span> <span class="n">a</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</div>

<p>状態変数<code>_state</code>フィールドで次にどのyield returnを返すのかを記憶し、その値に応じて<code>MoveNext()</code>メソッド内で<code>_current</code>フィールドの値を書き換えている。<br>
もとのコードでループを使っていれば<code>MoveNext()</code>の中身はもっと複雑になる。</p>

<p>注目してもらいたいのは<code>_this</code>フィールドと<code>_a</code>フィールドだ。<br>
これはもとのYieldSample.csの<code>GetFooEnumerable(int a)</code>メソッドの引数である。<sup id="fnref1"><a href="#fn1" title="C#では、というよりILではthisは暗黙のarg.0 (0番目の引数)である。">1</a></sup><br>
このように、コルーチンメソッドの引数やローカル変数は、自動生成されたEnumeratorのフィールドに転送される。</p>

<h2>
<span id="linq" class="fragment"></span><a href="#linq"><i class="fa fa-link"></i></a>LINQ</h2>

<p>統合言語クエリ。<br>
データ集合に対する一律な問い合わせ手法をまとめた機能群のこと。<br>
関数型プログラミングのエッセンスを取り入れており、データ加工を順序立てて表現できるというメリットがある。<br>
.Netにおいては<code>IEnumerable&lt;T&gt;</code>の拡張メソッドとして提供されている。</p>

<p>LINQの重要な性質は、それが遅延評価されるということだ。<br>
LINQオペレータを積み上げただけでは結果は確定せず、実際にイテレーションを開始することで最終的なデータが出来上がる。<br>
これにより、LINQでは必要なデータだけが評価されるようになっている。<br>
膨大なデータソース(場合によっては無限)に対して必要なデータが少ない場合にはパフォーマンスの観点からもパワフルなシステムなのだ。</p>

<p>だが先述した<code>IEnumerator&lt;T&gt;</code>の性質のため、実際にすべての出力を評価し終えるよりも前に論理的な評価結果は確定している。<br>
評価を開始した後はもとのデータソースを変更することができなくなるからである。<br>
つまり、イテレーションを開始した時点でその出力は一意に決まるのだ。<sup id="fnref2"><a href="#fn2" title="純粋でないオペレータを使っていればその限りではないが、そのようなケースは仕様外扱いで構わないと思う。">2</a></sup><br>
キャッシュを利用するならこのことを頭の片隅にでも置いておいたほうがいいだろう。</p>

<h2>
<span id="bufferオペレータの仕様" class="fragment"></span><a href="#buffer%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%BF%E3%81%AE%E4%BB%95%E6%A7%98"><i class="fa fa-link"></i></a><code>Buffer</code>オペレータの仕様</h2>

<p>これらLINQの仕様を踏まえた上で<code>Buffer</code>の仕様を決めていきたい。</p>

<p><br><strong>シグニチャと制約</strong><br>
<code>IEnumerable&lt;IEnumerable&lt;T&gt;&gt; Buffer&lt;T&gt;(this IEnumerable&lt;T&gt; source, int count)</code></p>

<ul>
<li>
<code>source</code> : 入力シーケンス。非null。</li>
<li>
<code>count</code>  : 正の整数。</li>
<li>return value : sourceの要素をcount個ずつまとめたイテラブルを列挙するイテラブル。</li>
</ul>

<p><code>Buffer</code>を実装するにあたり求められる最低限の仕様。ここは多分誰も異存ないだろうと思う。</p>

<p><br><strong>遅延評価</strong></p>

<ul>
<li>
<code>source</code>は遅延評価する。</li>
</ul>

<p>さらっと言ったが実はここが結構複雑。というのも、<code>Buffer</code>が取り扱うべき<code>IEnumerable</code>は2通りあるからだ。<br>
すなわち、次のようなコードがあったとき、</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">BufferSample.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">buffered</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>         <span class="c1">// (0)</span>
<span class="kt">var</span> <span class="n">chunk</span>    <span class="p">=</span> <span class="n">buffered</span><span class="p">.</span><span class="nf">ElementAt</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>    <span class="c1">// (1)</span>
<span class="kt">var</span> <span class="k">value</span>    <span class="p">=</span> <span class="n">buffer</span><span class="p">.</span><span class="nf">ElementAt</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>      <span class="c1">// (2)</span>
</code></pre></div>
</div>

<p>(1)と(2)のどちらで出力が確定しているべきか、という点だ。<br>
本記事で列挙した実装例でもこの部分の取り扱いはまちまちだ。<br>
いずれにせよ、(0)のタイミングで即時評価はしない、という点では共通している。</p>

<p>個人的には(1)のタイミングで評価完了している方が自然だと思う。<br>
<code>source.GetEnumerator()</code>が実行されているし、Rxの<code>Buffer</code>も事実そのような実装になっている。</p>

<p><br><strong>戻り値の性質</strong></p>

<ul>
<li>剰余が出た場合は末尾に余りの分のイテラブル要素を付ける。</li>
<li>剰余がない場合には末尾に空のイテラブル要素を付けない。</li>
<li>戻り値自体に、また戻り値の各要素に対してイミュータブル。</li>
</ul>

<p>最後の項目は、元のソースが不変である限り何回評価しても同じであるということだ。<br>
一度評価すると壊れてしまうと言った制約をつければより高効率化できるかもしれないが、そういった制約は設けないということである。</p>

<p><br><strong>ベンチマーク</strong></p>

<p>今回利用したベンチマーク用のメソッド。<br>
ソースの要素数に対してどれほど計算時間を要するかを確認する。<br>
ちゃんとGCも立ち上げてテスト間の依存性を減らすよう心がける。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">BufferBenchmark.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="c1">/// &lt;summary&gt; Bufferの戻り値の評価 &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">double</span> <span class="nf">Benchmark1</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">GC</span><span class="p">.</span><span class="nf">Collect</span><span class="p">();</span>
    <span class="n">GC</span><span class="p">.</span><span class="nf">WaitForPendingFinalizers</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">sw</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Stopwatch</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">enumerable</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">count</span><span class="p">).</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="nf">Last</span><span class="p">();</span>
    <span class="n">sw</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">1000000</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">enumerable</span><span class="p">.</span><span class="nf">Last</span><span class="p">();</span>

    <span class="n">sw</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
    <span class="k">return</span> <span class="m">1000.0</span> <span class="p">*</span> <span class="n">sw</span><span class="p">.</span><span class="n">ElapsedTicks</span> <span class="p">/</span> <span class="n">Stopwatch</span><span class="p">.</span><span class="n">Frequency</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/// &lt;summary&gt; Buffer + Bufferの戻り値の評価 &lt;/summary&gt;</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">double</span> <span class="nf">Benchmark2</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">GC</span><span class="p">.</span><span class="nf">Collect</span><span class="p">();</span>
    <span class="n">GC</span><span class="p">.</span><span class="nf">WaitForPendingFinalizers</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">sw</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Stopwatch</span><span class="p">();</span>
    <span class="n">sw</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">Enumerable</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">count</span><span class="p">).</span><span class="nf">Buffer</span><span class="p">(</span><span class="m">10</span><span class="p">).</span><span class="nf">Last</span><span class="p">().</span><span class="nf">Last</span><span class="p">();</span>

    <span class="n">sw</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
    <span class="k">return</span> <span class="m">1000.0</span> <span class="p">*</span> <span class="n">sw</span><span class="p">.</span><span class="n">ElapsedTicks</span> <span class="p">/</span> <span class="n">Stopwatch</span><span class="p">.</span><span class="n">Frequency</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<h1>
<span id="実装例" class="fragment"></span><a href="#%E5%AE%9F%E8%A3%85%E4%BE%8B"><i class="fa fa-link"></i></a>実装例</h1>

<h2>
<span id="i-skip--take-その1" class="fragment"></span><a href="#i-skip--take-%E3%81%9D%E3%81%AE1"><i class="fa fa-link"></i></a>I. Skip &amp; Take その1</h2>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Buffer1.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">Buffer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="p">&lt;=</span> <span class="m">0</span> <span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">count</span><span class="p">));</span>

    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="nf">BufferImpl</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="n">source</span><span class="p">.</span><span class="nf">Any</span><span class="p">();</span> <span class="n">source</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="nf">Skip</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="n">source</span><span class="p">.</span><span class="nf">Take</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">BufferImpl</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>多分これが一番シンプルな実装。<br>
中身も非常にLINQらしい仕上がりとなっている。<br>
手元でさらっと実装して使うときにはこの実装を利用している人も多いと思う。<br>
この実装では遅延評価の確定タイミングは(2)である。</p>

<h2>
<span id="ii-skip--take-その2" class="fragment"></span><a href="#ii-skip--take-%E3%81%9D%E3%81%AE2"><i class="fa fa-link"></i></a>II. Skip &amp; Take その2</h2>

<p>その1の実装は短くまとまっているが、パフォーマンス的によろしいとはいえない。<br>
ベンチマークを取ってみると計算時間はソースの要素数に対して$O(n^3)$程度にもなっている。<br>
原因は<code>Skip</code>オペレータが多段化してしまっていることにある。<br>
後ろの方のイテラブルは<code>Skip</code>のネストが深くなりすぎてとても重くなる。<br>
そこでスキップ数の方をカウントアップし、常に<code>Skip</code>1段のみになるよう書き直す。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Buffer2.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">Buffer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="p">&lt;=</span> <span class="m">0</span> <span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">count</span><span class="p">));</span>

    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="nf">BufferImpl</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">source</span><span class="p">.</span><span class="nf">Skip</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="nf">Any</span><span class="p">()</span> <span class="p">;</span> <span class="n">i</span> <span class="p">+=</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="n">source</span><span class="p">.</span><span class="nf">Skip</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="nf">Take</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">BufferImpl</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>こちらは$O(n^2)$程度なので、前項のものと比べるとかなり速い。<br>
ほんの僅かに記述量が増えたものの、パフォーマンス向上の恩恵に比べれば安いものじゃなろうか。</p>

<p>こちらの実装でも遅延評価の確定タイミングは(2)である。</p>

<h2>
<span id="iii-arrayバッファ" class="fragment"></span><a href="#iii-array%E3%83%90%E3%83%83%E3%83%95%E3%82%A1"><i class="fa fa-link"></i></a>III. Arrayバッファ</h2>

<p><a href="https://qiita.com/wipiano/items/eb562603f7efb7fac1aa">先行記事</a>で紹介されていた実装。<br>
アルゴリズムの勉強と思って、一応丸コピペではなく自分流に書き直してある。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Buffer3.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">Buffer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">count</span><span class="p">));</span>

    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="nf">BufferImpl</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">count</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">array</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(!</span><span class="n">enumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">())</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">array</span><span class="p">.</span><span class="n">Count</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="k">return</span> <span class="n">array</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">BufferImpl</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>分割後の各イテラブルが始まるタイミングで要素数<code>count</code>の配列を生成、シーケンスをインクリメントしながら配列を詰めていき、全て埋まったところでyield return。<br>
評価タイミングは(1)。</p>

<h2>
<span id="iv-listバッファ-その1" class="fragment"></span><a href="#iv-list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1-%E3%81%9D%E3%81%AE1"><i class="fa fa-link"></i></a>IV. Listバッファ その1</h2>

<p>III.の実装をArrayからListに置き換えたもの。Addが使えるので若干表現が変わる。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Buffer4.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">Buffer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">count</span><span class="p">));</span>

    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="nf">BufferImpl</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">count</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">list</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(!</span><span class="n">enumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">())</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">Count</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">BufferImpl</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>分割後の各イテラブルが始まるタイミングで要素数<code>count</code>の配列を生成、シーケンスをインクリメントしながら配列を詰めていき、全て埋まったところでyield return。<br>
評価タイミングは(1)。</p>

<h2>
<span id="v-queue--listバッファ" class="fragment"></span><a href="#v-queue--list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1"><i class="fa fa-link"></i></a>V. Queue &amp; Listバッファ</h2>

<p><a href="https://github.com/Reactive-Extensions/Rx.NET/blob/develop/Ix.NET/Source/System.Interactive/Buffer.cs" rel="nofollow noopener" target="_blank">Reactive Extensions</a>で用意されているアルゴリズム。<br>
Rxを導入しているならこれ使っとけばええねんという感じだが、それはそれ。<br>
Rxの<code>Buffer</code>は単純にシーケンスを分割するだけでなく、出力される各シーケンスがどのような間隔(<code>skip</code>引数)をとるかを指定するオーバーロード<sup id="fnref3"><a href="#fn3" title="Rx版(IObservable)では更に時間幅を引数に取るオーバーロードも存在するが、Ix版(IEnumerable)に同等の機能はない。IEnumerableの出力に時間的分布は考慮されない(もちろん、激遅コルーチンで無理やり時間差を付けることはできるが)ので当然といえば当然である。">3</a></sup>を持っており、それを踏まえた実装になっている。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Buffer5.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">Buffer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">count</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">source</span><span class="p">.</span><span class="nf">BufferImpl</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">BufferImpl</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">buffers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;(</span><span class="n">Math</span><span class="p">.</span><span class="nf">Max</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">count</span><span class="p">-</span><span class="n">skip</span><span class="p">)</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">source</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">%</span> <span class="n">skip</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="n">buffers</span><span class="p">.</span><span class="nf">Enqueue</span><span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">count</span><span class="p">));</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">buffer</span> <span class="k">in</span> <span class="n">buffers</span><span class="p">)</span>
            <span class="n">buffer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">buffers</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="p">&amp;&amp;</span> <span class="n">buffers</span><span class="p">.</span><span class="nf">Peek</span><span class="p">().</span><span class="n">Count</span> <span class="p">==</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="n">buffers</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">();</span>

        <span class="n">i</span><span class="p">++;</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">buffers</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="n">buffers</span><span class="p">.</span><span class="nf">Dequeue</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>方針としては、Arrayバッファの時と同様イテラブルの先頭要素に来たときに新しいバッファを生成し、要素が必要数溜まった段階で放流する。<br>
異なっているのはListを使っていることと、Queueにより複数のイテラブルを並行的に生成できることだ。</p>

<p>このアルゴリズムの評価タイミングは(1)。</p>

<h2>
<span id="vi-listバッファ-その2" class="fragment"></span><a href="#vi-list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1-%E3%81%9D%E3%81%AE2"><i class="fa fa-link"></i></a>VI. Listバッファ その2</h2>

<p>V.の実装はオーバーロードのためにQueueを用意しており、追加のコストを払っている。<br>
今回話題にしている、count個ごとのシーケンスの分割だけを考えるならList一つで十分なはずだと指摘を受け、急遽実装。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Buffer6.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">Buffer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">count</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">source</span><span class="p">.</span><span class="nf">BufferImpl</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">BufferImpl</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">count</span><span class="p">);</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">source</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">buffer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="n">count</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
            <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">count</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">yield</span> <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>このアルゴリズムの評価タイミングは(1)。</p>

<h2>
<span id="vii-単一listバッファ" class="fragment"></span><a href="#vii-%E5%8D%98%E4%B8%80list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1"><i class="fa fa-link"></i></a>VII. 単一Listバッファ</h2>

<p>最後に自作のアルゴリズムを一つ。</p>

<div class="code-frame" data-lang="C#">
<div class="code-lang"><span class="bold">Buffer7.cs</span></div>
<div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">Buffer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">source</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="p">&lt;=</span> <span class="m">0</span><span class="p">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentOutOfRangeException</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">count</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">source</span><span class="p">.</span><span class="nf">BufferImpl</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">BufferImpl</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">source</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">skip</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">enumerator</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span> <span class="p">&amp;&amp;</span> <span class="n">enumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">();</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">buffer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(;</span> <span class="n">enumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">();</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="p">-</span> <span class="n">count</span><span class="p">)</span> <span class="p">%</span> <span class="n">skip</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
                <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">SubList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span> <span class="p">-</span> <span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">enumerator</span><span class="p">.</span><span class="nf">MoveNext</span><span class="p">())</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="n">buffer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="p">-</span> <span class="n">count</span><span class="p">)</span> <span class="p">%</span> <span class="n">skip</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
            <span class="k">yield</span> <span class="k">return</span> <span class="k">new</span> <span class="n">SubList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">i</span> <span class="p">-</span> <span class="p">(</span><span class="n">i</span> <span class="p">%</span> <span class="n">skip</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>

<p>最初のfor文は、count個バッファに溜まっていない状態では放流を開始しないという条件分岐の計算コストを減らすためのもの。<br>
2つ目のfor文とマージしてもよいが、どうせなら余計な計算コストは避けたいものだ。</p>

<p>このアルゴリズムでは、バッファには単一のリストを利用している。<br>
<code>SubList&lt;T&gt;</code>は<code>IList&lt;T&gt;</code>のデコレータで、<code>start</code>と<code>count</code>という2つのパラメータを用いてインデックスにオフセットをかけた部分リストを表現する。あくまでデコレータなので自身にアロケーションコストはない。<br>
区間を抽出できさえすればわざわざ新しいバッファを用意する必要がなく、またIListであれば区間抽出の計算コストが$O(1)$にできるという訳だ。<br>
調子に乗ってクソでかいソースに対して使うとListの内部配列がLOH送りになってパフォーマンスに影響が出るかもしれないが・・・。</p>

<p>このアルゴリズムも評価タイミングは(1)である。</p>

<h1>
<span id="ベンチマーク" class="fragment"></span><a href="#%E3%83%99%E3%83%B3%E3%83%81%E3%83%9E%E3%83%BC%E3%82%AF"><i class="fa fa-link"></i></a>ベンチマーク</h1>

<p>というわけでベンチマークを取ってみる。<br>
とりあえず自分のマシンで回した結果は以下の通り。</p>

<p><strong>スペック</strong><br>
- CPU : Intel Core i7-6700K 4.00GHz (64bit)<br>
- RAM : 32.0GB<br>
- OS : Windows 10 Home<br>
- 処理系 : .NET Framework 4.6.1 64bit</p>

<ul>
<li>Benchmark1</li>
</ul>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: right">count = 100</th>
<th style="text-align: right">500</th>
<th style="text-align: right">1000</th>
<th style="text-align: right">5000</th>
<th style="text-align: right">10000</th>
<th style="text-align: right">10^5</th>
<th style="text-align: right">10^6</th>
<th style="text-align: right">10^7</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">Skip &amp; Take 1</td>
<td style="text-align: right">4555ms</td>
<td style="text-align: right">100036ms</td>
<td style="text-align: right">379809ms</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
</tr>
<tr>
<td style="text-align: left">Skip &amp; Take 2</td>
<td style="text-align: right">598ms</td>
<td style="text-align: right">1582ms</td>
<td style="text-align: right">2945ms</td>
<td style="text-align: right">13857ms</td>
<td style="text-align: right">27589ms</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
</tr>
<tr>
<td style="text-align: left">Array</td>
<td style="text-align: right">24.3ms</td>
<td style="text-align: right">24.0ms</td>
<td style="text-align: right">24.7ms</td>
<td style="text-align: right">30.2ms</td>
<td style="text-align: right">27.3ms</td>
<td style="text-align: right">28.4ms</td>
<td style="text-align: right">28.5ms</td>
<td style="text-align: right">32.1ms</td>
</tr>
<tr>
<td style="text-align: left">List 1</td>
<td style="text-align: right">7.67ms</td>
<td style="text-align: right">6.67ms</td>
<td style="text-align: right">6.81ms</td>
<td style="text-align: right">6.65ms</td>
<td style="text-align: right">6.71ms</td>
<td style="text-align: right">6.68ms</td>
<td style="text-align: right">6.67ms</td>
<td style="text-align: right">6.52ms</td>
</tr>
<tr>
<td style="text-align: left">Queue &amp; List</td>
<td style="text-align: right">7.70ms</td>
<td style="text-align: right">6.54ms</td>
<td style="text-align: right">7.39ms</td>
<td style="text-align: right">6.65ms</td>
<td style="text-align: right">6.70ms</td>
<td style="text-align: right">6.54ms</td>
<td style="text-align: right">6.67ms</td>
<td style="text-align: right">6.53ms</td>
</tr>
<tr>
<td style="text-align: left">List 2</td>
<td style="text-align: right">6.08ms</td>
<td style="text-align: right">6.08ms</td>
<td style="text-align: right">6.15ms</td>
<td style="text-align: right">6.70ms</td>
<td style="text-align: right">6.73ms</td>
<td style="text-align: right">6.59ms</td>
<td style="text-align: right">7.07ms</td>
<td style="text-align: right">6.42ms</td>
</tr>
<tr>
<td style="text-align: left">Single List</td>
<td style="text-align: right">7.99ms</td>
<td style="text-align: right">7.64ms</td>
<td style="text-align: right">7.65ms</td>
<td style="text-align: right">7.57ms</td>
<td style="text-align: right">7.57ms</td>
<td style="text-align: right">8.49ms</td>
<td style="text-align: right">7.87ms</td>
<td style="text-align: right">8.01ms</td>
</tr>
</tbody>
</table>

<ul>
<li>Benchmark2</li>
</ul>

<table>
<thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: right">count = 100</th>
<th style="text-align: right">500</th>
<th style="text-align: right">1000</th>
<th style="text-align: right">5000</th>
<th style="text-align: right">10000</th>
<th style="text-align: right">10^5</th>
<th style="text-align: right">10^6</th>
<th style="text-align: right">10^7</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left">Skip &amp; Take 1</td>
<td style="text-align: right">2.31ms</td>
<td style="text-align: right">186ms</td>
<td style="text-align: right">1370ms</td>
<td style="text-align: right">159076ms</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
</tr>
<tr>
<td style="text-align: left">Skip &amp; Take 2</td>
<td style="text-align: right">0.29ms</td>
<td style="text-align: right">4.35ms</td>
<td style="text-align: right">23.8ms</td>
<td style="text-align: right">348ms</td>
<td style="text-align: right">1530ms</td>
<td style="text-align: right">136629ms</td>
<td style="text-align: right">X</td>
<td style="text-align: right">X</td>
</tr>
<tr>
<td style="text-align: left">Array</td>
<td style="text-align: right">0.07ms</td>
<td style="text-align: right">0.49ms</td>
<td style="text-align: right">0.58ms</td>
<td style="text-align: right">3.23ms</td>
<td style="text-align: right">6.01ms</td>
<td style="text-align: right">60.2ms</td>
<td style="text-align: right">582ms</td>
<td style="text-align: right">5635ms</td>
</tr>
<tr>
<td style="text-align: left">List 1</td>
<td style="text-align: right">0.11ms</td>
<td style="text-align: right">0.50ms</td>
<td style="text-align: right">1.01ms</td>
<td style="text-align: right">3.50ms</td>
<td style="text-align: right">7.00ms</td>
<td style="text-align: right">82.6ms</td>
<td style="text-align: right">696ms</td>
<td style="text-align: right">6763ms</td>
</tr>
<tr>
<td style="text-align: left">Queue &amp; List</td>
<td style="text-align: right">0.33ms</td>
<td style="text-align: right">1.36ms</td>
<td style="text-align: right">2.70ms</td>
<td style="text-align: right">13.5ms</td>
<td style="text-align: right">30.9ms</td>
<td style="text-align: right">275ms</td>
<td style="text-align: right">2718ms</td>
<td style="text-align: right">27272ms</td>
</tr>
<tr>
<td style="text-align: left">List 2</td>
<td style="text-align: right">0.09ms</td>
<td style="text-align: right">0.40ms</td>
<td style="text-align: right">0.77ms</td>
<td style="text-align: right">3.93ms</td>
<td style="text-align: right">7.88ms</td>
<td style="text-align: right">81.1ms</td>
<td style="text-align: right">801ms</td>
<td style="text-align: right">7397ms</td>
</tr>
<tr>
<td style="text-align: left">Single List</td>
<td style="text-align: right">0.11ms</td>
<td style="text-align: right">0.38ms</td>
<td style="text-align: right">0.76ms</td>
<td style="text-align: right">3.84ms</td>
<td style="text-align: right">7.60ms</td>
<td style="text-align: right">98.2ms</td>
<td style="text-align: right">838ms</td>
<td style="text-align: right">8538ms</td>
</tr>
</tbody>
</table>

<p>※ X印はあまりの遅さにベンチマーク完走を断念したことを表します。遅すぎるわ！</p>

<p>Skip &amp; Take その1、走らせてみるとこれはちょっと深刻に遅い・・・。<br>
その2の方はその1に比べればかなりまし。下3つに比べればかなり不満な数字だが、評価タイミング(2)の実装でこれより速いのはちょっと思いつかない。</p>

<p>評価タイミング(1)の実装だとBenchmark1の方ではArrayバッファが若干遅い。<br>
しかし、これらの実装にとってBenchmark1は単にリストの末尾要素にアクセスするだけの操作になっているはず。<br>
詳しくはよくわからないが、<code>IEnumerable&lt;T&gt;</code>としてアクセスする場合にはArrayよりListの方が速いみたいだ。</p>

<p>Benchmark2ではArrayバッファが最速だった。<br>
List 1とList 2の比較を見る限り、<a href="https://qiita.com/wipiano/items/eb562603f7efb7fac1aa">先行記事</a>の実装は制御構造的にも速いようだ。</p>

<p>Rxの<code>Buffer</code>実装は存外速くない。<br>
Queue &amp; ListとList 2の差が、Rxがオーバーロードのために払っているコストであり、それは決して小さくはないようである。</p>

<p>今回実装したSingle ListはBenchmark1でListを返すものに比べごく僅かに遅い傾向があり、Benchmark2でもListには敵わない。<br>
これは、デコレータを挟んだことでcallvirt命令が一つ余分に入っているせいなのではと思っている。<br>
でも、オーバーロードに対応する前提でいえばQueue &amp; Listの実装よりもずっと速い。</p>

<h1>
<span id="結論" class="fragment"></span><a href="#%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>結論</h1>

<p><a href="https://qiita.com/wipiano/items/eb562603f7efb7fac1aa">先行記事</a>で紹介されていた実装はさすがの速さだった。<br>
Arrayでは<code>IEnumerable&lt;T&gt;</code>としてのアクセスに若干の不利があるようだが、Benchmark1のようなユースケースではそもそも即<code>ToList</code>なりするだろうから問題になりにくいだろう。<br>
評価タイミング(1)の実装においてはBenchmark2の結果のほうが重要だ。<br>
とは言えArrayバッファの実装はオーバーロードへの応用に難があるので、その点では単一Listバッファにもメリットがあるんじゃないかな。</p>

<p>Skip &amp; Take その1の実装は色んなブログで見かけた記憶があるが、これはちょっと一考すべきパフォーマンスの悪さだと思う。<br>
それほどシビアなユースケースでなくとも、可能な限りその2の実装に切り替えたほうがいい。<br>
そのSkip &amp; Takeその2の実装もお世辞には高速と言えないが、分割後の各イテラブルにまで遅延評価がかかる実装はこれしかない。<br>
もしもそういうユースケースがあるなら諦めて使わざるを得ないだろう。(正直そんなケースは思いつかないが)</p>

<p>かなり関係ないところからスタートしてだいぶ遠回りしたが、ライブラリレイヤーではこういった厳密な仕様固めが大事だと思う。<br>
ドキュメントを突き詰めてインターフェースの仕様をしっかり理解することに努めたのはいい経験になったかな。</p>

<h1>
<span id="最後に" class="fragment"></span><a href="#%E6%9C%80%E5%BE%8C%E3%81%AB"><i class="fa fa-link"></i></a>最後に</h1>

<p>普通にコーディングしてる分にはRx使えばいいと思うよ。<br>
ビバ、メジャーライブラリ。</p>

<hr>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>C#では、というよりILでは<code>this</code>は暗黙のarg.0 (0番目の引数)である。 <a href="#fnref1">↩</a></p>
</li>

<li id="fn2">
<p>純粋でないオペレータを使っていればその限りではないが、そのようなケースは仕様外扱いで構わないと思う。 <a href="#fnref2">↩</a></p>
</li>

<li id="fn3">
<p>Rx版(IObservable)では更に時間幅を引数に取るオーバーロードも存在するが、Ix版(IEnumerable)に同等の機能はない。IEnumerableの出力に時間的分布は考慮されない(もちろん、激遅コルーチンで無理やり時間差を付けることはできるが)ので当然といえば当然である。 <a href="#fnref3">↩</a></p>
</li>

</ol>
</div>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Faka-nse%2Fitems%2F010e2865cbfd06c71bd6&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Faka-nse%2Fitems%2F010e2865cbfd06c71bd6&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/aka-nse/items/010e2865cbfd06c71bd6/likers" class="css-1iupg5d">7</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">6</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/010e2865cbfd06c71bd6/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/aka-nse/items/010e2865cbfd06c71bd6/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/aka-nse/items/010e2865cbfd06c71bd6/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/aka-nse/items/010e2865cbfd06c71bd6/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/aka-nse/items/010e2865cbfd06c71bd6.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-c13c617e-3097-41f1-9ecd-b828826023ed">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-0f8702dc-8f1a-4213-9f72-c79ea002ff0d"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-0f8702dc-8f1a-4213-9f72-c79ea002ff0d">{}</script>
      
<div id="LoginModal-react-component-644dfa2b-6d2d-4b7f-8d61-4e7622bc31ef"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-644dfa2b-6d2d-4b7f-8d61-4e7622bc31ef">{}</script>
      
<div id="StockModal-react-component-6639f6a9-ef0f-4556-a4db-5ad1a20e2f3c"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-6639f6a9-ef0f-4556-a4db-5ad1a20e2f3c">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;mud35nTU7g++6PD9IVks+MfzqnHW+o50/Ac3MyswvZ/LNE53XmtQ2UJAafUU2U90KJ4jUz4C6aw9o0Y/oMBi0g==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003e\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eを指定件数で分割するという記事が何件か投稿されてたので自分でもやってみよう！という話\u003cbr\u003e\nRxのBuffer使えばいいじゃん？と言うのはナシ。中身は参照してるけども。\u003cbr\u003e\n記事の内容に誤りがあればバシバシ叩いてください。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e2017.10.17追記\u003c/strong\u003e\u003cbr\u003e\n幾つかの実装にガード節の誤りがあったので修正。\u003cbr\u003e\n普通のListバッファを使った実装を2通り追加。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/wipiano/items/eb562603f7efb7fac1aa\"\u003e[C#][LINQ] IEnumerable の分割 (多分実用的)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/AsladaGSX/items/4f39c21f02b2a073a364\" id=\"reference-149b6baaf93df4a16f17\"\u003eDivide Enumerable\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eなお本記事では\u003ccode\u003eBuffer\u003c/code\u003eという、また別のメソッド名を利用してるが、これは前述の通りReactive Extensionsの同名メソッドに倣うということで採用した。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実装を始める前に\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85%E3%82%92%E5%A7%8B%E3%82%81%E3%82%8B%E5%89%8D%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装を始める前に\u003c/h1\u003e\n\n\u003cp\u003eそもそも\u003ccode\u003eBuffer\u003c/code\u003eにはどんな仕様が要求されるのか、関連インターフェースにはどんな制約があるのかを考えてみる。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ienumerablet\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ienumerablet\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003e\n\u003c/h2\u003e\n\n\u003cp\u003eそのインスタンスに対するイテレータを公開する。\u003cbr\u003e\n\u003ccode\u003eList\u0026lt;T\u0026gt;\u003c/code\u003eや\u003ccode\u003eDictionary\u0026lt;TKey,TValue\u0026gt;\u003c/code\u003eのような、.Netのコレクションはすべて\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eを実装している。\u003cbr\u003e\nLINQのオペレータは\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eの拡張メソッドとして定義されている。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ienumeratort\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ienumeratort\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eIEnumerator\u0026lt;T\u0026gt;\u003c/code\u003e\n\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;.GetEnumerator()\u003c/code\u003eメソッドにより取得できるイテレータの実体。\u003cbr\u003e\n主に現在の要素を返す\u003ccode\u003eCurrent\u003c/code\u003eプロパティと、次の要素を検索する\u003ccode\u003eMoveNext()\u003c/code\u003eメソッドからなる。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode\u003eIEnumerator\u0026lt;T\u0026gt;\u003c/code\u003eの重要な性質として、もとのコレクションの変更を認めないという点があげられる。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/api/system.collections.generic.ienumerator-1?view=netstandard-2.0#Remarks\" rel=\"nofollow noopener\" target=\"_blank\"\u003eIEnumerator Interface (System.Collections.Generic) | Microsoft Docs\u003c/a\u003e\u003c/p\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eAn enumerator remains valid as long as the collection remains unchanged. If changes are made to the collection, such as adding, modifying, or deleting elements, the enumerator is irrecoverably invalidated and the next call to MoveNext or Reset throws an InvalidOperationException.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eつまり、\u003ccode\u003eGetEnumerator()\u003c/code\u003eで\u003ccode\u003eIEnumerator\u0026lt;T\u0026gt;\u003c/code\u003eインスタンスを生成したあと、もとのデータソースを変更してしまうと\u003ccode\u003eIEnumerator\u0026lt;T\u0026gt;\u003c/code\u003eインスタンスは壊れてしまうということ。\u003cbr\u003e\n後述するが、これはLINQの性質と密接に関係がある。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"コルーチン\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコルーチン\u003c/h2\u003e\n\n\u003cp\u003eC#では\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eの実装、あるいは\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eを返すメソッドの実装に\u003ccode\u003eyield\u003c/code\u003eキーワードによりコルーチンを利用できる。\u003cbr\u003e\n例えば、次のように記述することができる。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eYieldSample.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFooClass\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// {0*a, 1*a,2*a}を返す。\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetFooEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e\u003ccode\u003eyield\u003c/code\u003eはかなり複雑な糖衣構文で、コンパイラがステートマシンを自動生成する。\u003cbr\u003e\n前述のコードから自動生成されたクラスを読みやすく書き直すと以下のようになる。\u003cbr\u003e\n本来の生成コードはC#では認められない文法(ILレベルでは正当)を含んでいるが、ここではちゃんとC# 7.0でコンパイルが通るところまでいじっている。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eYieldSample_GeneratedCode.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFooClass\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003esealed\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eFooEnumerable\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;,\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003e_current\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_initialThreadId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e_a\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eget\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_a\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eset\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_a\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eFooClass\u003c/span\u003e \u003cspan class=\"n\"\u003e_this\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_current\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003eobject\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrent\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_current\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_initialThreadId\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentManagedThreadId\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\n        \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\n        \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_state\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_current\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_current\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_a\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_current\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003e_a\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\n        \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReset\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eNotSupportedException\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n\n\n        \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eFooEnumerable\u003c/span\u003e \u003cspan class=\"n\"\u003eretval\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e  \u003cspan class=\"n\"\u003e_initialThreadId\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eEnvironment\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrentManagedThreadId\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_state\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eretval\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eretval\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003e_this\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_this\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eretval\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003e_a\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e  \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eretval\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\n        \u003cspan class=\"n\"\u003eIEnumerator\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;).\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\n\n    \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eGetFooEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eretval\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eFooEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e(-\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_this\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ethis\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eA\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eretval\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e状態変数\u003ccode\u003e_state\u003c/code\u003eフィールドで次にどのyield returnを返すのかを記憶し、その値に応じて\u003ccode\u003eMoveNext()\u003c/code\u003eメソッド内で\u003ccode\u003e_current\u003c/code\u003eフィールドの値を書き換えている。\u003cbr\u003e\nもとのコードでループを使っていれば\u003ccode\u003eMoveNext()\u003c/code\u003eの中身はもっと複雑になる。\u003c/p\u003e\n\n\u003cp\u003e注目してもらいたいのは\u003ccode\u003e_this\u003c/code\u003eフィールドと\u003ccode\u003e_a\u003c/code\u003eフィールドだ。\u003cbr\u003e\nこれはもとのYieldSample.csの\u003ccode\u003eGetFooEnumerable(int a)\u003c/code\u003eメソッドの引数である。\u003csup id=\"fnref1\"\u003e\u003ca href=\"#fn1\" title=\"C#では、というよりILではthisは暗黙のarg.0 (0番目の引数)である。\"\u003e1\u003c/a\u003e\u003c/sup\u003e\u003cbr\u003e\nこのように、コルーチンメソッドの引数やローカル変数は、自動生成されたEnumeratorのフィールドに転送される。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"linq\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#linq\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eLINQ\u003c/h2\u003e\n\n\u003cp\u003e統合言語クエリ。\u003cbr\u003e\nデータ集合に対する一律な問い合わせ手法をまとめた機能群のこと。\u003cbr\u003e\n関数型プログラミングのエッセンスを取り入れており、データ加工を順序立てて表現できるというメリットがある。\u003cbr\u003e\n.Netにおいては\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eの拡張メソッドとして提供されている。\u003c/p\u003e\n\n\u003cp\u003eLINQの重要な性質は、それが遅延評価されるということだ。\u003cbr\u003e\nLINQオペレータを積み上げただけでは結果は確定せず、実際にイテレーションを開始することで最終的なデータが出来上がる。\u003cbr\u003e\nこれにより、LINQでは必要なデータだけが評価されるようになっている。\u003cbr\u003e\n膨大なデータソース(場合によっては無限)に対して必要なデータが少ない場合にはパフォーマンスの観点からもパワフルなシステムなのだ。\u003c/p\u003e\n\n\u003cp\u003eだが先述した\u003ccode\u003eIEnumerator\u0026lt;T\u0026gt;\u003c/code\u003eの性質のため、実際にすべての出力を評価し終えるよりも前に論理的な評価結果は確定している。\u003cbr\u003e\n評価を開始した後はもとのデータソースを変更することができなくなるからである。\u003cbr\u003e\nつまり、イテレーションを開始した時点でその出力は一意に決まるのだ。\u003csup id=\"fnref2\"\u003e\u003ca href=\"#fn2\" title=\"純粋でないオペレータを使っていればその限りではないが、そのようなケースは仕様外扱いで構わないと思う。\"\u003e2\u003c/a\u003e\u003c/sup\u003e\u003cbr\u003e\nキャッシュを利用するならこのことを頭の片隅にでも置いておいたほうがいいだろう。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"bufferオペレータの仕様\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#buffer%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%BF%E3%81%AE%E4%BB%95%E6%A7%98\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eBuffer\u003c/code\u003eオペレータの仕様\u003c/h2\u003e\n\n\u003cp\u003eこれらLINQの仕様を踏まえた上で\u003ccode\u003eBuffer\u003c/code\u003eの仕様を決めていきたい。\u003c/p\u003e\n\n\u003cp\u003e\u003cbr\u003e\u003cstrong\u003eシグニチャと制約\u003c/strong\u003e\u003cbr\u003e\n\u003ccode\u003eIEnumerable\u0026lt;IEnumerable\u0026lt;T\u0026gt;\u0026gt; Buffer\u0026lt;T\u0026gt;(this IEnumerable\u0026lt;T\u0026gt; source, int count)\u003c/code\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003esource\u003c/code\u003e : 入力シーケンス。非null。\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003ecount\u003c/code\u003e  : 正の整数。\u003c/li\u003e\n\u003cli\u003ereturn value : sourceの要素をcount個ずつまとめたイテラブルを列挙するイテラブル。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003ccode\u003eBuffer\u003c/code\u003eを実装するにあたり求められる最低限の仕様。ここは多分誰も異存ないだろうと思う。\u003c/p\u003e\n\n\u003cp\u003e\u003cbr\u003e\u003cstrong\u003e遅延評価\u003c/strong\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003esource\u003c/code\u003eは遅延評価する。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eさらっと言ったが実はここが結構複雑。というのも、\u003ccode\u003eBuffer\u003c/code\u003eが取り扱うべき\u003ccode\u003eIEnumerable\u003c/code\u003eは2通りあるからだ。\u003cbr\u003e\nすなわち、次のようなコードがあったとき、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBufferSample.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffered\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e         \u003cspan class=\"c1\"\u003e// (0)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003echunk\u003c/span\u003e    \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffered\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eElementAt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// (1)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"k\"\u003evalue\u003c/span\u003e    \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eElementAt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// (2)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e(1)と(2)のどちらで出力が確定しているべきか、という点だ。\u003cbr\u003e\n本記事で列挙した実装例でもこの部分の取り扱いはまちまちだ。\u003cbr\u003e\nいずれにせよ、(0)のタイミングで即時評価はしない、という点では共通している。\u003c/p\u003e\n\n\u003cp\u003e個人的には(1)のタイミングで評価完了している方が自然だと思う。\u003cbr\u003e\n\u003ccode\u003esource.GetEnumerator()\u003c/code\u003eが実行されているし、Rxの\u003ccode\u003eBuffer\u003c/code\u003eも事実そのような実装になっている。\u003c/p\u003e\n\n\u003cp\u003e\u003cbr\u003e\u003cstrong\u003e戻り値の性質\u003c/strong\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e剰余が出た場合は末尾に余りの分のイテラブル要素を付ける。\u003c/li\u003e\n\u003cli\u003e剰余がない場合には末尾に空のイテラブル要素を付けない。\u003c/li\u003e\n\u003cli\u003e戻り値自体に、また戻り値の各要素に対してイミュータブル。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e最後の項目は、元のソースが不変である限り何回評価しても同じであるということだ。\u003cbr\u003e\n一度評価すると壊れてしまうと言った制約をつければより高効率化できるかもしれないが、そういった制約は設けないということである。\u003c/p\u003e\n\n\u003cp\u003e\u003cbr\u003e\u003cstrong\u003eベンチマーク\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e今回利用したベンチマーク用のメソッド。\u003cbr\u003e\nソースの要素数に対してどれほど計算時間を要するかを確認する。\u003cbr\u003e\nちゃんとGCも立ち上げてテスト間の依存性を減らすよう心がける。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBufferBenchmark.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt; Bufferの戻り値の評価 \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"nf\"\u003eBenchmark1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCollect\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitForPendingFinalizers\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerable\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e1000000\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eenumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e1000.0\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsedTicks\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrequency\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e/// \u0026lt;summary\u0026gt; Buffer + Bufferの戻り値の評価 \u0026lt;/summary\u0026gt;\u003c/span\u003e\n\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003edouble\u003c/span\u003e \u003cspan class=\"nf\"\u003eBenchmark2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eCollect\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGC\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitForPendingFinalizers\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eLast\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eStop\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"m\"\u003e1000.0\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003esw\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElapsedTicks\u003c/span\u003e \u003cspan class=\"p\"\u003e/\u003c/span\u003e \u003cspan class=\"n\"\u003eStopwatch\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFrequency\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"実装例\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%AE%9F%E8%A3%85%E4%BE%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e実装例\u003c/h1\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"i-skip--take-その1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#i-skip--take-%E3%81%9D%E3%81%AE1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eI. Skip \u0026amp; Take その1\u003c/h2\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBuffer1.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentNullException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAny\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSkip\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e多分これが一番シンプルな実装。\u003cbr\u003e\n中身も非常にLINQらしい仕上がりとなっている。\u003cbr\u003e\n手元でさらっと実装して使うときにはこの実装を利用している人も多いと思う。\u003cbr\u003e\nこの実装では遅延評価の確定タイミングは(2)である。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"ii-skip--take-その2\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#ii-skip--take-%E3%81%9D%E3%81%AE2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eII. Skip \u0026amp; Take その2\u003c/h2\u003e\n\n\u003cp\u003eその1の実装は短くまとまっているが、パフォーマンス的によろしいとはいえない。\u003cbr\u003e\nベンチマークを取ってみると計算時間はソースの要素数に対して$O(n^3)$程度にもなっている。\u003cbr\u003e\n原因は\u003ccode\u003eSkip\u003c/code\u003eオペレータが多段化してしまっていることにある。\u003cbr\u003e\n後ろの方のイテラブルは\u003ccode\u003eSkip\u003c/code\u003eのネストが深くなりすぎてとても重くなる。\u003cbr\u003e\nそこでスキップ数の方をカウントアップし、常に\u003ccode\u003eSkip\u003c/code\u003e1段のみになるよう書き直す。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBuffer2.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentNullException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSkip\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eAny\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSkip\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eTake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこちらは$O(n^2)$程度なので、前項のものと比べるとかなり速い。\u003cbr\u003e\nほんの僅かに記述量が増えたものの、パフォーマンス向上の恩恵に比べれば安いものじゃなろうか。\u003c/p\u003e\n\n\u003cp\u003eこちらの実装でも遅延評価の確定タイミングは(2)である。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"iii-arrayバッファ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#iii-array%E3%83%90%E3%83%83%E3%83%95%E3%82%A1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eIII. Arrayバッファ\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/wipiano/items/eb562603f7efb7fac1aa\"\u003e先行記事\u003c/a\u003eで紹介されていた実装。\u003cbr\u003e\nアルゴリズムの勉強と思って、一応丸コピペではなく自分流に書き直してある。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBuffer3.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentNullException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003earray\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003earray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003earray\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003earray\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e分割後の各イテラブルが始まるタイミングで要素数\u003ccode\u003ecount\u003c/code\u003eの配列を生成、シーケンスをインクリメントしながら配列を詰めていき、全て埋まったところでyield return。\u003cbr\u003e\n評価タイミングは(1)。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"iv-listバッファ-その1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#iv-list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1-%E3%81%9D%E3%81%AE1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eIV. Listバッファ その1\u003c/h2\u003e\n\n\u003cp\u003eIII.の実装をArrayからListに置き換えたもの。Addが使えるので若干表現が変わる。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBuffer4.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentNullException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e分割後の各イテラブルが始まるタイミングで要素数\u003ccode\u003ecount\u003c/code\u003eの配列を生成、シーケンスをインクリメントしながら配列を詰めていき、全て埋まったところでyield return。\u003cbr\u003e\n評価タイミングは(1)。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"v-queue--listバッファ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#v-queue--list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eV. Queue \u0026amp; Listバッファ\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/Reactive-Extensions/Rx.NET/blob/develop/Ix.NET/Source/System.Interactive/Buffer.cs\" rel=\"nofollow noopener\" target=\"_blank\"\u003eReactive Extensions\u003c/a\u003eで用意されているアルゴリズム。\u003cbr\u003e\nRxを導入しているならこれ使っとけばええねんという感じだが、それはそれ。\u003cbr\u003e\nRxの\u003ccode\u003eBuffer\u003c/code\u003eは単純にシーケンスを分割するだけでなく、出力される各シーケンスがどのような間隔(\u003ccode\u003eskip\u003c/code\u003e引数)をとるかを指定するオーバーロード\u003csup id=\"fnref3\"\u003e\u003ca href=\"#fn3\" title=\"Rx版(IObservable)では更に時間幅を引数に取るオーバーロードも存在するが、Ix版(IEnumerable)に同等の機能はない。IEnumerableの出力に時間的分布は考慮されない(もちろん、激遅コルーチンで無理やり時間差を付けることはできるが)ので当然といえば当然である。\"\u003e3\u003c/a\u003e\u003c/sup\u003eを持っており、それを踏まえた実装になっている。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBuffer5.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentNullException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eskip\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffers\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eQueue\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eMath\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eskip\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e+\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eskip\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuffers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eEnqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffers\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003ePeek\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDequeue\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffers\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDequeue\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e方針としては、Arrayバッファの時と同様イテラブルの先頭要素に来たときに新しいバッファを生成し、要素が必要数溜まった段階で放流する。\u003cbr\u003e\n異なっているのはListを使っていることと、Queueにより複数のイテラブルを並行的に生成できることだ。\u003c/p\u003e\n\n\u003cp\u003eこのアルゴリズムの評価タイミングは(1)。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"vi-listバッファ-その2\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#vi-list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1-%E3%81%9D%E3%81%AE2\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eVI. Listバッファ その2\u003c/h2\u003e\n\n\u003cp\u003eV.の実装はオーバーロードのためにQueueを用意しており、追加のコストを払っている。\u003cbr\u003e\n今回話題にしている、count個ごとのシーケンスの分割だけを考えるならList一つで十分なはずだと指摘を受け、急遽実装。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBuffer6.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentNullException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eforeach\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003eこのアルゴリズムの評価タイミングは(1)。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"vii-単一listバッファ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#vii-%E5%8D%98%E4%B8%80list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eVII. 単一Listバッファ\u003c/h2\u003e\n\n\u003cp\u003e最後に自作のアルゴリズムを一つ。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"C#\"\u003e\n\u003cdiv class=\"code-lang\"\u003e\u003cspan class=\"bold\"\u003eBuffer7.cs\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentNullException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ethrow\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eArgumentOutOfRangeException\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enameof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBufferImpl\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"k\"\u003ethis\u003c/span\u003e \u003cspan class=\"n\"\u003eIEnumerable\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eskip\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esource\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetEnumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(;\u003c/span\u003e \u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"p\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eskip\u003c/span\u003e \u003cspan class=\"p\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eSubList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eMoveNext\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eenumerator\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCurrent\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eskip\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eyield\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eSubList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e%\u003c/span\u003e \u003cspan class=\"n\"\u003eskip\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n\n\u003cp\u003e最初のfor文は、count個バッファに溜まっていない状態では放流を開始しないという条件分岐の計算コストを減らすためのもの。\u003cbr\u003e\n2つ目のfor文とマージしてもよいが、どうせなら余計な計算コストは避けたいものだ。\u003c/p\u003e\n\n\u003cp\u003eこのアルゴリズムでは、バッファには単一のリストを利用している。\u003cbr\u003e\n\u003ccode\u003eSubList\u0026lt;T\u0026gt;\u003c/code\u003eは\u003ccode\u003eIList\u0026lt;T\u0026gt;\u003c/code\u003eのデコレータで、\u003ccode\u003estart\u003c/code\u003eと\u003ccode\u003ecount\u003c/code\u003eという2つのパラメータを用いてインデックスにオフセットをかけた部分リストを表現する。あくまでデコレータなので自身にアロケーションコストはない。\u003cbr\u003e\n区間を抽出できさえすればわざわざ新しいバッファを用意する必要がなく、またIListであれば区間抽出の計算コストが$O(1)$にできるという訳だ。\u003cbr\u003e\n調子に乗ってクソでかいソースに対して使うとListの内部配列がLOH送りになってパフォーマンスに影響が出るかもしれないが・・・。\u003c/p\u003e\n\n\u003cp\u003eこのアルゴリズムも評価タイミングは(1)である。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"ベンチマーク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%83%99%E3%83%B3%E3%83%81%E3%83%9E%E3%83%BC%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eベンチマーク\u003c/h1\u003e\n\n\u003cp\u003eというわけでベンチマークを取ってみる。\u003cbr\u003e\nとりあえず自分のマシンで回した結果は以下の通り。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eスペック\u003c/strong\u003e\u003cbr\u003e\n- CPU : Intel Core i7-6700K 4.00GHz (64bit)\u003cbr\u003e\n- RAM : 32.0GB\u003cbr\u003e\n- OS : Windows 10 Home\u003cbr\u003e\n- 処理系 : .NET Framework 4.6.1 64bit\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eBenchmark1\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003ecount = 100\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e500\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e1000\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e5000\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e10000\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e10^5\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e10^6\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e10^7\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eSkip \u0026amp; Take 1\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e4555ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e100036ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e379809ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eSkip \u0026amp; Take 2\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e598ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e1582ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e2945ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e13857ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e27589ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eArray\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e24.3ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e24.0ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e24.7ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e30.2ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e27.3ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e28.4ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e28.5ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e32.1ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eList 1\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.67ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.67ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.81ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.65ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.71ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.68ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.67ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.52ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eQueue \u0026amp; List\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.70ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.54ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.39ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.65ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.70ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.54ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.67ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.53ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eList 2\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.08ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.08ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.15ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.70ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.73ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.59ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.07ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.42ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eSingle List\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.99ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.64ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.65ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.57ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.57ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e8.49ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.87ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e8.01ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cul\u003e\n\u003cli\u003eBenchmark2\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align: left\"\u003e\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003ecount = 100\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e500\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e1000\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e5000\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e10000\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e10^5\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e10^6\u003c/th\u003e\n\u003cth style=\"text-align: right\"\u003e10^7\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eSkip \u0026amp; Take 1\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e2.31ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e186ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e1370ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e159076ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eSkip \u0026amp; Take 2\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.29ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e4.35ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e23.8ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e348ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e1530ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e136629ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003eX\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eArray\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.07ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.49ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.58ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.23ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6.01ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e60.2ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e582ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e5635ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eList 1\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.11ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.50ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e1.01ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.50ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.00ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e82.6ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e696ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e6763ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eQueue \u0026amp; List\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.33ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e1.36ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e2.70ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e13.5ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e30.9ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e275ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e2718ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e27272ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eList 2\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.09ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.40ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.77ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.93ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.88ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e81.1ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e801ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7397ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: left\"\u003eSingle List\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.11ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.38ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e0.76ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e3.84ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e7.60ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e98.2ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e838ms\u003c/td\u003e\n\u003ctd style=\"text-align: right\"\u003e8538ms\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e※ X印はあまりの遅さにベンチマーク完走を断念したことを表します。遅すぎるわ！\u003c/p\u003e\n\n\u003cp\u003eSkip \u0026amp; Take その1、走らせてみるとこれはちょっと深刻に遅い・・・。\u003cbr\u003e\nその2の方はその1に比べればかなりまし。下3つに比べればかなり不満な数字だが、評価タイミング(2)の実装でこれより速いのはちょっと思いつかない。\u003c/p\u003e\n\n\u003cp\u003e評価タイミング(1)の実装だとBenchmark1の方ではArrayバッファが若干遅い。\u003cbr\u003e\nしかし、これらの実装にとってBenchmark1は単にリストの末尾要素にアクセスするだけの操作になっているはず。\u003cbr\u003e\n詳しくはよくわからないが、\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eとしてアクセスする場合にはArrayよりListの方が速いみたいだ。\u003c/p\u003e\n\n\u003cp\u003eBenchmark2ではArrayバッファが最速だった。\u003cbr\u003e\nList 1とList 2の比較を見る限り、\u003ca href=\"https://qiita.com/wipiano/items/eb562603f7efb7fac1aa\"\u003e先行記事\u003c/a\u003eの実装は制御構造的にも速いようだ。\u003c/p\u003e\n\n\u003cp\u003eRxの\u003ccode\u003eBuffer\u003c/code\u003e実装は存外速くない。\u003cbr\u003e\nQueue \u0026amp; ListとList 2の差が、Rxがオーバーロードのために払っているコストであり、それは決して小さくはないようである。\u003c/p\u003e\n\n\u003cp\u003e今回実装したSingle ListはBenchmark1でListを返すものに比べごく僅かに遅い傾向があり、Benchmark2でもListには敵わない。\u003cbr\u003e\nこれは、デコレータを挟んだことでcallvirt命令が一つ余分に入っているせいなのではと思っている。\u003cbr\u003e\nでも、オーバーロードに対応する前提でいえばQueue \u0026amp; Listの実装よりもずっと速い。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"結論\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%90%E8%AB%96\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e結論\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/wipiano/items/eb562603f7efb7fac1aa\"\u003e先行記事\u003c/a\u003eで紹介されていた実装はさすがの速さだった。\u003cbr\u003e\nArrayでは\u003ccode\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/code\u003eとしてのアクセスに若干の不利があるようだが、Benchmark1のようなユースケースではそもそも即\u003ccode\u003eToList\u003c/code\u003eなりするだろうから問題になりにくいだろう。\u003cbr\u003e\n評価タイミング(1)の実装においてはBenchmark2の結果のほうが重要だ。\u003cbr\u003e\nとは言えArrayバッファの実装はオーバーロードへの応用に難があるので、その点では単一Listバッファにもメリットがあるんじゃないかな。\u003c/p\u003e\n\n\u003cp\u003eSkip \u0026amp; Take その1の実装は色んなブログで見かけた記憶があるが、これはちょっと一考すべきパフォーマンスの悪さだと思う。\u003cbr\u003e\nそれほどシビアなユースケースでなくとも、可能な限りその2の実装に切り替えたほうがいい。\u003cbr\u003e\nそのSkip \u0026amp; Takeその2の実装もお世辞には高速と言えないが、分割後の各イテラブルにまで遅延評価がかかる実装はこれしかない。\u003cbr\u003e\nもしもそういうユースケースがあるなら諦めて使わざるを得ないだろう。(正直そんなケースは思いつかないが)\u003c/p\u003e\n\n\u003cp\u003eかなり関係ないところからスタートしてだいぶ遠回りしたが、ライブラリレイヤーではこういった厳密な仕様固めが大事だと思う。\u003cbr\u003e\nドキュメントを突き詰めてインターフェースの仕様をしっかり理解することに努めたのはいい経験になったかな。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"最後に\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e最後に\u003c/h1\u003e\n\n\u003cp\u003e普通にコーディングしてる分にはRx使えばいいと思うよ。\u003cbr\u003e\nビバ、メジャーライブラリ。\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cdiv class=\"footnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\n\u003cli id=\"fn1\"\u003e\n\u003cp\u003eC#では、というよりILでは\u003ccode\u003ethis\u003c/code\u003eは暗黙のarg.0 (0番目の引数)である。 \u003ca href=\"#fnref1\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn2\"\u003e\n\u003cp\u003e純粋でないオペレータを使っていればその限りではないが、そのようなケースは仕様外扱いで構わないと思う。 \u003ca href=\"#fnref2\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003cli id=\"fn3\"\u003e\n\u003cp\u003eRx版(IObservable)では更に時間幅を引数に取るオーバーロードも存在するが、Ix版(IEnumerable)に同等の機能はない。IEnumerableの出力に時間的分布は考慮されない(もちろん、激遅コルーチンで無理やり時間差を付けることはできるが)ので当然といえば当然である。 \u003ca href=\"#fnref3\"\u003e↩\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\n\u003c/ol\u003e\n\u003c/div\u003e\n","createdAt":"2017-10-16T17:09:20Z","elapsedYearsFromLastModifiedAt":1,"encryptedId":"qOpBw4xpDrsgz/qLYjo9Pd0zCtnz8C0b--mJUjrKILig7YPmA2--M80DKIq+rUb/x3CdFOXlWA==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2019-11-20T09:21:44Z","likesCount":7,"linkUrl":"https://qiita.com/aka-nse/items/010e2865cbfd06c71bd6","organization":null,"originalId":532576,"stockedCount":6,"title":"LINQでBufferをやってみる話","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85%E3%82%92%E5%A7%8B%E3%82%81%E3%82%8B%E5%89%8D%E3%81%AB\"\u003e実装を始める前に\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#ienumerablet\"\u003eIEnumerable\u0026lt;T\u0026gt;\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ienumeratort\"\u003eIEnumerator\u0026lt;T\u0026gt;\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%AB%E3%83%BC%E3%83%81%E3%83%B3\"\u003eコルーチン\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#linq\"\u003eLINQ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#buffer%E3%82%AA%E3%83%9A%E3%83%AC%E3%83%BC%E3%82%BF%E3%81%AE%E4%BB%95%E6%A7%98\"\u003eBufferオペレータの仕様\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%AE%9F%E8%A3%85%E4%BE%8B\"\u003e実装例\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#i-skip--take-%E3%81%9D%E3%81%AE1\"\u003eI. Skip \u0026amp; Take その1\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#ii-skip--take-%E3%81%9D%E3%81%AE2\"\u003eII. Skip \u0026amp; Take その2\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#iii-array%E3%83%90%E3%83%83%E3%83%95%E3%82%A1\"\u003eIII. Arrayバッファ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#iv-list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1-%E3%81%9D%E3%81%AE1\"\u003eIV. Listバッファ その1\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#v-queue--list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1\"\u003eV. Queue \u0026amp; Listバッファ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#vi-list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1-%E3%81%9D%E3%81%AE2\"\u003eVI. Listバッファ その2\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#vii-%E5%8D%98%E4%B8%80list%E3%83%90%E3%83%83%E3%83%95%E3%82%A1\"\u003eVII. 単一Listバッファ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%83%99%E3%83%B3%E3%83%81%E3%83%9E%E3%83%BC%E3%82%AF\"\u003eベンチマーク\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%90%E8%AB%96\"\u003e結論\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"\u003e最後に\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":4372,"uuid":"010e2865cbfd06c71bd6","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"rOp7lq37K23UDMy9SOpis94X/Nx6--jg1mKnrrtX66tl+g--xIaeS1hLc5uM1R+ttJ1YOw==","originalId":130885,"description":"","facebookUrl":null,"githubUrl":"https://github.com/aka-nse","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"ガラス草","profileImageUrl":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/130885/profile-images/1605373686","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F130885%2Fprofile-images%2F1605373686?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=0f19f57924b328558135502eb406c9be","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F130885%2Fprofile-images%2F1605373686?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=680f4cff724a4ebd7fde1e3143ff43b0","urlName":"aka-nse","websiteUrl":"","twitterUrl":null,"twitterUrlName":null,"revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"LINQ","urlName":"linq"}],"followingLikers":{"edges":[]},"comments":{"totalCount":4}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
