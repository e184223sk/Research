More than 1 year has passed since last update.MessagePack-CSharp
存在はけっこう前から知っていたのですが、UnityのIL2CPP環境下だと事前コードジェネレート1が必要で、それがwindows環境でしか動かない……とのことだったので敬遠していました。MessagePack for C# v2によるC#における最新のI/Oパイプライン最適化ところがv2が出てなんかmacでも動くようになった？　っぽい？　ということなので試してみました。実際動いたやり方はこことここに書いてあります。
おま環疑惑がだいぶ濃厚なので、そこのところを念頭に置いてお読みください。MessagePackのバージョンは以下のとおりです。
2.0.335このデータクラスをSerialize/Deserializeするのが今回の目標です。
こんな感じのディレクトリに配置してあります。
事前生成なしでもエディタでは動きますが、Androidとかにビルドすると動きません。Window -&gt; MessagePack -&gt; CodeGenerator
ねえぞ！　って言われます。
確かに.Net Core 3入れた覚えはないのでリンクの通りにインストールします。
Terminalからバージョンチェック。2入ってます。というわけでもう一回起動。

ねえぞ！　って言われます。Assets/Scripts/MessagePack/Unity/MessagePackWindow.cs
メッセージを生成しているのはこのスクリプトです。
ねえぞ！　って言ってきてるのはこのあたり。InvokeProcessStartAsyncの中身を見る限り、普通にTerminalでdotnet --versionと入力したときと同じ結果を返してくる……はず。再起動してみても変化はありません。
ProcessStartInfoのFileNameとかWorkingDirectoryとかがうまくいってないっぽいですが、シェルにぜんぜん詳しくないのでわかりません。いったんUnityを離れてリポジトリのReadMeの手順を進めます。MessagePack.Generatorをインストール。
dotnet tool install --global MessagePack.Generator入ってます。でなんかdotnet toolsをPATHに追加しろとか言ってくるので素直に表示されるコマンドをコピー→実行していきます。今回もTerminalから存在チェック。います。でもどうせねえぞって言われるんでしょ。知ってる。/Users/XXXXXX/.dotnet/tools/dotnet-mpc
実態っぽいのはここのパスにあります。なのでAssets直下に移動して次のコマンドを打ってみます。
/Users/XXXXXX/.dotnet/tools/dotnet-mpc -i Scripts/Entity -o Scripts/Entity/Generated/MessagePackGenerated.csこんな感じで生成されました。
MessagePackGenerated.csにはusing UnityEngineが足りなくてエラーが出ていますが、それさえ補填してあげればビルドは通ります。
ビルドすると実機でも動作します。こんな感じのメソッドを作ってみました。とりあえず自分の環境では動いてます。
既存のエディタ拡張をいろいろコメントアウトするとか、必要なとこだけコピペして新しく作るとかしてこのメソッドに食わせれば動く……はず。
using UnityEngineが足りなくてエラー出てるのは相変わらずなのでこわいですが。macでもなんとかならないことはないっぽい。です。
windowsでは試していませんが、あっさり動くのではないでしょうか。
ぶっちゃけSerialize/Deserializeするクラスを頻繁に変更することってそうないと思うので、必要なときだけwindowsで生成してgitで共有してもらったほうが早いと思います。ちなみにOSアップデートしてない、まだbashのmacでも同様でした。とはいえどちらも自分が使っているやつなので、他の人が使ってるmacだと動くかも。
あと、ぱっと見た感じIssuesに似たような問題は上がってませんでした。おま環なのでは疑惑。おしまい。MessagePack-Csharp と MagicOnion のコード生成を自動化するコンパイル時にコードを生成しておく、のが大好きです。もっと言うなら通信とかするならProtoBufみたいにお約束を作っておいたほうがみんなしあわせなのでは？　くらいに思っています。でも.proto書くのめんどくせえ！ ↩なんか知らないうちにbashじゃなくてzshになってる。macのOSアップデートでそうなった？　らしい？　なぞ。 ↩


