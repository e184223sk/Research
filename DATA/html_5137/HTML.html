<!DOCTYPE html><html><head><meta charset="utf-8" /><title>System.Threading.Channelsを使う - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/skitoy4321/items/c19ca3dc7624a7049fd5" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="3GCikV5Lw5er9JTkqbHI5SEll3Yn0V42L+clNB9wke4bMSHvJ65R+feDtj6F+kdISOSrO7ai9w8/i6INcrDVTw==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@skitoy4321" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="System.Threading.Channelsを使う - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1VM2x6ZEdWdExsUm9jbVZoWkdsdVp5NURhR0Z1Ym1Wc2MtT0NrdVM5di1PQmhnJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTY2MDZjODhiZDI3Y2MwNzVjYTE2YTY0MTkyZjMxMGE1&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=982c59b0ac3a5e818857183e7c75664b"><meta property="og:description" content="

はじめに

マルチスレッドでの非同期データ受け渡しライブラリのSystem.Threading.Channels(corefxlabにあったころはSystem.Threading.Tasks.Channels)が、corefxに統..."><meta content="https://qiita.com/skitoy4321/items/c19ca3dc7624a7049fd5" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,Thread" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-653c745d-3ffe-45e9-92f4-c827967e3c0a"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Fskitoy4321%2Fitems%2Fc19ca3dc7624a7049fd5">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Fskitoy4321%2Fitems%2Fc19ca3dc7624a7049fd5">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-653c745d-3ffe-45e9-92f4-c827967e3c0a">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2018-05-15T12:48:00.000+09:00","dateModified":"2018-07-05T12:27:58.000+09:00","headline":"System.Threading.Channelsを使う","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1VM2x6ZEdWdExsUm9jbVZoWkdsdVp5NURhR0Z1Ym1Wc2MtT0NrdVM5di1PQmhnJnR4dC1jb2xvcj0lMjMzMzMmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTQmdHh0LWNsaXA9ZWxsaXBzaXMmdHh0LWFsaWduPWNlbnRlciUyQ21pZGRsZSZzPTY2MDZjODhiZDI3Y2MwNzVjYTE2YTY0MTkyZjMxMGE1\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RSE5yYVhSdmVUUXpNakUmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz1jY2M1MmMxZWFiYjkwYjFjMmY5ZTYyZjVkZDk3ZmU4Zg\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=982c59b0ac3a5e818857183e7c75664b","mainEntityOfPage":"https://qiita.com/skitoy4321/items/c19ca3dc7624a7049fd5","author":{"@type":"Person","address":"","email":null,"identifier":"skitoy4321","name":"skitoy4321","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","url":"https://qiita.com/skitoy4321","description":"","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"c19ca3dc7624a7049fd5"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"c19ca3dc7624a7049fd5"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"skitoy4321","type":"items","id":"c19ca3dc7624a7049fd5"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/skitoy4321/items/c19ca3dc7624a7049fd5","location":"/skitoy4321/items/c19ca3dc7624a7049fd5","scheme":"https","host":"qiita.com","port":null,"pathname":"/skitoy4321/items/c19ca3dc7624a7049fd5","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"9gICr/XyLvh0KxsNpKyYEp5ocR8VmyNfUlNWwatZYa8xU4HRjBe8lihcOdeI5xe/96lNUoToimZCP9H4xpklDg==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-b730b597-c431-43f5-888e-aa1432141af8"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/c19ca3dc7624a7049fd5/likers" class="css-1iupg5d">53</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">47</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/c19ca3dc7624a7049fd5/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/c19ca3dc7624a7049fd5/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/c19ca3dc7624a7049fd5/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/c19ca3dc7624a7049fd5/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/c19ca3dc7624a7049fd5.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/skitoy4321"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/skitoy4321" class="css-10ougpm">@<!-- -->skitoy4321</a><div class="css-1ay9vb9"><span><meta content="2018-05-15T03:48:00Z"/><time dateTime="2018-07-05T03:27:58Z" class="css-m19uds">updated at 2018-07-05</time></span></div></div></div></div></div><h1 class="css-cgzq40">System.Threading.Channelsを使う</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/thread" class="css-4czcte">Thread</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div>
<h1>
<span id="はじめに" class="fragment"></span><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><i class="fa fa-link"></i></a>はじめに</h1>

<p>マルチスレッドでの非同期データ受け渡しライブラリのSystem.Threading.Channels(corefxlabにあったころはSystem.Threading.Tasks.Channels)が、corefxに統合され、この度4.5.0-rc1としてリリースされたので、<br>
さすがに大きな変更はないだろうと踏んで使い方などを書く。</p>

<ul>
<li>参考: <a href="https://azyobuzin.hatenablog.com/entry/2015/12/12/231932" rel="nofollow noopener" target="_blank">corefxlabにあったころの記事</a>
</li>
</ul>

<h1>
<span id="何ができるようになるか" class="fragment"></span><a href="#%E4%BD%95%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%8B"><i class="fa fa-link"></i></a>何ができるようになるか</h1>

<p>非同期でのプロデューサー・コンシューマーパターンを作るのがより容易になる。</p>

<p>特徴としては以下のようになる</p>

<ul>
<li>順序は必ずFIFO(先入れ先出し)</li>
<li>読み:書き=M:1、1:N、M:Nのパターンに対応</li>
<li>asyncと親和的な設計</li>
<li>パフォーマンスに配慮

<ul>
<li>netcoreapp2.1では更に特化実装で速い</li>
</ul>
</li>
</ul>

<p><strong>注意: 現在netcoreapp2.1で、ConcurrentQueueが特定のケースでnetcoreapp2.0よりも遅くなるという現象が発生しており、System.Threading.Channelsもこの影響を受けるとのこと。<br>
具体的には読み込み側スレッドが複数いた場合に性能がかなり不安定になる。(平均自体は1-2倍遅くなる程度だが、分散はかなり大きい)<br>
2.1.0ではおそらく修正されず、2.1.1以降に修正される見込みなので、使用する際は必ずパフォーマンスを計測し、許容範囲に収まるかどうか、確認することをお勧めする。</strong><br>
関連issue: <a href="https://github.com/dotnet/corefx/issues/29595" class="autolink" rel="nofollow noopener" target="_blank">https://github.com/dotnet/corefx/issues/29595</a></p>

<h2>
<span id="類似ライブラリとの比較" class="fragment"></span><a href="#%E9%A1%9E%E4%BC%BC%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%A8%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>類似ライブラリとの比較</h2>

<h3>
<span id="blockingcollectiont" class="fragment"></span><a href="#blockingcollectiont"><i class="fa fa-link"></i></a><code>BlockingCollection&lt;T&gt;</code>
</h3>

<p><a href="https://docs.microsoft.com/ja-jp/dotnet/standard/collections/thread-safe/blockingcollection-overview" rel="nofollow noopener" target="_blank">MSによる解説</a></p>

<p>こちらも同パターンを実現するためのもの、とされている。</p>

<p>しかし、こちらはasyncで運用するのにやや難がある実装になっていること、また、パフォーマンスもやや劣っている。<br>
ただし、ChannelsはFIFO固定なのに対し、任意のコレクションを扱うことができるという利点がある。</p>

<h3>
<span id="systemthreadingtasksdataflow" class="fragment"></span><a href="#systemthreadingtasksdataflow"><i class="fa fa-link"></i></a>System.Threading.Tasks.DataFlow</h3>

<ul>
<li><a href="https://docs.microsoft.com/ja-jp/dotnet/standard/parallel-programming/dataflow-task-parallel-library" class="autolink" rel="nofollow noopener" target="_blank">https://docs.microsoft.com/ja-jp/dotnet/standard/parallel-programming/dataflow-task-parallel-library</a></li>
<li><a href="https://qiita.com/kiichi54321/items/f0f427055b3b55427a23" class="autolink" id="reference-e121b406394919b67a9a">https://qiita.com/kiichi54321/items/f0f427055b3b55427a23</a></li>
</ul>

<p>こちらは単純なプロデューサー・コンシューマーパターンというよりは、よりデータの流れというものを意識した要求を実現するためのライブラリとなっている。</p>

<p>ただし、こちらの方は処理ブロックを定義してつなげる処理が必要なことなど、やや準備が煩雑で、気軽に使えるかというとそうでもない。</p>

<h3>
<span id="concurrentqueuet--セマフォまたはミューテックス" class="fragment"></span><a href="#concurrentqueuet--%E3%82%BB%E3%83%9E%E3%83%95%E3%82%A9%E3%81%BE%E3%81%9F%E3%81%AF%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%83%E3%82%AF%E3%82%B9"><i class="fa fa-link"></i></a><code>ConcurrentQueue&lt;T&gt;</code> + セマフォ(またはミューテックス)</h3>

<p>ConcurrentQueueを介して読み書きをする。ただし、待機処理等はないため、セマフォ等を使ってそれを実現する。<br>
こちらは自分で実装する範囲が大きく、面倒ごとも多いため、それらをやってくれるChannelの方が便利である。</p>

<h1>
<span id="導入" class="fragment"></span><a href="#%E5%B0%8E%E5%85%A5"><i class="fa fa-link"></i></a>導入</h1>

<p>導入はnugetで行う。パッケージ名は<code>System.Threading.Channels</code></p>

<ul>
<li><a href="https://www.nuget.org/packages/System.Threading.Channels/" rel="nofollow noopener" target="_blank">nugetページ</a></li>
</ul>

<h1>
<span id="systemthreadingchannelsで提供している機能" class="fragment"></span><a href="#systemthreadingchannels%E3%81%A7%E6%8F%90%E4%BE%9B%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%A9%9F%E8%83%BD"><i class="fa fa-link"></i></a>System.Threading.Channelsで提供している機能</h1>

<p>以下二つのクラスを起点として使用する</p>

<ul>
<li><code>System.Threading.Channels.Channel</code></li>
<li><code>System.Threading.Channels.Channel&lt;T&gt;</code></li>
</ul>

<h2>
<span id="生成" class="fragment"></span><a href="#%E7%94%9F%E6%88%90"><i class="fa fa-link"></i></a>生成</h2>

<p><code>System.Threading.Channels.Channel.CreateBounded&lt;T&gt;</code>あるいは<code>System.Threading.Channels.Channel.CreateUnbounded&lt;T&gt;</code>を使用する</p>

<h3>
<span id="createunboundedt" class="fragment"></span><a href="#createunboundedt"><i class="fa fa-link"></i></a><code>CreateUnbounded&lt;T&gt;</code>
</h3>

<p>長さ上限無しのチャンネルを作成する。作成時に追加で以下のようなオプションを追加することができる</p>

<ul>
<li>AllowSynchronousContinuations(bool)

<ul>
<li>チャンネル読み/書き/待ち操作を非同期で行った場合の継続タスクを同期的に実行するかどうか</li>
<li>trueの方が性能が出るとのことだが、falseの方が何か性能でるような?</li>
<li>デフォルトはfalse</li>
</ul>
</li>
<li>SingleReader/SingleWriter(bool)

<ul>
<li>それぞれ読み書きが同時実行される可能性が無い場合にTrueに設定すれば、性能向上が見込める</li>
<li>同時実行される可能性があるときにTrueに設定すると、予期しない動作になることがある</li>
<li>デフォルトはfalse</li>
</ul>
</li>
</ul>

<p>多くの場合はこちらで問題ないが、それでも読み出し側の処理が追い付かないと、メモリ消費量が大変なことになるので、シビアな環境で使う場合は要注意</p>

<h3>
<span id="createboundedt" class="fragment"></span><a href="#createboundedt"><i class="fa fa-link"></i></a><code>CreateBounded&lt;T&gt;</code>
</h3>

<p>長さ上限付きのチャンネルを作成する。上限値のみ渡すこともできるが、作成時に追加でオプションを渡すことができる。<br>
この時に指定できるオプションには、<code>UnboundedChannelOptions</code>で指定できるものに加え、以下二つが追加指定可能。</p>

<ul>
<li>Capacity: 上限値(int)</li>
<li>FullMode: 上限値に達した時にどう振る舞うか(BoundedChannelFullMode)

<ul>
<li>DropNewest: キューの中で一番新しいものを捨てて新規値と入れ替える</li>
<li>DropOldest: キューの中で一番古いものを捨てて新規と入れ替える</li>
<li>DropWrite: 新規値を捨てる</li>
<li>Wait: 追加可能になるまで待たせる(デフォルト)</li>
</ul>
</li>
</ul>

<p>仕様で動作が決まっているならば<code>Wait</code>以外の選択肢もあるが、黙って値を破棄する動作になるので、基本的には<code>Wait</code>推奨</p>

<h2>
<span id="読み書き" class="fragment"></span><a href="#%E8%AA%AD%E3%81%BF%E6%9B%B8%E3%81%8D"><i class="fa fa-link"></i></a>読み書き</h2>

<p>生成されたインスタンスには、<code>(ChannelReader&lt;T&gt;)Reader</code>及び<code>(ChannelWriter&lt;T&gt;)Writer</code>があるので、これを通して読み書きを行う。</p>

<h3>
<span id="書き込み" class="fragment"></span><a href="#%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>書き込み</h3>

<p><code>Writer</code>メンバの以下のメソッドを使用する</p>

<ul>
<li>
<code>ValueTask WaitToWriteAsync(CancellationToken ct)</code>

<ul>
<li>書き込み可能になるまで待機する</li>
<li>これがtrueを返しても、書き込みを割り込まれる可能性があるので注意すること</li>
<li>ctがキャンセル状態になるとOperationCancelledExceptionを投げる</li>
</ul>
</li>
<li>
<code>bool TryWrite(T item)</code>

<ul>
<li>値を書き込む</li>
<li>制限付きでFullMode==Waitの場合、いっぱいだった場合はfalseになるが、それ以外はtrueになる</li>
</ul>
</li>
<li>
<code>ValueTask WriteAsync(T item, CancellationToken ct)</code>

<ul>
<li>値を非同期で書き込む</li>
<li>
<code>WaitToWriteAsync</code>+<code>TryWrite</code>を行っているイメージ</li>
</ul>
</li>
<li>
<code>void Complete(Exception e)</code>,<code>bool TryComplete(Exception e)</code>

<ul>
<li>書き込み完了マークを付加し、以後全ての書き込み操作で例外を出すようにする</li>
<li>Disposeは実装していないので、終了を表現したい場合はこれを使う</li>
<li>Completeした後に更に<code>TryComplete/Complete</code>を呼んだ場合、TryCompleteはfalseを返し、Completeは例外を出す</li>
<li>引数のExceptionは通常nullだが、ここに例外を指定すると、後の読み側の<code>Completion</code>がFaulted状態になる</li>
</ul>
</li>
</ul>

<h3>
<span id="読み込み" class="fragment"></span><a href="#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>読み込み</h3>

<p><code>Reader</code>メンバの以下を使用する</p>

<ul>
<li>
<code>ValueTask&lt;bool&gt; WaitToReadAsync(CancellationToken ct)</code>

<ul>
<li>読み込めるようになるまで(値が書き込まれるまで)待つ</li>
<li>書き込みの方で完了マークがついており、かつもう読み込めるものが無い場合は、falseが返ってくる</li>
</ul>
</li>
<li>
<code>bool TryRead(out T item)</code>

<ul>
<li>値の読出しを行う</li>
<li>読み込めるものが無かった場合はfalseを返す</li>
</ul>
</li>
<li>
<code>ValueTask&lt;T&gt; ReadAsync(CancellationToken ct)</code>

<ul>
<li>値の読出しを非同期で行う</li>
<li>
<code>WaitToReadAsync</code> + <code>TryRead</code>を行うイメージ</li>
</ul>
</li>
<li>
<code>Task Completion</code>(プロパティ)

<ul>
<li>書き込み側が完了しており(Complete/TryCompleteが呼ばれている)、かつ全ての要素が全て読みだされると完了状態になる</li>
<li>書き込み側のCompleteで例外を指定していると、<code>Faulted</code>状態になる = <code>await</code>等でエラーになる</li>
<li>終了監視用?</li>
</ul>
</li>
</ul>

<h2>
<span id="使用例" class="fragment"></span><a href="#%E4%BD%BF%E7%94%A8%E4%BE%8B"><i class="fa fa-link"></i></a>使用例</h2>

<p>一般的にどういう手順で処理するべきかを書く。なお、基本的にはWaitで待ち、Tryで一気に読み出すのが効率が良いらしい。</p>

<h3>
<span id="書き込み側" class="fragment"></span><a href="#%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E5%81%B4"><i class="fa fa-link"></i></a>書き込み側</h3>

<ol>
<li>
<code>ChannelWriter&lt;T&gt;.WaitToWriteAsync()</code>で書き込み可能になるまで待つ(大抵一瞬)</li>
<li>
<code>ChannelWriter.TryWrite()</code>で書き込み

<ul>
<li>この時、falseが戻ってきて、回復不能と判断したらエラー処理を行う(<code>Complete(Exception)</code>を実行する)</li>
</ul>
</li>
<li>アプリシャットダウン時や、全てのデータが書き終わった後はCompleteを実行する</li>
</ol>

<h3>
<span id="読み込み側" class="fragment"></span><a href="#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E5%81%B4"><i class="fa fa-link"></i></a>読み込み側</h3>

<ol>
<li>
<code>ChannelReader&lt;T&gt;.WaitToReadAsync()</code>で読み込み可能、またはキューに何か入ってくるのを待つ

<ul>
<li>falseが来た場合はCompleteが呼ばれ、かつ残データが空ということなので終了</li>
</ul>
</li>
<li>TryReadがfalseになるまでデータ読み出し→処理を実行する</li>
<li>最後にCompletionを見てエラー処理</li>
</ol>

<h3>
<span id="コード例" class="fragment"></span><a href="#%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B"><i class="fa fa-link"></i></a>コード例</h3>

<p>リクエストは任意のスレッドから投げたいけど、実際の処理はシングルスレッドに集約するというやつ。<br>
大して短くなってないじゃないかと思われるかもしれないけど、これでも結構考慮事項が減って楽になっていると思う。<br>
後、複数タスクの処理もやろうと思えば簡単に移行できる。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">namespace</span> <span class="nn">channelstest</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
    <span class="k">using</span> <span class="nn">System.Threading.Channels</span><span class="p">;</span>
    <span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
    <span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
    <span class="k">sealed</span> <span class="k">class</span> <span class="nc">ConsumerAsync</span> <span class="p">:</span> <span class="n">IDisposable</span>
    <span class="p">{</span>
        <span class="n">Task</span> <span class="n">_ConsumerThread</span><span class="p">;</span>
        <span class="k">public</span> <span class="nf">ConsumerAsync</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_Channel</span> <span class="p">=</span> <span class="n">Channel</span><span class="p">.</span><span class="n">CreateUnbounded</span><span class="p">&lt;</span><span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;();</span>
            <span class="n">_ConsumerThread</span> <span class="p">=</span> <span class="nf">Worker</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">EnqueueAndGetValue</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// net461 or before, RunContinuationsAsynchronously may be ignored because of </span>
            <span class="c1">// https://github.com/dotnet/coreclr/issues/2021 and https://blog.stephencleary.com/2012/12/dont-block-in-asynchronous-code.html</span>
            <span class="kt">var</span> <span class="n">tcs</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">TaskCreationOptions</span><span class="p">.</span><span class="n">RunContinuationsAsynchronously</span><span class="p">);</span>
            <span class="k">await</span> <span class="n">_Channel</span><span class="p">.</span><span class="n">Writer</span><span class="p">.</span><span class="nf">WriteAsync</span><span class="p">(</span><span class="n">tcs</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">tcs</span><span class="p">.</span><span class="n">Task</span><span class="p">.</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">async</span> <span class="n">Task</span> <span class="nf">Worker</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Yield</span><span class="p">();</span>
            <span class="kt">int</span> <span class="n">currentValue</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">while</span><span class="p">(</span><span class="k">await</span> <span class="n">_Channel</span><span class="p">.</span><span class="n">Reader</span><span class="p">.</span><span class="nf">WaitToReadAsync</span><span class="p">().</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">_Channel</span><span class="p">.</span><span class="n">Reader</span><span class="p">.</span><span class="nf">TryRead</span><span class="p">(</span><span class="k">out</span> <span class="kt">var</span> <span class="n">item</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="c1">// net461 or before</span>
                        <span class="c1">// var t1 = Task.Run(() =&gt; item.TrySetResult(Interlocked.Increment(ref currentValue)));</span>
                        <span class="c1">// item.Task.Wait();</span>
                        <span class="n">item</span><span class="p">.</span><span class="nf">TrySetResult</span><span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="nf">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">currentValue</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"unexpected exception:</span><span class="p">{</span><span class="n">e</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="n">_Channel</span><span class="p">.</span><span class="n">Writer</span><span class="p">.</span><span class="nf">TryComplete</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">Channel</span><span class="p">&lt;</span><span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;</span> <span class="n">_Channel</span><span class="p">;</span>

        <span class="kt">bool</span> <span class="n">_Disposed</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_Disposed</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">completeSuccess</span> <span class="p">=</span> <span class="n">_Channel</span><span class="p">.</span><span class="n">Writer</span><span class="p">.</span><span class="nf">TryComplete</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">_ConsumerThread</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">_ConsumerThread</span><span class="p">.</span><span class="nf">Wait</span><span class="p">();</span>
                    <span class="n">_ConsumerThread</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">_Disposed</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1>
<span id="終りに" class="fragment"></span><a href="#%E7%B5%82%E3%82%8A%E3%81%AB"><i class="fa fa-link"></i></a>終りに</h1>

<p>corefxlabにあったころと比べると、随分機能削ったなーという印象。まあ基幹に入る場合はなるべくシンプルな方が良いと思うのでこれはこれで。</p>

<p>実際IOが絡むと、単一スレッドに集約みたいなことはよくやるので、このようなちょうどいいライブラリが出たというのは大変うれしい。<br>
Spanみたいに、どうしてもこれでなければ実現できない機能という事でもないけど、やっぱり便利なツールは使っていきたい。</p>

<p><a href="https://qiita.com/skitoy4321/items/dfe9103272fcb744865a#_reference-975ce7083af8ab3d56aa" id="reference-d7ce324900cfd87cd859">パフォーマンス等の話はこちらの記事で</a></p>

<p>後、より重要な機能と思われる<a href="https://www.nuget.org/packages/System.IO.Pipelines/" rel="nofollow noopener" target="_blank">System.IO.Pipelinesも4.5.0-rc1が出た</a>けど、これは誰か他の人がより詳しい解説を書いてくれると思う。</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2Fc19ca3dc7624a7049fd5&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Fskitoy4321%2Fitems%2Fc19ca3dc7624a7049fd5&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/skitoy4321/items/c19ca3dc7624a7049fd5/likers" class="css-1iupg5d">53</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">47</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/c19ca3dc7624a7049fd5/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/skitoy4321/items/c19ca3dc7624a7049fd5/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/skitoy4321/items/c19ca3dc7624a7049fd5/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/skitoy4321/items/c19ca3dc7624a7049fd5/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/skitoy4321/items/c19ca3dc7624a7049fd5.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-b730b597-c431-43f5-888e-aa1432141af8">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-3e31ffa1-4c9e-4e92-b84a-d45e3d971523"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-3e31ffa1-4c9e-4e92-b84a-d45e3d971523">{}</script>
      
<div id="LoginModal-react-component-ccefa34c-8a83-4ee1-8e49-d003b3823816"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-ccefa34c-8a83-4ee1-8e49-d003b3823816">{}</script>
      
<div id="StockModal-react-component-09c6bb6c-b9e7-491e-8e6c-94fe05b580b4"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-09c6bb6c-b9e7-491e-8e6c-94fe05b580b4">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;hq1sCvJG0Ilw96zIes/4o0zp8PZqkytDOSDctKNlmGJB/O90i6NC5yyAjhJWhHcOJSjMu/vggnopTFuNzqXcww==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\n\u003ch1\u003e\n\u003cspan id=\"はじめに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eはじめに\u003c/h1\u003e\n\n\u003cp\u003eマルチスレッドでの非同期データ受け渡しライブラリのSystem.Threading.Channels(corefxlabにあったころはSystem.Threading.Tasks.Channels)が、corefxに統合され、この度4.5.0-rc1としてリリースされたので、\u003cbr\u003e\nさすがに大きな変更はないだろうと踏んで使い方などを書く。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e参考: \u003ca href=\"https://azyobuzin.hatenablog.com/entry/2015/12/12/231932\" rel=\"nofollow noopener\" target=\"_blank\"\u003ecorefxlabにあったころの記事\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"何ができるようになるか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%95%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e何ができるようになるか\u003c/h1\u003e\n\n\u003cp\u003e非同期でのプロデューサー・コンシューマーパターンを作るのがより容易になる。\u003c/p\u003e\n\n\u003cp\u003e特徴としては以下のようになる\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e順序は必ずFIFO(先入れ先出し)\u003c/li\u003e\n\u003cli\u003e読み:書き=M:1、1:N、M:Nのパターンに対応\u003c/li\u003e\n\u003cli\u003easyncと親和的な設計\u003c/li\u003e\n\u003cli\u003eパフォーマンスに配慮\n\n\u003cul\u003e\n\u003cli\u003enetcoreapp2.1では更に特化実装で速い\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003e注意: 現在netcoreapp2.1で、ConcurrentQueueが特定のケースでnetcoreapp2.0よりも遅くなるという現象が発生しており、System.Threading.Channelsもこの影響を受けるとのこと。\u003cbr\u003e\n具体的には読み込み側スレッドが複数いた場合に性能がかなり不安定になる。(平均自体は1-2倍遅くなる程度だが、分散はかなり大きい)\u003cbr\u003e\n2.1.0ではおそらく修正されず、2.1.1以降に修正される見込みなので、使用する際は必ずパフォーマンスを計測し、許容範囲に収まるかどうか、確認することをお勧めする。\u003c/strong\u003e\u003cbr\u003e\n関連issue: \u003ca href=\"https://github.com/dotnet/corefx/issues/29595\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://github.com/dotnet/corefx/issues/29595\u003c/a\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"類似ライブラリとの比較\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%A1%9E%E4%BC%BC%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%A8%E3%81%AE%E6%AF%94%E8%BC%83\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e類似ライブラリとの比較\u003c/h2\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"blockingcollectiont\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#blockingcollectiont\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eBlockingCollection\u0026lt;T\u0026gt;\u003c/code\u003e\n\u003c/h3\u003e\n\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/standard/collections/thread-safe/blockingcollection-overview\" rel=\"nofollow noopener\" target=\"_blank\"\u003eMSによる解説\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eこちらも同パターンを実現するためのもの、とされている。\u003c/p\u003e\n\n\u003cp\u003eしかし、こちらはasyncで運用するのにやや難がある実装になっていること、また、パフォーマンスもやや劣っている。\u003cbr\u003e\nただし、ChannelsはFIFO固定なのに対し、任意のコレクションを扱うことができるという利点がある。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"systemthreadingtasksdataflow\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#systemthreadingtasksdataflow\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eSystem.Threading.Tasks.DataFlow\u003c/h3\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://docs.microsoft.com/ja-jp/dotnet/standard/parallel-programming/dataflow-task-parallel-library\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\"\u003ehttps://docs.microsoft.com/ja-jp/dotnet/standard/parallel-programming/dataflow-task-parallel-library\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://qiita.com/kiichi54321/items/f0f427055b3b55427a23\" class=\"autolink\" id=\"reference-e121b406394919b67a9a\"\u003ehttps://qiita.com/kiichi54321/items/f0f427055b3b55427a23\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eこちらは単純なプロデューサー・コンシューマーパターンというよりは、よりデータの流れというものを意識した要求を実現するためのライブラリとなっている。\u003c/p\u003e\n\n\u003cp\u003eただし、こちらの方は処理ブロックを定義してつなげる処理が必要なことなど、やや準備が煩雑で、気軽に使えるかというとそうでもない。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"concurrentqueuet--セマフォまたはミューテックス\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#concurrentqueuet--%E3%82%BB%E3%83%9E%E3%83%95%E3%82%A9%E3%81%BE%E3%81%9F%E3%81%AF%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%83%E3%82%AF%E3%82%B9\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eConcurrentQueue\u0026lt;T\u0026gt;\u003c/code\u003e + セマフォ(またはミューテックス)\u003c/h3\u003e\n\n\u003cp\u003eConcurrentQueueを介して読み書きをする。ただし、待機処理等はないため、セマフォ等を使ってそれを実現する。\u003cbr\u003e\nこちらは自分で実装する範囲が大きく、面倒ごとも多いため、それらをやってくれるChannelの方が便利である。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"導入\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E5%B0%8E%E5%85%A5\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e導入\u003c/h1\u003e\n\n\u003cp\u003e導入はnugetで行う。パッケージ名は\u003ccode\u003eSystem.Threading.Channels\u003c/code\u003e\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.nuget.org/packages/System.Threading.Channels/\" rel=\"nofollow noopener\" target=\"_blank\"\u003enugetページ\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"systemthreadingchannelsで提供している機能\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#systemthreadingchannels%E3%81%A7%E6%8F%90%E4%BE%9B%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%A9%9F%E8%83%BD\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eSystem.Threading.Channelsで提供している機能\u003c/h1\u003e\n\n\u003cp\u003e以下二つのクラスを起点として使用する\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eSystem.Threading.Channels.Channel\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eSystem.Threading.Channels.Channel\u0026lt;T\u0026gt;\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"生成\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%94%9F%E6%88%90\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e生成\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode\u003eSystem.Threading.Channels.Channel.CreateBounded\u0026lt;T\u0026gt;\u003c/code\u003eあるいは\u003ccode\u003eSystem.Threading.Channels.Channel.CreateUnbounded\u0026lt;T\u0026gt;\u003c/code\u003eを使用する\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"createunboundedt\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#createunboundedt\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eCreateUnbounded\u0026lt;T\u0026gt;\u003c/code\u003e\n\u003c/h3\u003e\n\n\u003cp\u003e長さ上限無しのチャンネルを作成する。作成時に追加で以下のようなオプションを追加することができる\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eAllowSynchronousContinuations(bool)\n\n\u003cul\u003e\n\u003cli\u003eチャンネル読み/書き/待ち操作を非同期で行った場合の継続タスクを同期的に実行するかどうか\u003c/li\u003e\n\u003cli\u003etrueの方が性能が出るとのことだが、falseの方が何か性能でるような?\u003c/li\u003e\n\u003cli\u003eデフォルトはfalse\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eSingleReader/SingleWriter(bool)\n\n\u003cul\u003e\n\u003cli\u003eそれぞれ読み書きが同時実行される可能性が無い場合にTrueに設定すれば、性能向上が見込める\u003c/li\u003e\n\u003cli\u003e同時実行される可能性があるときにTrueに設定すると、予期しない動作になることがある\u003c/li\u003e\n\u003cli\u003eデフォルトはfalse\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e多くの場合はこちらで問題ないが、それでも読み出し側の処理が追い付かないと、メモリ消費量が大変なことになるので、シビアな環境で使う場合は要注意\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"createboundedt\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#createboundedt\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e\u003ccode\u003eCreateBounded\u0026lt;T\u0026gt;\u003c/code\u003e\n\u003c/h3\u003e\n\n\u003cp\u003e長さ上限付きのチャンネルを作成する。上限値のみ渡すこともできるが、作成時に追加でオプションを渡すことができる。\u003cbr\u003e\nこの時に指定できるオプションには、\u003ccode\u003eUnboundedChannelOptions\u003c/code\u003eで指定できるものに加え、以下二つが追加指定可能。\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eCapacity: 上限値(int)\u003c/li\u003e\n\u003cli\u003eFullMode: 上限値に達した時にどう振る舞うか(BoundedChannelFullMode)\n\n\u003cul\u003e\n\u003cli\u003eDropNewest: キューの中で一番新しいものを捨てて新規値と入れ替える\u003c/li\u003e\n\u003cli\u003eDropOldest: キューの中で一番古いものを捨てて新規と入れ替える\u003c/li\u003e\n\u003cli\u003eDropWrite: 新規値を捨てる\u003c/li\u003e\n\u003cli\u003eWait: 追加可能になるまで待たせる(デフォルト)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e仕様で動作が決まっているならば\u003ccode\u003eWait\u003c/code\u003e以外の選択肢もあるが、黙って値を破棄する動作になるので、基本的には\u003ccode\u003eWait\u003c/code\u003e推奨\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"読み書き\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%AD%E3%81%BF%E6%9B%B8%E3%81%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e読み書き\u003c/h2\u003e\n\n\u003cp\u003e生成されたインスタンスには、\u003ccode\u003e(ChannelReader\u0026lt;T\u0026gt;)Reader\u003c/code\u003e及び\u003ccode\u003e(ChannelWriter\u0026lt;T\u0026gt;)Writer\u003c/code\u003eがあるので、これを通して読み書きを行う。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"書き込み\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e書き込み\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003eWriter\u003c/code\u003eメンバの以下のメソッドを使用する\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eValueTask WaitToWriteAsync(CancellationToken ct)\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e書き込み可能になるまで待機する\u003c/li\u003e\n\u003cli\u003eこれがtrueを返しても、書き込みを割り込まれる可能性があるので注意すること\u003c/li\u003e\n\u003cli\u003ectがキャンセル状態になるとOperationCancelledExceptionを投げる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003ebool TryWrite(T item)\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e値を書き込む\u003c/li\u003e\n\u003cli\u003e制限付きでFullMode==Waitの場合、いっぱいだった場合はfalseになるが、それ以外はtrueになる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eValueTask WriteAsync(T item, CancellationToken ct)\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e値を非同期で書き込む\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eWaitToWriteAsync\u003c/code\u003e+\u003ccode\u003eTryWrite\u003c/code\u003eを行っているイメージ\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003evoid Complete(Exception e)\u003c/code\u003e,\u003ccode\u003ebool TryComplete(Exception e)\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e書き込み完了マークを付加し、以後全ての書き込み操作で例外を出すようにする\u003c/li\u003e\n\u003cli\u003eDisposeは実装していないので、終了を表現したい場合はこれを使う\u003c/li\u003e\n\u003cli\u003eCompleteした後に更に\u003ccode\u003eTryComplete/Complete\u003c/code\u003eを呼んだ場合、TryCompleteはfalseを返し、Completeは例外を出す\u003c/li\u003e\n\u003cli\u003e引数のExceptionは通常nullだが、ここに例外を指定すると、後の読み側の\u003ccode\u003eCompletion\u003c/code\u003eがFaulted状態になる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"読み込み\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e読み込み\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode\u003eReader\u003c/code\u003eメンバの以下を使用する\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ccode\u003eValueTask\u0026lt;bool\u0026gt; WaitToReadAsync(CancellationToken ct)\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e読み込めるようになるまで(値が書き込まれるまで)待つ\u003c/li\u003e\n\u003cli\u003e書き込みの方で完了マークがついており、かつもう読み込めるものが無い場合は、falseが返ってくる\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003ebool TryRead(out T item)\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e値の読出しを行う\u003c/li\u003e\n\u003cli\u003e読み込めるものが無かった場合はfalseを返す\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eValueTask\u0026lt;T\u0026gt; ReadAsync(CancellationToken ct)\u003c/code\u003e\n\n\u003cul\u003e\n\u003cli\u003e値の読出しを非同期で行う\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eWaitToReadAsync\u003c/code\u003e + \u003ccode\u003eTryRead\u003c/code\u003eを行うイメージ\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eTask Completion\u003c/code\u003e(プロパティ)\n\n\u003cul\u003e\n\u003cli\u003e書き込み側が完了しており(Complete/TryCompleteが呼ばれている)、かつ全ての要素が全て読みだされると完了状態になる\u003c/li\u003e\n\u003cli\u003e書き込み側のCompleteで例外を指定していると、\u003ccode\u003eFaulted\u003c/code\u003e状態になる = \u003ccode\u003eawait\u003c/code\u003e等でエラーになる\u003c/li\u003e\n\u003cli\u003e終了監視用?\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"使用例\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%BF%E7%94%A8%E4%BE%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e使用例\u003c/h2\u003e\n\n\u003cp\u003e一般的にどういう手順で処理するべきかを書く。なお、基本的にはWaitで待ち、Tryで一気に読み出すのが効率が良いらしい。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"書き込み側\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E5%81%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e書き込み側\u003c/h3\u003e\n\n\u003col\u003e\n\u003cli\u003e\n\u003ccode\u003eChannelWriter\u0026lt;T\u0026gt;.WaitToWriteAsync()\u003c/code\u003eで書き込み可能になるまで待つ(大抵一瞬)\u003c/li\u003e\n\u003cli\u003e\n\u003ccode\u003eChannelWriter.TryWrite()\u003c/code\u003eで書き込み\n\n\u003cul\u003e\n\u003cli\u003eこの時、falseが戻ってきて、回復不能と判断したらエラー処理を行う(\u003ccode\u003eComplete(Exception)\u003c/code\u003eを実行する)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eアプリシャットダウン時や、全てのデータが書き終わった後はCompleteを実行する\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"読み込み側\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E5%81%B4\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e読み込み側\u003c/h3\u003e\n\n\u003col\u003e\n\u003cli\u003e\n\u003ccode\u003eChannelReader\u0026lt;T\u0026gt;.WaitToReadAsync()\u003c/code\u003eで読み込み可能、またはキューに何か入ってくるのを待つ\n\n\u003cul\u003e\n\u003cli\u003efalseが来た場合はCompleteが呼ばれ、かつ残データが空ということなので終了\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eTryReadがfalseになるまでデータ読み出し→処理を実行する\u003c/li\u003e\n\u003cli\u003e最後にCompletionを見てエラー処理\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"コード例\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eコード例\u003c/h3\u003e\n\n\u003cp\u003eリクエストは任意のスレッドから投げたいけど、実際の処理はシングルスレッドに集約するというやつ。\u003cbr\u003e\n大して短くなってないじゃないかと思われるかもしれないけど、これでも結構考慮事項が減って楽になっていると思う。\u003cbr\u003e\n後、複数タスクの処理もやろうと思えば簡単に移行できる。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"nn\"\u003echannelstest\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading.Channels\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"nn\"\u003eSystem.Threading.Tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003esealed\u003c/span\u003e \u003cspan class=\"k\"\u003eclass\u003c/span\u003e \u003cspan class=\"nc\"\u003eConsumerAsync\u003c/span\u003e \u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eIDisposable\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"n\"\u003e_ConsumerThread\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"nf\"\u003eConsumerAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_Channel\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eChannel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCreateUnbounded\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTaskCompletionSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;();\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e_ConsumerThread\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eWorker\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eEnqueueAndGetValue\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// net461 or before, RunContinuationsAsynchronously may be ignored because of \u003c/span\u003e\n            \u003cspan class=\"c1\"\u003e// https://github.com/dotnet/coreclr/issues/2021 and https://blog.stephencleary.com/2012/12/dont-block-in-asynchronous-code.html\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etcs\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eTaskCompletionSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;(\u003c/span\u003e\u003cspan class=\"n\"\u003eTaskCreationOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRunContinuationsAsynchronously\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003e_Channel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etcs\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003etcs\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eWorker\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eYield\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentValue\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003etry\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003e_Channel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWaitToReadAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_Channel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eReader\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryRead\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eout\u003c/span\u003e \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                        \u003cspan class=\"c1\"\u003e// net461 or before\u003c/span\u003e\n                        \u003cspan class=\"c1\"\u003e// var t1 = Task.Run(() =\u0026gt; item.TrySetResult(Interlocked.Increment(ref currentValue)));\u003c/span\u003e\n                        \u003cspan class=\"c1\"\u003e// item.Task.Wait();\u003c/span\u003e\n                        \u003cspan class=\"n\"\u003eitem\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTrySetResult\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eInterlocked\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eIncrement\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eref\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentValue\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n                    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecatch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eException\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e$\"unexpected exception:\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"s\"\u003e\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_Channel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eChannel\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTaskCompletionSource\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003e_Channel\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003e_Disposed\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eDispose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(!\u003c/span\u003e\u003cspan class=\"n\"\u003e_Disposed\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ecompleteSuccess\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e_Channel\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eTryComplete\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e_ConsumerThread\u003c/span\u003e \u003cspan class=\"p\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_ConsumerThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003e_ConsumerThread\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enull\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"n\"\u003e_Disposed\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"終りに\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E7%B5%82%E3%82%8A%E3%81%AB\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e終りに\u003c/h1\u003e\n\n\u003cp\u003ecorefxlabにあったころと比べると、随分機能削ったなーという印象。まあ基幹に入る場合はなるべくシンプルな方が良いと思うのでこれはこれで。\u003c/p\u003e\n\n\u003cp\u003e実際IOが絡むと、単一スレッドに集約みたいなことはよくやるので、このようなちょうどいいライブラリが出たというのは大変うれしい。\u003cbr\u003e\nSpanみたいに、どうしてもこれでなければ実現できない機能という事でもないけど、やっぱり便利なツールは使っていきたい。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://qiita.com/skitoy4321/items/dfe9103272fcb744865a#_reference-975ce7083af8ab3d56aa\" id=\"reference-d7ce324900cfd87cd859\"\u003eパフォーマンス等の話はこちらの記事で\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003e後、より重要な機能と思われる\u003ca href=\"https://www.nuget.org/packages/System.IO.Pipelines/\" rel=\"nofollow noopener\" target=\"_blank\"\u003eSystem.IO.Pipelinesも4.5.0-rc1が出た\u003c/a\u003eけど、これは誰か他の人がより詳しい解説を書いてくれると思う。\u003c/p\u003e\n","createdAt":"2018-05-15T03:48:00Z","elapsedYearsFromLastModifiedAt":3,"encryptedId":"HsOUWBpc549jrZBKNtzByzgLHHFJer/b--TTBteT5AvGp4kcRP--/vUNBUEMNs/p2akY2NGJnw==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2018-07-05T03:27:58Z","likesCount":53,"linkUrl":"https://qiita.com/skitoy4321/items/c19ca3dc7624a7049fd5","organization":null,"originalId":645521,"stockedCount":47,"title":"System.Threading.Channelsを使う","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"\u003eはじめに\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%95%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB%E3%81%AA%E3%82%8B%E3%81%8B\"\u003e何ができるようになるか\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%A1%9E%E4%BC%BC%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%A8%E3%81%AE%E6%AF%94%E8%BC%83\"\u003e類似ライブラリとの比較\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#blockingcollectiont\"\u003eBlockingCollection\u0026lt;T\u0026gt;\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#systemthreadingtasksdataflow\"\u003eSystem.Threading.Tasks.DataFlow\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#concurrentqueuet--%E3%82%BB%E3%83%9E%E3%83%95%E3%82%A9%E3%81%BE%E3%81%9F%E3%81%AF%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%83%E3%82%AF%E3%82%B9\"\u003eConcurrentQueue\u0026lt;T\u0026gt; + セマフォ(またはミューテックス)\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E5%B0%8E%E5%85%A5\"\u003e導入\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#systemthreadingchannels%E3%81%A7%E6%8F%90%E4%BE%9B%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%A9%9F%E8%83%BD\"\u003eSystem.Threading.Channelsで提供している機能\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%94%9F%E6%88%90\"\u003e生成\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#createunboundedt\"\u003eCreateUnbounded\u0026lt;T\u0026gt;\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#createboundedt\"\u003eCreateBounded\u0026lt;T\u0026gt;\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%AD%E3%81%BF%E6%9B%B8%E3%81%8D\"\u003e読み書き\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF\"\u003e書き込み\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF\"\u003e読み込み\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%BF%E7%94%A8%E4%BE%8B\"\u003e使用例\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BF%E5%81%B4\"\u003e書き込み側\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E5%81%B4\"\u003e読み込み側\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B3%E3%83%BC%E3%83%89%E4%BE%8B\"\u003eコード例\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E7%B5%82%E3%82%8A%E3%81%AB\"\u003e終りに\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n","totalPv":7419,"uuid":"c19ca3dc7624a7049fd5","banReason":null,"adventCalendarItem":null,"author":{"encryptedId":"AE2AdJYGrxgXsEUWSY5rH4qCgXHQ--kVVL5Yoeaqd5lxZv--wXtBLIbjWx/cw2pOiMNWjQ==","originalId":103253,"description":"","facebookUrl":null,"githubUrl":null,"isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/103253/profile-images/1526359222","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=a7dce827dc16582e1b8e9c7a52216638","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F103253%2Fprofile-images%2F1526359222?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=9623ed561bd61ca207da0cb6419ba01d","urlName":"skitoy4321","websiteUrl":"","twitterUrl":"https://twitter.com/skitoy4321","twitterUrlName":"skitoy4321","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"Thread","urlName":"thread"}],"followingLikers":{"edges":[]},"comments":{"totalCount":2}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
