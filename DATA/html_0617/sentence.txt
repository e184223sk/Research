IAM認証を使っているAWSのAPI Gatewayは、APIリクエスト時にSigV4署名が必要です。S3にSigV4署名でアクセスする方法は、AWS公式の以下のページにJavaとC#でのサンプルがあります。これをベースにIAM認証を使っているAPI GatewayにC#でアクセスしてみます。Pythonならば、以前の記事(IAM認証のAWS API GatewayにPythonからSigV4署名してアクセスするには)で似たことをしました。IAMユーザのアクセスキーが ~/.aws/credentials に設定されていて、そのIAMユーザでAPI Gatewayにアクセスするものとします。API GatewayのリソースポリシーにはそのIAMユーザからのAPIアクセスを許可してあるものとします。動作確認した環境はUbuntu 20.04です。C#の環境は以下の通り。以下は私の記事でして、このとおりC#をほとんど始めて触っています。C#の流儀と違うところがあったらごめんなさい。本記事でのライブラリ等は2020/10/14時点のものです。AWS公式のS3アクセスのサンプルをダウンロードします。IAMユーザを使ってS3アクセスするサンプルです。今回はこのうち、Signers と Util というディレクトリだけ使います。このサンプルはnamespaceが AWSSignatureV4_S3_Sample となっています。今回はS3ではないので、適当な名前 Sample に全置換します。(このコマンドの説明は sedコマンドでディレクトリ内の全ファイルをテキスト全置換するには)ここまでで以下のようなディレクトリ構成になります。dotnetコマンドでプロジェクトを作成します。以下のようなディレクトリ構成になります。sample.csprojに以下のように RootNamespace の項目を追加します。サンプルダウンロード後に全置換したnamespaceを指定します。必要なパッケージをダウンロードします。 AWSSDK.Core だけで大丈夫です。今回はHTTP(S)でAPIアクセスするだけですので、API Gatewayのパッケージは不要です。Program.cs は以下です。uriはAPI GatewayのAPIのURLを入れます。以下のコマンドで実行できます。ダウンロードしたサンプルコードのSignersとUtilにデバッグ用出力があるので、いろいろ表示されますが、最後にAPI Gatewayからのレスポンスが表示されます。IAMロールの場合の記事を書きました。


