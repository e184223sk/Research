More than 1 year has passed since last update.案外情報が少なかった(特に日本語)ので調べたり試してみた。
Gradleのお話とか詳細な使い方は割愛。
(そもそも詳しくないので間違えてたらごめんなさい。。。)公式の情報はこちら。
https://docs.unity3d.com/ja/current/Manual/android-BuildProcess.htmlGradleビルドに必要な手順は主に2つです。Unityエディタ上でマウスをカチカチするだけですね。
BuildSettingsのAndroid設定から「Build System」に「Gradle」の設定があります。Unity2017以降ならPlayerSettingsからも設定できるようです。Unity2017.3.0以降ならデフォルトで「Gradle」なのでこの手順は不要です。バッチビルドなどでC#スクリプトから設定を変更したい場合は下記のエディタ拡張用コードを埋め込みます。Gradleプロジェクトにはbuild.gradleが必要です。
UnityはGradleプロジェクトを出力するときにUnityプロジェクトの構成からbuild.gradleを作成してくれます。build.gradleの作成にはmainTemplate.gradleを使います。
このファイルはUnityエディタをインストールしたディレクトリ内の下記にあります。参考にUnity2017.4.10f1のmainTemplate.gradleを下記に掲載します。ファイル内に「**」で挟まれた記述が含まれていますが、これはUnityがbuild.gradleを作成する際にUnityプロジェクトの各情報に置き換えるための目印のようです。このmainTemplate.gradleはプロジェクトごとにカスタマイズしたものを使うこともできます。Unityプロジェクトの「Assets/Plugins/Android/mainTemplate.gradle」にファイルをコピーして配置してください。
「Assets/Plugins/Android/mainTemplate.gradle」にファイルがある場合はPlaybackEnginesのmainTemplate.gradleを使わずに、こちらのファイルを使ってbuild.gradleを作成する仕組みになっています。
(こちらの方の記事によるとUnity5.5.2からできるようになったらしいです。私はUnity5.6.6で実際にできることを確認しました)カスタムのmainTemplate.gradleを用意したら後はここにPlayServicesプラグインの依存関係を記述していきます。必要な記述は2カ所です。まず、プラグインを入手するためのリポジトリを記載します。
リポジトリとはプラグインをネットワーク経由などから入手する際の置き場所です。
mainTemplate.gradleの下記の記載がリポジトリの指定箇所です。PlayServicesプラグインの場合は「https://maven.google.com」辺りにあるようなのでそちらの設定を記入します。
(詳しい書き方はGradleを勉強してね！)次にPlayServicesプラグインの依存関係を記載します。
mainTemplate.gradleの記載は下記です。PlayServicesResolverでは〜Dependencies.csや〜Dependencies.xmlなどResolver独自のクラスや記法で依存ファイルを作っていると思いますがGradleの記載は簡単です。
例えば下記のように記載します。より具体的な情報が公式にまとめられているようなので詳しく知りたい方はこちらもご覧になると良いでしょう。(英語)
https://developers.google.com/android/guides/setupこれで準備は完了です。
後はビルドを行うとGradleツールが依存関係に記載されたプラグインを確認して無ければ取得してきてくれます。
(もちろんUnityプロジェクトにPlayServicesResolverを導入する必要もありません)BuildSettingsで「Build System」をGradleに設定し、さらにUnityからGradleビルドを行うか、Gradleプロジェクトをエクスポートして自分でGradleビルドを行うかを選ぶことができます。エクスポートする場合は「Build System」の下にある「Export Project」にチェックを入れてください。
チェックを入れると「Build」ボタンが「Export」ボタンに変化します。「Export」ボタンを押すと指定したディレクトリにGradleプロジェクトを出力してくれます。このGradleプロジェクトはAndroidStudioで開くこともできるそうですが、例えばPlayServicesプラグインを初回に組み込むときに、上手く行くまで繰り返しUnityから出力させて試行するには手間がかかるかもしれません。
(出力時に上書きすれば気にならない？)私の場合はAndroidStudioを使わずにコマンドラインから直接Gradleビルドを実行してビルド時のトラブル調査や試行を繰り返しました。コマンドラインからGradleビルドを実行する場合は予め必要なバージョンのGradleツールをインストールして使えるようにしておくか、「Gradle Wrapper」などを作成して利用してください。下記では(私の方で実際に行った手順ということで)Gradleツールで「Gradle Wrapper」(gradlew)を作成し、gradlew経由でGradleビルドを実行する手順を例に挙げます。エクスポートしたGradleプロジェクトに必要なGradleツールバージョンはmainTemplate.gradleの最初の方に記載されています。
出力するUnityエディタのバージョンで必要なGradleツールバージョンも異なるようです。コマンドライン上からカレントをGradleプロジェクトのルートディレクトリへ移動し、下記のコマンドを実行してください。(予めGradleのインストールが必要)実行するとカレントディレクトリに「gradlew」という実行形式のファイルが作成されます。
これを使って下記のように実行するとGradleビルドが実行されます。
(パスが通ってないのでカレントディレクトリからの相対パスで指定してます)これでGradleビルドが実行され、上手くいくとカレントディレクトリにbuildディレクトリが作成されその中に作成物ができます。(apkファイルとか)上手く行かないとエラーが表示され、失敗するので原因を解消してからUnityのエクスポートやGradleビルドを繰り返します。ビルドに成功するようになったら、UnityのBuildSettingsにある「Export Project」のチェックを外して以降はUnityからGradleビルドを回すようにすると良いかと思います。私の関わったプロジェクトでは下記の要件が必要でした。これを実現させるため、エディタ拡張スクリプトでビルド時にバンドルIDを切り替える運用にしていたため、Resolverの置き換えてくれる機能では不十分でした。
(Androidビルドが通らない、動かない、でここで心が折れた)PlayServicesResolverに苦戦してからのGradleビルドへの移行を試してみたお話でした。
正直、私はもうGradleビルドだけ使ってUnityのPlayServicesResolverのことは忘れたら良いのではと思いました。AndroidStudioやGradle自体の知識に詳しいわけでは無いので今回の手順の中には実はさらに簡単にできるよみたいな手順があるかもしれないです。
(間違いが含まれている場合はごめんなさい。気づいたときにできるだけ直すようには気をつけます)また、Gradle自体はとても強力なツールのようでmainTemplate.gradleをさらにカスタマイズすると色んな便利なことができるかもしれませんね。
(Gradleの知識やAndroidの知識が色々と必要そうですが。。。その内勉強してみよう)そちらは詳しい方にお任せするということで、
今回は表題のことについて参考程度にご覧いただけたら幸いです。


