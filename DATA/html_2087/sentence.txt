More than 1 year has passed since last update.OpenCV公式が公開している Android用ライブラリを利用して、Xamarin.Forms から C/C++ で OpenCV を操作する方法をまとめました。(Xamarin.Forms ですが iOS については何も書いていません）今回は動作確認用のサンプルとして、単色の黒/白 2つのMat画像を結合して平均輝度値を求めています。以降は arm64-v8a アーキテクチャに絞って書いていますので、他の環境の方は適宜読み替えてください。特に変わったことはしていません。VisualStudioプロジェクト作成 (折りたたみ)


Xamarin.Formsプロジェクト

モバイルアプリ(Xamarin.Forms) から、"XamaFormsOfficialCv" として作成しました。ダイナミック共有ライブラリ(Android) から、"NativeOpenCv" として作成しました。先に作成したXamaFormsOfficialCv.Android プロジェクトの [参照の追加] より NativeOpenCv を参照します。この時点で一旦、動作確認しておくと安全です。OpenCVの公式 から取得して、良い感じの場所に展開しておきます。今回は "C:\opencv\OpenCV-android-sdk" に置きました。デフォルトでは [LLVM libc++ スタティックライブラリ(c++_static)] になっていたので、[共有ライブラリ (c++_shared)] に変えました。展開したOpenCVのヘッダフォルダをインクルードします。展開したOpenCVの各ライブラリフォルダをインクルードします。上記ディレクトリ内の各ライブラリ名を指定します。今回は全てのライブラリを列挙してみました。ライブラリ名には、libXXXX.a の XXXX の部分のみを記述するようにして下さい。ちなみに libXXXX.a とフルで書くと、LINK で "cannot find" になります。VSが気を利かせてくれればハマらずに済んだのですが…デフォルトで作成される [プロジェクト名.h] と  [プロジェクト名.cpp]  の中身は削除して、以下を追加しました。サンプルなので、ややこしいことはしていません。自作ライブラリの対応は以上です。Android側のプロジェクトに libs\arm64-v8a フォルダを作成して、OpenCVの共有ライブラリ(*.so) を追加します。（今回は1つだけでした）追加したライブラリ(*.so) のプロパティを変更します。とりあえず動作を見るだけなので、デフォルトで作成される MainActivity.cs に自作ライブラリの呼び出し処理（P/Invoke）を追加しました。対応は以上です。実行しても何も分かりませんが、ブレークポイントを仕掛ければコメント通りの輝度値が取得できるはずです。今回の紹介に使用したリポジトリは以下で公開しています。OpenCV AndroidAndroid C++ ライブラリ サポートAndroid プロジェクトへの C / C++ コードの追加2019年冬休みの自分への課題を記事にまとめました。本当はOpenCVのソースをセルフビルドして利用したかったのですが、CMakeやらLinkやらのエラーが取れないまま休みが終わってしましました…仕事が始まるとバタバタして熱が冷めてしまいそうですが、時間を見つけてリベンジしたい！何とかリベンジできました。と言ってもライブラリをビルドしただけなので、これから捏ね繰り回して行きたいです！
OpenCV をソースコードからビルドしてXamarin で利用する


