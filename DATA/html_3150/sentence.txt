More than 1 year has passed since last update.最近スマートフォンを新しいやつに買い替えたので、ついにおうちでARCoreができるようになりました。
サンプルを一通り触ってみたのですが、目玉機能であるCloud Anchorのサンプルがあまりにもわからないすぎる1ので自分で勉強がてら作り直してみようかと思っています。この記事はその下調べ。
Unityです。話を始める前に参考になったサイトを貼ります。これを元に話をしています。ARCore Cloud Anchor APIをマスターする（前編）
ARCore Cloud Anchor APIをマスターする（後編）
どうして空間共有で先に座標系の逆変換（inverse）を行うのか？Cloud Anchorは実空間上の一点をアンカーと定め、それを共有する仕組みです。
つまり起点であるアンカーとの相対距離・相対角度を求めることができればオブジェクトの位置と向きを共有できるはずです。
CloudAnchorのサンプル内でそれを行っているのは以下のメソッドです。わからん。UnityのInspectorのTransformは親がないときはPositionを表示、親オブジェクトがいる場合はLocalPositionを表示するというなかなか殺意に満ちた仕様をしています。
デバッグ表示にしてすら表示してくれません。なんでそんなひどいことするんでしょうか。謎。
これが見えないと話が始まらないのでInspectorを拡張します。
NGUIのようにTransformを便利に拡張する
元記事のコードにちょっと足してPositionとLocalPositionを同時に表示できるようにします。共有したいオブジェクトをアンカーの子オブジェクトにしてLocalPositionだけ引っこ抜けばいいような気もします。
しますが、PositionとLocalPositionを混用すると不思議の森に迷い込むので、わたしは基本的にPositionだけを使うようにしています。なのでPositionだけで相対座標を導出します。変換の仕組みは標準APIの中にありました。メインスレッドからしか実行できません。たぶん。たしか。
別スレッドで行いたい場合は行列を勉強してなんか頑張ってください。わからんことはわかっている3ので考えないで検索します。【Unity道場 博多スペシャル 2017】クォータニオン完全マスター
【Unity道場スペシャル 2017博多】クォータニオン完全マスター相対のRotationの出し方は最後のほうにあります。でもすごい勉強になるので最初から見たほうがよいと思います。4完成品はこれ。必要なコードはできたので適当なコードでテストしてみます。このgifではCapsuleをアンカー、Cylinderを共有オブジェクトに設定しています。
目視での確認、および先程拡張したInspectorのTransformで確認します。ちゃんとPositionもRotationも一致しているようです。正直Rotationの共有部分は2×2の4パターンを試しただけです。まあなんかあってるし。いいかなって。
……あってると書いておいてなんなのですが、CloudAnchorのサンプルの座標変換ではRotationをMatrixを使って変換しているので、もしかしたらこの記事のやり方ではだめなのかも。
というかサンプル内で送られてきた座標を復元しているところも今の所発見できていません。そんなに量はないはずなのに、あのサンプル、なんかほんとよみづらい……。次は Unity + CloudAnchor + PUN2 を組み合わせてわたしのかんがえたさいこうのCloudAnchorさんぷるを出す予定です。おしまい。わからん！　Google様のサンプルはわからん！ ↩Instant Preview？　AndroidStudioのアレと同レベルでしょ？　とか言っててすいませんでした。 ↩脱線ですが、ソクラテスってあれだけ煽り散らしてたらそら処刑されますよね。 ↩じつはわたしは熊なのでこのような勉強会に行くには差し障りがあるのですが、一度は行ってみたいものです。 ↩


