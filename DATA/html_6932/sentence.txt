More than 3 years have passed since last update.前 その8
次 その10完全に理解できた訳ではないので、間違っている部分もあるかもしれません。FK・モーションの実装
MSAAの設定
カリングモードの切り替えソース(GitHub): ModelViewer, MmdFileLoaderMMDでモデルを動かそうとするときに表示される、これ。
ボーン(を可視化したもの)です。
このボーンを回転させるなどすることで動きを表現します。PMDファイルでは、ボーンを以下のように定義しています。(今回使用するパラメータ・情報のみ抜粋)注意しなければいけない点として、
PMDでは子ボーンのインデックスは「なしの場合は0」になっています。PMXのデータと共通化することを考え、-1に修正しています。
PMXではボーンの向きを決定するために、子ボーンのインデックスで指定 or ボーンの向きを表すベクトルのどちらかで指定します。Offsetで指定されている場合は、子ボーンのインデックスを-2にしています。
さらに、PMXではボーンを変形させる順番が物理演算前後と階層により決まります。ボーンを変形させる方法の一つ、FK(フォワードキネマティクス)を実装します。
FKについてはこちらが詳しいです。ボーンの計算をさせる前に、ボーンに従って頂点を動かすためにシェーダに情報を送る準備をします。BoneMatrixにはボーンの変形行列を格納します。ボーンの数は多めに512に設定しています。
頂点データには、頂点に影響を与えるボーンのインデックスとその重みを表す配列を渡しています。こちらを参考にしました。ボーンの親子関係を表現するSkinBoneクラスを作成します。モデルから読み込んだボーンの情報をSkinBoneクラスに流しこみます。
初期姿勢行列はボーンの根本へ移動する行列を用意し、オフセット行列を親から掛けていくことで得られます。
オフセット行列はボーンを原点に移動させる行列です。ボーンの回転量と移動量をRotateとTranslateに設定し、変換行列を更新させます。
シェーダに変換行列を渡すことで、モデルを動かすことができます。モーションデータとしてVMDを使用します。
フォーマットはこちらMMDにおいてモーションとモーションの間は、三次ベジエ曲線を用いて補完されますが、とりあえず線形補完にします。
FrameCountは、相対的なフレーム数です。FrameCountが[0, 10, 20, 30]とあった場合、0・10・20・30フレーム目ではなく、0・10・30・60フレーム目です。モーションの再生・適用を管理するMotionManagerクラスを作ります。
現在のフレームを算出するため、System.Diagnostics.Stopwatchを用いて再生時間を計測します。
再生されるモーションデータのリストをボーンごとに追加し、それぞれのボーンのモーションが始まるフレームと終了するフレーム番号を記録します。モーションデータを格納し、モーションの再生が始まったら、その時点のフレームをもとに、各ボーンの回転・移動量を計算します。各ボーンの回転・移動量を計算したあと、ボーンにそれを適用します。やっと踊らせられました。
今回実装したのはFKのみなので、足がぶんぶん振れています。前回までの画像を見ると分かるとおり、ちょっとギザギザしてました。
SlimDX.Direct3D11.Deviceを作成したあとにDevice.CheckMultisampleQualityLevelsでQualityとCountを調べ、SwapChainDescriptionとTexture2DDescriptionのSampleDescriptionに設定することで、アンチエイリアスが働き、綺麗に描画してくれます。Lat式ミクを描画しようとすると下図のようになってしまいます。
Lat式ミクは若干特殊で、輪郭などを表現するために透明な裏返しのポリゴンを顔に貼り付けているそうです。マテリアルのアルファ値が0.999のときのみにカリングさせることで正しく描画されます。
こちらを参考にしました。次回はIKの実装とTGA読み込み対応をするつもりです。


