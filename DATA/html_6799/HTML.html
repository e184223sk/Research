<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Taskを極めろ！async/await完全攻略 - Qiita</title><meta content="width=device-width,initial-scale=1,shrink-to-fit=no,viewport-fit=cover" name="viewport" /><meta content="#55c500" name="theme-color" /><meta content="XWpkTG32-_C4joZoJ_UsmDUi-zaH-hcrjF6ZC_FoFbk" name="google-site-verification" /><meta content="telephone=no" name="format-detection" /><link rel="canonical" href="https://qiita.com/acple@github/items/8f63aacb13de9954c5da" /><link href="/manifest.json" rel="manifest" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link as="script" href="https://www.googletagservices.com/tag/js/gpt.js" rel="preload" /><link href="https://securepubads.g.doubleclick.net" rel="preconnect" /><script async="" src="https://www.googletagservices.com/tag/js/gpt.js"></script><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="5+h2dt2l48YTDy+2A0wJCSOWaE5uK9/kzQOqsSBB65nLQJH5m1+/sN9kOYYN1RPvuzx6jDRPuxkvyddF9tqjJg==" /><link rel="shortcut icon" type="image/x-icon" href="https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico" /><link rel="apple-touch-icon" type="image/png" href="https://cdn.qiita.com/assets/favicons/public/apple-touch-icon-ec5ba42a24ae923f16825592efdc356f.png" /><link rel="stylesheet" media="all" href="https://cdn.qiita.com/assets/public/article-2eaa7dbedc42a8ea65c722cda46d0ebb.min.css" /><script src="https://cdn.qiita.com/assets/public/v3-article-bundle-63de2d91fef827269d3f6b958db2335b.min.js" defer="defer"></script><meta name="twitter:card" content="summary_large_image"><meta content="@Qiita" name="twitter:site" /><meta content="@acple" name="twitter:creator" /><meta property="og:type" content="article"><meta property="og:title" content="Taskを極めろ！async/await完全攻略 - Qiita"><meta property="og:image" content="https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0&amp;w=1200&amp;mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WR0Z6YS1PQ2t1YWx0ZU9DZ2VPQ2plLThnV0Z6ZVc1akwyRjNZV2wwNWE2TTVZV281cFM3NTVXbCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1hZmQ3MmQwNDI4ZTAzZDY5MWNmMDYwNGI0NzYzYTNlMQ&amp;mark-align=center%2Cmiddle&amp;blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR0ZqY0d4bFFHZHBkR2gxWWcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz04MzFmZGI0M2FiZjc3MjY4ZTJlZmZmYTJlNGIzYWQ3Mw&amp;blend-align=center%2Cmiddle&amp;blend-mode=normal&amp;s=475dd247c855c8119e2adb5820e0c89c"><meta property="og:description" content="この記事は、


Task.Runを書けばとりあえず非同期で動くのはわかる
時々なんかうまく動かなかったりするけどどうして動かないのかはよくわからない
よくわからないまま書いてよくわからないまま動いてるけどこれで大丈夫なのかわからなく..."><meta content="https://qiita.com/acple@github/items/8f63aacb13de9954c5da" property="og:url" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><meta content="C#,AdventCalendar" name="keywords" /><script>!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '668972150489891');
fbq('track', 'PageView');</script><style data-emotion-css="17jxvjw 11t2ec1 1dvr2p8 18lkoru 1g4cku8 1iupg5d ijvq0v 15cocm3 12rp90f 115f4t 1b8uj5v 79elbk 16hhh7b fcbn8c 1gj7nt 154zy0m yikrym 1jqivyb 1ode1bp le4d8r 1hbd3g7 1nzh4zz 38fzdi helsa7 8qb8m4 2imjyh he5w1s 70qvj9 3ojehk 100alwu 1dtnjt5 10ougpm 1ay9vb9 m19uds cgzq40 1wa99t2 1l3zk9f 4czcte 1yzj1fm 1uv1qiv 109dbrr 5jpx49 mnxgyc 1vlpknv fsjkhv 1b17vb0 7i7f4d"}>.css-17jxvjw{display:grid;display:-ms-grid;grid-template-columns:80px minmax(0,1fr) 300px;-ms-grid-columns:80px minmax(0,1fr) 300px;grid-template-rows:minmax(270px,auto) 1fr;-ms-grid-rows:minmax(270px,auto) 1fr;max-width:1280px;margin-right:auto;margin-left:auto;padding-top:24px;padding-right:24px;padding-left:24px;}@media (max-width:1200px){.css-17jxvjw{padding-bottom:0;padding-left:0;padding-right:0;}}@media (max-width:992px){.css-17jxvjw{grid-template-columns:80px 452px 300px;-ms-grid-columns:80px 452px 300px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}}@media (max-width:770px){.css-17jxvjw{display:block;}}@media (max-width:480px){.css-17jxvjw{padding-top:0;}}.css-11t2ec1{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:5;position:-webkit-sticky;position:sticky;top:calc(56px + 24px + 16px + 32px - 16px);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding:16px;width:80px;}.css-11t2ec1:after{content:'';display:table;}.css-11t2ec1:before{content:'';display:table;}@media (max-width:770px){.css-11t2ec1{display:none;}}.css-1dvr2p8{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-18lkoru{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;background-color:#FFFFFF;}.css-1g4cku8{display:inline-block;vertical-align:middle;height:20px;width:20px;fill:#55C500;}.css-1iupg5d{color:#55C500;cursor:pointer;font-size:14px;font-weight:bold;}.css-ijvq0v{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;margin-bottom:16px;}.css-15cocm3{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:#FFFFFF;border:2px solid #6E6F70;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:2px 0px 0px;width:40px;}.css-12rp90f{display:inline-block;vertical-align:bottom;height:17.77777777777778px;width:16px;fill:#6E6F70;}.css-115f4t{color:#6E6F70;font-size:14px;font-weight:bold;}.css-1b8uj5v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;margin-bottom:16px;padding:0;}.css-79elbk{position:relative;}.css-16hhh7b{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;font-size:20px;height:32px;outline:none;width:32px;padding:0;}.css-fcbn8c{display:none;bottom:initial;left:initial;right:initial;top:initial;left:100%;top:calc(-8px - (14px * 1.8) - 16px - 4px);}.css-1gj7nt{color:rgba(0,0,0,0.6);font-size:14px;font-weight:bold;line-height:1.8;padding:8px 16px;}.css-154zy0m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.87);cursor:pointer;font-size:16px;font-weight:normal;line-height:1.8;padding:4px 16px;}.css-154zy0m:hover{-webkit-text-decoration:none;text-decoration:none;background-color:#F2F2F2;}.css-yikrym{width:20px;}.css-1jqivyb{color:rgba(0,0,0,0.6);font-size:13px;}.css-1ode1bp{background-color:rgba(0,0,0,0.12);height:1px;width:100%;margin:8px 0;}.css-le4d8r{display:inline-block;vertical-align:middle;height:13px;width:13px;fill:rgba(0,0,0,0.6);}.css-1hbd3g7{height:250px;}.css-1nzh4zz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 32px;background-color:#FBE69E;color:rgba(0,0,0,0.87);line-height:1.5;font-weight:600;}@media (max-width:770px){.css-1nzh4zz{padding:16px;}}.css-38fzdi{color:#CA832A;margin-right:4px;}.css-helsa7{background-color:#FFFFFF;padding:32px;margin-bottom:24px;}@media (max-width:992px){.css-helsa7{margin:0 auto 40px;}}@media (max-width:480px){.css-helsa7{margin:0 0 40px;padding:32px 16px;}}.css-8qb8m4{margin-bottom:48px;}.css-2imjyh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-he5w1s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;width:100%;}@media (max-width:770px){.css-he5w1s{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}}.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-3ojehk{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-right:4px;}.css-100alwu{display:inline-block;border-radius:50%;line-height:1;overflow:hidden;vertical-align:middle;}.css-1dtnjt5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.css-10ougpm{color:rgba(0,0,0,0.87);font-size:14px;font-weight:600;line-height:1.8;margin-right:4px;text-wrap:break-word;word-break:break-all;}.css-1ay9vb9{margin-right:16px;}.css-m19uds{color:rgba(0,0,0,0.6);font-size:14px;line-height:1.8;}.css-cgzq40{color:rgba(0,0,0,0.87);font-size:32px;font-weight:bold;line-height:1.4;margin-top:8px;text-wrap:break-word;word-break:break-all;}.css-1wa99t2{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(0,0,0,0.6);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:8px;}.css-1l3zk9f{color:rgba(0,0,0,0.6);font-size:20px;margin-right:8px;}.css-4czcte{margin-right:4px;color:inherit;font-size:14px;line-height:1.8;}.css-4czcte:not(:last-child)::after{content:',';margin-right:4px;}.css-1yzj1fm{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-top:32px;}.css-1uv1qiv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:transparent;border:none;color:#6E6F70;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:20px;height:32px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-right:16px;outline:none;padding:0;width:32px;}.css-109dbrr{background-color:#F9F9F9;border-top:1px solid rgba(0,0,0,0.12);bottom:0;box-shadow:0px 1px 4px rgba(0,0,0,0.14);display:none;height:calc(env(safe-area-inset-bottom,0px) + 56px);-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding-bottom:env(safe-area-inset-bottom);position:-webkit-sticky;position:sticky;width:100%;z-index:2000;}@media (max-width:770px){.css-109dbrr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}.css-5jpx49{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;width:100%;}.css-mnxgyc{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1vlpknv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:2px solid #55C500;border-radius:50%;cursor:pointer;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:40px;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;padding:0;width:40px;margin-right:4px;background-color:#FFFFFF;}.css-fsjkhv{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-appearance:none;-moz-appearance:none;appearance:none;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;outline:none;}.css-1b17vb0{color:#6E6F70;font-size:14px;font-weight:bold;margin-left:4px;}.css-7i7f4d{display:none;bottom:initial;left:initial;right:initial;top:initial;bottom:32px;right:0;}</style></head><body><div class="allWrapper"><div><div id="GlobalHeader-react-component-d126c760-f595-41f7-b796-648435676fec"><div class="st-Header"><div class="st-Header_container"><div class="st-Header_start"><a href="/" class="st-Header_logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426.57 130"><circle cx="167.08" cy="21.4" r="12.28"></circle><path d="M250.81 29.66h23.48v18.9h-23.48z"></path><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z"></path><circle cx="216.33" cy="21.4" r="12.28"></circle></svg></a><div class="st-Header_communitySelector" tabindex="0"><span class="fa fa-caret-down"></span></div><div class="st-Header_dropdown"><div class="st-Header_dropdownHeading">Qiita Teams that are logged in</div><div class="st-Header_dropdownItemNote">You are not logged in to any team</div><hr class="st-Header_dropdownDivider st-Header_dropdownDivider-shrink"/><a href="https://teams-center.qiita.com/find_team" class="st-Header_dropdownItem"><span class="fa fa-fw fa-sign-in st-Header_dropdownItemIcon"></span><div>Log in to Qiita Team</div></a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Community</div><a href="/organizations" class="st-Header_dropdownItem">Organization</a><a href="/official-events/open" class="st-Header_dropdownItem">Event</a><a href="/advent-calendar" class="st-Header_dropdownItem">Advent Calendar</a><a href="https://qiitadon.com/" class="st-Header_dropdownItem" target="_blank">Qiitadon (β)</a><div class="st-Header_dropdownDivider"></div><div class="st-Header_dropdownHeading">Service</div><a href="https://jobs.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Jobs</a><a href="https://zine.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Zine</a><a href="https://blog.qiita.com/?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=header" class="st-Header_dropdownItem" target="_blank">Qiita Blog</a></div><form class="st-Header_search" action="/search" method="get"><span class="fa fa-search st-Header_searchIcon"></span><input type="search" class="st-Header_searchInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form><form class="st-Header_searchModal" action="/search" method="get"><input type="text" class="st-Header_searchModalInput" autoComplete="off" placeholder="Search" value="" name="q" required=""/></form></div><div class="st-Header_end"><div class="st-Header_searchButton"><span class="fa fa-search"></span></div><a class="st-Header_signupButton" href="/signup?redirect_to=%2Facple%40github%2Fitems%2F8f63aacb13de9954c5da">Signup</a><a class="st-Header_loginLink" href="/login?redirect_to=%2Facple%40github%2Fitems%2F8f63aacb13de9954c5da">Login</a></div><div class="st-Header_overlay"></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="GlobalHeader" data-dom-id="GlobalHeader-react-component-d126c760-f595-41f7-b796-648435676fec">{"unreadNotificationsCount":null,"realms":[{"humanName":"Qiita","isCurrentRealm":true,"isQiita":true,"isQiitaTeam":false,"loggedInUser":null,"teamId":null,"url":"https://qiita.com/"}],"teamFindUrl":"https://teams-center.qiita.com/find_team","isTeamOnlyUser":null,"currentUser":null}</script>
      
</div><div class="st-HeaderAlert st-HeaderAlert-warning"><div class="st-HeaderAlert_body"></div></div><script type="application/ld+json">{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"/","name":"Qiita"}},{"@type":"ListItem","position":2,"item":{"@id":"/tags/csharp","name":"C#"}}]}</script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","datePublished":"2016-12-09T23:56:21.000+09:00","dateModified":"2016-12-10T17:19:56.000+09:00","headline":"Taskを極めろ！async/await完全攻略","image":"https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-1150d8b18a7c15795b701a55ae908f94.png?ixlib=rb-4.0.0\u0026w=1200\u0026mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTM4MCZ0eHQ2ND1WR0Z6YS1PQ2t1YWx0ZU9DZ2VPQ2plLThnV0Z6ZVc1akwyRjNZV2wwNWE2TTVZV281cFM3NTVXbCZ0eHQtY29sb3I9JTIzMzMzJnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1zaXplPTU0JnR4dC1jbGlwPWVsbGlwc2lzJnR4dC1hbGlnbj1jZW50ZXIlMkNtaWRkbGUmcz1hZmQ3MmQwNDI4ZTAzZDY5MWNmMDYwNGI0NzYzYTNlMQ\u0026mark-align=center%2Cmiddle\u0026blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTg0MCZoPTUwMCZ0eHQ2ND1RR0ZqY0d4bFFHZHBkR2gxWWcmdHh0LWNvbG9yPSUyMzMzMyZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT00NSZ0eHQtYWxpZ249cmlnaHQlMkNib3R0b20mcz04MzFmZGI0M2FiZjc3MjY4ZTJlZmZmYTJlNGIzYWQ3Mw\u0026blend-align=center%2Cmiddle\u0026blend-mode=normal\u0026s=475dd247c855c8119e2adb5820e0c89c","mainEntityOfPage":"https://qiita.com/acple@github/items/8f63aacb13de9954c5da","author":{"@type":"Person","address":"","email":null,"identifier":"acple@github","name":"acple@github","image":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F15349%2Fprofile-images%2F1473684254?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=3a436d04088cd4d1870e042deced4196","url":"https://qiita.com/acple@github","description":"言語仕様とか設計思想を掘るのが趣味のプログラミング初心者\r\nC#とPureScriptちょっとできる(できない)","memberOf":[]},"publisher":{"@type":"Organization","name":"Qiita","logo":{"@type":"ImageObject","url":"//cdn.qiita.com/assets/public/qiita-logo-c39ded593afa388e2e1ba435b110554e.png"}}}</script><style type="text/css">.wb-CampaignLink {
  background-color: #333333;
  width: 100%;
}

.wb-CampaignLink_container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1100px;
  margin: 0 auto;
  font-size: 13px;
  padding: 0.8em;
}
.wb-CampaignLink_container > a {
  color: #fff;
}

.wb-CampaignLink_container > a:hover {
  text-decoration: underline;
}</style><div class="wb-CampaignLink"><div class="wb-CampaignLink_container"><a target="_blank" id="header_text_message_1" href="https://increments.connpass.com/event/211948/">【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup</a><a target="_blank" id="header_text_message_2" href="https://increments.connpass.com/event/211948/">詳しくはこちら</a></div><script>td.trackEvent(
  'front_events',
  {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"acple@github","type":"items","id":"8f63aacb13de9954c5da"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Show","data":{"message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
)</script><script>document.getElementById('header_text_message_1').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"acple@github","type":"items","id":"8f63aacb13de9954c5da"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_1","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script><script>document.getElementById('header_text_message_2').addEventListener('click', function() {
  td.trackEvent(
    'front_events',
    {"query_parameters":{},"path_parameters":{"controller":"public/items","action":"show","user_id":"acple@github","type":"items","id":"8f63aacb13de9954c5da"},"user_id":null,"event_category":"Header Text Ads Banner","event_action":"Click","data":{"index":2,"pos_id":"header_text_message_2","message":"【9/9(木)開催】Qiitaの過去と未来についてお話しします！Qiita エンジニアフェスタ 2021 Online Meetup","url":"https://increments.connpass.com/event/211948/","sub_message":"詳しくはこちら"}}
  )
})</script></div><script type="application/json" id="js-react-on-rails-context">{"railsEnv":"production","inMailer":false,"i18nLocale":"en","i18nDefaultLocale":"en","href":"https://qiita.com/acple@github/items/8f63aacb13de9954c5da","location":"/acple@github/items/8f63aacb13de9954c5da","scheme":"https","host":"qiita.com","port":null,"pathname":"/acple@github/items/8f63aacb13de9954c5da","search":null,"httpAcceptLanguage":null,"actionPath":"public/items#show","settings":{"analyticsTrackingId":"UA-24675221-12","assetsMap":{},"csrfToken":"8j1gsdvy7hBRcipRVOe0znPuzLsKvrXM5MNJLgyj9wXelYc+nQiyZp0ZPGFafq4o60TeeVDa0TEGCTTa2ji/ug==","locale":"en"},"currentUser":null,"isLoggedIn":false,"recaptchaSiteKey":"6LfNkiQTAAAAAM3UGnSquBy2akTITGNMO_QDxMw6","serverSide":false}</script>
<div id="PersonalArticlePage-react-component-ff88cf11-119a-4fad-901b-4c7db8f54901"><div class="p-items_wrapper"><div class=" css-17jxvjw"><div class="css-11t2ec1"><div class="css-1dvr2p8"><button class=" css-18lkoru"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/acple@github/items/8f63aacb13de9954c5da/likers" class="css-1iupg5d">945</a></div><div class="css-ijvq0v"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-115f4t">947</span></div><div class="css-1b8uj5v"><span class="fa fa-twitter"></span></div><div class="css-1b8uj5v"><span class="fa fa-facebook"></span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-fcbn8c"><div class="css-1gj7nt">Improve article</div><a href="/drafts/8f63aacb13de9954c5da/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/acple@github/items/8f63aacb13de9954c5da/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/acple@github/items/8f63aacb13de9954c5da/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/acple@github/items/8f63aacb13de9954c5da/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/acple@github/items/8f63aacb13de9954c5da.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div><div class="p-items_options"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_toc"><div class="mt-2"><div class="css-1hbd3g7"></div></div></div><div class="p-items_main"><div class="css-1nzh4zz"><span class="fa fa-fw fa-warning css-38fzdi"></span><p>More than 3 years have passed since last update.</p></div><div class="css-helsa7"><div class="css-8qb8m4"><div class="it-AdcalRibbon"><span><a href="/advent-calendar/2016/csharp" class="it-AdcalRibbon_title">C#<!-- --> Advent Calendar<!-- --> <!-- -->2016</a>Day 9</span></div><div class="css-2imjyh"><div class="css-he5w1s"><div class="css-70qvj9"><div class="css-3ojehk"><a href="/acple@github"><img class="css-100alwu eyfquo10" src="https://qiita-image-store.s3.amazonaws.com/0/15349/profile-images/1473684254" width="24" height="24" loading="lazy"/></a></div><div class="css-1dtnjt5"><a href="/acple@github" class="css-10ougpm">@<!-- -->acple@github</a><div class="css-1ay9vb9"><span><meta content="2016-12-09T14:56:21Z"/><time dateTime="2016-12-10T08:19:56Z" class="css-m19uds">updated at 2016-12-10</time></span></div></div></div></div></div><h1 class="css-cgzq40">Taskを極めろ！async/await完全攻略</h1><div class="css-1wa99t2"><span class="fa fa-tags mr-1of2 css-1l3zk9f" aria-hidden="true"></span><a href="/tags/csharp" class="css-4czcte">C#</a><a href="/tags/adventcalendar" class="css-4czcte">AdventCalendar</a></div></div><section class="it-MdContent"><div id="personal-public-article-body"><div><p>この記事は、</p>

<ul>
<li>Task.Runを書けばとりあえず非同期で動くのはわかる</li>
<li>時々なんかうまく動かなかったりするけどどうして動かないのかはよくわからない</li>
<li>よくわからないまま書いてよくわからないまま動いてるけどこれで大丈夫なのかわからなくてこわい</li>
</ul>

<p>みたいな人を対象にしています。</p>

<h1>
<span id="taskクラスとasyncawait" class="fragment"></span><a href="#task%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8asyncawait"><i class="fa fa-link"></i></a>Taskクラスとasync/await</h1>

<p>皆さん、非同期してますか？当然してますね。<del>同期処理が許されるのはC#2.0までだよねー</del>じゃなくて、async/awaitはC# 5.0から導入された、Taskクラスと紐付いた言語構文の一つです。登場はもう数年前なはずなんですが、未だに新しい言語仕様な感じがしてフシギです。それでもさすがに今は馴染んでいて、どこにでも遠慮なく飛び出てくるようになっています。</p>

<h2>
<span id="taskの難しさ" class="fragment"></span><a href="#task%E3%81%AE%E9%9B%A3%E3%81%97%E3%81%95"><i class="fa fa-link"></i></a>Taskの難しさ</h2>

<p>Taskは、難しいです。<br>
Taskがというよりは、非同期処理自体が持つ複雑さが根本に存在するため、いくらシンプルに書ける構文があったとしても、その難しさは変わりません。<br>
非同期処理の一般的な問題として、よくわかっていないまま使うと、目に見えにくい不具合や再現性が著しく低い不具合などを埋め込んでしまい大変危険なことになるんですが、その危険性も、使い慣れている人じゃないと気づけないというところがあります。<br>
下手な使い方をすると、</p>

<ul>
<li>例外がthrowされてたけど気づかない</li>
<li>見つけづらいデッドロックの発生</li>
<li>並列アクセスによるスレッドセーフ問題</li>
<li>そもそもちゃんと非同期処理になってないクソコード</li>
</ul>

<p>などの問題を引き起こします。やばいですね。</p>

<h1>
<span id="taskを理解しよう" class="fragment"></span><a href="#task%E3%82%92%E7%90%86%E8%A7%A3%E3%81%97%E3%82%88%E3%81%86"><i class="fa fa-link"></i></a>Taskを理解しよう</h1>

<p>まずはasync/awaitのことは置いておいて、Taskの事を理解することが大切です。<br>
細かい動きがわからなくても、理屈さえ理解さえしていれば、間違ってもasync voidなんて書いたりしなくなりますからね。</p>

<h2>
<span id="オブジェクト指向" class="fragment"></span><a href="#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%8C%87%E5%90%91"><i class="fa fa-link"></i></a>オブジェクト指向</h2>

<p>さすがに今更オブジェクト指向のことについて言及する必要もないとは思いますが、これ以降の話の内容にちょっと関わるので、一言だけ。<br>
オブジェクト指向というのは「有象無象の『値』の集まりに対して、クラスという枠組みを作り、その『値』に特別な性質と名前を与え、それを分類して管理していく」プログラミングスタイルのことです。つまり、オブジェクト指向におけるクラスの「名前」というのは非常に重要で、例えば中身が全く同じであっても、その名前が違うだけで使い方が自然に変わっていくような、そんなハイコンテクストなプログラミング手法なのです。</p>

<h2>
<span id="そもそもtaskとは何なのか" class="fragment"></span><a href="#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82task%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%AA%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>そもそもTaskとは何なのか</h2>

<p>Taskの解説を読むとスレッドプールだとかIO待ちだとか、並列だ並行だと話が出てきますが、そもそもスレッドプールとIO待ちは全くの別物だったりしますね。これは一体どういうことなのか？</p>

<p>まず一番の前提をぶち壊して行きます。<br>
「Taskとは、『非同期処理』のことではない。」</p>

<p><strong>だって、「Task」はただの「タスク」なのだから。</strong></p>

<h2>
<span id="taskという名前" class="fragment"></span><a href="#task%E3%81%A8%E3%81%84%E3%81%86%E5%90%8D%E5%89%8D"><i class="fa fa-link"></i></a>Taskという「名前」</h2>

<p>ここで、非同期処理に「Task」という名前が与えられている意味を考えてみましょう。Taskクラスはその名の通り、一つの「作業単位」「仕事」「タスク」そのものを表しているといえます。一般的なTaskファクトリであるTask.Runを例とすると、</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="nf">MethodA</span><span class="p">();</span>
    <span class="nf">MethodB</span><span class="p">();</span>
<span class="p">});</span>

</code></pre></div></div>

<p>この変数taskは、「MethodAを実行後、MethodBを実行する、という『タスク』を作成し、それを開始したもの」を表します。つまり、変数taskの中身は、文字通り『タスク』そのものなのです。</p>

<h3>
<span id="例" class="fragment"></span><a href="#%E4%BE%8B"><i class="fa fa-link"></i></a>例</h3>

<h4>
<span id="1000ミリ秒待機するという仕事を表す" class="fragment"></span><a href="#1000%E3%83%9F%E3%83%AA%E7%A7%92%E5%BE%85%E6%A9%9F%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E4%BB%95%E4%BA%8B%E3%82%92%E8%A1%A8%E3%81%99"><i class="fa fa-link"></i></a>「1000ミリ秒待機するという『仕事』を表す」</h4>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span> <span class="c1">// ただのDelayなんだけど、ちょっと違って見えてきません？</span>
</code></pre></div></div>

<h4>
<span id="httpclientでgetを行うという仕事" class="fragment"></span><a href="#httpclient%E3%81%A7get%E3%82%92%E8%A1%8C%E3%81%86%E3%81%A8%E3%81%84%E3%81%86%E4%BB%95%E4%BA%8B"><i class="fa fa-link"></i></a>「HttpClientでGETを行うという『仕事』」</h4>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="s">"https://......"</span><span class="p">);</span> <span class="c1">// &lt;- awaitを付けていない</span>
</code></pre></div></div>

<p>ここで記述しているのは「開始するところ」だけなのがポイント。だから、「実際のGET処理は裏で誰かが勝手にやってくれる」。</p>

<h1>
<span id="asyncawaitキーワードそして非同期メソッドとは" class="fragment"></span><a href="#asyncawait%E3%82%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%89%E3%81%9D%E3%81%97%E3%81%A6%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8%E3%81%AF"><i class="fa fa-link"></i></a>async/awaitキーワード、そして「非同期メソッド」とは</h1>

<ul>
<li>シグネチャにasyncを付けたメソッドのことを「非同期メソッド」と呼びます。</li>
<li>非同期メソッドの特徴はただ一つ、文中でawaitキーワードを使えるようになることです。</li>
<li>そして、awaitキーワードの効果は、「指定したTaskの完了を待つ」「そして、その結果を取り出す」ことです。</li>
<li>最後に、非同期メソッドの戻り値は必ずTask/Task&lt;T&gt;になります。</li>
</ul>

<p>なにか見えてきませんか？</p>

<p>非同期メソッドとは、<strong>複数の「タスク」の実行順序などを記述した「一つのタスク」である</strong>。<br>
いわゆる、作業手順書のようなものである。</p>

<h3>
<span id="例-1" class="fragment"></span><a href="#%E4%BE%8B-1"><i class="fa fa-link"></i></a>例</h3>

<h4>
<span id="1000ミリ秒待機するタスクの完了を待ちその後doneを出力するというタスク" class="fragment"></span><a href="#1000%E3%83%9F%E3%83%AA%E7%A7%92%E5%BE%85%E6%A9%9F%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%AE%E5%AE%8C%E4%BA%86%E3%82%92%E5%BE%85%E3%81%A1%E3%81%9D%E3%81%AE%E5%BE%8Cdone%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%BF%E3%82%B9%E3%82%AF"><i class="fa fa-link"></i></a>「1000ミリ秒待機する『タスク』の完了を待ち、その後"Done!"を出力する、という『タスク』」</h4>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">async</span> <span class="n">Task</span> <span class="nf">AsyncMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span> <span class="c1">// 1000ミリ秒待機するという仕事の完了を待ち、</span>
    <span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Done!"</span><span class="p">);</span> <span class="c1">// "Done!"をコンソールに出力する</span>
<span class="p">}</span> <span class="c1">// という、「一つのTask」を表す。</span>
</code></pre></div></div>

<h4>
<span id="httpclientでgetした内容を文字列で手に入れるタスク" class="fragment"></span><a href="#httpclient%E3%81%A7get%E3%81%97%E3%81%9F%E5%86%85%E5%AE%B9%E3%82%92%E6%96%87%E5%AD%97%E5%88%97%E3%81%A7%E6%89%8B%E3%81%AB%E5%85%A5%E3%82%8C%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF"><i class="fa fa-link"></i></a>「HttpClientでGETした内容を文字列で手に入れる『タスク』」</h4>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">AsyncMethod2</span><span class="p">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span> <span class="c1">// &lt;- 本当はHttpClientをusingで使っちゃダメ</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">uri</span><span class="p">);</span> <span class="c1">// &lt;- 「GETせよ」のタスクを開始し、その完了を待機する</span>
        <span class="kt">var</span> <span class="n">text</span> <span class="p">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span> <span class="c1">// 「レスポンスからその本文をstringとして読み出す」タスクを開始し、その完了を待機する</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">;</span> <span class="c1">// 読み出したtextを返す</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="c1">// という「一つのタスク(Task&lt;string&gt;)」を表す。</span>
</code></pre></div></div>

<h2>
<span id="タスクであるという意味" class="fragment"></span><a href="#%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%A7%E3%81%82%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E6%84%8F%E5%91%B3"><i class="fa fa-link"></i></a>「タスク」であるという意味</h2>

<p>非同期メソッドはタスクであり、作業手順書です。手順書であるということは、それが「書かれた通りの順序で実行していけばいい」ということであり、言い換えるとそれは「<strong>記述されたタスクの実行順序さえ間違えなければ、誰が（どのスレッドが）どのタスクを実行したって構わない</strong>」と表明しているような事になります。つまり、Taskとは「スレッドの存在を意識する必要がない、単なる『処理』のまとまり」だということです。非同期処理を「タスク」の組み合わせとみなすことで、処理を分割しやすく、そして容易に合成できるようにしたもの。それが、Taskクラスなのです。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="c1">// ちゃんと順番通り実行してくれるなら、</span>
<span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">uri</span><span class="p">);</span> <span class="c1">// このタスクを実行する人(スレッド)と</span>
<span class="kt">var</span> <span class="n">text</span> <span class="p">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span> <span class="c1">// このタスクを実行する人が違ったとしても</span>
<span class="k">return</span> <span class="n">text</span><span class="p">;</span> <span class="c1">// 全く問題はない！</span>
</code></pre></div></div>

<h2>
<span id="スレッドプールio待ち" class="fragment"></span><a href="#%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%83%97%E3%83%BC%E3%83%ABio%E5%BE%85%E3%81%A1"><i class="fa fa-link"></i></a>スレッドプール、IO待ち</h2>

<p>Taskは非同期のことではありません。あくまで処理を「手順書」として記述したものであり、それの中身がなんであるかを気にする必要はないのです。例えば、同期処理をTask.Runでラップした場合、それは「スレッドプール上で動作する一連の処理」となります。Task.Delayは「指定したミリ秒後にタイマーを設定し、スレッドを解放」します。HttpClientなどのIO待ちは、イベント処理をTaskでラップしたものになります。このように、中身は全く異なる枠組みで動作していても、それらを全て「単なるタスク」として取り扱えること。これが、Taskの本質なのです。</p>

<h1>
<span id="見て覚えるasyncawait" class="fragment"></span><a href="#%E8%A6%8B%E3%81%A6%E8%A6%9A%E3%81%88%E3%82%8Basyncawait"><i class="fa fa-link"></i></a>見て覚えるasync/await</h1>

<p>似たようだけどぜんぜん違うコードを並べてみましたので、見て、そして、理解して下さい。<br>
わかりやすさのため、for文を使用しています。<br>
この項では便宜的に、voidなメソッドのことを「アクション」と表現しています。その意図については後で説明します。</p>

<h3>
<span id="重い処理をエミュレートする同期メソッド" class="fragment"></span><a href="#%E9%87%8D%E3%81%84%E5%87%A6%E7%90%86%E3%82%92%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E5%90%8C%E6%9C%9F%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>重い処理をエミュレートする同期メソッド</h3>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">HeavyMethod</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">10</span> <span class="p">*</span> <span class="p">(</span><span class="m">100</span> <span class="p">-</span> <span class="n">x</span><span class="p">));</span> <span class="c1">// てきとーに時間を潰す</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="heavymethodを同期的に10回実行する普通のメソッド" class="fragment"></span><a href="#heavymethod%E3%82%92%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB10%E5%9B%9E%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E6%99%AE%E9%80%9A%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89"><i class="fa fa-link"></i></a>「HeavyMethodを同期的に10回実行する」普通のメソッド</h3>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">RunHeavyMethodSync</span><span class="p">()</span> <span class="c1">// 比較のため、ただの同期メソッド</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">x</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="nf">HeavyMethod</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>
<span id="heavymethodを順次実行するという一つのタスク" class="fragment"></span><a href="#heavymethod%E3%82%92%E9%A0%86%E6%AC%A1%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E4%B8%80%E3%81%A4%E3%81%AE%E3%82%BF%E3%82%B9%E3%82%AF"><i class="fa fa-link"></i></a>「HeavyMethodを順次実行する」という一つのタスク</h3>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">RunHeavyMethodAsync1</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">x</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">HeavyMethod</span><span class="p">(</span><span class="n">x</span><span class="p">));</span> <span class="c1">// 「HeavyMethodを実行する」というタスクを開始し、完了するまで待機</span>
    <span class="p">}</span> <span class="c1">// を、10回繰り返す</span>
<span class="p">}</span> <span class="c1">// というタスクを表す</span>
<span class="c1">// ので、これは順次動作であり、並列ではない。</span>
</code></pre></div></div>

<h3>
<span id="heavymethodを順次実行するというアクション" class="fragment"></span><a href="#heavymethod%E3%82%92%E9%A0%86%E6%AC%A1%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>「HeavyMethodを順次実行する」というアクション</h3>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">RunHeavyMethodAsync2</span><span class="p">()</span> <span class="c1">// RunHeavyMethodAsync1の戻り値がvoidになっただけ</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">x</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">HeavyMethod</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="c1">// 動作はRunHeavyMethodAsync1と同じだけど、HeavyMethodの実行がいつ完了するのか知ることができない。つらい。</span>
</code></pre></div></div>

<h3>
<span id="heavymethodを実行するタスクを10個開始するというアクション" class="fragment"></span><a href="#heavymethod%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%9210%E5%80%8B%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3"><i class="fa fa-link"></i></a>「HeavyMethodを実行するタスクを10個開始する」というアクション</h3>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">RunHeavyMethodParallel1</span><span class="p">()</span> <span class="c1">// asyncじゃない</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">x</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">HeavyMethod</span><span class="p">(</span><span class="n">x</span><span class="p">));</span> <span class="c1">// HeavyMethodを開始せよという命令</span>
    <span class="p">}</span> <span class="c1">// を、10回繰り返すだけ</span>
<span class="p">}</span> <span class="c1">// なので、これは並列動作になる。Task.Runが投げっぱなしなので、HeavyMethodの状態がわからなくてつらい。</span>
</code></pre></div></div>

<h3>
<span id="heavymethodを実行するタスクを10個開始しその全てが完了した時に完了するという一つのタスク" class="fragment"></span><a href="#heavymethod%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%9210%E5%80%8B%E9%96%8B%E5%A7%8B%E3%81%97%E3%81%9D%E3%81%AE%E5%85%A8%E3%81%A6%E3%81%8C%E5%AE%8C%E4%BA%86%E3%81%97%E3%81%9F%E6%99%82%E3%81%AB%E5%AE%8C%E4%BA%86%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E4%B8%80%E3%81%A4%E3%81%AE%E3%82%BF%E3%82%B9%E3%82%AF"><i class="fa fa-link"></i></a>「HeavyMethodを実行するタスクを10個開始し、その全てが完了した時に完了する」という一つのタスク</h3>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="n">Task</span> <span class="nf">RunHeavyMethodParallel2</span><span class="p">()</span> <span class="c1">// asyncじゃないけど、戻り値がTask</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">tasks</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Task</span><span class="p">&gt;();</span> <span class="c1">// TaskをまとめるListを作成</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">x</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">task</span> <span class="p">=</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">HeavyMethod</span><span class="p">(</span><span class="n">x</span><span class="p">));</span> <span class="c1">// HeavyMethodを開始するというTask</span>
        <span class="n">tasks</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">task</span><span class="p">);</span> <span class="c1">// を、Listにまとめる</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">WhenAll</span><span class="p">(</span><span class="n">tasks</span><span class="p">);</span> <span class="c1">// 全てのTaskが完了した時に完了扱いになるたった一つのTaskを作成</span>
<span class="p">}</span> <span class="c1">// 非同期メソッドではないが、戻り値がTaskなので、このメソッドは一つのタスクを表しているといえる。</span>
</code></pre></div></div>

<p>以上です。違いが分かるでしょうか？</p>

<p>まず最初に、Taskをawaitした場合とawaitしない場合の違いがあります。<br>
awaitするということは、「そのTaskが完了するまで待つ」ということなので、いわゆる同期実行的なフローになります。awaitしない場合は、その行で「(誰か)この仕事を開始して！」という命令を投げるだけに留まります。なので、そのタスクの実行中に自分は本来の仕事の続きをこなすことが出来るのです。並行ですね。そして、戻り値としてTaskを握ることで、その仕事の進行状況を把握することができるようになっています。</p>

<p>次に、戻り値がTaskの場合とvoidの場合です。<br>
Taskを返す場合は、基本的にその手順書に書かれた仕事が全て完了したことを報告することになります。非同期メソッドで戻り値をTaskにした場合は、自動的に、そのメソッドがreturnしたときに完了するTaskになります。<br>
そして、voidは、何も返しません。どういうことか？上司は「この仕事を開始して！」と命令したあと、命令したことを忘れます。そしてTaskを割り当てられたスレッドくんは、その仕事が完了しても報告する相手がいないわけです。マジヤバイ。</p>

<p>voidなメソッドを「アクション」と表現しましたが、これの意図は一つ。「それは『タスク』ではないから」。命令を投げるだけ投げっぱなしなのは、責任の所在を不明にする行為で、おおよそ推奨できるものではありません。その実害としては、voidで実行した非同期メソッド中で万が一例外が発生した場合など。その例外はコード上で見つけることが出来なくなり、それは時にアプリケーションを殺します。</p>

<h1>
<span id="async-void-なんてなかった" class="fragment"></span><a href="#async-void-%E3%81%AA%E3%82%93%E3%81%A6%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>async void なんてなかった</h1>

<p>async void は 使用禁止！使用禁止！使用禁止！<br>
上の話で書いたとおりですが、せっかく非同期メソッドがその仕事の進行状況を把握できるような設計になっているのに、わざわざそれを捨てるなんてとんでもない！<br>
同期メソッドで言うvoidは、非同期メソッドでは戻り値Taskのことであり、同期メソッドにおける戻り値は、非同期メソッドにおける戻り値Task&lt;T&gt;のTになります。それ以外はないです。</p>

<p>では、何故async voidなんていうものが存在するのか？その理由はただ一つ。UIイベントハンドラーに非同期メソッドを登録するには、voidじゃないと無理だったから。<br>
UIから直接実行されるイベントの受け皿メソッドにのみ、async voidを使うことが許されていると思って下さい。</p>

<h1>
<span id="taskってむずかしい" class="fragment"></span><a href="#task%E3%81%A3%E3%81%A6%E3%82%80%E3%81%9A%E3%81%8B%E3%81%97%E3%81%84"><i class="fa fa-link"></i></a>Taskってむずかしい</h1>

<p>ちょっとごちゃごちゃしてますが、ここまで実装とはなるべく無関係に内容を説明してきたつもりです。ここからはもう少し深掘りしていくので、読めなかったら適当に読み飛ばしてもいいですよーなのです。</p>

<h2>
<span id="taskrunとは何なのか" class="fragment"></span><a href="#taskrun%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%AA%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>Task.Runとは何なのか</h2>

<p>Task.Runはお手軽にTaskを作れるファクトリメソッドですが、お手軽すぎるせいで、使う必要が全くない場面でも使われていることがとても多くてもにょもにょします。<br>
Task.Runの概念は、一言で言えばこうです。</p>

<p>「同期的な一連の処理を、一つのタスクとみなす」</p>

<p>非同期タスクを組み合わせ、合成して、一つのタスクを組み上げるのが非同期メソッドだとしたら、その中に同期処理もタスクの一つとして組み込みたいこともあるわけです。その時に使えるのがTask.Runなのです。</p>

<p>もう一つ別の使い方に、Task.Runの中に非同期ラムダ式を書くパターンがあります。これは、単純にその非同期メソッドを呼び出しているようなものです。直接呼び出した場合と唯一異なるのが、「非同期メソッドを明確に別コンテキストで実行する」というものです。</p>

<p>これ以外の使い方をしているなら、それはTask.Runの濫用だと思っていいです。</p>

<h2>
<span id="taskはスレッドの呪縛から解放された-" class="fragment"></span><a href="#task%E3%81%AF%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E5%91%AA%E7%B8%9B%E3%81%8B%E3%82%89%E8%A7%A3%E6%94%BE%E3%81%95%E3%82%8C%E3%81%9F-"><i class="fa fa-link"></i></a>Taskはスレッドの呪縛から解放された！ ……？</h2>

<p>上で書いたとおり、「Taskは単なる手順書であり、それぞれの処理をどのスレッドが実行したって結果は変わらない」というものです。よって、Taskはレガシープログラミング的なスレッド管理という概念から解放された非同期機構であり、特定のスレッドに依存する処理(UI操作など)は、本来非同期メソッド上で扱ってはいけないのです！……Taskの思想では、そうなるはずだったのです。</p>

<h2>
<span id="asyncawaitはスレッドと切り離せなかった" class="fragment"></span><a href="#asyncawait%E3%81%AF%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%A8%E5%88%87%E3%82%8A%E9%9B%A2%E3%81%9B%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F"><i class="fa fa-link"></i></a>async/awaitはスレッドと切り離せなかった……</h2>

<p>async/awaitの有名な使用例として、まず最初にUI処理が出てきます。UIはシングルスレッドなので、その貴重な資源を内部処理などで長時間専有するなんてとんでもない！というのはその通りで、まさにここが非同期処理が活躍する最大の見せ場でもありました。なので、非同期メソッドには「まるで同期処理のような書き方で非同期処理を行えて、自然にUI処理に組み込める」というものが期待されました。<br>
よって、async/awaitは、「非同期メソッド内で何らかの処理をawaitした後、その続きはawaitする前と『同じスレッド上で』実行される」という設計になりました。<br>
例えば、UIからボタン操作などで非同期メソッドを開始(UIスレッド上で動作)し、その途中で何かしらの内部処理を呼び出してawait(内部処理は別スレッドで動作し、UIスレッドは自由に)、内部処理が完了した後の続きは再びUIスレッドに戻って動作するので、そこでUIの更新などのスレッド依存処理を書いても問題なく動作させることができるのです。<br>
これで、期待された「まるで同期処理のような書き方でUI処理」を実現することができたのです。これでみんなハッピー！</p>

<p>……本当に？</p>

<h2>
<span id="taskをwaitしてはいけない" class="fragment"></span><a href="#task%E3%82%92wait%E3%81%97%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>TaskをWaitしてはいけない</h2>

<p>TaskをWaitしてはいけないと聞いたことはありますね？<br>
どこの解説を読んでも、TaskをWaitすることについては一言二言書いてあったはずです。<br>
理由はもちろんデッドロック。ちょっとWaitを呼んでみるだけで、予想よりもずっと簡単にデッドロックを発生させることができてしまいます。<br>
例えば、</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">KusoMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">KusoAsyncMethod</span><span class="p">().</span><span class="nf">Wait</span><span class="p">();</span> <span class="c1">// エターナル不応答しぬ</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">KusoAsyncMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>はい。たったこれだけで、完全にデッドロックで死にます。ギルティです。</p>

<h2>
<span id="何故デッドロックが発生するのか" class="fragment"></span><a href="#%E4%BD%95%E6%95%85%E3%83%87%E3%83%83%E3%83%89%E3%83%AD%E3%83%83%E3%82%AF%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B"><i class="fa fa-link"></i></a>何故デッドロックが発生するのか</h2>

<p>非同期メソッドは、awaitする内部タスクを開始した後、自分のスレッドを一旦解放します。そして、その内部タスクが完了したとき、処理の続きを「前と同じスレッドで」実行します。その間に、「前のスレッドを既に誰かが使っていたら？」「そして、そのスレッドが解放されるためには、Taskの実行が完了しないといけないとしたら？」はい。デッドロックです。<br>
Waitじゃなくてもいいです。例えば、Taskが実行完了するまで廻り続けるwhileループとかでも余裕で発生します。Task&lt;T&gt;.Resultプロパティの参照もWaitと同様なので同じように死にます。</p>

<p>本来、<strong>Taskは好きなときに好きなようにWaitしても全く問題ないものだった</strong>はずなのです。しかし、async/awaitがスレッドのコンテキストを掴む関係で、Waitした際にデッドロックが発生する可能性が出てしまいました。非同期メソッドが本当の意味での「ただのタスク」であったならば、それがコンテキストを保存する必要は全くなかったのです。全ては、「UIスレッドのイベントハンドラをナチュラルに書く」というただ一つの用途のため。そのために、Waitは全面使用禁止となり、使おうとすれば我々は一目では見つけづらいデッドロックに怯えなければならない状況になってしまったのです。とてもつらい。</p>

<p>しかし！対策はあります！</p>

<h2>
<span id="configureawaitfalseのススメ" class="fragment"></span><a href="#configureawaitfalse%E3%81%AE%E3%82%B9%E3%82%B9%E3%83%A1"><i class="fa fa-link"></i></a>ConfigureAwait(false)のススメ</h2>

<p>特定のスレッドに戻りたくても戻れないために発生するデッドロックならば、「特定のスレッドに戻らなくても良い」ようにすればいいのではないでしょうか。そのためのメソッドが、<code>ConfigureAwait(false)</code>です。<br>
引数のbool値は、「awaitする際にコンテキストを保存するか？」を指定します。つまり、既定値はtrueで、これをfalseにすることで、await後に戻る先のスレッドを指定しないようにできます。そうすれば、続きの実行は適当な空いているスレッドに割り当てられ、上のようなデッドロックが発生することはなくなります。</p>

<p>つまりこういうことです、</p>

<ul>
<li>まずは、awaitする時は必ずConfigureAwait(false)を書け！</li>
<li>その上で、UI処理など、一連の処理を特定のスレッド上で走らせたい場合に限り、ConfigureAwait(false)を外せ！</li>
<li>なるべく多くのawaitにConfigureAwait(false)を付けるために、UI処理などはなるべく浅い層のメソッド上にまとめて書け！</li>
</ul>

<p>という設計が、Taskを扱う場合のベストプラクティスになります。<br>
超ぉめんどくさいですね。めんどくさいです。でも、やってください。これについては、async/awaitの最初の設計が悪かったとしか言えないです。<br>
このコーディングを徹底することで、初めてデッドロック問題を回避することができます。</p>

<div class="code-frame" data-lang="csharp"><div class="highlight"><pre class="with-code"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">KusoMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">NiceAsyncMethod</span><span class="p">().</span><span class="nf">Wait</span><span class="p">();</span> <span class="c1">// Waitしてもデッドロックしない！</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">NiceAsyncMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">1000</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>しかし、ここでさらに問題が。上のコード例、NiceAsyncMeshodとKusoAsyncMethodの違いは、中のawaitにConfigureAwait(false)がついているかどうかだけです。ということは、この2つのメソッドのシグネチャを見比べても、その違いはわからないわけです。もし、<strong>このメソッドが外部ライブラリの中に書かれていたものだとしたら？</strong>そのメソッドは果たしてちゃんとConfigureAwait(false)されているのか？これは、もう、ソースを読まないとわからない、のですね。<br>
そういうわけなので、ユーザーとしては、<strong>TaskのWaitは絶対使用禁止</strong>、必ず非同期メソッドでawaitを使うこと。となってしまうわけです。とても、残念です。</p>

<h1>
<span id="taskのこれから" class="fragment"></span><a href="#task%E3%81%AE%E3%81%93%E3%82%8C%E3%81%8B%E3%82%89"><i class="fa fa-link"></i></a>Taskのこれから</h1>

<p>C# 7が絶賛開発中なのです！たのしいのです！<br>
Visual Studio 2017のリリースに合わせて、C#のバージョン7がリリースされようとしています。<br>
その目玉新機能の一つとして、「値型のTask」と、それに付随して「ユーザー定義のTask型」が搭載されます！<br>
……これについては、ほぼパフォーマンス要件によるものなので、ユーザー目線で見ると、今までのTaskと全然変わらないし、逆に、変わってはいけないものです。完全にライブラリ制作者向けのものなので、まあ気にしなくていいです！！この記事を丸ごとすらすら読めるような人なら、調べてみたら面白いかもですよって感じです！簡単に言うと、Taskがインスタンス作りまくるからちょっとがべこれキツいんでスタック領域でなんとかならないですかね？っていう話と、値型のTask作るから自前でTask作れる枠組みをくれ！っていう話です。</p>

<h1>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h1>

<p>割とクソ長だこれ！</p>

<ul>
<li>Taskとは、「非同期処理」のことではない</li>
<li>Taskはただの「タスク」であり、そのタスクを誰かが処理していくという構造なので、勝手に非同期になるだけ</li>
<li>非同期メソッドは、Taskを組み合わせて作ったTask(作業手順書)である</li>
<li>Taskの意味さえわかってれば、仕組みがわからなくてもちゃんと使えるんだよ！</li>
<li>async void絶対使用禁止 (除く:UIイベントハンドラ)</li>
<li>そのTask.Run、本当に必要ですか？</li>
<li>TaskのWaitは本当にヤバイ</li>
<li>ConfigureAwait(false)つけような！</li>
<li>C# 7でValueTaskとかTask-likeとか出てくるけど、枠組みは変わらないから、まずは普通のTaskをマスターしよう！</li>
</ul>

<p>async/await、Taskは既に完成した代物なので、これからも変わらず使われていくことになるでしょう。<br>
ちゃんと理解してしまえば、つまづきどころも見えやすい仕組みなので、これを機に、非同期完全攻略、してみましょう？<br>
いくらか問題点はあるとしても、それでもasync/awaitはとてもよくできた構文なので、これを使わない手はないです。そんなわけで、みんな非同期でハッピーになりましょう！</p>

<hr>

<p>アドベントなんとかってやつに勢いで申し込んでみたんだけど、これ間に合った！？間に合ってないな！！ちょっと乱文具合がひどい気がする！ごめんなさい！</p>
</div></div></section><div class="css-1yzj1fm"><div class="css-1uv1qiv"><span class="fa fa-twitter"></span></div><div class="css-1uv1qiv"><span class="fa fa-facebook"></span></div></div><div class="apm-Content"><div class="apm-Content_title">Why not register and get more from Qiita?</div><ol class="apm-Content_list"><li>We will deliver articles that match you<div class="description">By following users and tags, you can catch up information on technical fields that you are interested in as a whole</div></li><li>you can read useful information later efficiently<div class="description">By &quot;stocking&quot; the articles you like, you can search right away</div></li><div><a class="apm-Content_help" href="https://help.qiita.com/ja/articles/qiita-login-user" target="_blank"><i class="fa fa-fw fa-arrow-circle-right"></i>What you can do with signing up</a></div></ol><a href="/signup?callback_action=login_or_signup&amp;redirect_to=%2Facple%40github%2Fitems%2F8f63aacb13de9954c5da&amp;realm=qiita" class="apm-Content_button apm-Content_button-signup">Sign up</a><a href="/login?callback_action=login_or_signup&amp;redirect_to=%2Facple%40github%2Fitems%2F8f63aacb13de9954c5da&amp;realm=qiita" class="apm-Content_button apm-Content_button-signin">Login</a></div></div><div class="css-helsa7"></div></div></div></div><div class="css-109dbrr"><div class="css-5jpx49"><div class="css-mnxgyc"><button class=" css-1vlpknv"><svg size="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="#55C500" class="css-1g4cku8 e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></button><a href="/acple@github/items/8f63aacb13de9954c5da/likers" class="css-1iupg5d">945</a></div><div class="css-fsjkhv"><button class=" css-15cocm3"><svg size="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 353.02 398" color="#6E6F70" class="css-12rp90f e11v00bf0"><path d="M176.72 398c-67.52 0-130.16-29-171.84-79.69l-4.46-5.42V78.05H353v234.84l-4.45 5.42C306.88 369 244.24 398 176.72 398zm-137.2-99.34c34.17 38.37 83.78 60.25 137.2 60.25s103-21.88 137.21-60.25V117.14H39.52zM0 0h351.12v40.94H0z"></path></svg></button><span class="css-1b17vb0">947</span></div><div class="css-79elbk"><button class="css-16hhh7b"><i class="fa fa-ellipsis-h"></i></button><div class="css-7i7f4d"><div class="css-1gj7nt">Improve article</div><a href="/drafts/8f63aacb13de9954c5da/edit" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-code-fork css-1jqivyb" aria-hidden="true"></i></span>Send edit request</a><div class="css-1ode1bp"></div><div class="css-1gj7nt">Article information</div><a href="/acple@github/items/8f63aacb13de9954c5da/revisions" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-history css-1jqivyb" aria-hidden="true"></i></span>Revisions</a><a href="/acple@github/items/8f63aacb13de9954c5da/patches" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-inbox css-1jqivyb" aria-hidden="true"></i></span>Edit Requests</a><a href="/acple@github/items/8f63aacb13de9954c5da/likers" class="css-154zy0m"><span class="css-yikrym"><svg size="13" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 392.81 429" color="rgba(0, 0, 0, 0.6)" class="css-le4d8r e31pr5q0"><path d="M14.19 5.4h53.86v149.45h90.05v44.87H14.19zM288.4 93.77h100.79q1.29 25-5.66 45.39a96.79 96.79 0 01-20.33 34.89 92 92 0 01-32.13 22.45 104 104 0 01-40.95 7.93 109.71 109.71 0 01-76-29.92 104.05 104.05 0 01-23-32.56 95.46 95.46 0 01-8.47-39.88 94.78 94.78 0 018.47-39.87 104.38 104.38 0 0123-32.42A107.71 107.71 0 01248.23 8a110.79 110.79 0 01118.48 22.49l-35.07 35.08a51.25 51.25 0 00-17.75-15 52.83 52.83 0 00-44.67-1.23 52.92 52.92 0 00-17 12 57.07 57.07 0 00-11.45 18.11 60 60 0 00-4.23 22.77 60 60 0 004.23 22.68 56.57 56.57 0 0011.45 18.19 52.62 52.62 0 0017 12 50.5 50.5 0 0020.9 4.36q20.19 0 31.07-7.51a35.75 35.75 0 0014.46-20.55h-47.39zM51.29 279.55H0v-44.86h156v44.86h-51.13V429H51.29zM283.36 381.71l-41.72-62V429h-53.86V234.69h47.47L290 312l55.9-77.29h46.9V429h-53.86V320.27l-42.43 61.44z"></path></svg></span>Show all likers</a><a href="/acple@github/items/8f63aacb13de9954c5da.md" class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-file-text-o css-1jqivyb" aria-hidden="true"></i></span>Show article in Markdown</a><div class="css-1ode1bp"></div><div class="css-154zy0m"><span class="css-yikrym"><i class="fa fa-flag css-1jqivyb" aria-hidden="true"></i></span>Report article</div></div><div class="st-Modal"><div class="st-Modal_backdrop"></div><div class="st-Modal_body"><form><div class="st-Form"><span class="st-Form_label">Help us understand the problem. What is going on with this article?</span></div><div class="st-Form"><label><input type="radio" name="reason" value="illegal" required=""/>It&#x27;s illegal (copyright infringement, privacy infringement, libel, etc.)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="inappropriate_content" required=""/>It&#x27;s socially inappropriate (offensive to public order and morals)</label></div><div class="st-Form"><label><input type="radio" name="reason" value="advertising" required=""/>It&#x27;s advertising</label></div><div class="st-Form"><label><input type="radio" name="reason" value="spam" required=""/>It&#x27;s spam</label></div><div class="st-Form"><label><input type="radio" name="reason" value="guideline_violation" required=""/>Other than the above, but not suitable for the Qiita community (violation of guidelines)</label></div><div class="st-Form st-Form-right"><input type="submit" class="st-Form_submit" value="Submit"/></div></form></div></div></div></div></div></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="PersonalArticlePage" data-dom-id="PersonalArticlePage-react-component-ff88cf11-119a-4fad-901b-4c7db8f54901">{"authorAnalyticsTrackingId":null,"organizationAnalyticsTrackingId":null}</script>
      
<footer id="globalFooter" class="st-Footer"><div class="st-Footer_container"><div class="st-Footer_start"><div class="st-Footer_logo"><svg viewbox="0 0 426.57 130" xmlns="http://www.w3.org/2000/svg"><circle cx="167.08" cy="21.4" r="12.28" /><path d="M250.81 29.66h23.48v18.9h-23.48z" /><path d="M300.76 105.26a22.23 22.23 0 01-6.26-.86 12.68 12.68 0 01-5.17-3 14.41 14.41 0 01-3.56-5.76 28 28 0 01-1.3-9.22V48.56h29.61v-18.9h-29.52V3.29h-20.17v83.34q0 11.16 2.83 18.27a27.71 27.71 0 007.7 11.2 26.86 26.86 0 0011.43 5.62 47.56 47.56 0 0012.34 1.53h15.16v-18zM0 61.7a58.6 58.6 0 015-24.21A62.26 62.26 0 0118.73 17.9 63.72 63.72 0 0139 4.78 64.93 64.93 0 0164 0a65 65 0 0124.85 4.78 64.24 64.24 0 0120.38 13.12A62 62 0 01123 37.49a58.6 58.6 0 015 24.21 58.34 58.34 0 01-4 21.46 62.8 62.8 0 01-10.91 18.16l11.1 11.1a10.3 10.3 0 010 14.52 10.29 10.29 0 01-14.64 0l-12.22-12.41a65 65 0 01-15.78 6.65 66.32 66.32 0 01-17.55 2.3 64.63 64.63 0 01-45.23-18A62.82 62.82 0 015 85.81 58.3 58.3 0 010 61.7zm21.64.08a43.13 43.13 0 0012.42 30.63 42.23 42.23 0 0013.43 9.09A41.31 41.31 0 0064 104.8a42 42 0 0030-12.39 42.37 42.37 0 009-13.64 43.43 43.43 0 003.3-17 43.77 43.77 0 00-3.3-17A41.7 41.7 0 0080.55 22 41.78 41.78 0 0064 18.68 41.31 41.31 0 0047.49 22a42.37 42.37 0 00-13.43 9.08 43.37 43.37 0 00-12.42 30.7zM331.89 78a47.59 47.59 0 013.3-17.73 43.22 43.22 0 019.34-14.47A44.25 44.25 0 01359 36a47.82 47.82 0 0118.81-3.58 42.72 42.72 0 019.26 1 46.5 46.5 0 018.22 2.58 40 40 0 017 3.84 44.39 44.39 0 015.71 4.63l1.22-9.47h17.35v85.83h-17.35l-1.17-9.42a42.54 42.54 0 01-5.84 4.67 43.11 43.11 0 01-7 3.79 44.86 44.86 0 01-8.17 2.59 43 43 0 01-9.22 1A47.94 47.94 0 01359 119.9a43.3 43.3 0 01-14.47-9.71 44.17 44.17 0 01-9.34-14.47 47 47 0 01-3.3-17.72zm20.27-.08a29.16 29.16 0 002.17 11.34 27 27 0 005.92 8.88 26.69 26.69 0 008.76 5.76 29.19 29.19 0 0021.44 0 26.11 26.11 0 008.72-5.76 27.57 27.57 0 005.88-8.84 29 29 0 002.16-11.38 28.62 28.62 0 00-2.16-11.22 26.57 26.57 0 00-5.93-8.8 27.68 27.68 0 00-19.51-7.9 28.29 28.29 0 00-10.77 2.05 26.19 26.19 0 00-8.71 5.75 27.08 27.08 0 00-5.84 8.8 28.94 28.94 0 00-2.13 11.31zm-194.97-30.5h19.78v73.54h-19.78zm49.25 0h19.78v73.54h-19.78z" /><circle cx="216.33" cy="21.4" r="12.28" /></svg></div><div class="st-Footer_catchcopy">How developers code is here.</div><div class="st-Footer_socials"><a class="fa fa-twitter" href="https://twitter.com/qiita"></a><a class="fa fa-facebook-square" href="https://www.facebook.com/qiita/"></a></div></div><div class="st-Footer_end"><div class="st-Footer_qiita"><div class="st-Footer_label">Qiita</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="/about">About</a><a href="/terms">Terms</a><a href="/privacy">Privacy</a><a target="_blank" href="http://help.qiita.com/ja/articles/qiita-community-guideline">Guideline</a><a target="_blank" href="https://help.qiita.com/ja/articles/others-brand-guideline">Design Guideline</a></div><div class="st-Footer_column"><a href="/release-notes">Release</a><a href="/api/v2/docs">API</a><a href="/feedback/new">ご意見</a><a href="https://help.qiita.com">Help</a><a target="_blank" href="https://qiita.com/ads?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Advertisement</a></div></div></div><div class="st-Footer_increments"><div class="st-Footer_label">Increments</div><div class="st-Footer_list"><div class="st-Footer_column"><a href="https://increments.co.jp/company/">About</a><a href="https://increments.co.jp/jobs/">採用情報</a><a href="https://blog.qiita.com">Blog</a></div><div class="st-Footer_column"><a href="https://teams.qiita.com/">Qiita Team</a><a href="https://jobs.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Jobs</a><a href="https://zine.qiita.com?utm_source=qiita&amp;utm_medium=referral&amp;utm_content=footer">Qiita Zine</a></div></div></div></div></div><div class="st-Footer_copyright">© 2011-2021 Increments Inc.</div></footer><div id="Snackbar-react-component-303d8ae8-062b-4140-84bb-ac6dbe36297e"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="Snackbar" data-dom-id="Snackbar-react-component-303d8ae8-062b-4140-84bb-ac6dbe36297e">{}</script>
      
<div id="LoginModal-react-component-76710ec8-f5fe-4a91-ad0a-c02a5b8b2ef1"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="LoginModal" data-dom-id="LoginModal-react-component-76710ec8-f5fe-4a91-ad0a-c02a5b8b2ef1">{}</script>
      
<div id="StockModal-react-component-adac4311-32c3-4d1c-be58-b0bf28e6e9e6"></div>
      <script type="application/json" class="js-react-on-rails-component" data-component-name="StockModal" data-dom-id="StockModal-react-component-adac4311-32c3-4d1c-be58-b0bf28e6e9e6">{}</script>
      
</div><div id="dataContainer" style="display: none;" data-config="{&quot;actionPath&quot;:&quot;public/items#show&quot;,&quot;settings&quot;:{&quot;analyticsTrackingId&quot;:&quot;UA-24675221-12&quot;,&quot;assetsMap&quot;:{},&quot;csrfToken&quot;:&quot;DQD/1f+yXw93sKWJrw63VW+/kMttURfsjHB0/RLt2gwhqBhauUgDebvbs7mhl62z9xWCCTc1cxFuugkJxHaSsw==&quot;,&quot;locale&quot;:&quot;en&quot;},&quot;currentUser&quot;:null}" /></body></html><script type="application/json" data-js-react-on-rails-store="AppStoreWithReactOnRails">{"snackbar":{"type":"","body":"","isActive":false},"article":{"article":{"body":"\u003cp\u003eこの記事は、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eTask.Runを書けばとりあえず非同期で動くのはわかる\u003c/li\u003e\n\u003cli\u003e時々なんかうまく動かなかったりするけどどうして動かないのかはよくわからない\u003c/li\u003e\n\u003cli\u003eよくわからないまま書いてよくわからないまま動いてるけどこれで大丈夫なのかわからなくてこわい\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eみたいな人を対象にしています。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"taskクラスとasyncawait\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#task%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8asyncawait\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTaskクラスとasync/await\u003c/h1\u003e\n\n\u003cp\u003e皆さん、非同期してますか？当然してますね。\u003cdel\u003e同期処理が許されるのはC#2.0までだよねー\u003c/del\u003eじゃなくて、async/awaitはC# 5.0から導入された、Taskクラスと紐付いた言語構文の一つです。登場はもう数年前なはずなんですが、未だに新しい言語仕様な感じがしてフシギです。それでもさすがに今は馴染んでいて、どこにでも遠慮なく飛び出てくるようになっています。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"taskの難しさ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#task%E3%81%AE%E9%9B%A3%E3%81%97%E3%81%95\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTaskの難しさ\u003c/h2\u003e\n\n\u003cp\u003eTaskは、難しいです。\u003cbr\u003e\nTaskがというよりは、非同期処理自体が持つ複雑さが根本に存在するため、いくらシンプルに書ける構文があったとしても、その難しさは変わりません。\u003cbr\u003e\n非同期処理の一般的な問題として、よくわかっていないまま使うと、目に見えにくい不具合や再現性が著しく低い不具合などを埋め込んでしまい大変危険なことになるんですが、その危険性も、使い慣れている人じゃないと気づけないというところがあります。\u003cbr\u003e\n下手な使い方をすると、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003e例外がthrowされてたけど気づかない\u003c/li\u003e\n\u003cli\u003e見つけづらいデッドロックの発生\u003c/li\u003e\n\u003cli\u003e並列アクセスによるスレッドセーフ問題\u003c/li\u003e\n\u003cli\u003eそもそもちゃんと非同期処理になってないクソコード\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eなどの問題を引き起こします。やばいですね。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"taskを理解しよう\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#task%E3%82%92%E7%90%86%E8%A7%A3%E3%81%97%E3%82%88%E3%81%86\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTaskを理解しよう\u003c/h1\u003e\n\n\u003cp\u003eまずはasync/awaitのことは置いておいて、Taskの事を理解することが大切です。\u003cbr\u003e\n細かい動きがわからなくても、理屈さえ理解さえしていれば、間違ってもasync voidなんて書いたりしなくなりますからね。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"オブジェクト指向\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%8C%87%E5%90%91\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eオブジェクト指向\u003c/h2\u003e\n\n\u003cp\u003eさすがに今更オブジェクト指向のことについて言及する必要もないとは思いますが、これ以降の話の内容にちょっと関わるので、一言だけ。\u003cbr\u003e\nオブジェクト指向というのは「有象無象の『値』の集まりに対して、クラスという枠組みを作り、その『値』に特別な性質と名前を与え、それを分類して管理していく」プログラミングスタイルのことです。つまり、オブジェクト指向におけるクラスの「名前」というのは非常に重要で、例えば中身が全く同じであっても、その名前が違うだけで使い方が自然に変わっていくような、そんなハイコンテクストなプログラミング手法なのです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"そもそもtaskとは何なのか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82task%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%AA%E3%81%AE%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eそもそもTaskとは何なのか\u003c/h2\u003e\n\n\u003cp\u003eTaskの解説を読むとスレッドプールだとかIO待ちだとか、並列だ並行だと話が出てきますが、そもそもスレッドプールとIO待ちは全くの別物だったりしますね。これは一体どういうことなのか？\u003c/p\u003e\n\n\u003cp\u003eまず一番の前提をぶち壊して行きます。\u003cbr\u003e\n「Taskとは、『非同期処理』のことではない。」\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eだって、「Task」はただの「タスク」なのだから。\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"taskという名前\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#task%E3%81%A8%E3%81%84%E3%81%86%E5%90%8D%E5%89%8D\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTaskという「名前」\u003c/h2\u003e\n\n\u003cp\u003eここで、非同期処理に「Task」という名前が与えられている意味を考えてみましょう。Taskクラスはその名の通り、一つの「作業単位」「仕事」「タスク」そのものを表しているといえます。一般的なTaskファクトリであるTask.Runを例とすると、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eMethodA\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eMethodB\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003cspan class=\"p\"\u003e});\u003c/span\u003e\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eこの変数taskは、「MethodAを実行後、MethodBを実行する、という『タスク』を作成し、それを開始したもの」を表します。つまり、変数taskの中身は、文字通り『タスク』そのものなのです。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"例\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BE%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e例\u003c/h3\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"1000ミリ秒待機するという仕事を表す\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1000%E3%83%9F%E3%83%AA%E7%A7%92%E5%BE%85%E6%A9%9F%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E4%BB%95%E4%BA%8B%E3%82%92%E8%A1%A8%E3%81%99\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「1000ミリ秒待機するという『仕事』を表す」\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// ただのDelayなんだけど、ちょっと違って見えてきません？\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"httpclientでgetを行うという仕事\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#httpclient%E3%81%A7get%E3%82%92%E8%A1%8C%E3%81%86%E3%81%A8%E3%81%84%E3%81%86%E4%BB%95%E4%BA%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「HttpClientでGETを行うという『仕事』」\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"https://......\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \u0026lt;- awaitを付けていない\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eここで記述しているのは「開始するところ」だけなのがポイント。だから、「実際のGET処理は裏で誰かが勝手にやってくれる」。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"asyncawaitキーワードそして非同期メソッドとは\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#asyncawait%E3%82%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%89%E3%81%9D%E3%81%97%E3%81%A6%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8%E3%81%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003easync/awaitキーワード、そして「非同期メソッド」とは\u003c/h1\u003e\n\n\u003cul\u003e\n\u003cli\u003eシグネチャにasyncを付けたメソッドのことを「非同期メソッド」と呼びます。\u003c/li\u003e\n\u003cli\u003e非同期メソッドの特徴はただ一つ、文中でawaitキーワードを使えるようになることです。\u003c/li\u003e\n\u003cli\u003eそして、awaitキーワードの効果は、「指定したTaskの完了を待つ」「そして、その結果を取り出す」ことです。\u003c/li\u003e\n\u003cli\u003e最後に、非同期メソッドの戻り値は必ずTask/Task\u0026lt;T\u0026gt;になります。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eなにか見えてきませんか？\u003c/p\u003e\n\n\u003cp\u003e非同期メソッドとは、\u003cstrong\u003e複数の「タスク」の実行順序などを記述した「一つのタスク」である\u003c/strong\u003e。\u003cbr\u003e\nいわゆる、作業手順書のようなものである。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"例-1\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BE%8B-1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e例\u003c/h3\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"1000ミリ秒待機するタスクの完了を待ちその後doneを出力するというタスク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#1000%E3%83%9F%E3%83%AA%E7%A7%92%E5%BE%85%E6%A9%9F%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%AE%E5%AE%8C%E4%BA%86%E3%82%92%E5%BE%85%E3%81%A1%E3%81%9D%E3%81%AE%E5%BE%8Cdone%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%BF%E3%82%B9%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「1000ミリ秒待機する『タスク』の完了を待ち、その後\"Done!\"を出力する、という『タスク』」\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eAsyncMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 1000ミリ秒待機するという仕事の完了を待ち、\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\"Done!\"\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \"Done!\"をコンソールに出力する\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e// という、「一つのTask」を表す。\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4\u003e\n\u003cspan id=\"httpclientでgetした内容を文字列で手に入れるタスク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#httpclient%E3%81%A7get%E3%81%97%E3%81%9F%E5%86%85%E5%AE%B9%E3%82%92%E6%96%87%E5%AD%97%E5%88%97%E3%81%A7%E6%89%8B%E3%81%AB%E5%85%A5%E3%82%8C%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「HttpClientでGETした内容を文字列で手に入れる『タスク』」\u003c/h4\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eAsyncMethod2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eUri\u003c/span\u003e \u003cspan class=\"n\"\u003euri\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"nf\"\u003eHttpClient\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \u0026lt;- 本当はHttpClientをusingで使っちゃダメ\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresponse\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euri\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// \u0026lt;- 「GETせよ」のタスクを開始し、その完了を待機する\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eresponse\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAsStringAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 「レスポンスからその本文をstringとして読み出す」タスクを開始し、その完了を待機する\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003etext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 読み出したtextを返す\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e// という「一つのタスク(Task\u0026lt;string\u0026gt;)」を表す。\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"タスクであるという意味\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%A7%E3%81%82%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E6%84%8F%E5%91%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「タスク」であるという意味\u003c/h2\u003e\n\n\u003cp\u003e非同期メソッドはタスクであり、作業手順書です。手順書であるということは、それが「書かれた通りの順序で実行していけばいい」ということであり、言い換えるとそれは「\u003cstrong\u003e記述されたタスクの実行順序さえ間違えなければ、誰が（どのスレッドが）どのタスクを実行したって構わない\u003c/strong\u003e」と表明しているような事になります。つまり、Taskとは「スレッドの存在を意識する必要がない、単なる『処理』のまとまり」だということです。非同期処理を「タスク」の組み合わせとみなすことで、処理を分割しやすく、そして容易に合成できるようにしたもの。それが、Taskクラスなのです。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// ちゃんと順番通り実行してくれるなら、\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eresponse\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eGetAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euri\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// このタスクを実行する人(スレッド)と\u003c/span\u003e\n\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etext\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eresponse\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContent\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eReadAsStringAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// このタスクを実行する人が違ったとしても\u003c/span\u003e\n\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003etext\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 全く問題はない！\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"スレッドプールio待ち\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%83%97%E3%83%BC%E3%83%ABio%E5%BE%85%E3%81%A1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eスレッドプール、IO待ち\u003c/h2\u003e\n\n\u003cp\u003eTaskは非同期のことではありません。あくまで処理を「手順書」として記述したものであり、それの中身がなんであるかを気にする必要はないのです。例えば、同期処理をTask.Runでラップした場合、それは「スレッドプール上で動作する一連の処理」となります。Task.Delayは「指定したミリ秒後にタイマーを設定し、スレッドを解放」します。HttpClientなどのIO待ちは、イベント処理をTaskでラップしたものになります。このように、中身は全く異なる枠組みで動作していても、それらを全て「単なるタスク」として取り扱えること。これが、Taskの本質なのです。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"見て覚えるasyncawait\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E8%A6%8B%E3%81%A6%E8%A6%9A%E3%81%88%E3%82%8Basyncawait\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e見て覚えるasync/await\u003c/h1\u003e\n\n\u003cp\u003e似たようだけどぜんぜん違うコードを並べてみましたので、見て、そして、理解して下さい。\u003cbr\u003e\nわかりやすさのため、for文を使用しています。\u003cbr\u003e\nこの項では便宜的に、voidなメソッドのことを「アクション」と表現しています。その意図については後で説明します。\u003c/p\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"重い処理をエミュレートする同期メソッド\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E9%87%8D%E3%81%84%E5%87%A6%E7%90%86%E3%82%92%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E5%90%8C%E6%9C%9F%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e重い処理をエミュレートする同期メソッド\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eHeavyMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eThread\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eSleep\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e10\u003c/span\u003e \u003cspan class=\"p\"\u003e*\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e100\u003c/span\u003e \u003cspan class=\"p\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e \u003cspan class=\"c1\"\u003e// てきとーに時間を潰す\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eConsole\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWriteLine\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"heavymethodを同期的に10回実行する普通のメソッド\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#heavymethod%E3%82%92%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB10%E5%9B%9E%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E6%99%AE%E9%80%9A%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「HeavyMethodを同期的に10回実行する」普通のメソッド\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRunHeavyMethodSync\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 比較のため、ただの同期メソッド\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"nf\"\u003eHeavyMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"heavymethodを順次実行するという一つのタスク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#heavymethod%E3%82%92%E9%A0%86%E6%AC%A1%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E4%B8%80%E3%81%A4%E3%81%AE%E3%82%BF%E3%82%B9%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「HeavyMethodを順次実行する」という一つのタスク\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eRunHeavyMethodAsync1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eHeavyMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 「HeavyMethodを実行する」というタスクを開始し、完了するまで待機\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e// を、10回繰り返す\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e// というタスクを表す\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// ので、これは順次動作であり、並列ではない。\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"heavymethodを順次実行するというアクション\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#heavymethod%E3%82%92%E9%A0%86%E6%AC%A1%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「HeavyMethodを順次実行する」というアクション\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRunHeavyMethodAsync2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c1\"\u003e// RunHeavyMethodAsync1の戻り値がvoidになっただけ\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eHeavyMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 動作はRunHeavyMethodAsync1と同じだけど、HeavyMethodの実行がいつ完了するのか知ることができない。つらい。\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"heavymethodを実行するタスクを10個開始するというアクション\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#heavymethod%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%9210%E5%80%8B%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「HeavyMethodを実行するタスクを10個開始する」というアクション\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eRunHeavyMethodParallel1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c1\"\u003e// asyncじゃない\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eHeavyMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e \u003cspan class=\"c1\"\u003e// HeavyMethodを開始せよという命令\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e// を、10回繰り返すだけ\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e// なので、これは並列動作になる。Task.Runが投げっぱなしなので、HeavyMethodの状態がわからなくてつらい。\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3\u003e\n\u003cspan id=\"heavymethodを実行するタスクを10個開始しその全てが完了した時に完了するという一つのタスク\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#heavymethod%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%9210%E5%80%8B%E9%96%8B%E5%A7%8B%E3%81%97%E3%81%9D%E3%81%AE%E5%85%A8%E3%81%A6%E3%81%8C%E5%AE%8C%E4%BA%86%E3%81%97%E3%81%9F%E6%99%82%E3%81%AB%E5%AE%8C%E4%BA%86%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E4%B8%80%E3%81%A4%E3%81%AE%E3%82%BF%E3%82%B9%E3%82%AF\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e「HeavyMethodを実行するタスクを10個開始し、その全てが完了した時に完了する」という一つのタスク\u003c/h3\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eRunHeavyMethodParallel2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c1\"\u003e// asyncじゃないけど、戻り値がTask\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etasks\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003enew\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e\u0026gt;();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// TaskをまとめるListを作成\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e++)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eRun\u003c/span\u003e\u003cspan class=\"p\"\u003e(()\u003c/span\u003e \u003cspan class=\"p\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"nf\"\u003eHeavyMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e \u003cspan class=\"c1\"\u003e// HeavyMethodを開始するというTask\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etasks\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eAdd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// を、Listにまとめる\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eWhenAll\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etasks\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 全てのTaskが完了した時に完了扱いになるたった一つのTaskを作成\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 非同期メソッドではないが、戻り値がTaskなので、このメソッドは一つのタスクを表しているといえる。\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e以上です。違いが分かるでしょうか？\u003c/p\u003e\n\n\u003cp\u003eまず最初に、Taskをawaitした場合とawaitしない場合の違いがあります。\u003cbr\u003e\nawaitするということは、「そのTaskが完了するまで待つ」ということなので、いわゆる同期実行的なフローになります。awaitしない場合は、その行で「(誰か)この仕事を開始して！」という命令を投げるだけに留まります。なので、そのタスクの実行中に自分は本来の仕事の続きをこなすことが出来るのです。並行ですね。そして、戻り値としてTaskを握ることで、その仕事の進行状況を把握することができるようになっています。\u003c/p\u003e\n\n\u003cp\u003e次に、戻り値がTaskの場合とvoidの場合です。\u003cbr\u003e\nTaskを返す場合は、基本的にその手順書に書かれた仕事が全て完了したことを報告することになります。非同期メソッドで戻り値をTaskにした場合は、自動的に、そのメソッドがreturnしたときに完了するTaskになります。\u003cbr\u003e\nそして、voidは、何も返しません。どういうことか？上司は「この仕事を開始して！」と命令したあと、命令したことを忘れます。そしてTaskを割り当てられたスレッドくんは、その仕事が完了しても報告する相手がいないわけです。マジヤバイ。\u003c/p\u003e\n\n\u003cp\u003evoidなメソッドを「アクション」と表現しましたが、これの意図は一つ。「それは『タスク』ではないから」。命令を投げるだけ投げっぱなしなのは、責任の所在を不明にする行為で、おおよそ推奨できるものではありません。その実害としては、voidで実行した非同期メソッド中で万が一例外が発生した場合など。その例外はコード上で見つけることが出来なくなり、それは時にアプリケーションを殺します。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"async-void-なんてなかった\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#async-void-%E3%81%AA%E3%82%93%E3%81%A6%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003easync void なんてなかった\u003c/h1\u003e\n\n\u003cp\u003easync void は 使用禁止！使用禁止！使用禁止！\u003cbr\u003e\n上の話で書いたとおりですが、せっかく非同期メソッドがその仕事の進行状況を把握できるような設計になっているのに、わざわざそれを捨てるなんてとんでもない！\u003cbr\u003e\n同期メソッドで言うvoidは、非同期メソッドでは戻り値Taskのことであり、同期メソッドにおける戻り値は、非同期メソッドにおける戻り値Task\u0026lt;T\u0026gt;のTになります。それ以外はないです。\u003c/p\u003e\n\n\u003cp\u003eでは、何故async voidなんていうものが存在するのか？その理由はただ一つ。UIイベントハンドラーに非同期メソッドを登録するには、voidじゃないと無理だったから。\u003cbr\u003e\nUIから直接実行されるイベントの受け皿メソッドにのみ、async voidを使うことが許されていると思って下さい。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"taskってむずかしい\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#task%E3%81%A3%E3%81%A6%E3%82%80%E3%81%9A%E3%81%8B%E3%81%97%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTaskってむずかしい\u003c/h1\u003e\n\n\u003cp\u003eちょっとごちゃごちゃしてますが、ここまで実装とはなるべく無関係に内容を説明してきたつもりです。ここからはもう少し深掘りしていくので、読めなかったら適当に読み飛ばしてもいいですよーなのです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"taskrunとは何なのか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#taskrun%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%AA%E3%81%AE%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTask.Runとは何なのか\u003c/h2\u003e\n\n\u003cp\u003eTask.Runはお手軽にTaskを作れるファクトリメソッドですが、お手軽すぎるせいで、使う必要が全くない場面でも使われていることがとても多くてもにょもにょします。\u003cbr\u003e\nTask.Runの概念は、一言で言えばこうです。\u003c/p\u003e\n\n\u003cp\u003e「同期的な一連の処理を、一つのタスクとみなす」\u003c/p\u003e\n\n\u003cp\u003e非同期タスクを組み合わせ、合成して、一つのタスクを組み上げるのが非同期メソッドだとしたら、その中に同期処理もタスクの一つとして組み込みたいこともあるわけです。その時に使えるのがTask.Runなのです。\u003c/p\u003e\n\n\u003cp\u003eもう一つ別の使い方に、Task.Runの中に非同期ラムダ式を書くパターンがあります。これは、単純にその非同期メソッドを呼び出しているようなものです。直接呼び出した場合と唯一異なるのが、「非同期メソッドを明確に別コンテキストで実行する」というものです。\u003c/p\u003e\n\n\u003cp\u003eこれ以外の使い方をしているなら、それはTask.Runの濫用だと思っていいです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"taskはスレッドの呪縛から解放された-\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#task%E3%81%AF%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E5%91%AA%E7%B8%9B%E3%81%8B%E3%82%89%E8%A7%A3%E6%94%BE%E3%81%95%E3%82%8C%E3%81%9F-\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTaskはスレッドの呪縛から解放された！ ……？\u003c/h2\u003e\n\n\u003cp\u003e上で書いたとおり、「Taskは単なる手順書であり、それぞれの処理をどのスレッドが実行したって結果は変わらない」というものです。よって、Taskはレガシープログラミング的なスレッド管理という概念から解放された非同期機構であり、特定のスレッドに依存する処理(UI操作など)は、本来非同期メソッド上で扱ってはいけないのです！……Taskの思想では、そうなるはずだったのです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"asyncawaitはスレッドと切り離せなかった\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#asyncawait%E3%81%AF%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%A8%E5%88%87%E3%82%8A%E9%9B%A2%E3%81%9B%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003easync/awaitはスレッドと切り離せなかった……\u003c/h2\u003e\n\n\u003cp\u003easync/awaitの有名な使用例として、まず最初にUI処理が出てきます。UIはシングルスレッドなので、その貴重な資源を内部処理などで長時間専有するなんてとんでもない！というのはその通りで、まさにここが非同期処理が活躍する最大の見せ場でもありました。なので、非同期メソッドには「まるで同期処理のような書き方で非同期処理を行えて、自然にUI処理に組み込める」というものが期待されました。\u003cbr\u003e\nよって、async/awaitは、「非同期メソッド内で何らかの処理をawaitした後、その続きはawaitする前と『同じスレッド上で』実行される」という設計になりました。\u003cbr\u003e\n例えば、UIからボタン操作などで非同期メソッドを開始(UIスレッド上で動作)し、その途中で何かしらの内部処理を呼び出してawait(内部処理は別スレッドで動作し、UIスレッドは自由に)、内部処理が完了した後の続きは再びUIスレッドに戻って動作するので、そこでUIの更新などのスレッド依存処理を書いても問題なく動作させることができるのです。\u003cbr\u003e\nこれで、期待された「まるで同期処理のような書き方でUI処理」を実現することができたのです。これでみんなハッピー！\u003c/p\u003e\n\n\u003cp\u003e……本当に？\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"taskをwaitしてはいけない\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#task%E3%82%92wait%E3%81%97%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTaskをWaitしてはいけない\u003c/h2\u003e\n\n\u003cp\u003eTaskをWaitしてはいけないと聞いたことはありますね？\u003cbr\u003e\nどこの解説を読んでも、TaskをWaitすることについては一言二言書いてあったはずです。\u003cbr\u003e\n理由はもちろんデッドロック。ちょっとWaitを呼んでみるだけで、予想よりもずっと簡単にデッドロックを発生させることができてしまいます。\u003cbr\u003e\n例えば、\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eKusoMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eKusoAsyncMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// エターナル不応答しぬ\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eKusoAsyncMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eはい。たったこれだけで、完全にデッドロックで死にます。ギルティです。\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"何故デッドロックが発生するのか\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E4%BD%95%E6%95%85%E3%83%87%E3%83%83%E3%83%89%E3%83%AD%E3%83%83%E3%82%AF%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003e何故デッドロックが発生するのか\u003c/h2\u003e\n\n\u003cp\u003e非同期メソッドは、awaitする内部タスクを開始した後、自分のスレッドを一旦解放します。そして、その内部タスクが完了したとき、処理の続きを「前と同じスレッドで」実行します。その間に、「前のスレッドを既に誰かが使っていたら？」「そして、そのスレッドが解放されるためには、Taskの実行が完了しないといけないとしたら？」はい。デッドロックです。\u003cbr\u003e\nWaitじゃなくてもいいです。例えば、Taskが実行完了するまで廻り続けるwhileループとかでも余裕で発生します。Task\u0026lt;T\u0026gt;.Resultプロパティの参照もWaitと同様なので同じように死にます。\u003c/p\u003e\n\n\u003cp\u003e本来、\u003cstrong\u003eTaskは好きなときに好きなようにWaitしても全く問題ないものだった\u003c/strong\u003eはずなのです。しかし、async/awaitがスレッドのコンテキストを掴む関係で、Waitした際にデッドロックが発生する可能性が出てしまいました。非同期メソッドが本当の意味での「ただのタスク」であったならば、それがコンテキストを保存する必要は全くなかったのです。全ては、「UIスレッドのイベントハンドラをナチュラルに書く」というただ一つの用途のため。そのために、Waitは全面使用禁止となり、使おうとすれば我々は一目では見つけづらいデッドロックに怯えなければならない状況になってしまったのです。とてもつらい。\u003c/p\u003e\n\n\u003cp\u003eしかし！対策はあります！\u003c/p\u003e\n\n\u003ch2\u003e\n\u003cspan id=\"configureawaitfalseのススメ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#configureawaitfalse%E3%81%AE%E3%82%B9%E3%82%B9%E3%83%A1\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eConfigureAwait(false)のススメ\u003c/h2\u003e\n\n\u003cp\u003e特定のスレッドに戻りたくても戻れないために発生するデッドロックならば、「特定のスレッドに戻らなくても良い」ようにすればいいのではないでしょうか。そのためのメソッドが、\u003ccode\u003eConfigureAwait(false)\u003c/code\u003eです。\u003cbr\u003e\n引数のbool値は、「awaitする際にコンテキストを保存するか？」を指定します。つまり、既定値はtrueで、これをfalseにすることで、await後に戻る先のスレッドを指定しないようにできます。そうすれば、続きの実行は適当な空いているスレッドに割り当てられ、上のようなデッドロックが発生することはなくなります。\u003c/p\u003e\n\n\u003cp\u003eつまりこういうことです、\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eまずは、awaitする時は必ずConfigureAwait(false)を書け！\u003c/li\u003e\n\u003cli\u003eその上で、UI処理など、一連の処理を特定のスレッド上で走らせたい場合に限り、ConfigureAwait(false)を外せ！\u003c/li\u003e\n\u003cli\u003eなるべく多くのawaitにConfigureAwait(false)を付けるために、UI処理などはなるべく浅い層のメソッド上にまとめて書け！\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eという設計が、Taskを扱う場合のベストプラクティスになります。\u003cbr\u003e\n超ぉめんどくさいですね。めんどくさいです。でも、やってください。これについては、async/awaitの最初の設計が悪かったとしか言えないです。\u003cbr\u003e\nこのコーディングを徹底することで、初めてデッドロック問題を回避することができます。\u003c/p\u003e\n\n\u003cdiv class=\"code-frame\" data-lang=\"csharp\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"with-code\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epublic\u003c/span\u003e \u003cspan class=\"k\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eKusoMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nf\"\u003eNiceAsyncMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e().\u003c/span\u003e\u003cspan class=\"nf\"\u003eWait\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"c1\"\u003e// Waitしてもデッドロックしない！\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eprivate\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"nf\"\u003eNiceAsyncMethod\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eawait\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"nf\"\u003eDelay\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e1000\u003c/span\u003e\u003cspan class=\"p\"\u003e).\u003c/span\u003e\u003cspan class=\"nf\"\u003eConfigureAwait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eしかし、ここでさらに問題が。上のコード例、NiceAsyncMeshodとKusoAsyncMethodの違いは、中のawaitにConfigureAwait(false)がついているかどうかだけです。ということは、この2つのメソッドのシグネチャを見比べても、その違いはわからないわけです。もし、\u003cstrong\u003eこのメソッドが外部ライブラリの中に書かれていたものだとしたら？\u003c/strong\u003eそのメソッドは果たしてちゃんとConfigureAwait(false)されているのか？これは、もう、ソースを読まないとわからない、のですね。\u003cbr\u003e\nそういうわけなので、ユーザーとしては、\u003cstrong\u003eTaskのWaitは絶対使用禁止\u003c/strong\u003e、必ず非同期メソッドでawaitを使うこと。となってしまうわけです。とても、残念です。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"taskのこれから\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#task%E3%81%AE%E3%81%93%E3%82%8C%E3%81%8B%E3%82%89\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eTaskのこれから\u003c/h1\u003e\n\n\u003cp\u003eC# 7が絶賛開発中なのです！たのしいのです！\u003cbr\u003e\nVisual Studio 2017のリリースに合わせて、C#のバージョン7がリリースされようとしています。\u003cbr\u003e\nその目玉新機能の一つとして、「値型のTask」と、それに付随して「ユーザー定義のTask型」が搭載されます！\u003cbr\u003e\n……これについては、ほぼパフォーマンス要件によるものなので、ユーザー目線で見ると、今までのTaskと全然変わらないし、逆に、変わってはいけないものです。完全にライブラリ制作者向けのものなので、まあ気にしなくていいです！！この記事を丸ごとすらすら読めるような人なら、調べてみたら面白いかもですよって感じです！簡単に言うと、Taskがインスタンス作りまくるからちょっとがべこれキツいんでスタック領域でなんとかならないですかね？っていう話と、値型のTask作るから自前でTask作れる枠組みをくれ！っていう話です。\u003c/p\u003e\n\n\u003ch1\u003e\n\u003cspan id=\"まとめ\" class=\"fragment\"\u003e\u003c/span\u003e\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003e\u003ci class=\"fa fa-link\"\u003e\u003c/i\u003e\u003c/a\u003eまとめ\u003c/h1\u003e\n\n\u003cp\u003e割とクソ長だこれ！\u003c/p\u003e\n\n\u003cul\u003e\n\u003cli\u003eTaskとは、「非同期処理」のことではない\u003c/li\u003e\n\u003cli\u003eTaskはただの「タスク」であり、そのタスクを誰かが処理していくという構造なので、勝手に非同期になるだけ\u003c/li\u003e\n\u003cli\u003e非同期メソッドは、Taskを組み合わせて作ったTask(作業手順書)である\u003c/li\u003e\n\u003cli\u003eTaskの意味さえわかってれば、仕組みがわからなくてもちゃんと使えるんだよ！\u003c/li\u003e\n\u003cli\u003easync void絶対使用禁止 (除く:UIイベントハンドラ)\u003c/li\u003e\n\u003cli\u003eそのTask.Run、本当に必要ですか？\u003c/li\u003e\n\u003cli\u003eTaskのWaitは本当にヤバイ\u003c/li\u003e\n\u003cli\u003eConfigureAwait(false)つけような！\u003c/li\u003e\n\u003cli\u003eC# 7でValueTaskとかTask-likeとか出てくるけど、枠組みは変わらないから、まずは普通のTaskをマスターしよう！\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003easync/await、Taskは既に完成した代物なので、これからも変わらず使われていくことになるでしょう。\u003cbr\u003e\nちゃんと理解してしまえば、つまづきどころも見えやすい仕組みなので、これを機に、非同期完全攻略、してみましょう？\u003cbr\u003e\nいくらか問題点はあるとしても、それでもasync/awaitはとてもよくできた構文なので、これを使わない手はないです。そんなわけで、みんな非同期でハッピーになりましょう！\u003c/p\u003e\n\n\u003chr\u003e\n\n\u003cp\u003eアドベントなんとかってやつに勢いで申し込んでみたんだけど、これ間に合った！？間に合ってないな！！ちょっと乱文具合がひどい気がする！ごめんなさい！\u003c/p\u003e\n","createdAt":"2016-12-09T14:56:21Z","elapsedYearsFromLastModifiedAt":4,"encryptedId":"RgQPy0v9ket4+P/66uHfLZeDWdz+ltZv--5Njob1lfgKctRzmi--SkEqpr6HQhKWhJ3JpY6KVQ==","isBanned":false,"isDeprecated":true,"isDestroyableByViewer":false,"isEditRequestReadableByViewer":true,"isEditRequestSendableByViewer":true,"isLikableByViewer":true,"isLikedByViewer":false,"isPublic":true,"isSlide":false,"isStockableByViewer":true,"isStockedByViewer":false,"isSubscribableByViewer":false,"isSubscribedByViewer":false,"isUpdatableByViewer":false,"isUpdated":true,"lastModifiedAt":"2016-12-10T08:19:56Z","likesCount":945,"linkUrl":"https://qiita.com/acple@github/items/8f63aacb13de9954c5da","organization":null,"originalId":447266,"stockedCount":947,"title":"Taskを極めろ！async/await完全攻略","toc":"\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#task%E3%82%AF%E3%83%A9%E3%82%B9%E3%81%A8asyncawait\"\u003eTaskクラスとasync/await\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#task%E3%81%AE%E9%9B%A3%E3%81%97%E3%81%95\"\u003eTaskの難しさ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#task%E3%82%92%E7%90%86%E8%A7%A3%E3%81%97%E3%82%88%E3%81%86\"\u003eTaskを理解しよう\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%8C%87%E5%90%91\"\u003eオブジェクト指向\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%9D%E3%82%82%E3%81%9D%E3%82%82task%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%AA%E3%81%AE%E3%81%8B\"\u003eそもそもTaskとは何なのか\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#task%E3%81%A8%E3%81%84%E3%81%86%E5%90%8D%E5%89%8D\"\u003eTaskという「名前」\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BE%8B\"\u003e例\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1000%E3%83%9F%E3%83%AA%E7%A7%92%E5%BE%85%E6%A9%9F%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E4%BB%95%E4%BA%8B%E3%82%92%E8%A1%A8%E3%81%99\"\u003e「1000ミリ秒待機するという『仕事』を表す」\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#httpclient%E3%81%A7get%E3%82%92%E8%A1%8C%E3%81%86%E3%81%A8%E3%81%84%E3%81%86%E4%BB%95%E4%BA%8B\"\u003e「HttpClientでGETを行うという『仕事』」\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#asyncawait%E3%82%AD%E3%83%BC%E3%83%AF%E3%83%BC%E3%83%89%E3%81%9D%E3%81%97%E3%81%A6%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%A8%E3%81%AF\"\u003easync/awaitキーワード、そして「非同期メソッド」とは\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BE%8B-1\"\u003e例\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#1000%E3%83%9F%E3%83%AA%E7%A7%92%E5%BE%85%E6%A9%9F%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%AE%E5%AE%8C%E4%BA%86%E3%82%92%E5%BE%85%E3%81%A1%E3%81%9D%E3%81%AE%E5%BE%8Cdone%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%BF%E3%82%B9%E3%82%AF\"\u003e「1000ミリ秒待機する『タスク』の完了を待ち、その後\"Done!\"を出力する、という『タスク』」\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#httpclient%E3%81%A7get%E3%81%97%E3%81%9F%E5%86%85%E5%AE%B9%E3%82%92%E6%96%87%E5%AD%97%E5%88%97%E3%81%A7%E6%89%8B%E3%81%AB%E5%85%A5%E3%82%8C%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF\"\u003e「HttpClientでGETした内容を文字列で手に入れる『タスク』」\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%BF%E3%82%B9%E3%82%AF%E3%81%A7%E3%81%82%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E6%84%8F%E5%91%B3\"\u003e「タスク」であるという意味\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%83%97%E3%83%BC%E3%83%ABio%E5%BE%85%E3%81%A1\"\u003eスレッドプール、IO待ち\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cli\u003e\n\u003ca href=\"#%E8%A6%8B%E3%81%A6%E8%A6%9A%E3%81%88%E3%82%8Basyncawait\"\u003e見て覚えるasync/await\u003c/a\u003e\n\u003cul\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#%E9%87%8D%E3%81%84%E5%87%A6%E7%90%86%E3%82%92%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B%E5%90%8C%E6%9C%9F%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89\"\u003e重い処理をエミュレートする同期メソッド\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#heavymethod%E3%82%92%E5%90%8C%E6%9C%9F%E7%9A%84%E3%81%AB10%E5%9B%9E%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E6%99%AE%E9%80%9A%E3%81%AE%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89\"\u003e「HeavyMethodを同期的に10回実行する」普通のメソッド\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#heavymethod%E3%82%92%E9%A0%86%E6%AC%A1%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E4%B8%80%E3%81%A4%E3%81%AE%E3%82%BF%E3%82%B9%E3%82%AF\"\u003e「HeavyMethodを順次実行する」という一つのタスク\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#heavymethod%E3%82%92%E9%A0%86%E6%AC%A1%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e「HeavyMethodを順次実行する」というアクション\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#heavymethod%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%9210%E5%80%8B%E9%96%8B%E5%A7%8B%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\"\u003e「HeavyMethodを実行するタスクを10個開始する」というアクション\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#heavymethod%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B%E3%82%BF%E3%82%B9%E3%82%AF%E3%82%9210%E5%80%8B%E9%96%8B%E5%A7%8B%E3%81%97%E3%81%9D%E3%81%AE%E5%85%A8%E3%81%A6%E3%81%8C%E5%AE%8C%E4%BA%86%E3%81%97%E3%81%9F%E6%99%82%E3%81%AB%E5%AE%8C%E4%BA%86%E3%81%99%E3%82%8B%E3%81%A8%E3%81%84%E3%81%86%E4%B8%80%E3%81%A4%E3%81%AE%E3%82%BF%E3%82%B9%E3%82%AF\"\u003e「HeavyMethodを実行するタスクを10個開始し、その全てが完了した時に完了する」という一つのタスク\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\n\n\u003cli\u003e\n\u003ca href=\"#async-void-%E3%81%AA%E3%82%93%E3%81%A6%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F\"\u003easync void なんてなかった\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#task%E3%81%A3%E3%81%A6%E3%82%80%E3%81%9A%E3%81%8B%E3%81%97%E3%81%84\"\u003eTaskってむずかしい\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\"#taskrun%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%AA%E3%81%AE%E3%81%8B\"\u003eTask.Runとは何なのか\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#task%E3%81%AF%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%AE%E5%91%AA%E7%B8%9B%E3%81%8B%E3%82%89%E8%A7%A3%E6%94%BE%E3%81%95%E3%82%8C%E3%81%9F-\"\u003eTaskはスレッドの呪縛から解放された！ ……？\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#asyncawait%E3%81%AF%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%81%A8%E5%88%87%E3%82%8A%E9%9B%A2%E3%81%9B%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F\"\u003easync/awaitはスレッドと切り離せなかった……\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#task%E3%82%92wait%E3%81%97%E3%81%A6%E3%81%AF%E3%81%84%E3%81%91%E3%81%AA%E3%81%84\"\u003eTaskをWaitしてはいけない\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E4%BD%95%E6%95%85%E3%83%87%E3%83%83%E3%83%89%E3%83%AD%E3%83%83%E3%82%AF%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B\"\u003e何故デッドロックが発生するのか\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#configureawaitfalse%E3%81%AE%E3%82%B9%E3%82%B9%E3%83%A1\"\u003eConfigureAwait(false)のススメ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#task%E3%81%AE%E3%81%93%E3%82%8C%E3%81%8B%E3%82%89\"\u003eTaskのこれから\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\n","totalPv":374913,"uuid":"8f63aacb13de9954c5da","banReason":null,"adventCalendarItem":{"day":9,"calendar":{"name":"C#","urlName":"csharp","year":2016,"organization":null}},"author":{"encryptedId":"oPvpndrSbsVExsoGXMIj2WAxH/s=--hIbf8LEq6nmJWrqy--d5IqQ9Dy6afcGvqOdTs2jA==","originalId":15349,"description":"言語仕様とか設計思想を掘るのが趣味のプログラミング初心者\r\nC#とPureScriptちょっとできる(できない)","facebookUrl":null,"githubUrl":"https://github.com/acple","isBlockingViewer":false,"isFollowableByViewer":true,"isFollowedByViewer":false,"isTweetWebNotificationReceivable":true,"linkedinUrl":null,"name":"","profileImageUrl":"https://qiita-image-store.s3.amazonaws.com/0/15349/profile-images/1473684254","profileImageUrlW48":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F15349%2Fprofile-images%2F1473684254?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=48\u0026s=7e2d11318dbc6cd08edc08af828a2299","profileImageUrlW75":"https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F15349%2Fprofile-images%2F1473684254?ixlib=rb-4.0.0\u0026auto=compress%2Cformat\u0026lossless=0\u0026w=75\u0026s=3a436d04088cd4d1870e042deced4196","urlName":"acple@github","websiteUrl":"","twitterUrl":"https://twitter.com/acple","twitterUrlName":"acple","revealedOrganizations":{"edges":[]}},"tags":[{"name":"C#","urlName":"csharp"},{"name":"AdventCalendar","urlName":"adventcalendar"}],"followingLikers":{"edges":[]},"comments":{"totalCount":4}},"comments":[],"client":null,"ads_event_emitter":null}}</script>
